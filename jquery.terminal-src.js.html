<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.54 in css mode. -->
<html>
  <head>
    <meta name="robots" content="noindex"/>
    <title>jquery.terminal-src.js</title>
    <style type="text/css">
    <!--
      body {
        color: #ffffff;
        background-color: #000000;
      }
      .builtin {
        /* font-lock-builtin-face */
        color: #b0c4de;
      }
      .comment {
        /* font-lock-comment-face */
        color: #ff7f24;
      }
      .constant {
        /* font-lock-constant-face */
        color: #7fffd4;
      }
      .doc {
        /* font-lock-doc-face */
        color: #ffa07a;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #87cefa;
      }
      .jcXcovered {
        /* jc/covered */
        background-color: #006400;
      }
      .jcXnot-covered {
        /* jc/not-covered */
        background-color: #8b0000;
      }
      .js2-function-call {
        /* js2-function-call */
        color: #ffffff;
        background-color: #000000;
      }
      .js2-function-param {
        /* js2-function-param */
        color: #2e8b57;
      }
      .js2-object-property {
        /* js2-object-property */
        color: #ffffff;
        background-color: #000000;
      }
      .js2-warning {
        /* js2-warning */
        text-decoration: underline;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #00ffff;
      }
      .negation-char {
      }
      .string {
        /* font-lock-string-face */
        color: #ffa07a;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #eedd82;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="doc">/**@license
 *       __ _____                     ________                              __
 *      / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___  / /
 *  __ / // // // // // _  // _// // / / // _  // _//     // //  \/ // _ \/ /
 * /  / // // // // // ___// / / // / / // ___// / / / / // // /\  // // / /__
 * \___//____ \\___//____//_/ _\_  / /_//____//_/ /_/ /_//_//_/ /_/ \__\_\___/
 *           \/              /____/                              version {{VER}}
 *
 * This file is part of jQuery Terminal. https://terminal.jcubic.pl
 *
 * Copyright (c) 2010-2019 Jakub T. Jankiewicz <a href="https://jcubic.pl/me&gt;
 * Released under the MIT license
 *
 * Contains:
 *
 * Storage plugin Distributed under the MIT License
 * modified to work from Data URIs that block storage and cookies in Chrome
 * Copyright (c) 2010 Dave Schindler
 *
 * jQuery Timers licenced with the WTFPL
 * &lt;http://jquery.offput.ca/timers/&gt;
 *
 * Cross-Browser Split 1.1.1
 * Copyright 2007-2012 Steven Levithan &lt;stevenlevithan.com&gt;
 * Available under the MIT License
 *
 * jQuery Caret
 * Copyright (c) 2009, Gideon Sireling
 * 3 clause BSD License
 *
 * sprintf.js
 * Copyright (c) 2007-2013 Alexandru Marasteanu &lt;hello at alexei dot ro&gt;
 * licensed under 3 clause BSD license
 *
 * debounce function from Lodash
 * Copyright JS Foundation and other contributors &lt;https://js.foundation/">&lt;https://jcubic.pl/me&gt;
 * Released under the MIT license
 *
 * Contains:
 *
 * Storage plugin Distributed under the MIT License
 * modified to work from Data URIs that block storage and cookies in Chrome
 * Copyright (c) 2010 Dave Schindler
 *
 * jQuery Timers licenced with the WTFPL
 * &lt;http://jquery.offput.ca/timers/&gt;
 *
 * Cross-Browser Split 1.1.1
 * Copyright 2007-2012 Steven Levithan &lt;stevenlevithan.com&gt;
 * Available under the MIT License
 *
 * jQuery Caret
 * Copyright (c) 2009, Gideon Sireling
 * 3 clause BSD License
 *
 * sprintf.js
 * Copyright (c) 2007-2013 Alexandru Marasteanu &lt;hello at alexei dot ro&gt;
 * licensed under 3 clause BSD license
 *
 * debounce function from Lodash
 * Copyright JS Foundation and other contributors &lt;https://js.foundation/&gt;</a>
 * The MIT License
 *
 * emoji regex v7.0.1 by Mathias Bynens
 * MIT license
 *
 * Date: {{DATE}}
 */</span>
<span class="comment">/* global location, setTimeout, window, global, sprintf, setImmediate,
          IntersectionObserver,  ResizeObserver, module, require, define,
          setInterval, clearInterval, clearTimeout, Blob */</span>
<span class="comment">/* eslint-disable */</span>
<span class="comment">/* istanbul ignore next */</span>
(<span class="keyword">function</span>(<span class="js2-function-param">ctx</span>) {
    <span class="keyword">var</span> <span class="function-name">sprintf</span> = <span class="keyword">function</span>() {
        <span class="keyword">if</span> (<span class="negation-char">!</span>sprintf.<span class="js2-object-property">cache</span>.<span class="js2-function-call">hasOwnProperty</span>(arguments[0])) {
            sprintf.<span class="js2-object-property">cache</span>[arguments[0]] = sprintf.<span class="js2-function-call">parse</span>(arguments[0]);
        }
        <span class="keyword">return</span> sprintf.<span class="js2-object-property">format</span>.<span class="js2-function-call">call</span>(<span class="constant">null</span>, sprintf.<span class="js2-object-property">cache</span>[arguments[0]], <span class="constant">arguments</span>);
    };
    sprintf.<span class="function-name">format</span> = <span class="keyword">function</span>(<span class="js2-function-param">parse_tree</span>, <span class="js2-function-param">argv</span>) {
        <span class="keyword">var</span> <span class="variable-name">cursor</span> = 1, <span class="variable-name">tree_length</span> = parse_tree.<span class="js2-object-property">length</span>, <span class="variable-name">node_type</span> = <span class="string">''</span>, <span class="variable-name">arg</span>, <span class="variable-name">output</span> = [], <span class="variable-name">i</span>, <span class="variable-name">k</span>, <span class="variable-name">match</span>, <span class="variable-name">pad</span>, <span class="variable-name">pad_character</span>, <span class="variable-name">pad_length</span>;
        <span class="keyword">for</span> (i = 0; i &lt; tree_length; i++) {
            node_type = <span class="js2-function-call">get_type</span>(parse_tree[i]);
            <span class="keyword">if</span> (node_type === <span class="string">'string'</span>) {
                output.<span class="js2-function-call">push</span>(parse_tree[i]);
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (node_type === <span class="string">'array'</span>) {
                match = parse_tree[i]; <span class="comment">// convenience purposes only
</span>                <span class="keyword">if</span> (match[2]) { <span class="comment">// keyword argument
</span>                    arg = argv[cursor];
                    <span class="keyword">for</span> (k = 0; k &lt; match[2].<span class="js2-object-property">length</span>; k++) {
                        <span class="keyword">if</span> (<span class="negation-char">!</span>arg.<span class="js2-function-call">hasOwnProperty</span>(match[2][k])) {
                            <span class="keyword">throw</span>(<span class="js2-function-call">sprintf</span>(<span class="string">'[sprintf] property "%s" does not exist'</span>, match[2][k]));
                        }
                        arg = arg[match[2][k]];
                    }
                }
                <span class="keyword">else</span> <span class="keyword">if</span> (match[1]) { <span class="comment">// positional argument (explicit)
</span>                    arg = argv[match[1]];
                }
                <span class="keyword">else</span> { <span class="comment">// positional argument (implicit)
</span>                    arg = argv[cursor++];
                }

                <span class="keyword">if</span> (<span class="string">/[^s]/</span>.<span class="js2-function-call">test</span>(match[8]) &amp;&amp; (<span class="js2-function-call">get_type</span>(arg) !== <span class="string">'number'</span>)) {
                    <span class="keyword">throw</span>(<span class="js2-function-call">sprintf</span>(<span class="string">'[sprintf] expecting number but found %s'</span>, <span class="js2-function-call">get_type</span>(arg)));
                }
                <span class="keyword">switch</span> (match[8]) {
                    <span class="keyword">case</span> <span class="string">'b'</span>: arg = arg.<span class="js2-function-call">toString</span>(2); <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'c'</span>: arg = String.<span class="js2-function-call">fromCharCode</span>(arg); <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'d'</span>: arg = <span class="builtin">parseInt</span>(arg, 10); <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'e'</span>: arg = match[7] ? arg.<span class="js2-function-call">toExponential</span>(match[7]) : arg.<span class="js2-function-call">toExponential</span>(); <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'f'</span>: arg = match[7] ? <span class="builtin">parseFloat</span>(arg).<span class="js2-function-call">toFixed</span>(match[7]) : <span class="builtin">parseFloat</span>(arg); <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'o'</span>: arg = arg.<span class="js2-function-call">toString</span>(8); <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'s'</span>: arg = ((arg = <span class="js2-function-call">String</span>(arg)) &amp;&amp; match[7] ? arg.<span class="js2-function-call">slice</span>(0, match[7]) : arg); <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'u'</span>: arg = arg &gt;&gt;&gt; 0; <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'x'</span>: arg = arg.<span class="js2-function-call">toString</span>(16); <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'X'</span>: arg = arg.<span class="js2-function-call">toString</span>(16).<span class="js2-function-call">toUpperCase</span>(); <span class="keyword">break</span>;
                }
                arg = (<span class="string">/[def]/</span>.<span class="js2-function-call">test</span>(match[8]) &amp;&amp; match[3] &amp;&amp; arg &gt;= 0 ? <span class="string">' +'</span> + arg : arg);
                pad_character = match[4] ? match[4] === <span class="string">'0'</span> ? <span class="string">'0'</span> : match[4].<span class="js2-function-call">charAt</span>(1) : <span class="string">' '</span>;
                pad_length = match[6] - <span class="js2-function-call">String</span>(arg).<span class="js2-object-property">length</span>;
                pad = match[6] ? <span class="js2-function-call">str_repeat</span>(pad_character, pad_length) : <span class="string">''</span>;
                output.<span class="js2-function-call">push</span>(match[5] ? arg + pad : pad + arg);
            }
        }
        <span class="keyword">return</span> output.<span class="js2-function-call">join</span>(<span class="string">''</span>);
    };

    sprintf.<span class="js2-object-property">cache</span> = {};

    sprintf.<span class="function-name">parse</span> = <span class="keyword">function</span>(<span class="js2-function-param">fmt</span>) {
        <span class="keyword">var</span> <span class="variable-name">_fmt</span> = fmt, <span class="variable-name">match</span> = [], <span class="variable-name">parse_tree</span> = [], <span class="variable-name">arg_names</span> = 0;
        <span class="keyword">while</span> (_fmt) {
            <span class="keyword">if</span> ((match = <span class="string">/^[^\x25]+/</span>.<span class="js2-function-call">exec</span>(_fmt)) !== <span class="constant">null</span>) {
                parse_tree.<span class="js2-function-call">push</span>(match[0]);
            }
            <span class="keyword">else</span> <span class="keyword">if</span> ((match = <span class="string">/^\x25{2}/</span>.<span class="js2-function-call">exec</span>(_fmt)) !== <span class="constant">null</span>) {
                parse_tree.<span class="js2-function-call">push</span>(<span class="string">'%'</span>);
            }
            <span class="keyword">else</span> <span class="keyword">if</span> ((match = <span class="string">/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/</span>.<span class="js2-function-call">exec</span>(_fmt)) !== <span class="constant">null</span>) {
                <span class="keyword">if</span> (match[2]) {
                    arg_names |= 1;
                    <span class="keyword">var</span> <span class="variable-name">field_list</span> = [], <span class="variable-name">replacement_field</span> = match[2], <span class="variable-name">field_match</span> = [];
                    <span class="keyword">if</span> ((field_match = <span class="string">/^([a-z_][a-z_\d]*)/i</span>.<span class="js2-function-call">exec</span>(replacement_field)) !== <span class="constant">null</span>) {
                        field_list.<span class="js2-function-call">push</span>(field_match[1]);
                        <span class="keyword">while</span> ((replacement_field = replacement_field.<span class="js2-function-call">slice</span>(field_match[0].<span class="js2-object-property">length</span>)) !== <span class="string">''</span>) {
                            <span class="keyword">if</span> ((field_match = <span class="string">/^\.([a-z_][a-z_\d]*)/i</span>.<span class="js2-function-call">exec</span>(replacement_field)) !== <span class="constant">null</span>) {
                                field_list.<span class="js2-function-call">push</span>(field_match[1]);
                            }
                            <span class="keyword">else</span> <span class="keyword">if</span> ((field_match = <span class="string">/^\[(\d+)\]/</span>.<span class="js2-function-call">exec</span>(replacement_field)) !== <span class="constant">null</span>) {
                                field_list.<span class="js2-function-call">push</span>(field_match[1]);
                            }
                            <span class="keyword">else</span> {
                                <span class="keyword">throw</span>(<span class="string">'[sprintf] huh?'</span>);
                            }
                        }
                    }
                    <span class="keyword">else</span> {
                        <span class="keyword">throw</span>(<span class="string">'[sprintf] huh?'</span>);
                    }
                    match[2] = field_list;
                }
                <span class="keyword">else</span> {
                    arg_names |= 2;
                }
                <span class="keyword">if</span> (arg_names === 3) {
                    <span class="keyword">throw</span>(<span class="string">'[sprintf] mixing positional and named placeholders is not (yet) supported'</span>);
                }
                parse_tree.<span class="js2-function-call">push</span>(match);
            }
            <span class="keyword">else</span> {
                <span class="keyword">throw</span>(<span class="string">'[sprintf] huh?'</span>);
            }
            _fmt = _fmt.<span class="js2-function-call">slice</span>(match[0].<span class="js2-object-property">length</span>);
        }
        <span class="keyword">return</span> parse_tree;
    };

    <span class="keyword">var</span> <span class="function-name">vsprintf</span> = <span class="keyword">function</span>(<span class="js2-function-param">fmt</span>, <span class="js2-function-param">argv</span>, <span class="js2-function-param">_argv</span>) {
        _argv = argv.<span class="js2-function-call">slice</span>(0);
        _argv.<span class="js2-function-call">splice</span>(0, 0, fmt);
        <span class="keyword">return</span> sprintf.<span class="js2-function-call">apply</span>(<span class="constant">null</span>, _argv);
    };

    <span class="doc">/**
     * helpers
     */</span>
    <span class="keyword">function</span> <span class="function-name">get_type</span>(<span class="js2-function-param">variable</span>) {
        <span class="keyword">return</span> Object.<span class="js2-object-property">prototype</span>.<span class="js2-object-property">toString</span>.<span class="js2-function-call">call</span>(variable).<span class="js2-function-call">slice</span>(8, -1).<span class="js2-function-call">toLowerCase</span>();
    }

    <span class="keyword">function</span> <span class="function-name">str_repeat</span>(<span class="js2-function-param">input</span>, <span class="js2-function-param">multiplier</span>) {
        <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable-name">output</span> = []; multiplier &gt; 0; output[--multiplier] = input) {<span class="comment">/* do nothing */</span>}
        <span class="keyword">return</span> output.<span class="js2-function-call">join</span>(<span class="string">''</span>);
    }

    <span class="doc">/**
     * export to either browser or node.js
     */</span>
    ctx.<span class="js2-object-property">sprintf</span> = sprintf;
    ctx.<span class="js2-object-property">vsprintf</span> = vsprintf;
})(<span class="keyword">typeof</span> global !== <span class="string">"undefined"</span> ? global : window);
<span class="comment">// -----------------------------------------------------------------------
/* eslint-enable */</span>
<span class="comment">// UMD taken from https://github.com/umdjs/umd
</span><span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">fu</span></span><span class="keyword">nction</span>(<span class="js2-function-param">factory</span>, <span class="js2-function-param">undefined</span>) {
    <span class="keyword">var</span> <span class="variable-name">root</span> = <span class="keyword"><span class="jcXcovered">typeof</span></span><span class="jcXcovered"> window !== </span><span class="string"><span class="jcXcovered">'undefined'</span></span><span class="jcXcovered"> ? window : global</span>;
    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.<span class="js2-object-property">amd</span>) {
        <span class="comment">// AMD. Register as an anonymous module.
</span>        <span class="comment">// istanbul ignore next
</span>        <span class="js2-function-call">define</span>([<span class="string">'jquery'</span>, <span class="string">'wcwidth'</span>], factory);
    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> module === <span class="string">'object'</span> &amp;&amp; module.<span class="js2-object-property">exports</span>) {
        <span class="comment">// Node/CommonJS
</span>        <span class="jcXcovered">mo</span>dule.<span class="function-name">exports</span> = <span class="keyword">function</span>(<span class="js2-function-param">root</span>, <span class="js2-function-param">jQuery</span>, <span class="js2-function-param">wcwidth</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (jQuery === <span class="constant">undefined</span>) {
                <span class="comment">// require('jQuery') returns a factory that requires window to
</span>                <span class="comment">// build a jQuery instance, we normalize how we use modules
</span>                <span class="comment">// that require this pattern but the window provided is a noop
</span>                <span class="comment">// if it's defined (how jquery works)
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (window !== <span class="constant">undefined</span>) {
                    <span class="jcXcovered">jQuery = </span><span class="js2-function-call"><span class="jcXcovered">require</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'jquery'</span></span><span class="jcXcovered">);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">jQuery = </span><span class="js2-function-call"><span class="jcXnot-covered">require</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'jquery'</span></span><span class="jcXnot-covered">)(root);</span>
                }
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (wcwidth === <span class="constant">undefined</span>) {
                <span class="jcXcovered">wcwidth = </span><span class="js2-function-call"><span class="jcXcovered">require</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'wcwidth'</span></span><span class="jcXcovered">);</span>
            }
            <span class="js2-function-call"><span class="jcXcovered">factory</span></span><span class="jcXcovered">(jQuery, wcwidth);</span>
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> jQuery;</span>
        };
    } <span class="keyword">else</span> {
        <span class="comment">// Browser
</span>        <span class="comment">// istanbul ignore next
</span>        <span class="js2-function-call">factory</span>(root.<span class="js2-object-property">jQuery</span>, root.<span class="js2-object-property">wcwidth</span>);
    }
})(<span class="keyword">function</span>(<span class="js2-function-param">$</span>, <span class="js2-function-param">wcwidth</span>, <span class="js2-function-param">undefined</span>) {
    <span class="string">'use strict'</span>;
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: debug functions
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">/* eslint-disable */</span>
    <span class="comment">/* istanbul ignore next */</span>
    <span class="keyword">function</span> <span class="function-name">debug</span>(<span class="js2-function-param">str</span>) {
        <span class="keyword">if</span> (<span class="constant">false</span>) {
            console.<span class="js2-function-call">log</span>(str);
            <span class="comment">//$.terminal.active().echo(str);
</span>        }
    }
    <span class="comment">/* eslint-enable */</span>
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Replacemenet for jQuery 2 deferred objects
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">DelayQueue</span>() {
        <span class="keyword">var</span> <span class="variable-name">callbacks</span> = <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">Callbacks</span></span><span class="jcXcovered">()</span>;
        <span class="keyword">var</span> <span class="variable-name">resolved</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>.<span class="function-name">resolve</span> = <span class="keyword">function</span>() {
            <span class="jcXcovered">callbacks.</span><span class="js2-function-call"><span class="jcXcovered">fire</span></span><span class="jcXcovered">();</span>
            <span class="jcXcovered">resolved = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
        };
        <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>.<span class="function-name">add</span> = <span class="keyword">function</span>(<span class="js2-function-param">fn</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (resolved) {
                <span class="js2-function-call"><span class="jcXcovered">fn</span></span><span class="jcXcovered">();</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">callbacks.</span><span class="js2-function-call"><span class="jcXcovered">add</span></span><span class="jcXcovered">(fn);</span>
            }
        };
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: map object to object
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="jcXcovered">$.</span><span class="function-name">omap</span> = <span class="keyword">function</span>(<span class="js2-function-param">o</span>, <span class="js2-function-param">fn</span>) {
        <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">{}</span>;
        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">ach</span>(o, <span class="keyword">function</span>(<span class="js2-function-param">k</span>, <span class="js2-function-param">v</span>) {
            <span class="jcXcovered">result[k] = fn.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(o, k, v);</span>
        });
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
    };
    <span class="jcXcovered">$.</span><span class="js2-object-property">fn</span>.<span class="function-name">text_length</span> = <span class="keyword">function</span>() {
        <span class="keyword"><span class="jcXcovered">return</span></span> <span class="builtin">this</span>.<span class="js2-function-call">map</span>(<span class="keyword">function</span>() {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
        }).<span class="js2-function-call">get</span>().<span class="js2-function-call">reduce</span>(<span class="keyword">function</span>(<span class="js2-function-param">a</span>, <span class="js2-function-param">b</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> a + b;</span>
        }, 0);
    };
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Deep clone of objects and arrays
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">Clone</span></span><span class="jcXcovered"> = </span>{
        <span class="function-name">clone_object</span>: <span class="keyword">function</span>(<span class="js2-function-param">object</span>) {
            <span class="keyword">var</span> <span class="variable-name">tmp</span> = <span class="jcXcovered">{}</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> object === <span class="string">'object'</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">isArray</span>(object)) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">clone_array</span></span><span class="jcXcovered">(object);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (object === <span class="constant">null</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> object;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">key</span> <span class="keyword">in</span> object) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">isArray</span>(object[key])) {
                            <span class="jcXcovered">tmp[key] = </span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">clone_array</span></span><span class="jcXcovered">(object[key]);</span>
                        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> object[key] === <span class="string">'object'</span>) {
                            <span class="jcXnot-covered">tmp[key] = </span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">clone_object</span></span><span class="jcXnot-covered">(object[key]);</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">tmp[key] = object[key];</span>
                        }
                    }
                }
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> tmp;</span>
        },
        <span class="function-name">clone_array</span>: <span class="keyword">function</span>(<span class="js2-function-param">array</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span><span class="js2-function-call">is_function</span>(Array.<span class="js2-object-property">prototype</span>.<span class="js2-object-property">map</span>)) {
                <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">"Your browser do</span></span><span class="string">n't support ES5 array map "</span> +
                                <span class="string">'use es5-shim'</span>);
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> array.</span><span class="js2-function-call"><span class="jcXcovered">s</span></span><span class="js2-function-call">lice</span>(0).<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">item</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> item === <span class="string">'object'</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">clone_object</span></span><span class="jcXcovered">(item);</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> item;</span>
                }
            }.<span class="js2-function-call">bind</span>(<span class="builtin">this</span>));
        }
    };
    <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="function-name"><span class="jcXcovered">clone</span></span><span class="jcXcovered"> = </span><span class="keyword">function</span>(<span class="js2-function-param">object</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> Clone.</span><span class="js2-function-call"><span class="jcXcovered">clone_object</span></span><span class="jcXcovered">(object);</span>
    };

    <span class="comment">/* eslint-disable */</span>
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Storage plugin
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">localStorage</span>;
    <span class="comment">/* istanbul ignore next */</span>
    (<span class="keyword">function</span>() {
        <span class="keyword">var</span> <span class="function-name">hasLS</span> = <span class="keyword">function</span>() {
            <span class="keyword">try</span> {
                <span class="keyword">var</span> <span class="variable-name">testKey</span> = <span class="string">'test'</span>, <span class="variable-name">storage</span> = window.<span class="js2-object-property">localStorage</span>;
                storage.<span class="js2-function-call">setItem</span>(testKey, <span class="string">'1'</span>);
                storage.<span class="js2-function-call">removeItem</span>(testKey);
                <span class="keyword">return</span> <span class="constant">true</span>;
            } <span class="keyword">catch</span> (error) {
                <span class="keyword">return</span> <span class="constant">false</span>;
            }
        };
        <span class="keyword">var</span> <span class="function-name">hasCookies</span> = <span class="keyword">function</span>() {
            <span class="keyword">try</span> {
                document.<span class="js2-object-property">cookie</span>.<span class="js2-function-call">split</span>(<span class="string">';'</span>);
                <span class="keyword">return</span> <span class="constant">true</span>;
            } <span class="keyword">catch</span> (e) {
                <span class="keyword">return</span> <span class="constant">false</span>;
            }
        };
        <span class="comment">// Private data
</span>        <span class="keyword">var</span> <span class="variable-name">isLS</span> = <span class="js2-function-call">hasLS</span>();
        <span class="comment">// Private functions
</span>        <span class="keyword">function</span> <span class="function-name">wls</span>(<span class="js2-function-param">n</span>, <span class="js2-function-param">v</span>) {
            <span class="keyword">var</span> <span class="variable-name">c</span>;
            <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">'string'</span> &amp;&amp; <span class="keyword">typeof</span> v === <span class="string">'string'</span>) {
                localStorage[n] = v;
                <span class="keyword">return</span> <span class="constant">true</span>;
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> v === <span class="string">'undefined'</span>) {
                <span class="keyword">for</span> (c <span class="keyword">in</span> n) {
                    <span class="keyword">if</span> (n.<span class="js2-function-call">hasOwnProperty</span>(c)) {
                        localStorage[c] = n[c];
                    }
                }
                <span class="keyword">return</span> <span class="constant">true</span>;
            }
            <span class="keyword">return</span> <span class="constant">false</span>;
        }
        <span class="keyword">function</span> <span class="function-name">wc</span>(<span class="js2-function-param">n</span>, <span class="js2-function-param">v</span>) {
            <span class="keyword">var</span> <span class="variable-name">dt</span>, <span class="variable-name">e</span>, <span class="variable-name">c</span>;
            dt = <span class="keyword">new</span> <span class="js2-function-call">Date</span>();
            dt.<span class="js2-function-call">setTime</span>(dt.<span class="js2-function-call">getTime</span>() + 31536000000);
            e = <span class="string">'; expires='</span> + dt.<span class="js2-function-call">toGMTString</span>();
            <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">'string'</span> &amp;&amp; <span class="keyword">typeof</span> v === <span class="string">'string'</span>) {
                document.<span class="js2-object-property">cookie</span> = n + <span class="string">'='</span> + v + e + <span class="string">'; path=/'</span>;
                <span class="keyword">return</span> <span class="constant">true</span>;
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> v === <span class="string">'undefined'</span>) {
                <span class="keyword">for</span> (c <span class="keyword">in</span> n) {
                    <span class="keyword">if</span> (n.<span class="js2-function-call">hasOwnProperty</span>(c)) {
                        document.<span class="js2-object-property">cookie</span> = c + <span class="string">'='</span> + n[c] + e + <span class="string">'; path=/'</span>;
                    }
                }
                <span class="keyword">return</span> <span class="constant">true</span>;
            }
            <span class="keyword">return</span> <span class="constant">false</span>;
        }
        <span class="keyword">function</span> <span class="function-name">rls</span>(<span class="js2-function-param">n</span>) {
            <span class="keyword">return</span> localStorage[n];
        }
        <span class="keyword">function</span> <span class="function-name">rc</span>(<span class="js2-function-param">n</span>) {
            <span class="keyword">var</span> <span class="variable-name">nn</span>, <span class="variable-name">ca</span>, <span class="variable-name">i</span>, <span class="variable-name">c</span>;
            nn = n + <span class="string">'='</span>;
            ca = document.<span class="js2-object-property">cookie</span>.<span class="js2-function-call">split</span>(<span class="string">';'</span>);
            <span class="keyword">for</span> (i = 0; i &lt; ca.<span class="js2-object-property">length</span>; i++) {
                c = ca[i];
                <span class="keyword">while</span> (c.<span class="js2-function-call">charAt</span>(0) === <span class="string">' '</span>) {
                    c = c.<span class="js2-function-call">slice</span>(1, c.<span class="js2-object-property">length</span>);
                }
                <span class="keyword">if</span> (c.<span class="js2-function-call">indexOf</span>(nn) === 0) {
                    <span class="keyword">return</span> c.<span class="js2-function-call">slice</span>(nn.<span class="js2-object-property">length</span>, c.<span class="js2-object-property">length</span>);
                }
            }
            <span class="keyword">return</span> <span class="constant">null</span>;
        }
        <span class="keyword">function</span> <span class="function-name">dls</span>(<span class="js2-function-param">n</span>) {
            <span class="keyword">return</span> <span class="keyword">delete</span> localStorage[n];
        }
        <span class="keyword">function</span> <span class="function-name">dc</span>(<span class="js2-function-param">n</span>) {
            <span class="keyword">return</span> <span class="js2-function-call">wc</span>(n, <span class="string">''</span>, -1);
        }
        <span class="doc">/**
         * Public API
         * $.Storage.set("name", "value")
         * $.Storage.set({"name1":"value1", "name2":"value2", etc})
         * $.Storage.get("name")
         * $.Storage.remove("name")
         */</span>
        <span class="keyword">if</span> (<span class="negation-char">!</span><span class="js2-function-call">hasCookies</span>() &amp;&amp; <span class="negation-char">!</span>isLS) {
            localStorage = {};
            $.<span class="js2-function-call">extend</span>({
                <span class="js2-object-property">Storage</span>: {
                    <span class="js2-object-property">set</span>: wls,
                    <span class="js2-object-property">get</span>: rls,
                    <span class="js2-object-property">remove</span>: dls
                }
            });
        } <span class="keyword">else</span> {
            <span class="keyword">if</span> (isLS) {
                localStorage = window.<span class="js2-object-property">localStorage</span>;
            }
            $.<span class="js2-function-call">extend</span>({
                <span class="js2-object-property">Storage</span>: {
                    <span class="js2-object-property">set</span>: isLS ? wls : wc,
                    <span class="js2-object-property">get</span>: isLS ? rls : rc,
                    <span class="js2-object-property">remove</span>: isLS ? dls : dc
                }
            });
        }
    })();
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Debounce from Lodash
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">/* istanbul ignore next */</span>
    <span class="keyword">var</span> <span class="variable-name">debounce</span> = (<span class="keyword">function</span>() {
        <span class="keyword">var</span> <span class="variable-name">FUNC_ERROR_TEXT</span> = <span class="string">'Expected a function'</span>;
        <span class="keyword">function</span> <span class="function-name">isObject</span>(<span class="js2-function-param">value</span>) {
            <span class="keyword">var</span> <span class="variable-name">type</span> = <span class="keyword">typeof</span> value;
            <span class="keyword">return</span> value != <span class="constant">null</span> &amp;&amp; (type == <span class="string">'object'</span> || type == <span class="string">'function'</span>);
        }
        <span class="keyword">function</span> <span class="function-name">now</span>() {
            <span class="keyword">return</span> Date.<span class="js2-function-call">now</span>();
        }
        <span class="keyword">return</span> <span class="keyword">function</span> <span class="function-name">debounce</span>(<span class="js2-function-param">func</span>, <span class="js2-function-param">wait</span>, <span class="js2-function-param">options</span>) {
            <span class="keyword">var</span> <span class="variable-name">nativeMax</span> = Math.<span class="js2-object-property">max</span>,
                <span class="variable-name">nativeMin</span> = Math.<span class="js2-object-property">min</span>;

            <span class="keyword">var</span> <span class="variable-name">lastArgs</span>,
                <span class="variable-name">lastThis</span>,
                <span class="variable-name">maxWait</span>,
                <span class="variable-name">result</span>,
                <span class="variable-name">timerId</span>,
                <span class="variable-name">lastCallTime</span>,
                <span class="variable-name">lastInvokeTime</span> = 0,
                <span class="variable-name">leading</span> = <span class="constant">false</span>,
                <span class="variable-name">maxing</span> = <span class="constant">false</span>,
                <span class="variable-name">trailing</span> = <span class="constant">true</span>;

            <span class="keyword">if</span> (<span class="keyword">typeof</span> func != <span class="string">'function'</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="js2-function-call">TypeError</span>(FUNC_ERROR_TEXT);
            }
            wait = wait || 0;
            <span class="keyword">if</span> (<span class="js2-function-call">isObject</span>(options)) {
                leading = <span class="negation-char">!!</span>options.<span class="js2-object-property">leading</span>;
                maxing = <span class="string">'maxWait'</span> <span class="keyword">in</span> options;
                maxWait = maxing ? <span class="js2-function-call">nativeMax</span>(options.<span class="js2-object-property">maxWait</span> || 0, wait) : maxWait;
                trailing = <span class="string">'trailing'</span> <span class="keyword">in</span> options ? <span class="negation-char">!!</span>options.<span class="js2-object-property">trailing</span> : trailing;
            }

            <span class="keyword">function</span> <span class="function-name">invokeFunc</span>(<span class="js2-function-param">time</span>) {
                <span class="keyword">var</span> <span class="variable-name">args</span> = lastArgs,
                    <span class="variable-name">thisArg</span> = lastThis;

                lastArgs = lastThis = <span class="constant">undefined</span>;
                lastInvokeTime = time;
                result = func.<span class="js2-function-call">apply</span>(thisArg, args);
                <span class="keyword">return</span> result;
            }

            <span class="keyword">function</span> <span class="function-name">leadingEdge</span>(<span class="js2-function-param">time</span>) {
                <span class="comment">// Reset any `maxWait` timer.
</span>                lastInvokeTime = time;
                <span class="comment">// Start the timer for the trailing edge.
</span>                timerId = <span class="js2-function-call">setTimeout</span>(timerExpired, wait);
                <span class="comment">// Invoke the leading edge.
</span>                <span class="keyword">return</span> leading ? <span class="js2-function-call">invokeFunc</span>(time) : result;
            }

            <span class="keyword">function</span> <span class="function-name">remainingWait</span>(<span class="js2-function-param">time</span>) {
                <span class="keyword">var</span> <span class="variable-name">timeSinceLastCall</span> = time - lastCallTime,
                    <span class="variable-name">timeSinceLastInvoke</span> = time - lastInvokeTime,
                    <span class="variable-name">timeWaiting</span> = wait - timeSinceLastCall;

                <span class="keyword">return</span> maxing
                    ? <span class="js2-function-call">nativeMin</span>(timeWaiting, maxWait - timeSinceLastInvoke)
                    : timeWaiting;
            }

            <span class="keyword">function</span> <span class="function-name">shouldInvoke</span>(<span class="js2-function-param">time</span>) {
                <span class="keyword">var</span> <span class="variable-name">timeSinceLastCall</span> = time - lastCallTime,
                    <span class="variable-name">timeSinceLastInvoke</span> = time - lastInvokeTime;

                <span class="comment">// Either this is the first call, activity has stopped and we're at the
</span>                <span class="comment">// trailing edge, the system time has gone backwards and we're treating
</span>                <span class="comment">// it as the trailing edge, or we've hit the `maxWait` limit.
</span>                <span class="keyword">return</span> (lastCallTime === <span class="constant">undefined</span> || (timeSinceLastCall &gt;= wait) ||
                        (timeSinceLastCall &lt; 0) || (maxing &amp;&amp; timeSinceLastInvoke &gt;= maxWait));
            }

            <span class="keyword">function</span> <span class="function-name">timerExpired</span>() {
                <span class="keyword">var</span> <span class="variable-name">time</span> = <span class="js2-function-call">now</span>();
                <span class="keyword">if</span> (<span class="js2-function-call">shouldInvoke</span>(time)) {
                    <span class="keyword">return</span> <span class="js2-function-call">trailingEdge</span>(time);
                }
                <span class="comment">// Restart the timer.
</span>                timerId = <span class="js2-function-call">setTimeout</span>(timerExpired, <span class="js2-function-call">remainingWait</span>(time));
            }

            <span class="keyword">function</span> <span class="function-name">trailingEdge</span>(<span class="js2-function-param">time</span>) {
                timerId = <span class="constant">undefined</span>;

                <span class="comment">// Only invoke if we have `lastArgs` which means `func` has been
</span>                <span class="comment">// debounced at least once.
</span>                <span class="keyword">if</span> (trailing &amp;&amp; lastArgs) {
                    <span class="keyword">return</span> <span class="js2-function-call">invokeFunc</span>(time);
                }
                lastArgs = lastThis = <span class="constant">undefined</span>;
                <span class="keyword">return</span> result;
            }

            <span class="keyword">function</span> <span class="function-name">cancel</span>() {
                <span class="keyword">if</span> (timerId !== <span class="constant">undefined</span>) {
                    <span class="js2-function-call">clearTimeout</span>(timerId);
                }
                lastInvokeTime = 0;
                lastArgs = lastCallTime = lastThis = timerId = <span class="constant">undefined</span>;
            }

            <span class="keyword">function</span> <span class="function-name">flush</span>() {
                <span class="keyword">return</span> timerId === <span class="constant">undefined</span> ? result : <span class="js2-function-call">trailingEdge</span>(<span class="js2-function-call">now</span>());
            }

            <span class="keyword">function</span> <span class="function-name">debounced</span>() {
                <span class="keyword">var</span> <span class="variable-name">time</span> = <span class="js2-function-call">now</span>(),
                    <span class="variable-name">isInvoking</span> = <span class="js2-function-call">shouldInvoke</span>(time);

                lastArgs = <span class="constant">arguments</span>;
                lastThis = <span class="builtin">this</span>;
                lastCallTime = time;

                <span class="keyword">if</span> (isInvoking) {
                    <span class="keyword">if</span> (timerId === <span class="constant">undefined</span>) {
                        <span class="keyword">return</span> <span class="js2-function-call">leadingEdge</span>(lastCallTime);
                    }
                    <span class="keyword">if</span> (maxing) {
                        <span class="comment">// Handle invocations in a tight loop.
</span>                        timerId = <span class="js2-function-call">setTimeout</span>(timerExpired, wait);
                        <span class="keyword">return</span> <span class="js2-function-call">invokeFunc</span>(lastCallTime);
                    }
                }
                <span class="keyword">if</span> (timerId === <span class="constant">undefined</span>) {
                    timerId = <span class="js2-function-call">setTimeout</span>(timerExpired, wait);
                }
                <span class="keyword">return</span> result;
            }
            debounced.<span class="js2-object-property">cancel</span> = cancel;
            debounced.<span class="js2-object-property">flush</span> = flush;
            <span class="keyword">return</span> debounced;
        };
    })();
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: jQuery Timers
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">jQuery</span> = <span class="jcXcovered">$</span>;
    <span class="comment">/* istanbul ignore next */</span>
    (<span class="keyword">function</span>(<span class="js2-function-param">$</span>) {
        jQuery.<span class="js2-object-property">fn</span>.<span class="js2-function-call">extend</span>({
            <span class="function-name">everyTime</span>: <span class="keyword">function</span>(<span class="js2-function-param">interval</span>, <span class="js2-function-param">label</span>, <span class="js2-function-param">fn</span>, <span class="js2-function-param">times</span>, <span class="js2-function-param">belay</span>) {
                <span class="keyword">return</span> <span class="builtin">this</span>.<span class="js2-function-call">each</span>(<span class="keyword">function</span>() {
                    jQuery.<span class="js2-object-property">timer</span>.<span class="js2-function-call">add</span>(<span class="builtin">this</span>, interval, label, fn, times, belay);
                });
            },
            <span class="function-name">oneTime</span>: <span class="keyword">function</span>(<span class="js2-function-param">interval</span>, <span class="js2-function-param">label</span>, <span class="js2-function-param">fn</span>) {
                <span class="keyword">return</span> <span class="builtin">this</span>.<span class="js2-function-call">each</span>(<span class="keyword">function</span>() {
                    jQuery.<span class="js2-object-property">timer</span>.<span class="js2-function-call">add</span>(<span class="builtin">this</span>, interval, label, fn, 1);
                });
            },
            <span class="function-name">stopTime</span>: <span class="keyword">function</span>(<span class="js2-function-param">label</span>, <span class="js2-function-param">fn</span>) {
                <span class="keyword">return</span> <span class="builtin">this</span>.<span class="js2-function-call">each</span>(<span class="keyword">function</span>() {
                    jQuery.<span class="js2-object-property">timer</span>.<span class="js2-function-call">remove</span>(<span class="builtin">this</span>, label, fn);
                });
            }
        });

        jQuery.<span class="js2-function-call">extend</span>({
            <span class="js2-object-property">timer</span>: {
                <span class="js2-object-property">guid</span>: 1,
                <span class="js2-object-property">global</span>: {},
                <span class="js2-object-property">regex</span>: <span class="string">/^([0-9]+)\s*(.*s)?$/</span>,
                <span class="js2-object-property">powers</span>: {
                    <span class="comment">// Yeah this is major overkill...
</span>                    <span class="js2-object-property">'ms'</span>: 1,
                    <span class="js2-object-property">'cs'</span>: 10,
                    <span class="js2-object-property">'ds'</span>: 100,
                    <span class="js2-object-property">'s'</span>: 1000,
                    <span class="js2-object-property">'das'</span>: 10000,
                    <span class="js2-object-property">'hs'</span>: 100000,
                    <span class="js2-object-property">'ks'</span>: 1000000
                },
                <span class="function-name">timeParse</span>: <span class="keyword">function</span>(<span class="js2-function-param">value</span>) {
                    <span class="keyword">if</span> (value === <span class="constant">undefined</span> || value === <span class="constant">null</span>) {
                        <span class="keyword">return</span> <span class="constant">null</span>;
                    }
                    <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="builtin">this</span>.<span class="js2-object-property">regex</span>.<span class="js2-function-call">exec</span>(jQuery.<span class="js2-function-call">trim</span>(value.<span class="js2-function-call">toString</span>()));
                    <span class="keyword">if</span> (result[2]) {
                        <span class="keyword">var</span> <span class="variable-name">num</span> = <span class="builtin">parseInt</span>(result[1], 10);
                        <span class="keyword">var</span> <span class="variable-name">mult</span> = <span class="builtin">this</span>.<span class="js2-object-property">powers</span>[result[2]] || 1;
                        <span class="keyword">return</span> num * mult;
                    } <span class="keyword">else</span> {
                        <span class="keyword">return</span> value;
                    }
                },
                <span class="function-name">add</span>: <span class="keyword">function</span>(<span class="js2-function-param">element</span>, <span class="js2-function-param">interval</span>, <span class="js2-function-param">label</span>, <span class="js2-function-param">fn</span>, <span class="js2-function-param">times</span>, <span class="js2-function-param">belay</span>) {
                    <span class="keyword">var</span> <span class="variable-name">counter</span> = 0;

                    <span class="keyword">if</span> (jQuery.<span class="js2-function-call">isFunction</span>(label)) {
                        <span class="keyword">if</span> (<span class="negation-char">!</span>times) {
                            times = fn;
                        }
                        fn = label;
                        label = interval;
                    }

                    interval = jQuery.<span class="js2-object-property">timer</span>.<span class="js2-function-call">timeParse</span>(interval);

                    <span class="keyword">if</span> (<span class="keyword">typeof</span> interval !== <span class="string">'number'</span> ||
                        <span class="builtin">isNaN</span>(interval) ||
                        interval &lt;= 0) {
                        <span class="keyword">return</span>;
                    }
                    <span class="keyword">if</span> (times &amp;&amp; times.<span class="js2-object-property">constructor</span> !== Number) {
                        belay = <span class="negation-char">!!</span>times;
                        times = 0;
                    }

                    times = times || 0;
                    belay = belay || <span class="constant">false</span>;

                    <span class="keyword">if</span> (<span class="negation-char">!</span>element.<span class="js2-object-property">$timers</span>) {
                        element.<span class="js2-object-property">$timers</span> = {};
                    }
                    <span class="keyword">if</span> (<span class="negation-char">!</span>element.<span class="js2-object-property">$timers</span>[label]) {
                        element.<span class="js2-object-property">$timers</span>[label] = {};
                    }
                    fn.<span class="js2-object-property">$timerID</span> = fn.<span class="js2-object-property">$timerID</span> || <span class="builtin">this</span>.<span class="js2-object-property">guid</span>++;

                    <span class="keyword">var</span> <span class="function-name">handler</span> = <span class="keyword">function</span>() {
                        <span class="keyword">if</span> (belay &amp;&amp; handler.<span class="js2-object-property">inProgress</span>) {
                            <span class="keyword">return</span>;
                        }
                        handler.<span class="js2-object-property">inProgress</span> = <span class="constant">true</span>;
                        <span class="keyword">if</span> ((++counter &gt; times &amp;&amp; times !== 0) ||
                            fn.<span class="js2-function-call">call</span>(element, counter) === <span class="constant">false</span>) {
                            jQuery.<span class="js2-object-property">timer</span>.<span class="js2-function-call">remove</span>(element, label, fn);
                        }
                        handler.<span class="js2-object-property">inProgress</span> = <span class="constant">false</span>;
                    };

                    handler.<span class="js2-object-property">$timerID</span> = fn.<span class="js2-object-property">$timerID</span>;

                    <span class="keyword">if</span> (<span class="negation-char">!</span>element.<span class="js2-object-property">$timers</span>[label][fn.<span class="js2-object-property">$timerID</span>]) {
                        element.<span class="js2-object-property">$timers</span>[label][fn.<span class="js2-object-property">$timerID</span>] = window.<span class="js2-function-call">setInterval</span>(handler, interval);
                    }

                    <span class="keyword">if</span> (<span class="negation-char">!</span><span class="builtin">this</span>.<span class="js2-object-property">global</span>[label]) {
                        <span class="builtin">this</span>.<span class="js2-object-property">global</span>[label] = [];
                    }
                    <span class="builtin">this</span>.<span class="js2-object-property">global</span>[label].<span class="js2-function-call">push</span>(element);

                },
                <span class="function-name">remove</span>: <span class="keyword">function</span>(<span class="js2-function-param">element</span>, <span class="js2-function-param">label</span>, <span class="js2-function-param">fn</span>) {
                    <span class="keyword">var</span> <span class="variable-name">timers</span> = element.<span class="js2-object-property">$timers</span>, <span class="variable-name">ret</span>;

                    <span class="keyword">if</span> (timers) {

                        <span class="keyword">if</span> (<span class="negation-char">!</span>label) {
                            <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable-name">lab</span> <span class="keyword">in</span> timers) {
                                <span class="keyword">if</span> (timers.<span class="js2-function-call">hasOwnProperty</span>(lab)) {
                                    <span class="builtin">this</span>.<span class="js2-function-call">remove</span>(element, lab, fn);
                                }
                            }
                        } <span class="keyword">else</span> <span class="keyword">if</span> (timers[label]) {
                            <span class="keyword">if</span> (fn) {
                                <span class="keyword">if</span> (fn.<span class="js2-object-property">$timerID</span>) {
                                    window.<span class="js2-function-call">clearInterval</span>(timers[label][fn.<span class="js2-object-property">$timerID</span>]);
                                    <span class="keyword">delete</span> timers[label][fn.<span class="js2-object-property">$timerID</span>];
                                }
                            } <span class="keyword">else</span> {
                                <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable-name">_fn</span> <span class="keyword">in</span> timers[label]) {
                                    <span class="keyword">if</span> (timers[label].<span class="js2-function-call">hasOwnProperty</span>(_fn)) {
                                        window.<span class="js2-function-call">clearInterval</span>(timers[label][_fn]);
                                        <span class="keyword">delete</span> timers[label][_fn];
                                    }
                                }
                            }

                            <span class="keyword">for</span> (ret <span class="keyword">in</span> timers[label]) {
                                <span class="keyword">if</span> (timers[label].<span class="js2-function-call">hasOwnProperty</span>(ret)) {
                                    <span class="keyword">break</span>;
                                }
                            }
                            <span class="keyword">if</span> (<span class="negation-char">!</span>ret) {
                                ret = <span class="constant">null</span>;
                                <span class="keyword">delete</span> timers[label];
                            }
                        }

                        <span class="keyword">for</span> (ret <span class="keyword">in</span> timers) {
                            <span class="keyword">if</span> (timers.<span class="js2-function-call">hasOwnProperty</span>(ret)) {
                                <span class="keyword">break</span>;
                            }
                        }
                        <span class="keyword">if</span> (<span class="negation-char">!</span>ret) {
                            element.<span class="js2-object-property">$timers</span> = <span class="constant">null</span>;
                        }
                    }
                }
            }
        });
        <span class="keyword">if</span> (<span class="string">/(msie) ([\w.]+)/</span>.<span class="js2-function-call">exec</span>(navigator.<span class="js2-object-property">userAgent</span>.<span class="js2-function-call">toLowerCase</span>())) {
            <span class="js2-function-call">$</span>(window).<span class="js2-function-call">one</span>(<span class="string">'unload'</span>, <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">global</span> = jQuery.<span class="js2-object-property">timer</span>.<span class="js2-object-property">global</span>;
                <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable-name">label</span> <span class="keyword">in</span> global) {
                    <span class="keyword">if</span> (global.<span class="js2-function-call">hasOwnProperty</span>(label)) {
                        <span class="keyword">var</span> <span class="variable-name">els</span> = global[label], <span class="variable-name">i</span> = els.<span class="js2-object-property">length</span>;
                        <span class="keyword">while</span> (--i) {
                            jQuery.<span class="js2-object-property">timer</span>.<span class="js2-function-call">remove</span>(els[i], label);
                        }
                    }
                }
            });
        }
    })(jQuery);
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: CROSS BROWSER SPLIT
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">/* istanbul ignore next */</span>
    (<span class="keyword">function</span>(<span class="js2-function-param">undef</span>) {

        <span class="comment">// prevent double include
</span>
        <span class="keyword">if</span> (<span class="negation-char">!</span>String.<span class="js2-object-property">prototype</span>.<span class="js2-object-property">split</span>.<span class="js2-function-call">toString</span>().<span class="js2-function-call">match</span>(<span class="string">/\[native/</span>)) {
            <span class="keyword">return</span>;
        }

        <span class="keyword">var</span> <span class="variable-name">nativeSplit</span> = String.<span class="js2-object-property">prototype</span>.<span class="js2-object-property">split</span>,
        <span class="variable-name">compliantExecNpcg</span> = <span class="string">/()??/</span>.<span class="js2-function-call">exec</span>(<span class="string">""</span>)[1] === undef, <span class="comment">// NPCG: nonparticipating capturing group
</span>        <span class="variable-name">self</span>;

        <span class="function-name">self</span> = <span class="keyword">function</span>(<span class="js2-function-param">str</span>, <span class="js2-function-param">separator</span>, <span class="js2-function-param">limit</span>) {
            <span class="comment">// If `separator` is not a regex, use `nativeSplit`
</span>            <span class="keyword">if</span> (Object.<span class="js2-object-property">prototype</span>.<span class="js2-object-property">toString</span>.<span class="js2-function-call">call</span>(separator) !== <span class="string">"[object RegExp]"</span>) {
                <span class="keyword">return</span> nativeSplit.<span class="js2-function-call">call</span>(str, separator, limit);
            }
            <span class="keyword">var</span> <span class="variable-name">output</span> = [],
            <span class="variable-name">flags</span> = (separator.<span class="js2-object-property">ignoreCase</span> ? <span class="string">"i"</span> : <span class="string">""</span>) +
                (separator.<span class="js2-object-property">multiline</span>  ? <span class="string">"m"</span> : <span class="string">""</span>) +
                (separator.<span class="js2-object-property">extended</span>   ? <span class="string">"x"</span> : <span class="string">""</span>) + <span class="comment">// Proposed for ES6
</span>                (separator.<span class="js2-object-property">sticky</span>     ? <span class="string">"y"</span> : <span class="string">""</span>), <span class="comment">// Firefox 3+
</span>                <span class="variable-name">lastLastIndex</span> = 0,
            <span class="comment">// Make `global` and avoid `lastIndex` issues by working with a copy
</span>            <span class="variable-name">separator2</span>, <span class="variable-name">match</span>, <span class="variable-name">lastIndex</span>, <span class="variable-name">lastLength</span>;
            separator = <span class="keyword">new</span> <span class="js2-function-call">RegExp</span>(separator.<span class="js2-object-property">source</span>, flags + <span class="string">"g"</span>);
            str += <span class="string">""</span>; <span class="comment">// Type-convert
</span>            <span class="keyword">if</span> (<span class="negation-char">!</span>compliantExecNpcg) {
                <span class="comment">// Doesn't need flags gy, but they don't hurt
</span>                separator2 = <span class="keyword">new</span> <span class="js2-function-call">RegExp</span>(<span class="string">"^"</span> + separator.<span class="js2-object-property">source</span> + <span class="string">"$(?!\\s)"</span>, flags);
            }
            <span class="comment">/* Values for `limit`, per the spec:
             * If undefined: 4294967295 // Math.pow(2, 32) - 1
             * If 0, Infinity, or NaN: 0
             * If positive number: limit = Math.floor(limit); if (limit &gt; 4294967295) limit -= 4294967296;
             * If negative number: 4294967296 - Math.floor(Math.abs(limit))
             * If other: Type-convert, then use the above rules
             */</span>
            <span class="comment">// ? Math.pow(2, 32) - 1 : ToUint32(limit)
</span>            limit = limit === undef ? -1 &gt;&gt;&gt; 0 : limit &gt;&gt;&gt; 0;
            <span class="keyword">while</span> (<span class="js2-warning">match = separator.</span><span class="js2-function-call"><span class="js2-warning">exec</span></span><span class="js2-warning">(str)</span>) {
                    <span class="comment">// `separator.lastIndex` is not reliable cross-browser
</span>                    lastIndex = match.<span class="js2-object-property">index</span> + match[0].<span class="js2-object-property">length</span>;
                    <span class="keyword">if</span> (lastIndex &gt; lastLastIndex) {
                        output.<span class="js2-function-call">push</span>(str.<span class="js2-function-call">slice</span>(lastLastIndex, match.<span class="js2-object-property">index</span>));
                        <span class="comment">// Fix browsers whose `exec` methods don't consistently return `undefined` for
</span>                        <span class="comment">// nonparticipating capturing groups
</span>                        <span class="keyword">if</span> (<span class="negation-char">!</span>compliantExecNpcg &amp;&amp; match.<span class="js2-object-property">length</span> &gt; 1) {
                            match[0].<span class="js2-function-call">replace</span>(separator2, <span class="keyword">function</span>() {
                                <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = 1; i &lt; arguments.<span class="js2-object-property">length</span> - 2; i++) {
                                    <span class="keyword">if</span> (arguments[i] === undef) {
                                        match[i] = undef;
                                    }
                                }
                            });
                        }
                        <span class="keyword">if</span> (match.<span class="js2-object-property">length</span> &gt; 1 &amp;&amp; match.<span class="js2-object-property">index</span> &lt; str.<span class="js2-object-property">length</span>) {
                            Array.<span class="js2-object-property">prototype</span>.<span class="js2-object-property">push</span>.<span class="js2-function-call">apply</span>(output, match.<span class="js2-function-call">slice</span>(1));
                        }
                        lastLength = match[0].<span class="js2-object-property">length</span>;
                        lastLastIndex = lastIndex;
                        <span class="keyword">if</span> (output.<span class="js2-object-property">length</span> &gt;= limit) {
                            <span class="keyword">break</span>;
                        }
                    }
                    <span class="keyword">if</span> (separator.<span class="js2-object-property">lastIndex</span> === match.<span class="js2-object-property">index</span>) {
                        separator.<span class="js2-object-property">lastIndex</span>++; <span class="comment">// Avoid an infinite loop
</span>                    }
                }
            <span class="keyword">if</span> (lastLastIndex === str.<span class="js2-object-property">length</span>) {
                <span class="keyword">if</span> (lastLength || <span class="negation-char">!</span>separator.<span class="js2-function-call">test</span>(<span class="string">""</span>)) {
                    output.<span class="js2-function-call">push</span>(<span class="string">""</span>);
                }
            } <span class="keyword">else</span> {
                output.<span class="js2-function-call">push</span>(str.<span class="js2-function-call">slice</span>(lastLastIndex));
            }
            <span class="keyword">return</span> output.<span class="js2-object-property">length</span> &gt; limit ? output.<span class="js2-function-call">slice</span>(0, limit) : output;
        };

        <span class="comment">// For convenience
</span>        String.<span class="js2-object-property">prototype</span>.<span class="function-name">split</span> = <span class="keyword">function</span>(<span class="js2-function-param">separator</span>, <span class="js2-function-param">limit</span>) {
            <span class="keyword">return</span> <span class="js2-function-call">self</span>(<span class="builtin">this</span>, separator, limit);
        };

        <span class="keyword">return</span> self;

    })();
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: jQuery Caret
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">/* istanbul ignore next */</span>
    $.<span class="js2-object-property">fn</span>.<span class="function-name">caret</span> = <span class="keyword">function</span>(<span class="js2-function-param">pos</span>) {
        <span class="keyword">var</span> <span class="variable-name">target</span> = <span class="builtin">this</span>[0];
        <span class="keyword">var</span> <span class="variable-name">isContentEditable</span> = target.<span class="js2-object-property">contentEditable</span> === <span class="string">'true'</span>;
        <span class="comment">//get
</span>        <span class="keyword">if</span> (arguments.<span class="js2-object-property">length</span> === 0) {
            <span class="comment">//HTML5
</span>            <span class="keyword">if</span> (window.<span class="js2-object-property">getSelection</span>) {
                <span class="comment">//contenteditable
</span>                <span class="keyword">if</span> (isContentEditable) {
                    target.<span class="js2-function-call">focus</span>();
                    <span class="keyword">var</span> <span class="variable-name">range1</span> = window.<span class="js2-function-call">getSelection</span>().<span class="js2-function-call">getRangeAt</span>(0),
                    <span class="variable-name">range2</span> = range1.<span class="js2-function-call">cloneRange</span>();
                    range2.<span class="js2-function-call">selectNodeContents</span>(target);
                    range2.<span class="js2-function-call">setEnd</span>(range1.<span class="js2-object-property">endContainer</span>, range1.<span class="js2-object-property">endOffset</span>);
                    <span class="keyword">return</span> range2.<span class="js2-function-call">toString</span>().<span class="js2-object-property">length</span>;
                }
                <span class="comment">//textarea
</span>                <span class="keyword">return</span> target.<span class="js2-object-property">selectionStart</span>;
            }
            <span class="comment">//IE&lt;9
</span>            <span class="keyword">if</span> (document.<span class="js2-object-property">selection</span>) {
                target.<span class="js2-function-call">focus</span>();
                <span class="comment">//contenteditable
</span>                <span class="keyword">if</span> (isContentEditable) {
                    <span class="keyword">var</span> <span class="variable-name"><span class="js2-warning">range1</span></span> = document.<span class="js2-object-property">selection</span>.<span class="js2-function-call">createRange</span>(),
                    <span class="variable-name"><span class="js2-warning">range2</span></span> = document.<span class="js2-object-property">body</span>.<span class="js2-function-call">createTextRange</span>();
                    range2.<span class="js2-function-call">moveToElementText</span>(target);
                    range2.<span class="js2-function-call">setEndPoint</span>(<span class="string">'EndToEnd'</span>, range1);
                    <span class="keyword">return</span> range2.<span class="js2-object-property">text</span>.<span class="js2-object-property">length</span>;
                }
                <span class="comment">//textarea
</span>                <span class="keyword">var</span> <span class="variable-name"><span class="js2-warning">pos</span></span> = 0,
                <span class="variable-name">range</span> = target.<span class="js2-function-call">createTextRange</span>(),
                <span class="variable-name"><span class="js2-warning">range2</span></span> = document.<span class="js2-object-property">selection</span>.<span class="js2-function-call">createRange</span>().<span class="js2-function-call">duplicate</span>(),
                <span class="variable-name">bookmark</span> = range2.<span class="js2-function-call">getBookmark</span>();
                range.<span class="js2-function-call">moveToBookmark</span>(bookmark);
                <span class="keyword">while</span> (range.<span class="js2-function-call">moveStart</span>(<span class="string">'character'</span>, -1) !== 0) pos++;
                <span class="keyword">return</span> pos;
            }
            <span class="comment">//not supported
</span>            <span class="keyword">return</span> 0;
        }
        <span class="comment">//set
</span>        <span class="keyword">if</span> (pos === -1)
            pos = <span class="builtin">this</span>[isContentEditable? <span class="string">'text'</span> : <span class="string">'val'</span>]().<span class="js2-object-property">length</span>;
        <span class="comment">//HTML5
</span>        <span class="keyword">if</span> (window.<span class="js2-object-property">getSelection</span>) {
            <span class="comment">//contenteditable
</span>            <span class="keyword">if</span> (isContentEditable) {
                target.<span class="js2-function-call">focus</span>();
                window.<span class="js2-function-call">getSelection</span>().<span class="js2-function-call">collapse</span>(target.<span class="js2-object-property">firstChild</span>, pos);
            }
            <span class="comment">//textarea
</span>            <span class="keyword">else</span>
                target.<span class="js2-function-call">setSelectionRange</span>(pos, pos);
        }
        <span class="comment">//IE&lt;9
</span>        <span class="keyword">else</span> <span class="keyword">if</span> (document.<span class="js2-object-property">body</span>.<span class="js2-object-property">createTextRange</span>) {
            <span class="keyword">var</span> <span class="variable-name"><span class="js2-warning">range</span></span> = document.<span class="js2-object-property">body</span>.<span class="js2-function-call">createTextRange</span>();
            range.<span class="js2-function-call">moveToElementText</span>(target);
            range.<span class="js2-function-call">moveStart</span>(<span class="string">'character'</span>, pos);
            range.<span class="js2-function-call">collapse</span>(<span class="constant">true</span>);
            range.<span class="js2-function-call">select</span>();
        }
        <span class="keyword">if</span> (<span class="negation-char">!</span>isContentEditable &amp;&amp; <span class="negation-char">!</span><span class="builtin">this</span>.<span class="js2-function-call">is</span>(<span class="string">':focus'</span>)) {
            target.<span class="js2-function-call">focus</span>();
        }
        <span class="keyword">return</span> pos;
    };
    <span class="comment">/* eslint-enable */</span>
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Cross-browser resize element plugin using sentinel iframe or
</span>    <span class="comment">// :: resizeObserver
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="jcXcovered">$.</span><span class="js2-object-property">fn</span>.<span class="function-name">resizer</span> = <span class="keyword">function</span>(<span class="js2-function-param">callback</span>) {
        <span class="keyword">var</span> <span class="variable-name">trigger</span> = <span class="jcXcovered">arguments.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> === 0</span>;
        <span class="keyword">var</span> <span class="variable-name">unbind</span> = <span class="jcXcovered">arguments[0] === </span><span class="string"><span class="jcXcovered">"unbind"</span></span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>trigger &amp;&amp; <span class="negation-char">!</span>unbind &amp;&amp; <span class="negation-char">!</span><span class="js2-function-call">is_function</span>(callback)) {
            <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'Invalid argument, it need to</span></span><span class="string"> a function or string '</span> +
                            <span class="string">'"unbind" or no arguments.'</span>);
        }
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (unbind) {
            <span class="jcXcovered">callback = </span><span class="js2-function-call"><span class="jcXcovered">is_function</span></span><span class="jcXcovered">(arguments[1]) ? arguments[1] : </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
        }
        <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> <span class="builtin">this</span>.<span class="js2-function-call">each</span>(<span class="keyword">function</span>() {
            <span class="keyword">var</span> <span class="variable-name">$this</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">)</span>;
            <span class="keyword">var</span> <span class="variable-name">iframe</span>;
            <span class="keyword">var</span> <span class="variable-name">callbacks</span>;
            <span class="keyword">function</span> <span class="function-name">resize_handler</span>() {
                <span class="jcXcovered">callbacks.</span><span class="js2-function-call"><span class="jcXcovered">fire</span></span><span class="jcXcovered">();</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (trigger || unbind) {
                <span class="jcXcovered">callbacks = $this.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'callbacks'</span></span><span class="jcXcovered">);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (trigger) {
                    <span class="jcXcovered">callbacks &amp;&amp; callbacks.</span><span class="js2-function-call"><span class="jcXcovered">fire</span></span><span class="jcXcovered">();</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (callback &amp;&amp; callbacks) {
                        <span class="jcXnot-covered">callbacks.</span><span class="js2-function-call"><span class="jcXnot-covered">remove</span></span><span class="jcXnot-covered">(callback);</span>
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>callbacks.<span class="js2-function-call">has</span>()) {
                            <span class="jcXnot-covered">callbacks = </span><span class="constant"><span class="jcXnot-covered">null</span></span><span class="jcXnot-covered">;</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">callbacks = </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>callbacks) {
                        <span class="jcXcovered">$this.</span><span class="js2-function-call"><span class="jcXcovered">removeData</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'callbacks'</span></span><span class="jcXcovered">);</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (window.<span class="js2-object-property">ResizeObserver</span>) {
                            <span class="keyword">var</span> <span class="variable-name">observer</span> = <span class="jcXcovered">$this.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'observer'</span></span><span class="jcXcovered">)</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (observer) {
                                <span class="jcXcovered">observer.</span><span class="js2-function-call"><span class="jcXcovered">unobserve</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">);</span>
                                <span class="jcXcovered">$this.</span><span class="js2-function-call"><span class="jcXcovered">removeData</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'observer'</span></span><span class="jcXcovered">);</span>
                            }
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">iframe = $this.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&gt; iframe'</span></span><span class="jcXcovered">);</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (iframe.<span class="js2-object-property">length</span>) {
                                <span class="comment">// just in case of memory leaks in IE
</span>                                <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(iframe[0].</span><span class="js2-object-property"><span class="jcXcovered">contentWindow</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">off</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'resize'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                                <span class="jcXcovered">iframe.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> ($this.<span class="js2-function-call">is</span>(<span class="string">'body'</span>)) {
                                <span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(window).</span><span class="js2-function-call"><span class="jcXnot-covered">off</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'resize.resizer'</span></span><span class="jcXnot-covered">);</span>
                            }
                        }
                    }
                }
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> ($this.<span class="js2-function-call">data</span>(<span class="string">'callbacks'</span>)) {
                <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'callbacks'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">add</span></span><span class="jcXcovered">(callback);</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">callbacks = $.</span><span class="js2-function-call"><span class="jcXcovered">Callbacks</span></span><span class="jcXcovered">();</span>
                <span class="jcXcovered">callbacks.</span><span class="js2-function-call"><span class="jcXcovered">add</span></span><span class="jcXcovered">(callback);</span>
                <span class="jcXcovered">$this.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'callbacks'</span></span><span class="jcXcovered">, callbacks);</span>
                <span class="keyword">var</span> <span class="variable-name">resizer</span>;
                <span class="keyword">var</span> <span class="variable-name">first</span> = <span class="constant"><span class="jcXcovered">true</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (window.<span class="js2-object-property">ResizeObserver</span>) {
                    <span class="jcXcovered">res</span>izer = <span class="keyword">new</span> <span class="js2-function-call">ResizeObserver</span>(<span class="keyword">function</span>() {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>first) {
                            <span class="js2-function-call"><span class="jcXcovered">resize_handler</span></span><span class="jcXcovered">();</span>
                        }
                        <span class="jcXcovered">first = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    });
                    <span class="jcXcovered">resizer.</span><span class="js2-function-call"><span class="jcXcovered">observe</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">$this.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'observer'</span></span><span class="jcXcovered">, resizer);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> ($this.<span class="js2-function-call">is</span>(<span class="string">'body'</span>)) {
                    <span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(window).</span><span class="js2-function-call"><span class="jcXnot-covered">on</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'resize.resizer'</span></span><span class="jcXnot-covered">, resize_handler);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">iframe = </span><span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;iframe/&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'resizer'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">appendTo</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">)[0];</span>

                    <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(iframe.</span><span class="js2-object-property"><span class="jcXcovered">contentWindow</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">on</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'resize'</span></span><span class="jcXcovered">, resize_handler);</span>
                }
            }
        });
    };
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">jquery_resolve</span>(<span class="js2-function-param">value</span>) {
        <span class="keyword">var</span> <span class="variable-name">defer</span> = <span class="jcXcovered">jQuery.</span><span class="js2-function-call"><span class="jcXcovered">Deferred</span></span><span class="jcXcovered">()</span>;
        <span class="jcXcovered">defer.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">(value);</span>
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> defer.</span><span class="js2-function-call"><span class="jcXcovered">promise</span></span><span class="jcXcovered">();</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: based on https://github.com/zeusdeux/isInViewport
</span>    <span class="comment">// :: work only vertically and on dom elements
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">fn</span></span><span class="jcXcovered">.</span><span class="js2-object-property">is_fully_in_viewport</span> = (<span class="keyword">function</span>() {
        <span class="keyword">function</span> <span class="function-name">is_visible</span>(<span class="js2-function-param">node</span>, <span class="js2-function-param">container</span>) {
            <span class="keyword">var</span> <span class="variable-name">box</span> = <span class="jcXcovered">node.</span><span class="js2-function-call"><span class="jcXcovered">getBoundingClientRect</span></span><span class="jcXcovered">()</span>;
            <span class="keyword">var</span> <span class="variable-name">viewport</span> = <span class="jcXcovered">container[0].</span><span class="js2-function-call"><span class="jcXcovered">getBoundingClientRect</span></span><span class="jcXcovered">()</span>;
            <span class="keyword">var</span> <span class="variable-name">top</span> = <span class="jcXcovered">box.</span><span class="js2-object-property"><span class="jcXcovered">top</span></span><span class="jcXcovered"> - viewport.</span><span class="js2-object-property"><span class="jcXcovered">top</span></span>;
            <span class="keyword">var</span> <span class="variable-name">bottom</span> = <span class="jcXcovered">box.</span><span class="js2-object-property"><span class="jcXcovered">bottom</span></span><span class="jcXcovered"> - viewport.</span><span class="js2-object-property"><span class="jcXcovered">top</span></span>;
            <span class="keyword">var</span> <span class="variable-name">height</span> = <span class="jcXcovered">container.</span><span class="js2-function-call"><span class="jcXcovered">height</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> bottom &gt; 0 &amp;&amp; top &lt;= height;</span>
        }
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (window.<span class="js2-object-property">IntersectionObserver</span>) {
            <span class="keyword"><span class="jcXnot-covered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">container</span>) {
                <span class="keyword">var</span> <span class="variable-name">node</span> = <span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">[0]</span>;
                <span class="keyword">var</span> <span class="variable-name">defer</span> = <span class="jcXnot-covered">jQuery.</span><span class="js2-function-call"><span class="jcXnot-covered">Deferred</span></span><span class="jcXnot-covered">()</span>;
                <span class="keyword">va</span><span class="keyword"><span class="jcXnot-covered">r</span></span><span class="jcXnot-covered"> </span><span class="variable-name"><span class="jcXnot-covered">item_observer</span></span><span class="jcXnot-covered"> = </span><span class="keyword">new</span> window.<span class="js2-function-call">IntersectionObserver</span>(<span class="keyword">function</span>(<span class="js2-function-param">entries</span>) {
                    <span class="jcXnot-covered">defer.</span><span class="js2-function-call"><span class="jcXnot-covered">resolve</span></span><span class="jcXnot-covered">(entries[0].</span><span class="js2-object-property"><span class="jcXnot-covered">isIntersecting</span></span><span class="jcXnot-covered"> &amp;&amp; entries[0].</span><span class="js2-object-property"><span class="jcXnot-covered">ratio</span></span><span class="jcXnot-covered"> === 1);</span>
                    <span class="jcXnot-covered">item_observer.</span><span class="js2-function-call"><span class="jcXnot-covered">unobserve</span></span><span class="jcXnot-covered">(node);</span>
                }, {
                    <span class="js2-object-property">root</span>: container[0]
                });
                <span class="jcXnot-covered">item_observer.</span><span class="js2-function-call"><span class="jcXnot-covered">observe</span></span><span class="jcXnot-covered">(node);</span>
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> defer.</span><span class="js2-function-call"><span class="jcXnot-covered">promise</span></span><span class="jcXnot-covered">();</span>
            };
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">container</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">jquery_resolve</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">is_visible</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">[0], container));</span>
            };
        }
    })();
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: hide elements from screen readers
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">a11y_hide</span>(<span class="js2-function-param">element</span>) {
        <span class="jcXcovered">ele</span>ment.<span class="js2-function-call">attr</span>({
            <span class="js2-object-property">role</span>: <span class="string">'presentation'</span>,
            <span class="js2-object-property">'aria-hidden'</span>: <span class="string">'true'</span>
        });
    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="comment">// :: alert only first exception of type
</span>    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">excepctions</span> = <span class="jcXcovered">[]</span>;
    <span class="keyword">function</span> <span class="function-name">alert_exception</span>(<span class="js2-function-param">label</span>, <span class="js2-function-param">e</span>) {
        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (arguments[0] <span class="keyword">instanceof</span> $.<span class="js2-object-property">terminal</span>.<span class="js2-object-property">Exception</span>) {
            <span class="jcXnot-covered">label = arguments[0].</span><span class="js2-object-property"><span class="jcXnot-covered">type</span></span><span class="jcXnot-covered">;</span>
            <span class="jcXnot-covered">e = arguments[0];</span>
        }
        <span class="keyword">var</span> <span class="variable-name">message</span> = <span class="jcXnot-covered">(label ? label + </span><span class="string"><span class="jcXnot-covered">': '</span></span><span class="jcXnot-covered"> : </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">) + </span><span class="js2-function-call"><span class="jcXnot-covered">exception_message</span></span><span class="jcXnot-covered">(e)</span>;
        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (excepctions.<span class="js2-function-call">indexOf</span>(message) === -1) {
            <span class="jcXnot-covered">excepctions.</span><span class="js2-function-call"><span class="jcXnot-covered">push</span></span><span class="jcXnot-covered">(message);</span>
            <span class="js2-function-call"><span class="jcXnot-covered">setTim</span></span><span class="js2-function-call">eout</span>(<span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> e;</span>
            }, 0);
            <span class="comment">//alert(message + (e.stack ? '\n' + e.stack : ''));
</span>        }
    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="comment">// :; detect if mouse event happen on scrollbar
</span>    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">scrollbar_event</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">node</span>) {
        <span class="keyword">var</span> <span class="variable-name">left</span> = <span class="jcXcovered">node.</span><span class="js2-function-call"><span class="jcXcovered">offset</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">left</span></span>;
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> node.</span><span class="js2-function-call"><span class="jcXcovered">outerWidth</span></span><span class="jcXcovered">() &lt;= e.</span><span class="js2-object-property"><span class="jcXcovered">clientX</span></span><span class="jcXcovered"> - left;</span>
    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="comment">// :: Return exception message as string
</span>    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">exception_message</span>(<span class="js2-function-param">e</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> e === <span class="string">'string'</span>) {
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> e;</span>
        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> e.<span class="js2-object-property">fileName</span> === <span class="string">'string'</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> e.</span><span class="js2-object-property"><span class="jcXcovered">fileName</span></span><span class="jcXcovered"> + </span><span class="string"><span class="jcXcovered">': '</span></span><span class="jcXcovered"> + e.</span><span class="js2-object-property"><span class="jcXcovered">message</span></span><span class="jcXcovered">;</span>
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> e.</span><span class="js2-object-property"><span class="jcXcovered">message</span></span><span class="jcXcovered">;</span>
        }
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: CYCLE DATA STRUCTURE
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">Cycle</span>() {
        <span class="keyword">var</span> <span class="variable-name">data</span> = <span class="jcXcovered">[].</span><span class="js2-object-property"><span class="jcXcovered">slice</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">arguments</span></span><span class="jcXcovered">)</span>;
        <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXcovered">0</span>;
        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">xtend</span>(<span class="builtin">this</span>, {
            <span class="function-name">get</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data;</span>
            },
            <span class="function-name">index</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> pos;</span>
            },
            <span class="function-name">rotate</span>: <span class="keyword">function</span>(<span class="js2-function-param">skip</span>, <span class="js2-function-param">init</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (init === <span class="constant">undefined</span>) {
                    <span class="jcXcovered">init = pos;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (init === pos) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>skip) {
                    <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">defined</span></span><span class="jcXcovered"> = </span>data.<span class="js2-function-call">filter</span>(<span class="keyword">function</span>(<span class="js2-function-param">item</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">typeof</span></span><span class="jcXcovered"> item !== </span><span class="string"><span class="jcXcovered">'undefined'</span></span><span class="jcXcovered">;</span>
                    });
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>defined.<span class="js2-object-property">length</span>) {
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>data.<span class="js2-object-property">length</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-object-property">length</span> === 1) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> data[0];</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (pos === data.<span class="js2-object-property">length</span> - 1) {
                        <span class="jcXcovered">pos = 0;</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">++pos;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> data[pos] !== <span class="string">'undefined'</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data[pos];</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">rotate</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">, init);</span>
                    }
                }
            },
            <span class="function-name">length</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">remove</span>: <span class="keyword">function</span>(<span class="js2-function-param">index</span>) {
                <span class="keyword"><span class="jcXcovered">delete</span></span><span class="jcXcovered"> data[index];</span>
            },
            <span class="function-name">set</span>: <span class="keyword">function</span>(<span class="js2-function-param">item</span>) {
                <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>; i--;) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data[i] === item) {
                        <span class="jcXcovered">pos = i;</span>
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                    }
                }
                <span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">append</span></span><span class="jcXcovered">(item);</span>
                <span class="jcXcovered">pos = data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1;</span>
            },
            <span class="function-name">front</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-object-property">length</span>) {
                    <span class="keyword">var</span> <span class="variable-name">index</span> = <span class="jcXcovered">pos</span>;
                    <span class="keyword">var</span> <span class="variable-name">restart</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
                    <span class="keyword"><span class="jcXcovered">w</span></span><span class="keyword">hile</span> (<span class="negation-char">!</span>data[index]) {
                        <span class="jcXcovered">index++;</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (index &gt; data.<span class="js2-object-property">length</span>) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (restart) {
                                <span class="keyword"><span class="jcXnot-covered">break</span></span><span class="jcXnot-covered">;</span>
                            }
                            <span class="jcXcovered">index = 0;</span>
                            <span class="jcXcovered">restart = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                        }
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data[index];</span>
                }
            },
            <span class="function-name">map</span>: <span class="keyword">function</span>(<span class="js2-function-param">fn</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data.</span><span class="js2-function-call"><span class="jcXcovered">map</span></span><span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">fun</span></span><span class="keyword">ction</span>(<span class="js2-function-param">item</span>, <span class="js2-function-param">i</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> item !== <span class="string">'undefined'</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">fn</span></span><span class="jcXcovered">(item, i);</span>
                    }
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">null</span></span><span class="jcXnot-covered">;</span>
                }).<span class="js2-function-call">filter</span>(Boolean);
            },
            <span class="function-name">forEach</span>: <span class="keyword">function</span>(<span class="js2-function-param">fn</span>) {
                <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> data.<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">item</span>, <span class="js2-function-param">i</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> item !== <span class="string">'undefined'</span>) {
                        <span class="js2-function-call"><span class="jcXcovered">fn</span></span><span class="jcXcovered">(item, i);</span>
                    }
                });
            },
            <span class="function-name">append</span>: <span class="keyword">function</span>(<span class="js2-function-param">item</span>) {
                <span class="jcXcovered">data.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(item);</span>
            }
        });
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: STACK DATA STRUCTURE
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">Stack</span>(<span class="js2-function-param">init</span>) {
        <span class="keyword">var</span> <span class="variable-name">data</span> = <span class="js2-function-call"><span class="jcXcovered">is_array</span></span><span class="jcXcovered">(init) ? init : init ? [init] : []</span>;
        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">xtend</span>(<span class="builtin">this</span>, {
            <span class="function-name">data</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data;</span>
            },
            <span class="function-name">map</span>: <span class="keyword">function</span>(<span class="js2-function-param">fn</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">map</span></span><span class="jcXcovered">(data, fn);</span>
            },
            <span class="function-name">size</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">pop</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-object-property">length</span> === 0) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">value</span> = <span class="jcXcovered">data[data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1]</span>;
                    <span class="jcXcovered">data = data.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1);</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> value;</span>
                }
            },
            <span class="function-name">push</span>: <span class="keyword">function</span>(<span class="js2-function-param">value</span>) {
                <span class="jcXcovered">data = data.</span><span class="js2-function-call"><span class="jcXcovered">concat</span></span><span class="jcXcovered">([value]);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> value;</span>
            },
            <span class="function-name">top</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> &gt; 0 ? data[data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1] : </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">clone</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">Stack</span></span><span class="jcXcovered">(data.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0));</span>
            }
        });
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// :: HISTORY CLASS
</span>    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">History</span>(<span class="js2-function-param">name</span>, <span class="js2-function-param">size</span>, <span class="js2-function-param">memory</span>) {
        <span class="keyword">var</span> <span class="variable-name">enabled</span> = <span class="constant"><span class="jcXcovered">true</span></span>;
        <span class="keyword">var</span> <span class="variable-name">storage_key</span> = <span class="string"><span class="jcXcovered">''</span></span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> name === <span class="string">'string'</span> &amp;&amp; name !== <span class="string">''</span>) {
            <span class="jcXcovered">storage_key = name + </span><span class="string"><span class="jcXcovered">'_'</span></span><span class="jcXcovered">;</span>
        }
        <span class="jcXcovered">storage_key += </span><span class="string"><span class="jcXcovered">'commands'</span></span><span class="jcXcovered">;</span>
        <span class="keyword">var</span> <span class="variable-name">data</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (memory) {
            <span class="jcXcovered">data = [];</span>
        } <span class="keyword">else</span> {
            <span class="jcXcovered">data = $.</span><span class="js2-object-property"><span class="jcXcovered">Storage</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">(storage_key);</span>
            <span class="jcXcovered">data = data ? JSON.</span><span class="js2-function-call"><span class="jcXcovered">parse</span></span><span class="jcXcovered">(data) : [];</span>
        }
        <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXcovered">data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1</span>;
        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">xtend</span>(<span class="builtin">this</span>, {
            <span class="function-name">append</span>: <span class="keyword">function</span>(<span class="js2-function-param">item</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data[data.<span class="js2-object-property">length</span> - 1] !== item) {
                        <span class="jcXcovered">data.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(item);</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (size &amp;&amp; data.<span class="js2-object-property">length</span> &gt; size) {
                            <span class="jcXcovered">data = data.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(-size);</span>
                        }
                        <span class="jcXcovered">pos = data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1;</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>memory) {
                            <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">Storage</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(storage_key, JSON.</span><span class="js2-function-call"><span class="jcXcovered">stringify</span></span><span class="jcXcovered">(data));</span>
                        }
                    }
                }
            },
            <span class="function-name">set</span>: <span class="keyword">function</span>(<span class="js2-function-param">new_data</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_array</span>(new_data)) {
                    <span class="jcXcovered">data = new_data;</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>memory) {
                        <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">Storage</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(storage_key, JSON.</span><span class="js2-function-call"><span class="jcXcovered">stringify</span></span><span class="jcXcovered">(data));</span>
                    }
                }
            },
            <span class="function-name">data</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data;</span>
            },
            <span class="function-name">reset</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">pos = data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1;</span>
            },
            <span class="function-name">last</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data[data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1];</span>
            },
            <span class="function-name">end</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> pos === data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1;</span>
            },
            <span class="function-name">position</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> pos;</span>
            },
            <span class="function-name">current</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data[pos];</span>
            },
            <span class="function-name">next</span>: <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">old</span> = <span class="jcXcovered">pos</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (pos &lt; data.<span class="js2-object-property">length</span> - 1) {
                    <span class="jcXcovered">++pos;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (old !== pos) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data[pos];</span>
                }
            },
            <span class="function-name">previous</span>: <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">old</span> = <span class="jcXcovered">pos</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (pos &gt; 0) {
                    <span class="jcXcovered">--pos;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (old !== pos) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> data[pos];</span>
                }
            },
            <span class="function-name">clear</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">data = [];</span>
                <span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">purge</span></span><span class="jcXcovered">();</span>
            },
            <span class="function-name">enabled</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> enabled;</span>
            },
            <span class="function-name">enable</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">enabled = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">purge</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>memory) {
                    <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">Storage</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(storage_key);</span>
                }
            },
            <span class="function-name">disable</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">enabled = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">toggle</span>: <span class="keyword">function</span>(<span class="js2-function-param">value</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> value === <span class="string">'undefined'</span>) {
                    <span class="jcXnot-covered">enabled = </span><span class="negation-char"><span class="jcXnot-covered">!</span></span><span class="jcXnot-covered">enabled;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">enabled = value;</span>
                }
            }
        });
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// :: COMMAND LINE PLUGIN
</span>    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">cmd_index</span> = <span class="jcXcovered">0</span>;
    <span class="jcXcovered">$.</span><span class="js2-object-property">cmd</span> = {
        <span class="js2-object-property">defaults</span>: {
            <span class="js2-object-property">mask</span>: <span class="constant">false</span>,
            <span class="js2-object-property">caseSensitiveSearch</span>: <span class="constant">true</span>,
            <span class="js2-object-property">historySize</span>: 60,
            <span class="js2-object-property">prompt</span>: <span class="string">'&gt; '</span>,
            <span class="js2-object-property">enabled</span>: <span class="constant">true</span>,
            <span class="js2-object-property">history</span>: <span class="constant">true</span>,
            <span class="js2-object-property">onPositionChange</span>: $.<span class="js2-object-property">noop</span>,
            <span class="js2-object-property">onCommandChange</span>: $.<span class="js2-object-property">noop</span>,
            <span class="js2-object-property">inputStyle</span>: <span class="string">'textarea'</span>,
            <span class="js2-object-property">onPaste</span>: $.<span class="js2-object-property">noop</span>,
            <span class="js2-object-property">clickTimeout</span>: 200,
            <span class="js2-object-property">holdTimeout</span>: 400,
            <span class="js2-object-property">holdRepeatTimeout</span>: 200,
            <span class="js2-object-property">mobileIngoreAutoSpace</span>: [],
            <span class="js2-object-property">repeatTimeoutKeys</span>: [<span class="string">'HOLD+BACKSPACE'</span>],
            <span class="js2-object-property">tabindex</span>: 1,
            <span class="js2-object-property">tabs</span>: 4
        }
    };
    <span class="jcXcovered">$.</span><span class="js2-object-property">fn</span>.<span class="function-name">cmd</span> = <span class="keyword">function</span>(<span class="js2-function-param">options</span>) {
        <span class="keyword">var</span> <span class="variable-name">settings</span> = <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span><span class="jcXcovered">({}, $.</span><span class="js2-object-property"><span class="jcXcovered">cmd</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">defaults</span></span><span class="jcXcovered">, options)</span>;
        <span class="keyword">function</span> <span class="function-name">mobile_ignore_key</span>(<span class="js2-function-param">key</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> settings.</span><span class="js2-object-property"><span class="jcXcovered">mobileIngoreAutoSpace</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> &amp;&amp;
                setti</span>ngs.<span class="js2-object-property">mobileIngoreAutoSpace</span>.<span class="js2-function-call">indexOf</span>(key) !== -1 &amp;&amp; is_android;
        }
        <span class="keyword">var</span> <span class="variable-name">self</span> = <span class="builtin"><span class="jcXcovered">this</span></span>;
        <span class="keyword">var</span> <span class="variable-name">maybe_data</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'cmd'</span></span><span class="jcXcovered">)</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (maybe_data) {
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> maybe_data;</span>
        }
        <span class="keyword">var</span> <span class="variable-name">id</span> = <span class="jcXcovered">cmd_index++</span>;
        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'cmd'</span></span><span class="jcXcovered">);</span>
        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">append</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;span class="prompt"&gt;&lt;/span&gt;'</span></span><span class="jcXcovered">);</span>
        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">append</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;div clas</span></span><span class="string">s="cursor-line"&gt;'</span> +
                    <span class="string">'&lt;span&gt;&lt;/span&gt;'</span> +
                    <span class="string">'&lt;span class="cursor"&gt;&lt;span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;'</span> +
                    <span class="string">'&lt;span&gt;&lt;/span&gt;'</span> +
                    <span class="string">'&lt;/div&gt;'</span>);
        <span class="comment">// a11y: don't read command it's in textarea that's in focus
</span>        <span class="js2-function-call"><span class="jcXcovered">a11y_hide</span></span><span class="jcXcovered">(self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cursor-line'</span></span><span class="jcXcovered">));</span>
        <span class="comment">// on mobile the only way to hide textarea on desktop it's needed because
</span>        <span class="comment">// textarea show up after focus
</span>        <span class="comment">//self.append('&lt;span class="mask"&gt;&lt;/mask&gt;');
</span>        <span class="keyword">var</span> <span class="variable-name">clip</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;textarea&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">({
     </span>       <span class="js2-object-property">autocapitalize</span>: <span class="string">'off'</span>,
            <span class="js2-object-property">spellcheck</span>: <span class="string">'false'</span>,
            <span class="js2-object-property">tabindex</span>: settings.<span class="js2-object-property">tabindex</span>
        }).<span class="js2-function-call">addClass</span>(<span class="string">'clipboard'</span>).<span class="js2-function-call">appendTo</span>(self);
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>is_mobile) {
            <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">val</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">);</span>
        }
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">width</span>) {
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">width</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">width</span></span><span class="jcXcovered">);</span>
        }
        <span class="keyword">var</span> <span class="variable-name">num_chars</span>; <span class="comment">// calculated by resize
</span>        <span class="keyword">var</span> <span class="variable-name">char_width</span>;
        <span class="keyword">var</span> <span class="variable-name">last_rendered_prompt</span>;
        <span class="keyword">var</span> <span class="variable-name">prompt_last_line</span>;
        <span class="keyword">var</span> <span class="variable-name">prompt_len</span>;
        <span class="keyword">var</span> <span class="variable-name">prompt_node</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.prompt'</span></span><span class="jcXcovered">)</span>;
        <span class="keyword">var</span> <span class="variable-name">reverse_search</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">rev_search_str</span> = <span class="string"><span class="jcXcovered">''</span></span>;
        <span class="keyword">var</span> <span class="variable-name">reverse_search_position</span> = <span class="constant"><span class="jcXcovered">null</span></span>;
        <span class="keyword">var</span> <span class="variable-name">backup_prompt</span>;
        <span class="keyword">var</span> <span class="variable-name">command</span> = <span class="string"><span class="jcXcovered">''</span></span>;
        <span class="keyword">var</span> <span class="variable-name">last_command</span>;
        <span class="comment">// text from selection using CTRL+SHIFT+C (as in Xterm)
</span>        <span class="keyword">var</span> <span class="variable-name">kill_text</span> = <span class="string"><span class="jcXcovered">''</span></span>; <span class="comment">// text from command that kill part of the command
</span>        <span class="keyword">var</span> <span class="variable-name">position</span> = <span class="jcXcovered">0</span>;
        <span class="keyword">var</span> <span class="variable-name">prompt</span>;
        <span class="keyword">var</span> <span class="variable-name">enabled</span>;
        <span class="keyword">var</span> <span class="variable-name">formatted_position</span> = <span class="jcXcovered">0</span>;
        <span class="keyword">var</span> <span class="variable-name">name</span>, <span class="variable-name">history</span>;
        <span class="keyword">var</span> <span class="variable-name">cursor</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cursor'</span></span><span class="jcXcovered">)</span>;
        <span class="keyword">var</span> <span class="variable-name">animation</span>;
        <span class="keyword">var</span> <span class="variable-name">restart_animation</span>;
        <span class="keyword">var</span> <span class="variable-name">paste_count</span> = <span class="jcXcovered">0</span>;
        <span class="comment">// use \uFFFF to mark newline extra character
</span>        <span class="comment">// so we can hide it by css when using text selection
</span>        <span class="keyword">var</span> <span class="variable-name">line_marker</span> = <span class="string"><span class="jcXcovered">'\uFFFF'</span></span>;
        <span class="keyword">var</span> <span class="variable-name">line_marker_re</span> = <span class="string"><span class="jcXcovered">/\uFFFF$/</span></span>;
        <span class="keyword">function</span> <span class="function-name">get_char_pos</span>(<span class="js2-function-param">e</span>) {
            <span class="keyword">var</span> <span class="variable-name">node</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(e.</span><span class="js2-object-property"><span class="jcXcovered">target</span></span><span class="jcXcovered">)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (node.<span class="js2-function-call">is</span>(<span class="string">'span'</span>)) {
                <span class="jcXcovered">node = node.</span><span class="js2-function-call"><span class="jcXcovered">closest</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'[data-text]'</span></span><span class="jcXcovered">);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> node.</span><span class="js2-function-call"><span class="jcXcovered">index</span></span><span class="jcXcovered">() +
                    node.</span><span class="js2-function-call"><span class="jcXcovered">parent</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'sp</span></span><span class="string">an'</span>).<span class="js2-function-call">prevAll</span>().<span class="js2-function-call">find</span>(<span class="string">'[data-text]'</span>).<span class="js2-object-property">length</span> +
                    node.<span class="js2-function-call">closest</span>(<span class="string">'[role="presentation"]'</span>)
                        .<span class="js2-function-call">prevUntil</span>(<span class="string">'.prompt'</span>).<span class="js2-function-call">find</span>(<span class="string">'[data-text]'</span>).<span class="js2-object-property">length</span>;
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (node.<span class="js2-function-call">is</span>(<span class="string">'div[role="presentation"]'</span>)) {
                <span class="keyword">var</span> <span class="variable-name">last</span> = <span class="negation-char"><span class="jcXcovered">!</span></span><span class="jcXcovered">node.</span><span class="js2-function-call"><span class="jcXcovered">nextUntil</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'textarea'</span></span><span class="jcXcovered">).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> node.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'s</span></span><span class="string">pan[data-text]'</span>).<span class="js2-object-property">length</span> +
                    node.<span class="js2-function-call">prevUntil</span>(<span class="string">'.prompt'</span>).<span class="js2-function-call">find</span>(<span class="string">'span[data-text]'</span>).<span class="js2-object-property">length</span> -
                    (last ? 0 : 1);
            }
        }
        <span class="comment">// IE mapping
</span>        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">key_mapping</span></span><span class="jcXcovered"> = </span>{
            <span class="js2-object-property">'SPACEBAR'</span>: <span class="string">' '</span>,
            <span class="js2-object-property">'UP'</span>: <span class="string">'ARROWUP'</span>,
            <span class="js2-object-property">'DOWN'</span>: <span class="string">'ARROWDOWN'</span>,
            <span class="js2-object-property">'LEFT'</span>: <span class="string">'ARROWLEFT'</span>,
            <span class="js2-object-property">'RIGHT'</span>: <span class="string">'ARROWRIGHT'</span>,
            <span class="js2-object-property">'DEL'</span>: <span class="string">'DELETE'</span>,
            <span class="js2-object-property">'MULTIPLY'</span>: <span class="string">'*'</span>,
            <span class="js2-object-property">'DIVIDE'</span>: <span class="string">'/'</span>,
            <span class="js2-object-property">'SUBTRACT'</span>: <span class="string">'-'</span>,
            <span class="js2-object-property">'ADD'</span>: <span class="string">'+'</span>
        };
        <span class="keyword">function</span> <span class="function-name">get_key</span>(<span class="js2-function-param">e</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">key</span>) {
                <span class="keyword">var</span> <span class="variable-name">key</span> = <span class="jcXcovered">e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">toUpperCase</span></span><span class="jcXcovered">()</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (key_mapping[key]) {
                    <span class="jcXnot-covered">key = key_mapping[key];</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (key === <span class="string">'CONTROL'</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">'CTRL'</span></span><span class="jcXnot-covered">;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">combo</span> = <span class="jcXcovered">[]</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">ctrlKey</span>) {
                        <span class="jcXcovered">combo.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'CTRL'</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">metaKey</span> &amp;&amp; key !== <span class="string">'META'</span>) {
                        <span class="jcXnot-covered">combo.</span><span class="js2-function-call"><span class="jcXnot-covered">push</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'META'</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">shiftKey</span> &amp;&amp; key !== <span class="string">'SHIFT'</span>) {
                        <span class="jcXcovered">combo.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'SHIFT'</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">altKey</span> &amp;&amp; key !== <span class="string">'ALT'</span>) {
                        <span class="jcXnot-covered">combo.</span><span class="js2-function-call"><span class="jcXnot-covered">push</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'ALT'</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (combo.<span class="js2-object-property">length</span> &amp;&amp; key === <span class="string">' '</span>) {
                        <span class="jcXnot-covered">key = </span><span class="string"><span class="jcXnot-covered">'SPACEBAR'</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">key</span>) {
                        <span class="jcXcovered">combo.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(key);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> combo.</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'+'</span></span><span class="jcXcovered">);</span>
                }
            }
        }
        <span class="comment">// -----------------------------------------------------------------
</span>        <span class="comment">// for invoking shortcuts using terminal::keydown
</span>        <span class="comment">// taken from https://github.com/cvan/keyboardevent-key-polyfill/
</span>        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">keycodes</span></span><span class="jcXcovered"> = </span>{
            <span class="js2-object-property">3</span>: <span class="string">'Cancel'</span>,
            <span class="js2-object-property">6</span>: <span class="string">'Help'</span>,
            <span class="js2-object-property">8</span>: <span class="string">'Backspace'</span>,
            <span class="js2-object-property">9</span>: <span class="string">'Tab'</span>,
            <span class="js2-object-property">12</span>: <span class="string">'Clear'</span>,
            <span class="js2-object-property">13</span>: <span class="string">'Enter'</span>,
            <span class="js2-object-property">16</span>: <span class="string">'Shift'</span>,
            <span class="js2-object-property">17</span>: <span class="string">'Control'</span>,
            <span class="js2-object-property">18</span>: <span class="string">'Alt'</span>,
            <span class="js2-object-property">19</span>: <span class="string">'Pause'</span>,
            <span class="js2-object-property">20</span>: <span class="string">'CapsLock'</span>,
            <span class="js2-object-property">27</span>: <span class="string">'Escape'</span>,
            <span class="js2-object-property">28</span>: <span class="string">'Convert'</span>,
            <span class="js2-object-property">29</span>: <span class="string">'NonConvert'</span>,
            <span class="js2-object-property">30</span>: <span class="string">'Accept'</span>,
            <span class="js2-object-property">31</span>: <span class="string">'ModeChange'</span>,
            <span class="js2-object-property">32</span>: <span class="string">' '</span>,
            <span class="js2-object-property">33</span>: <span class="string">'PageUp'</span>,
            <span class="js2-object-property">34</span>: <span class="string">'PageDown'</span>,
            <span class="js2-object-property">35</span>: <span class="string">'End'</span>,
            <span class="js2-object-property">36</span>: <span class="string">'Home'</span>,
            <span class="js2-object-property">37</span>: <span class="string">'ArrowLeft'</span>,
            <span class="js2-object-property">38</span>: <span class="string">'ArrowUp'</span>,
            <span class="js2-object-property">39</span>: <span class="string">'ArrowRight'</span>,
            <span class="js2-object-property">40</span>: <span class="string">'ArrowDown'</span>,
            <span class="js2-object-property">41</span>: <span class="string">'Select'</span>,
            <span class="js2-object-property">42</span>: <span class="string">'Print'</span>,
            <span class="js2-object-property">43</span>: <span class="string">'Execute'</span>,
            <span class="js2-object-property">44</span>: <span class="string">'PrintScreen'</span>,
            <span class="js2-object-property">45</span>: <span class="string">'Insert'</span>,
            <span class="js2-object-property">46</span>: <span class="string">'Delete'</span>,
            <span class="js2-object-property">48</span>: [<span class="string">'0'</span>, <span class="string">')'</span>],
            <span class="js2-object-property">49</span>: [<span class="string">'1'</span>, <span class="string">'!'</span>],
            <span class="js2-object-property">50</span>: [<span class="string">'2'</span>, <span class="string">'@'</span>],
            <span class="js2-object-property">51</span>: [<span class="string">'3'</span>, <span class="string">'#'</span>],
            <span class="js2-object-property">52</span>: [<span class="string">'4'</span>, <span class="string">'$'</span>],
            <span class="js2-object-property">53</span>: [<span class="string">'5'</span>, <span class="string">'%'</span>],
            <span class="js2-object-property">54</span>: [<span class="string">'6'</span>, <span class="string">'^'</span>],
            <span class="js2-object-property">55</span>: [<span class="string">'7'</span>, <span class="string">'&amp;'</span>],
            <span class="js2-object-property">56</span>: [<span class="string">'8'</span>, <span class="string">'*'</span>],
            <span class="js2-object-property">57</span>: [<span class="string">'9'</span>, <span class="string">'('</span>],
            <span class="js2-object-property">91</span>: <span class="string">'OS'</span>,
            <span class="js2-object-property">93</span>: <span class="string">'ContextMenu'</span>,
            <span class="js2-object-property">144</span>: <span class="string">'NumLock'</span>,
            <span class="js2-object-property">145</span>: <span class="string">'ScrollLock'</span>,
            <span class="js2-object-property">181</span>: <span class="string">'VolumeMute'</span>,
            <span class="js2-object-property">182</span>: <span class="string">'VolumeDown'</span>,
            <span class="js2-object-property">183</span>: <span class="string">'VolumeUp'</span>,
            <span class="js2-object-property">186</span>: [<span class="string">';'</span>, <span class="string">':'</span>],
            <span class="js2-object-property">187</span>: [<span class="string">'='</span>, <span class="string">'+'</span>],
            <span class="js2-object-property">188</span>: [<span class="string">','</span>, <span class="string">'&lt;'</span>],
            <span class="js2-object-property">189</span>: [<span class="string">'-'</span>, <span class="string">'_'</span>],
            <span class="js2-object-property">190</span>: [<span class="string">'.'</span>, <span class="string">'&gt;'</span>],
            <span class="js2-object-property">191</span>: [<span class="string">'/'</span>, <span class="string">'?'</span>],
            <span class="js2-object-property">192</span>: [<span class="string">'`'</span>, <span class="string">'~'</span>],
            <span class="js2-object-property">219</span>: [<span class="string">'['</span>, <span class="string">'{'</span>],
            <span class="js2-object-property">220</span>: [<span class="string">'\\'</span>, <span class="string">'|'</span>],
            <span class="js2-object-property">221</span>: [<span class="string">']'</span>, <span class="string">'}'</span>],
            <span class="js2-object-property">222</span>: [<span class="string">"'"</span>, <span class="string">'"'</span>],
            <span class="js2-object-property">224</span>: <span class="string">'Meta'</span>,
            <span class="js2-object-property">225</span>: <span class="string">'AltGraph'</span>,
            <span class="js2-object-property">246</span>: <span class="string">'Attn'</span>,
            <span class="js2-object-property">247</span>: <span class="string">'CrSel'</span>,
            <span class="js2-object-property">248</span>: <span class="string">'ExSel'</span>,
            <span class="js2-object-property">249</span>: <span class="string">'EraseEof'</span>,
            <span class="js2-object-property">250</span>: <span class="string">'Play'</span>,
            <span class="js2-object-property">251</span>: <span class="string">'ZoomOut'</span>
        };
        <span class="keyword">var</span> <span class="variable-name">i</span>;
        <span class="comment">// Function keys (F1-24).
</span>        <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (i = 1; i &lt; 25; i++) {
            <span class="jcXcovered">keycodes[111 + i] = </span><span class="string"><span class="jcXcovered">'F'</span></span><span class="jcXcovered"> + i;</span>
        }
        <span class="comment">// Printable ASCII characters.
</span>        <span class="keyword">var</span> <span class="variable-name">letter</span> = <span class="string"><span class="jcXcovered">''</span></span>;
        <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (i = 65; i &lt; 91; i++) {
            <span class="jcXcovered">letter = String.</span><span class="js2-function-call"><span class="jcXcovered">fromCharCode</span></span><span class="jcXcovered">(i);</span>
            <span class="jcXcovered">keycodes[i] = [letter.</span><span class="js2-function-call"><span class="jcXcovered">toLowerCase</span></span><span class="jcXcovered">(), letter.</span><span class="js2-function-call"><span class="jcXcovered">toUpperCase</span></span><span class="jcXcovered">()];</span>
        }
        <span class="keyword">var</span> <span class="variable-name">reversed_keycodes</span> = <span class="jcXcovered">{}</span>;
        <span class="jcXcovered">Obj</span>ect.<span class="js2-function-call">keys</span>(keycodes).<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">which</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_array</span>(keycodes[which])) {
                <span class="jcXcovered">key</span>codes[which].<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">key</span>) {
                    <span class="jcXcovered">reversed_keycodes[key.</span><span class="js2-function-call"><span class="jcXcovered">toUpperCase</span></span><span class="jcXcovered">()] = which;</span>
                });
            } <span class="keyword">else</span> {
                <span class="jcXcovered">reversed_keycodes[keycodes[which].</span><span class="js2-function-call"><span class="jcXcovered">toUpperCase</span></span><span class="jcXcovered">()] = which;</span>
            }
        });
        <span class="comment">// -----------------------------------------------------------------
</span>        <span class="keyword">var</span> <span class="variable-name">keymap</span>;
        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">default_keymap</span></span><span class="jcXcovered"> = </span>{
            <span class="js2-object-property">'ALT+D'</span>: <span class="js2-function-call">delete_word</span>(<span class="constant">true</span>),
            <span class="js2-object-property">'HOLD+ALT+D'</span>: <span class="js2-function-call">delete_word</span>(<span class="constant">true</span>),
            <span class="js2-object-property">'HOLD+DELETE'</span>: <span class="js2-function-call">delete_word</span>(<span class="constant">false</span>),
            <span class="js2-object-property">'HOLD+SHIFT+DELETE'</span>: <span class="js2-function-call">delete_word</span>(<span class="constant">false</span>),
            <span class="function-name">'ENTER'</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (history &amp;&amp; command &amp;&amp; <span class="negation-char">!</span>settings.<span class="js2-object-property">mask</span> &amp;&amp;
                    ((<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">historyFilter</span>) &amp;&amp;
                      settings.<span class="js2-function-call">historyFilter</span>(command)) ||
                     (settings.<span class="js2-object-property">historyFilter</span> <span class="keyword">instanceof</span> RegExp &amp;&amp;
                      command.<span class="js2-function-call">match</span>(settings.<span class="js2-object-property">historyFilter</span>)) ||
                     <span class="negation-char">!</span>settings.<span class="js2-object-property">historyFilter</span>)) {
                    <span class="jcXcovered">history.</span><span class="js2-function-call"><span class="jcXcovered">append</span></span><span class="jcXcovered">(command);</span>
                }
                <span class="keyword">var</span> <span class="variable-name">tmp</span> = <span class="jcXcovered">command</span>;
                <span class="jcXcovered">history.</span><span class="js2-function-call"><span class="jcXcovered">reset</span></span><span class="jcXcovered">();</span>

                <span class="comment">// for next input event on firefox/android with google keyboard
</span>                <span class="jcXcovered">prev_command = </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                <span class="jcXcovered">no_keydown = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>

                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                <span class="keyword">var</span> <span class="variable-name">promise</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">commands</span>) {
                    <span class="jcXcovered">promise = settings.</span><span class="js2-object-property"><span class="jcXcovered">commands</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, tmp);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(prompt)) {
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (promise &amp;&amp; <span class="js2-function-call">is_function</span>(promise.<span class="js2-object-property">then</span>)) {
                        <span class="jcXnot-covered">promise.</span><span class="js2-function-call"><span class="jcXnot-covered">then</span></span><span class="jcXnot-covered">(draw_prompt);</span>
                    } <span class="keyword">else</span> {
                        <span class="js2-function-call"><span class="jcXnot-covered">draw_prompt</span></span><span class="jcXnot-covered">();</span>
                    }
                }
                <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">val</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">'SHIFT+ENTER'</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">insert</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
            },
            <span class="js2-object-property">'BACKSPACE'</span>: backspace_key,
            <span class="js2-object-property">'SHIFT+BACKSPACE'</span>: backspace_key,
            <span class="function-name">'TAB'</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">insert</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\t'</span></span><span class="jcXcovered">);</span>
            },
            <span class="function-name">'CTRL+D'</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">self[</span><span class="string"><span class="jcXcovered">'delete'</span></span><span class="jcXcovered">](1);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">'DELETE'</span>: <span class="keyword">function</span>() {
                <span class="jcXnot-covered">self[</span><span class="string"><span class="jcXnot-covered">'delete'</span></span><span class="jcXnot-covered">](1);</span>
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
            },
            <span class="js2-object-property">'HOLD+ARROWUP'</span>: up_arrow,
            <span class="js2-object-property">'ARROWUP'</span>: up_arrow,
            <span class="js2-object-property">'CTRL+P'</span>: prev_history,
            <span class="js2-object-property">'ARROWDOWN'</span>: down_arrow,
            <span class="js2-object-property">'HOLD+ARROWDOWN'</span>: down_arrow,
            <span class="js2-object-property">'CTRL+N'</span>: next_history,
            <span class="js2-object-property">'ARROWLEFT'</span>: left,
            <span class="js2-object-property">'HOLD+ARROWLEFT'</span>: <span class="js2-function-call">debounce</span>(left, 10),
            <span class="js2-object-property">'CTRL+B'</span>: left,
            <span class="function-name">'CTRL+ARROWLEFT'</span>: <span class="keyword">function</span>() {
                <span class="comment">// jump to one character after last space before prevoius word
</span>                <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="jcXcovered">position - 1</span>;
                <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXcovered">0</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command[len] === <span class="string">' '</span>) {
                    <span class="jcXcovered">--len;</span>
                }
                <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">len</span>; i &gt; 0; --i) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command[i] === <span class="string">' '</span> &amp;&amp; command[i + 1] !== <span class="string">' '</span>) {
                        <span class="jcXcovered">pos = i + 1;</span>
                        <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (command[i] === <span class="string">'\n'</span> &amp;&amp;
                               command[i + 1] !== <span class="string">'\n'</span>) {
                        <span class="jcXnot-covered">pos = i;</span>
                        <span class="keyword"><span class="jcXnot-covered">break</span></span><span class="jcXnot-covered">;</span>
                    }
                }
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(pos);</span>
            },
            <span class="function-name">'CTRL+R'</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (reverse_search) {
                    <span class="js2-function-call"><span class="jcXnot-covered">reverse_history_search</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">backup_prompt = prompt;</span>
                    <span class="js2-function-call"><span class="jcXcovered">draw_reverse_prompt</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">last_command = command;</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">reverse_search = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">'CTRL+G'</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (reverse_search) {
                    <span class="jcXcovered">prompt = backup_prompt;</span>
                    <span class="js2-function-call"><span class="jcXcovered">draw_prompt</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(last_command);</span>
                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">reverse_search = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">rev_search_str = </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                }
            },
            <span class="js2-object-property">'ARROWRIGHT'</span>: right,
            <span class="js2-object-property">'HOLD+ARROWRIGHT'</span>: <span class="js2-function-call">debounce</span>(right, 10),
            <span class="js2-object-property">'CTRL+F'</span>: right,
            <span class="function-name">'CTRL+ARROWRIGHT'</span>: <span class="keyword">function</span>() {
                <span class="comment">// jump to beginning or end of the word
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command[position] === <span class="string">' '</span>) {
                    <span class="jcXcovered">++position;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="string"><span class="jcXcovered">/\S[\n\s]{2,}|[\n\s]+\S?/</span></span>;
                <span class="keyword">var</span> <span class="variable-name">match</span> = <span class="jcXcovered">command.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(position).</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(re)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>match || match[0].<span class="js2-function-call">match</span>(<span class="string">/^\s+$/</span>)) {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (match[0][0] !== <span class="string">' '</span>) {
                    <span class="jcXnot-covered">position += match.</span><span class="js2-object-property"><span class="jcXnot-covered">index</span></span><span class="jcXnot-covered"> + 1;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">position += match.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered"> + match[0].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1;</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (match[0][match[0].<span class="js2-object-property">length</span> - 1] !== <span class="string">' '</span>) {
                        <span class="jcXcovered">--position;</span>
                    }
                }
                <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
            },
            <span class="js2-object-property">'F12'</span>: return_true, <span class="comment">// Allow Firebug
</span>            <span class="js2-object-property">'END'</span>: <span class="js2-function-call">end</span>(<span class="constant">true</span>),
            <span class="js2-object-property">'CTRL+END'</span>: <span class="js2-function-call">end</span>(),
            <span class="js2-object-property">'CTRL+E'</span>: <span class="js2-function-call">end</span>(),
            <span class="js2-object-property">'HOME'</span>: <span class="js2-function-call">home</span>(<span class="constant">true</span>),
            <span class="js2-object-property">'CTRL+HOME'</span>: <span class="js2-function-call">home</span>(),
            <span class="js2-object-property">'CTRL+A'</span>: <span class="js2-function-call">home</span>(),
            <span class="js2-object-property">'SHIFT+INSERT'</span>: paste_event,
            <span class="js2-object-property">'CTRL+SHIFT+T'</span>: return_true, <span class="comment">// open closed tab
</span>            <span class="js2-object-property">'CTRL+W'</span>: <span class="js2-function-call">delete_word_backward</span>(<span class="constant">true</span>),
            <span class="js2-object-property">'HOLD+BACKSPACE'</span>: <span class="js2-function-call">delete_word_backward</span>(<span class="constant">false</span>),
            <span class="js2-object-property">'HOLD+SHIFT+BACKSPACE'</span>: <span class="js2-function-call">delete_word_backward</span>(<span class="constant">false</span>),
            <span class="function-name">'CTRL+H'</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (command !== <span class="string">''</span> &amp;&amp; position &gt; 0) {
                    <span class="jcXnot-covered">self[</span><span class="string"><span class="jcXnot-covered">'delete'</span></span><span class="jcXnot-covered">](-1);</span>
                }
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
            },
            <span class="js2-object-property">'CTRL+X'</span>: return_true,
            <span class="js2-object-property">'CTRL+C'</span>: return_true,
            <span class="js2-object-property">'CTRL+T'</span>: return_true,
            <span class="function-name">'CTRL+Y'</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (kill_text !== <span class="string">''</span>) {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">insert</span></span><span class="jcXcovered">(kill_text);</span>
                }
            },
            <span class="js2-object-property">'CTRL+V'</span>: paste_event,
            <span class="js2-object-property">'META+V'</span>: paste_event,
            <span class="function-name">'CTRL+K'</span>: <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (len &gt; position) {
                    <span class="jcXcovered">kill_text = self[</span><span class="string"><span class="jcXcovered">'delete'</span></span><span class="jcXcovered">](len - position);</span>
                    <span class="js2-function-call"><span class="jcXcovered">text_to_clipboard</span></span><span class="jcXcovered">(clip, kill_text);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">'CTRL+U'</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command !== <span class="string">''</span> &amp;&amp; position !== 0) {
                    <span class="jcXcovered">kill_text = self[</span><span class="string"><span class="jcXcovered">'delete'</span></span><span class="jcXcovered">](-position);</span>
                    <span class="js2-function-call"><span class="jcXcovered">text_to_clipboard</span></span><span class="jcXcovered">(clip, kill_text);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">'CTRL+TAB'</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
            },
            <span class="js2-object-property">'META+`'</span>: return_true, <span class="comment">// CMD+` switch browser window on Mac
</span>            <span class="js2-object-property">'META+R'</span>: return_true, <span class="comment">// CMD+R page reload in Chrome Mac
</span>            <span class="js2-object-property">'META+L'</span>: return_true <span class="comment">// CLD+L jump into Ominbox on Chrome Mac
</span>        };
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">delete_word</span>(<span class="js2-function-param">clipboard</span>) {
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span> <span class="function-name">delete_word</span>() {
                <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="string"><span class="jcXnot-covered">/ *[^ ]+ *(?= )|[^ ]+$/</span></span>;
                <span class="keyword">var</span> <span class="variable-name">substring</span> = <span class="jcXnot-covered">command.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(position)</span>;
                <span class="keyword">var</span> <span class="variable-name">m</span> = <span class="jcXnot-covered">substring.</span><span class="js2-function-call"><span class="jcXnot-covered">match</span></span><span class="jcXnot-covered">(re)</span>;
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (m) {
                    <span class="jcXnot-covered">kill_text = m[0];</span>
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (clipboard) {
                        <span class="js2-function-call"><span class="jcXnot-covered">text_to_clipboard</span></span><span class="jcXnot-covered">(clip, kill_text);</span>
                    }
                }
                <span class="jcXnot-covered">se</span>lf.<span class="js2-function-call">set</span>(
                    command.<span class="js2-function-call">slice</span>(0, position) +
                        command.<span class="js2-function-call">slice</span>(position).<span class="js2-function-call">replace</span>(re, <span class="string">''</span>),
                    <span class="constant">true</span>
                );
                <span class="comment">// chrome jump to address bar
</span>                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
            };
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">delete_word_backward</span>(<span class="js2-function-param">clipboard</span>) {
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span> <span class="function-name">delete_word_backward</span>() {
                <span class="comment">// don't work in Chromium (can't prevent close tab)
</span>                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (command !== <span class="string">''</span> &amp;&amp; position !== 0) {
                    <span class="keyword">var</span> <span class="variable-name">m</span> = <span class="jcXnot-covered">command.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(0, position).</span><span class="js2-function-call"><span class="jcXnot-covered">match</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/([^ ]* *$)/</span></span><span class="jcXnot-covered">)</span>;
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (m[0].<span class="js2-object-property">length</span>) {
                        <span class="jcXnot-covered">kill_text = self[</span><span class="string"><span class="jcXnot-covered">'delete'</span></span><span class="jcXnot-covered">](-m[0].</span><span class="js2-object-property"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered">);</span>
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (clipboard) {
                            <span class="js2-function-call"><span class="jcXnot-covered">text_to_clipboard</span></span><span class="jcXnot-covered">(clip, kill_text);</span>
                        }
                    }
                }
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
            };
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">return_true</span>() {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">paste_event</span>() {
            <span class="jcXnot-covered">clip.</span><span class="js2-function-call"><span class="jcXnot-covered">val</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">);</span>
            <span class="jcXnot-covered">paste_count = 0;</span>
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">isenabled</span>() &amp;&amp; <span class="negation-char">!</span>clip.<span class="js2-function-call">is</span>(<span class="string">':focus'</span>)) {
                <span class="jcXnot-covered">clip.</span><span class="js2-function-call"><span class="jcXnot-covered">trigger</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'focus'</span></span><span class="jcXnot-covered">, [</span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">]);</span>
            }
            <span class="jcXnot-covered">clip.</span><span class="js2-function-call"><span class="jcXnot-covered">one</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'input'</span></span><span class="jcXnot-covered">, paste);</span>
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Paste content to terminal using hidden textarea
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">paste</span>() {
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (paste_count++ &gt; 0) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
            }
            <span class="keyword">function</span> <span class="function-name">set</span>() {
                <span class="jcXnot-covered">clip.</span><span class="js2-function-call"><span class="jcXnot-covered">val</span></span><span class="jcXnot-covered">(command);</span>
                <span class="js2-function-call"><span class="jcXnot-covered">fix_textarea</span></span><span class="jcXnot-covered">();</span>
            }
            <span class="keyword">function</span> <span class="function-name">insert</span>(<span class="js2-function-param">text</span>) {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">insert</span></span><span class="jcXnot-covered">(text);</span>
                <span class="js2-function-call"><span class="jcXnot-covered">set</span></span><span class="jcXnot-covered">();</span>
            }
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">isenabled</span>()) {
                <span class="comment">//wait until Browser insert text to textarea
</span>                <span class="jcXnot-covered">sel</span>f.<span class="js2-function-call">oneTime</span>(100, <span class="keyword">function</span>() {
                    <span class="keyword">var</span> <span class="variable-name">value</span> = <span class="jcXnot-covered">clip.</span><span class="js2-function-call"><span class="jcXnot-covered">val</span></span><span class="jcXnot-covered">()</span>;
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onPaste</span>)) {
                        <span class="keyword">va</span><span class="keyword"><span class="jcXnot-covered">r</span></span><span class="jcXnot-covered"> </span><span class="variable-name"><span class="jcXnot-covered">ret</span></span><span class="jcXnot-covered"> = </span>settings.<span class="js2-object-property">onPaste</span>.<span class="js2-function-call">call</span>(self, {
                            <span class="js2-object-property">target</span>: self,
                            <span class="js2-object-property">text</span>: value
                        });
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (ret !== <span class="constant">undefined</span>) {
                            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (ret &amp;&amp; <span class="js2-function-call">is_function</span>(ret.<span class="js2-object-property">then</span>)) {
                                <span class="jcXnot-covered">ret.</span><span class="js2-function-call"><span class="jcXnot-covered">then</span></span><span class="jcXnot-covered">(insert);</span>
                            }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> ret === <span class="string">'string'</span>) {
                                <span class="js2-function-call"><span class="jcXnot-covered">insert</span></span><span class="jcXnot-covered">(ret);</span>
                            }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (ret === <span class="constant">false</span>) {
                                <span class="js2-function-call"><span class="jcXnot-covered">set</span></span><span class="jcXnot-covered">();</span>
                            }
                            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                        }
                    }
                    <span class="js2-function-call"><span class="jcXnot-covered">insert</span></span><span class="jcXnot-covered">(value);</span>
                });
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">prev_history</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (first_up_history) {
                <span class="jcXcovered">last_command = command;</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(history.</span><span class="js2-function-call"><span class="jcXcovered">current</span></span><span class="jcXcovered">());</span>
            } <span class="keyword">else</span> {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">set</span></span><span class="jcXnot-covered">(history.</span><span class="js2-function-call"><span class="jcXnot-covered">previous</span></span><span class="jcXnot-covered">());</span>
            }
            <span class="jcXcovered">first_up_history = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">next_history</span>() {
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(history.</span><span class="js2-function-call"><span class="jcXcovered">end</span></span><span class="jcXcovered">() ? last_command : history.</span><span class="js2-function-call"><span class="jcXcovered">next</span></span><span class="jcXcovered">());</span>
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">have_newlines</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\n/</span></span><span class="jcXcovered">);</span>
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">match_column</span>(<span class="js2-function-param">re</span>, <span class="js2-function-param">string</span>, <span class="js2-function-param">col</span>) {
            <span class="keyword">var</span> <span class="variable-name">match</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(re)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">have_newlines</span>(string)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> match &amp;&amp; match[1].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> &lt;= col;</span>
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> match &amp;&amp; match[1].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> &lt;= col - prompt_len;</span>
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">up_arrow</span>() {
            <span class="keyword">var</span> <span class="variable-name">before</span> = <span class="jcXcovered">command.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(0, position)</span>;
            <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="string"><span class="jcXcovered">/\n?([^\n]+)$/</span></span>;
            <span class="keyword">var</span> <span class="variable-name">col</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">column</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">have_newlines</span>(before)) {
                <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">before.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - col - 1</span>; i--;) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (before[i] === <span class="string">'\n'</span>) {
                        <span class="keyword"><span class="jcXnot-covered">break</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="keyword">var</span> <span class="variable-name">str</span> = <span class="jcXcovered">before.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(0, i)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">match_column</span>(re, str, col)) {
                        <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                    }
                }
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(i);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">prev_history</span></span><span class="jcXcovered">();</span>
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">down_arrow</span>() {
            <span class="keyword">var</span> <span class="variable-name">after</span> = <span class="jcXcovered">command.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(position)</span>;
            <span class="keyword">var</span> <span class="variable-name">col</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">column</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">have_newlines</span>(after)) {
                <span class="keyword">var</span> <span class="variable-name">before</span> = <span class="jcXcovered">command.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(0, position)</span>;
                <span class="keyword">var</span> <span class="variable-name">match</span> = <span class="jcXcovered">after.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^[^\n]*\n/</span></span><span class="jcXcovered">)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (match) {
                    <span class="keyword">var</span> <span class="variable-name">new_pos</span> = <span class="jcXcovered">col + match[0].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span><span class="js2-function-call">have_newlines</span>(before)) {
                        <span class="jcXcovered">new_pos += prompt_len;</span>
                    }
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(new_pos, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">next_history</span></span><span class="jcXcovered">();</span>
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">backspace_key</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (reverse_search) {
                <span class="jcXnot-covered">rev_search_str = rev_search_str.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(0, -1);</span>
                <span class="js2-function-call"><span class="jcXnot-covered">draw_reverse_prompt</span></span><span class="jcXnot-covered">();</span>
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (command !== <span class="string">''</span> &amp;&amp; position &gt; 0) {
                <span class="jcXcovered">self[</span><span class="string"><span class="jcXcovered">'delete'</span></span><span class="jcXcovered">](-1);</span>
            }
            <span class="comment">// for next input after naitve backspace
</span>            <span class="comment">// we need timeout because we don't want it to trigger
</span>            <span class="comment">// for current input but next one
</span>            <span class="jcXcovered">sel</span>f.<span class="js2-function-call">oneTime</span>(1, <span class="keyword">function</span>() {
                <span class="jcXcovered">no_keydown = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
            });
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">left</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position &gt; 0) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(-1, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">right</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position &lt; <span class="js2-function-call">text</span>(command).<span class="js2-object-property">length</span>) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(1, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">home</span>(<span class="js2-function-param">line</span>) {
            <span class="keyword">function</span> <span class="function-name">home</span>() {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(0);</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (line) {
                <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command.<span class="js2-function-call">match</span>(<span class="string">/\n/</span>)) {
                        <span class="keyword">var</span> <span class="variable-name">string</span> = <span class="jcXnot-covered">command.</span><span class="js2-function-call"><span class="jcXnot-covered">substring</span></span><span class="jcXnot-covered">(0, self.</span><span class="js2-function-call"><span class="jcXnot-covered">position</span></span><span class="jcXnot-covered">())</span>;
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">position</span></span><span class="jcXnot-covered">(string.</span><span class="js2-function-call"><span class="jcXnot-covered">lastIndexOf</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'\n'</span></span><span class="jcXnot-covered">) + 1);</span>
                    } <span class="keyword">else</span> {
                        <span class="js2-function-call"><span class="jcXcovered">home</span></span><span class="jcXcovered">();</span>
                    }
                };
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> home;</span>
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">end</span>(<span class="js2-function-param">line</span>) {
            <span class="keyword">function</span> <span class="function-name">end</span>() {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">);</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (line) {
                <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command.<span class="js2-function-call">match</span>(<span class="string">/\n/</span>)) {
                        <span class="keyword">var</span> <span class="variable-name">lines</span> = <span class="jcXnot-covered">command.</span><span class="js2-function-call"><span class="jcXnot-covered">split</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'\n'</span></span><span class="jcXnot-covered">)</span>;
                        <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">position</span></span><span class="jcXnot-covered">()</span>;
                        <span class="keyword">var</span> <span class="variable-name">sum</span> = <span class="jcXnot-covered">0</span>;
                        <span class="keyword"><span class="jcXnot-covered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXnot-covered">0</span>; i &lt; lines.<span class="js2-object-property">length</span>; ++i) {
                            <span class="jcXnot-covered">sum += lines[i].</span><span class="js2-object-property"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered">;</span>
                            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (sum &gt; pos) {
                                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">position</span></span><span class="jcXnot-covered">(sum + i);</span>
                                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                            }
                        }
                    }
                    <span class="js2-function-call"><span class="jcXcovered">end</span></span><span class="jcXcovered">();</span>
                };
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> end;</span>
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">mobile_focus</span>() {
            <span class="comment">//if (is_touch) {
</span>            <span class="keyword">var</span> <span class="variable-name">focus</span> = <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">is</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">':focus'</span></span><span class="jcXcovered">)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>focus) {
                    <span class="comment">//clip.trigger('focus', [true]);
</span>                }
                <span class="jcXcovered">sel</span>f.<span class="js2-function-call">oneTime</span>(10, <span class="keyword">function</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>clip.<span class="js2-function-call">is</span>(<span class="string">':focus'</span>) &amp;&amp; enabled) {
                        <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">trigger</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'focus'</span></span><span class="jcXcovered">, [</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">]);</span>
                    }
                });
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (focus &amp;&amp; (is_mobile || <span class="negation-char">!</span>enabled)) {
                <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">trigger</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'blur'</span></span><span class="jcXcovered">, [</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">]);</span>
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="comment">// fix for .cursor span animation that should only be applied when
</span>        <span class="comment">// animation is equal to terminal-blink
</span>        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">fix_cursor</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (animation_supported) {
                <span class="keyword">var</span> <span class="variable-name">style</span> = <span class="jcXnot-covered">window.</span><span class="js2-function-call"><span class="jcXnot-covered">getComputedStyle</span></span><span class="jcXnot-covered">(cursor[0])</span>;
                <span class="keyword">var</span> <span class="variable-name">animationName</span> = <span class="jcXnot-covered">style.</span><span class="js2-function-call"><span class="jcXnot-covered">getPropertyValue</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'--animation'</span></span><span class="jcXnot-covered">)</span>;
                <span class="jcXnot-covered">animationName = animationName.</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/^\s*|\s*$/g</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">);</span>
                <span class="keyword">var</span> <span class="variable-name">_class</span> = <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">attr</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'class'</span></span><span class="jcXnot-covered">)</span>;
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (_class.<span class="js2-function-call">match</span>(<span class="string">/-animation/</span>)) {
                    <span class="jcXnot-covered">_class = _class.</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/[a-z]+-animation/g</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">);</span>
                }
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (animationName &amp;&amp; <span class="negation-char">!</span>animationName.<span class="js2-function-call">match</span>(<span class="string">/blink/</span>)) {
                    <span class="keyword">var</span> <span class="variable-name">className</span> = <span class="jcXnot-covered">animationName.</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/terminal-/</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">) + </span><span class="string"><span class="jcXnot-covered">'-animation'</span></span>;
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>_class.<span class="js2-function-call">match</span>(className)) {
                        <span class="jcXnot-covered">_class += </span><span class="string"><span class="jcXnot-covered">' '</span></span><span class="jcXnot-covered"> + className;</span>
                    }
                }
                <span class="jcXnot-covered">_class = _class.</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/\s+/g</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">' '</span></span><span class="jcXnot-covered">);</span>
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (_class !== self.<span class="js2-function-call">attr</span>(<span class="string">'class'</span>).<span class="js2-function-call">replace</span>(<span class="string">/\s+/g</span>, <span class="string">' '</span>)) {
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">attr</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'class'</span></span><span class="jcXnot-covered">, _class);</span>
                }
            }
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="comment">// on mobile you can't delete character if input is empty (event
</span>        <span class="comment">// will not fire) so we fake text entry, we could just put dummy
</span>        <span class="comment">// data but we put real command and position
</span>        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">fix_textarea</span>(<span class="js2-function-param">position_only</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>self.<span class="js2-function-call">isenabled</span>()) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
            }
            <span class="comment">// delay worked while experimenting
</span>            <span class="jcXcovered">sel</span>f.<span class="js2-function-call">oneTime</span>(10, <span class="keyword">function</span>() {
                <span class="comment">// we use space before command to show select all context menu
</span>                <span class="comment">// idea taken from CodeMirror
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>is_mobile &amp;&amp; clip.<span class="js2-function-call">val</span>() !== command &amp;&amp; <span class="negation-char">!</span>position_only) {
                    <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">val</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered"> + command);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled) {
                    <span class="jcXcovered">sel</span>f.<span class="js2-function-call">oneTime</span>(10, <span class="keyword">function</span>() {
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="comment">// we check first to improve performance
</span>                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>is_mobile &amp;&amp; clip.<span class="js2-function-call">caret</span>() !== position + 1) {
                                <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">caret</span></span><span class="jcXcovered">(position + 1);</span>
                            }
                        } <span class="keyword">catch</span> (e) {
                            <span class="comment">// firefox throw NS_ERROR_FAILURE ignore
</span>                        }
                    });
                }
            });
        }
        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="comment">// terminal animation don't work on android because they animate
</span>        <span class="comment">// 2 properties
</span>        <span class="comment">// -------------------------------------------------------------------------------
</span>        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (animation_supported &amp;&amp; <span class="negation-char">!</span>is_android) {
            <span class="function-name"><span class="jcXnot-covered">an</span></span><span class="function-name">imation</span> = <span class="keyword">function</span>(<span class="js2-function-param">toggle</span>) {
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (toggle) {
                    <span class="jcXnot-covered">cursor.</span><span class="js2-function-call"><span class="jcXnot-covered">addClass</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'blink'</span></span><span class="jcXnot-covered">);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">cursor.</span><span class="js2-function-call"><span class="jcXnot-covered">removeClass</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'blink'</span></span><span class="jcXnot-covered">);</span>
                }
            };
            <span class="function-name"><span class="jcXnot-covered">re</span></span><span class="function-name">start_animation</span> = <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">new_cursor</span> = <span class="jcXnot-covered">cursor.</span><span class="js2-function-call"><span class="jcXnot-covered">clone</span></span><span class="jcXnot-covered">()</span>;
                <span class="jcXnot-covered">new_cursor.</span><span class="js2-function-call"><span class="jcXnot-covered">insertBefore</span></span><span class="jcXnot-covered">(cursor);</span>
                <span class="jcXnot-covered">cursor.</span><span class="js2-function-call"><span class="jcXnot-covered">remove</span></span><span class="jcXnot-covered">();</span>
                <span class="jcXnot-covered">cursor = new_cursor;</span>
            };
        } <span class="keyword">else</span> {
            <span class="keyword">var</span> <span class="variable-name">animating</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
            <span class="function-name"><span class="jcXcovered">an</span></span><span class="function-name">imation</span> = <span class="keyword">function</span>(<span class="js2-function-param">toggle</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (toggle &amp;&amp; <span class="negation-char">!</span>animating) {
                    <span class="jcXcovered">animating = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'inverted blink'</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">everyTime</span></span><span class="jcXcovered">(500, </span><span class="string"><span class="jcXcovered">'blink'</span></span><span class="jcXcovered">, blink);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (animating &amp;&amp; <span class="negation-char">!</span>toggle) {
                    <span class="jcXcovered">animating = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">stopTime</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'blink'</span></span><span class="jcXcovered">, blink);</span>
                    <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">removeClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'inverted blink'</span></span><span class="jcXcovered">);</span>
                }
            };
            <span class="function-name"><span class="jcXcovered">re</span></span><span class="function-name">start_animation</span> = <span class="keyword">function</span>() {
                <span class="js2-function-call"><span class="jcXcovered">animation</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">);</span>
                <span class="js2-function-call"><span class="jcXcovered">animation</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
            };
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Blinking cursor function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">blink</span>() {
            <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">toggleClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'inverted'</span></span><span class="jcXcovered">);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Set prompt for reverse search
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">draw_reverse_prompt</span>() {
            <span class="jcXcovered">prompt = </span><span class="string"><span class="jcXcovered">'(reverse-i-search)`'</span></span><span class="jcXcovered"> + rev_search_str + </span><span class="string"><span class="jcXcovered">"': "</span></span><span class="jcXcovered">;</span>
            <span class="js2-function-call"><span class="jcXcovered">draw_prompt</span></span><span class="jcXcovered">();</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Disable reverse search
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">clear_reverse_state</span>() {
            <span class="jcXcovered">prompt = backup_prompt;</span>
            <span class="jcXcovered">reverse_search = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            <span class="jcXcovered">reverse_search_position = </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
            <span class="jcXcovered">rev_search_str = </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Search through command line history. If next is not defined or
</span>        <span class="comment">// :: false it searches for the first item from the end. If true it
</span>        <span class="comment">// :: search for the next item
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">reverse_history_search</span>(<span class="js2-function-param">next</span>) {
            <span class="keyword">var</span> <span class="variable-name">history_data</span> = <span class="jcXcovered">history.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">()</span>;
            <span class="keyword">var</span> <span class="variable-name">regex</span>, <span class="variable-name">save_string</span>;
            <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="jcXcovered">history_data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (next &amp;&amp; reverse_search_position &gt; 0) {
                <span class="jcXnot-covered">len -= reverse_search_position;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (rev_search_str.<span class="js2-object-property">length</span> &gt; 0) {
                <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">j</span> = <span class="jcXcovered">rev_search_str.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>; j &gt; 0; j--) {
                    <span class="jcXcovered">save_string = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_regex</span></span><span class="jcXcovered">(rev_search_str.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, j));</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">caseSensitiveSearch</span>) {
                        <span class="jcXcovered">regex = </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">RegExp</span></span><span class="jcXcovered">(save_string);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXnot-covered">regex = </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">RegExp</span></span><span class="jcXnot-covered">(save_string, </span><span class="string"><span class="jcXnot-covered">'i'</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">len</span>; i--;) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (regex.<span class="js2-function-call">test</span>(history_data[i])) {
                            <span class="jcXcovered">reverse_search_position = history_data.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - i;</span>
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(history_data[i].</span><span class="js2-function-call"><span class="jcXcovered">indexOf</span></span><span class="jcXcovered">(save_string));</span>
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(history_data[i], </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                            <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (rev_search_str.<span class="js2-object-property">length</span> !== j) {
                                <span class="jcXnot-covered">rev_search_str = rev_search_str.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(0, j);</span>
                                <span class="js2-function-call"><span class="jcXnot-covered">draw_reverse_prompt</span></span><span class="jcXnot-covered">();</span>
                            }
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                        }
                    }
                }
            }
            <span class="jcXnot-covered">rev_search_str = </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">;</span> <span class="comment">// clear if not found any
</span>        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: calculate width of hte character
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">get_char_width</span>() {
            <span class="keyword">var</span> <span class="variable-name">$prompt</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.prompt'</span></span><span class="jcXcovered">)</span>;
            <span class="keyword">var</span> <span class="variable-name">html</span> = <span class="jcXcovered">$prompt.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">()</span>;
            <span class="jcXcovered">$prompt.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;span&gt;&amp;nbsp;&lt;/span&gt;'</span></span><span class="jcXcovered">);</span>
            <span class="keyword">var</span> <span class="variable-name">width</span> = <span class="jcXcovered">$prompt.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'span'</span></span><span class="jcXcovered">)[0].</span><span class="js2-function-call"><span class="jcXcovered">getBoundingClientRect</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">width</span></span>;
            <span class="jcXcovered">$prompt.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(html);</span>
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> width;</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: return number of characters in command line
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">get_num_chars</span>(<span class="js2-function-param">char_width</span>) {
            <span class="keyword">var</span> <span class="variable-name">width</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">width</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> Math.</span><span class="builtin"><span class="jcXcovered">floor</span></span><span class="jcXcovered">(width / char_width);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Split String that fit into command line where first line need to
</span>        <span class="comment">// :: fit next to prompt (need to have less characters)
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">get_splitted_command_line</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword">function</span> <span class="function-name">split</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_equal</span></span><span class="jcXcovered">(string, num_chars);</span>
            }
            <span class="keyword">function</span> <span class="function-name">skip_empty</span>(<span class="js2-function-param">array</span>) {
                <span class="comment">// we remove lines that are leftovers after adding space at the end
</span>                <span class="keyword"><span class="jcXnot-covered">ret</span></span><span class="keyword">urn</span> array.<span class="js2-function-call">filter</span>(<span class="keyword">function</span>(<span class="js2-function-param">line</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="negation-char"><span class="jcXnot-covered">!</span></span><span class="jcXnot-covered">$.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">strip</span></span><span class="jcXnot-covered">(line).</span><span class="js2-function-call"><span class="jcXnot-covered">match</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/^ $/</span></span><span class="jcXnot-covered">);</span>
                });
            }
            <span class="keyword">var</span> <span class="variable-name">line</span> = <span class="jcXcovered">prompt_node.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.line'</span></span><span class="jcXcovered">)</span>;
            <span class="keyword">var</span> <span class="variable-name">prompt</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (line.<span class="js2-object-property">length</span>) {
                <span class="jcXnot-covered">prompt = line.</span><span class="js2-function-call"><span class="jcXnot-covered">nextUntil</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'.line'</span></span><span class="jcXnot-covered">).</span><span class="js2-function-call"><span class="jcXnot-covered">text</span></span><span class="jcXnot-covered">();</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">prompt = prompt_node.</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">();</span>
            }
            <span class="jcXcovered">prompt = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_brackets</span></span><span class="jcXcovered">(prompt);</span>
            <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">RegExp</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'^'</span></span><span class="jcXcovered"> + $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_regex</span></span><span class="jcXcovered">(prompt))</span>;
            <span class="keyword">var</span> <span class="variable-name">array</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">match</span>(<span class="string">/\n/</span>)) {
                <span class="keyword">var</span> <span class="variable-name">tmp</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">)</span>;
                <span class="keyword">var</span> <span class="variable-name">first_len</span> = <span class="jcXcovered">num_chars - prompt_len - 1</span>;
                <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>; i &lt; tmp.<span class="js2-object-property">length</span> - 1; ++i) {
                    <span class="jcXcovered">tmp[i] += line_marker;</span>
                }
                <span class="comment">// split first line
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">strlen</span>(tmp[0]) &gt; first_len) {
                    <span class="jcXnot-covered">array = </span><span class="js2-function-call"><span class="jcXnot-covered">split</span></span><span class="jcXnot-covered">(prompt + tmp[0]);</span>
                    <span class="jcXnot-covered">array[0] = array[0].</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(re, </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">);</span>
                    <span class="jcXnot-covered">array = </span><span class="js2-function-call"><span class="jcXnot-covered">skip_empty</span></span><span class="jcXnot-covered">(array);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">array = [tmp[0]];</span>
                }
                <span class="comment">// process rest of the lines
</span>                <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (i = 1; i &lt; tmp.<span class="js2-object-property">length</span>; ++i) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">strlen</span>(tmp[i]) &gt; num_chars) {
                        <span class="keyword">var</span> <span class="variable-name">splitted</span> = <span class="js2-function-call"><span class="jcXnot-covered">split</span></span><span class="jcXnot-covered">(tmp[i])</span>;
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (i &lt; tmp.<span class="js2-object-property">length</span> - 1) {
                            <span class="jcXnot-covered">splitted = </span><span class="js2-function-call"><span class="jcXnot-covered">skip_empty</span></span><span class="jcXnot-covered">(splitted);</span>
                        }
                        <span class="jcXnot-covered">array = array.</span><span class="js2-function-call"><span class="jcXnot-covered">concat</span></span><span class="jcXnot-covered">(splitted);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">array.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(tmp[i]);</span>
                    }
                }
            } <span class="keyword">else</span> {
                <span class="jcXcovered">array = </span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(prompt + string, num_chars);</span>
                <span class="jcXcovered">array[0] = array[0].</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(re, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
            }
            <span class="comment">// fix issue with cursor that was cut off #379
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (array.<span class="js2-object-property">length</span> &gt; 1 &amp;&amp; array[array.<span class="js2-object-property">length</span> - 1].<span class="js2-object-property">length</span> === num_chars) {
                <span class="jcXnot-covered">array.</span><span class="js2-function-call"><span class="jcXnot-covered">push</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">);</span>
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> array;</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: use custom formatting
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">formatting</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">skip_formatted_position</span>) {
            <span class="comment">// we don't want to format command when user type formatting in
</span>            <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                <span class="jcXcovered">string = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_formatting</span></span><span class="jcXcovered">(string);</span>
                <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">options</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>({}, settings, {
                    <span class="js2-object-property">unixFormattingEscapeBrackets</span>: <span class="constant">true</span>,
                    <span class="js2-object-property">position</span>: position
                });
                <span class="keyword">var</span> <span class="variable-name">formatted</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">apply_formatters</span></span><span class="jcXcovered">(string, options)</span>;
                <span class="keyword">var</span> <span class="variable-name">output</span> = <span class="jcXcovered">formatted[0]</span>;
                <span class="keyword">var</span> <span class="variable-name">max</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(output)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>skip_formatted_position) {
                    <span class="jcXcovered">formatted_position = formatted[1];</span>
                    <span class="comment">// fix issue with nested formatting where max length
</span>                    <span class="comment">// is checked before nested_formatting flatten formatting
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (formatted_position &gt; max) {
                        <span class="jcXnot-covered">formatted_position = max;</span>
                    }
                }
                <span class="jcXcovered">output = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">normalize</span></span><span class="jcXcovered">(output);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> output;</span>
            } <span class="keyword">catch</span> (e) {
                <span class="js2-function-call"><span class="jcXnot-covered">alert_exception</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'[Formatting]'</span></span><span class="jcXnot-covered">, e.</span><span class="js2-object-property"><span class="jcXnot-covered">stack</span></span><span class="jcXnot-covered">);</span>
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> string;</span>
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: format and encode the string
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">format</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">before</span>) {
            <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">encoded</span></span><span class="jcXcovered"> = </span>$.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">encode</span>(<span class="js2-function-call">wrap</span>(string), {
                <span class="js2-object-property">tabs</span>: settings.<span class="js2-object-property">tabs</span>,
                <span class="js2-object-property">before</span>: before
            });
            <span class="jcXcovered">str</span>ing = $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">format</span>(encoded, {
                <span class="js2-object-property">char_width</span>: settings.<span class="js2-object-property">char_width</span>
            });
            <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="string"><span class="jcXcovered">/(&lt;span[^&gt;]+data-text[^&gt;]+&gt;)(.*?)(&lt;\/span&gt;)/g</span></span>;
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(re, </span><span class="string"><span class="jcXcovered">'$1&lt;span&gt;$2&lt;/span&gt;$3'</span></span><span class="jcXcovered">);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: function create new string with all characters in it's own
</span>        <span class="comment">// :: formatting - it will only have style if the input is formatting
</span>        <span class="comment">// :: this function is not very usefull so it's not in $.terminal
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">wrap</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword">function</span> <span class="function-name">formatting</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">is_formatting</span>(string)) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">match</span>(<span class="string">/\\]$/</span>)) {
                        <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\\]/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'\\\\]'</span></span><span class="jcXcovered">);</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">match</span>(<span class="string">/\\$/</span>)) {
                        <span class="jcXcovered">string += </span><span class="string"><span class="jcXcovered">'\\'</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="jcXcovered">string = </span><span class="string"><span class="jcXcovered">'[[;;]'</span></span><span class="jcXcovered"> + string + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
            }
            <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(string)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (len === 1) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">formatting</span></span><span class="jcXcovered">(string);</span>
            }
            <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">[]</span>;
            <span class="comment">// len - 1 break the command line $.terminal.substring will return
</span>            <span class="comment">// empty string for out of bound indexes
</span>            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>; i &lt; len; ++i) {
                <span class="keyword">var</span> <span class="variable-name">text</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, i, i + 1)</span>;
                <span class="jcXcovered">result.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">formatting</span></span><span class="jcXcovered">(text));</span>
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result.</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: shortcut helpers
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">length</span>(<span class="js2-function-param">str</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(str);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">substring</span>(<span class="js2-function-param">str</span>, <span class="js2-function-param">start</span>, <span class="js2-function-param">end</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(str, start, end);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Function that displays the command line. Split long lines and
</span>        <span class="comment">// :: place cursor in the right place
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">redraw</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
            <span class="keyword">var</span> <span class="variable-name">before</span> = <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">prev</span></span><span class="jcXcovered">()</span>;
            <span class="keyword">var</span> <span class="variable-name">after</span> = <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">next</span></span><span class="jcXcovered">()</span>;
            <span class="keyword">var</span> <span class="variable-name">cursor_line</span> = <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">parent</span></span><span class="jcXcovered">()</span>;
            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="comment">// :: Draw line with the cursor
</span>            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">draw_cursor_line</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">options</span>) {
                <span class="keyword">var</span> <span class="variable-name">end_line</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(line_marker_re)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (end_line) {
                    <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(line_marker_re, </span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">);</span>
                }
                <span class="keyword">var</span> <span class="variable-name">cursor_end_line</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
                <span class="keyword">var</span> <span class="variable-name">setting</span><span class="variable-name"><span class="jcXcovered">s</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>({
                    <span class="js2-object-property">prompt</span>: <span class="string">''</span>,
                    <span class="js2-object-property">last</span>: <span class="constant">false</span>
                }, options);
                <span class="keyword">var</span> <span class="variable-name">position</span> = <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">position</span></span>;
                <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(string)</span>;
                <span class="keyword">var</span> <span class="variable-name">prompt</span> = <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ch_unit_bug) {
                    <span class="jcXnot-covered">cursor.</span><span class="js2-function-call"><span class="jcXnot-covered">width</span></span><span class="jcXnot-covered">(char_width);</span>
                }
                <span class="keyword">var</span> <span class="variable-name">c</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position === len) {
                    <span class="jcXcovered">before.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(string));</span>
                    <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;'</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">after.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (position === 0) {
                    <span class="jcXcovered">before.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">c = </span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, 0, 1);</span>
                    <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(c));</span>
                    <span class="jcXcovered">after.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, 1), prompt + c));</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">before_str</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, 0, position)</span>;
                    <span class="jcXcovered">before.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(before_str, prompt));</span>
                    <span class="jcXcovered">c = </span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, position, position + 1);</span>
                    <span class="keyword">var</span> <span class="variable-name">c_before</span> = <span class="jcXcovered">(prompt + before_str).</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^.*\t/</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">)</span>;
                    <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(c, c_before));</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position === len - 1) {
                        <span class="jcXcovered">cursor_end_line = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                        <span class="jcXcovered">after.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (c.<span class="js2-function-call">match</span>(<span class="string">/\t/</span>)) {
                            <span class="jcXcovered">c_before = </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">c_before += c;</span>
                        }
                        <span class="jcXcovered">after.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, position + 1), c_before));</span>
                    }
                }
                <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">toggleClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'end-line'</span></span><span class="jcXcovered">, cursor_end_line);</span>
                <span class="comment">// fix for animation when changing --animation dynamically
</span>                <span class="js2-function-call"><span class="jcXcovered">fix_cursor</span></span><span class="jcXcovered">();</span>
                <span class="keyword">var</span> <span class="variable-name">cursor_len</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(cursor.</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">())</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (cursor_len &gt; 1) {
                    <span class="keyword">var</span> <span class="variable-name">node</span> = <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'[data-text]'</span></span><span class="jcXcovered">)[0]</span>;
                    <span class="jcXcovered">node.</span><span class="js2-object-property"><span class="jcXcovered">style</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">setProperty</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'--length'</span></span><span class="jcXcovered">, cursor_len);</span>
                }
                <span class="comment">// synchronize css animations (it's not that important because if user
</span>                <span class="comment">// will change animation she should disable animation on span, but it
</span>                <span class="comment">// looks nicer until she disable that inner animation)
</span>                <span class="js2-function-call"><span class="jcXcovered">restart_animation</span></span><span class="jcXcovered">();</span>
            }
            <span class="keyword">function</span> <span class="function-name">div</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">before</span>) {
                <span class="keyword">var</span> <span class="variable-name">end_line</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(line_marker_re)</span>;
                <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="string"><span class="jcXcovered">'&lt;div role="presentation" aria-hidden="true"'</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (end_line) {
                    <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(line_marker_re, </span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">' class="end-line"'</span></span><span class="jcXcovered">;</span>
                }
                <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">'&gt;'</span></span><span class="jcXcovered"> + </span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(string, before || </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">) + </span><span class="string"><span class="jcXcovered">'&lt;/div&gt;'</span></span><span class="jcXcovered">;</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
            }
            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="comment">// :: Display lines after the cursor
</span>            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">lines_after</span>(<span class="js2-function-param">lines</span>) {
                <span class="keyword">var</span> <span class="variable-name">last_ins</span> = <span class="jcXcovered">cursor_line</span>;
                <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">ach</span>(lines, <span class="keyword">function</span>(<span class="js2-function-param">i</span>, <span class="js2-function-param">line</span>) {
                    <span class="jcXcovered">last_ins = </span><span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">div</span></span><span class="jcXcovered">(line)).</span><span class="js2-function-call"><span class="jcXcovered">insertAfter</span></span><span class="jcXcovered">(last_ins);</span>
                });
            }
            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="comment">// :: Display lines before the cursor
</span>            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">lines_before</span>(<span class="js2-function-param">lines</span>) {
                <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">ach</span>(lines, <span class="keyword">function</span>(<span class="js2-function-param">i</span>, <span class="js2-function-param">line</span>) {
                    <span class="jcXcovered">cursor_line.</span><span class="js2-function-call"><span class="jcXcovered">before</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">div</span></span><span class="jcXcovered">(line, i === 0 ? prompt_last_line : </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">));</span>
                });
            }
            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="comment">// :: Redraw function
</span>            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">string</span>;
                <span class="keyword"><span class="jcXcovered">s</span></span><span class="keyword">witch</span> (<span class="keyword">typeof</span> settings.<span class="js2-object-property">mask</span>) {
                    <span class="keyword">case</span> <span class="string">'boolean'</span>:
                        <span class="jcXcovered">string = settings.</span><span class="js2-object-property"><span class="jcXcovered">mask</span></span><span class="jcXcovered"> ? command.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/./g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'*'</span></span><span class="jcXcovered">) : command;</span>
                        <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                    <span class="keyword">case</span> <span class="string">'string'</span>:
                        <span class="jcXcovered">string = command.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/./g</span></span><span class="jcXcovered">, settings.</span><span class="js2-object-property"><span class="jcXcovered">mask</span></span><span class="jcXcovered">);</span>
                        <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">formatted</span> = <span class="js2-function-call"><span class="jcXcovered">formatting</span></span><span class="jcXcovered">(string)</span>;
                <span class="keyword">var</span> <span class="variable-name">pos</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">length</span>(formatted) === <span class="js2-function-call">text</span>(string).<span class="js2-object-property">length</span>) {
                    <span class="jcXcovered">pos = position;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">pos = formatted_position;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">i</span>;
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'div:not(.cursor-line,.clipboard-wrapper)'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'visibility'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'hidden'</span></span><span class="jcXcovered">);</span>
                <span class="jcXcovered">before.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                <span class="comment">// long line
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">strlen</span>(<span class="js2-function-call">text</span>(formatted)) &gt; num_chars - prompt_len - 1 ||
                    formatted.<span class="js2-function-call">match</span>(<span class="string">/\n/</span>)) {
                    <span class="keyword">var</span> <span class="variable-name">tabs</span> = <span class="jcXcovered">formatted.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\t/g</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword">var</span> <span class="variable-name">original_string</span> = <span class="jcXcovered">formatted</span>;
                    <span class="comment">//quick tabulation hack
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (tabs) {
                        <span class="jcXcovered">formatted = formatted.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\t/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'\x00\x00\x00\x00'</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword">var</span> <span class="variable-name">array</span> = <span class="js2-function-call"><span class="jcXcovered">get_splitted_command_line</span></span><span class="jcXcovered">(formatted)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (tabs) {
                        <span class="jcXcovered">arr</span>ay = $.<span class="js2-function-call">map</span>(array, <span class="keyword">function</span>(<span class="js2-function-param">line</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> line.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\x00\x00\x00\x00/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'\t'</span></span><span class="jcXcovered">);</span>
                        });
                    }
                    <span class="keyword">var</span> <span class="variable-name">first_len</span> = <span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(array[0])</span>;
                    <span class="comment">//cursor in first line
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (first_len === 0 &amp;&amp; array.<span class="js2-object-property">length</span> === 1) {
                        <span class="comment">// skip empty line
</span>                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (pos &lt; first_len) {
                        <span class="js2-function-call"><span class="jcXcovered">dra</span></span><span class="js2-function-call">w_cursor_line</span>(array[0], {
                            <span class="js2-object-property">length</span>: array.<span class="js2-object-property">length</span>,
                            <span class="js2-object-property">position</span>: pos,
                            <span class="js2-object-property">prompt</span>: prompt_last_line
                        });
                        <span class="js2-function-call"><span class="jcXcovered">lines_after</span></span><span class="jcXcovered">(array.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(1));</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (pos === first_len) {
                        <span class="comment">// first char acter of second line
</span>                        <span class="jcXcovered">cursor_line.</span><span class="js2-function-call"><span class="jcXcovered">before</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">div</span></span><span class="jcXcovered">(array[0], prompt_last_line));</span>
                        <span class="js2-function-call"><span class="jcXcovered">dra</span></span><span class="js2-function-call">w_cursor_line</span>(array[1] || <span class="string">''</span>, {
                            <span class="js2-object-property">length</span>: array.<span class="js2-object-property">length</span>,
                            <span class="js2-object-property">position</span>: 0,
                            <span class="js2-object-property">last</span>: array.<span class="js2-object-property">length</span> &lt;= 2
                        });
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (array.<span class="js2-object-property">length</span> &gt; 2) {
                            <span class="js2-function-call"><span class="jcXcovered">lines_after</span></span><span class="jcXcovered">(array.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(2));</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="keyword">var</span> <span class="variable-name">last</span> = <span class="jcXcovered">array.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(-1)[0]</span>;
                        <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(original_string)</span>;
                        <span class="keyword">var</span> <span class="variable-name">from_last</span> = <span class="jcXcovered">len - pos</span>;
                        <span class="keyword">var</span> <span class="variable-name">last_len</span> = <span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(last)</span>;
                        <span class="keyword">var</span> <span class="variable-name">new_pos</span> = <span class="jcXcovered">0</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (from_last === -1) {
                            <span class="jcXnot-covered">from_last = 0;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (from_last &lt;= last_len) { <span class="comment">// in last line
</span>                            <span class="js2-function-call"><span class="jcXcovered">lines_before</span></span><span class="jcXcovered">(array.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, -1));</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (last_len === from_last) {
                                <span class="jcXcovered">new_pos = 0;</span>
                            } <span class="keyword">else</span> {
                                <span class="jcXcovered">new_pos = last_len - from_last;</span>
                            }
                            <span class="js2-function-call"><span class="jcXcovered">dra</span></span><span class="js2-function-call">w_cursor_line</span>(last, {
                                <span class="js2-object-property">length</span>: array.<span class="js2-object-property">length</span>,
                                <span class="js2-object-property">position</span>: new_pos,
                                <span class="js2-object-property">last</span>: <span class="constant">true</span>
                            });
                        } <span class="keyword">else</span> {
                            <span class="comment">// more lines, cursor in the middle
</span>                            <span class="keyword">var</span> <span class="variable-name">line_index</span>;
                            <span class="keyword">var</span> <span class="variable-name">current</span>;
                            <span class="jcXcovered">new_pos = pos;</span>
                            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (i = 0; i &lt; array.<span class="js2-object-property">length</span>; ++i) {
                                <span class="keyword">var</span> <span class="variable-name">current_len</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(array[i])</span>;
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (new_pos &gt; current_len) {
                                    <span class="jcXcovered">new_pos -= current_len;</span>
                                } <span class="keyword">else</span> {
                                    <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                                }
                            }
                            <span class="jcXcovered">current = array[i];</span>
                            <span class="jcXcovered">line_index = i;</span>
                            <span class="comment">// cursor on first character in line
</span>                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (new_pos === <span class="js2-function-call">length</span>(current)) {
                                <span class="jcXcovered">new_pos = 0;</span>
                                <span class="jcXcovered">current = array[++line_index];</span>
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (current === <span class="constant">undefined</span>) {
                                    <span class="comment">//should never happen
</span>                                    <span class="keyword">var</span> <span class="variable-name">msg</span> = <span class="jcXnot-covered">$.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">defaults</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">redrawError</span></span>;
                                    <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(msg);</span>
                                }
                            }
                            <span class="js2-function-call"><span class="jcXcovered">dra</span></span><span class="js2-function-call">w_cursor_line</span>(current, {
                                <span class="js2-object-property">length</span>: array.<span class="js2-object-property">length</span>,
                                <span class="js2-object-property">position</span>: new_pos
                            });
                            <span class="js2-function-call"><span class="jcXcovered">lines_before</span></span><span class="jcXcovered">(array.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, line_index));</span>
                            <span class="js2-function-call"><span class="jcXcovered">lines_after</span></span><span class="jcXcovered">(array.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(line_index + 1));</span>
                        }
                    }
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cursor-line ~ div:last-of-type'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">append</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;span&gt;&lt;/span&gt;'</span></span><span class="jcXcovered">);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (formatted === <span class="string">''</span>) {
                    <span class="jcXcovered">before.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">cursor.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;span&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;'</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">after.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXcovered">dra</span></span><span class="js2-function-call">w_cursor_line</span>(formatted, {
                        <span class="js2-object-property">length</span>: 1,
                        <span class="js2-object-property">position</span>: pos
                    });
                }
                <span class="keyword">var</span> <span class="variable-name">in_line</span> = <span class="jcXcovered">cursor_line.</span><span class="js2-function-call"><span class="jcXcovered">prevUntil</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.prompt'</span></span><span class="jcXcovered">).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (is_css_variables_supported) {
                    <span class="jcXnot-covered">self[0].</span><span class="js2-object-property"><span class="jcXnot-covered">style</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">setProperty</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'--cursor-line'</span></span><span class="jcXnot-covered">, in_line);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'top'</span></span><span class="jcXcovered">, in_line * 14 + </span><span class="string"><span class="jcXcovered">'px'</span></span><span class="jcXcovered">);</span>
                }
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'visibility'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
            };
        })();
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: find position that match display position for commands that
</span>        <span class="comment">// :: change length by formatters
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">find_position</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
            <span class="keyword">function</span> <span class="function-name">cmp</span>(<span class="js2-function-param">search_pos</span>, <span class="js2-function-param">pos</span>) {
                <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">opts</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>({}, settings, {
                    <span class="js2-object-property">position</span>: pos
                });
                <span class="keyword">var</span> <span class="variable-name">guess</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">apply_formatters</span></span><span class="jcXcovered">(command, opts)[1]</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (guess === search_pos) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> 0;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (guess &lt; search_pos) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> 1;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> -1;</span>
                }
            }
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">formatted_position</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (formatted_position === 0) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> 0;</span>
                }
                <span class="jcXcovered">string = </span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(string);</span>
                <span class="keyword">var</span> <span class="variable-name">codepoint_len</span> = <span class="jcXcovered">string.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="js2-function-call"><span class="jcXcovered">binary_search</span></span><span class="jcXcovered">(0, codepoint_len, formatted_position, cmp)</span>;
                <span class="keyword">var</span> <span class="variable-name">chars</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_characters</span></span><span class="jcXcovered">(string)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (codepoint_len &gt; chars.<span class="js2-object-property">length</span>) {
                    <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="jcXcovered">0</span>;
                    <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>; i &lt; chars.<span class="js2-object-property">length</span>; ++i) {
                        <span class="jcXcovered">len += chars[i].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (len &gt;= pos) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> len;</span>
                        }
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> pos;</span>
            };
        })();
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Draw prompt that can be a function or a string
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">var</span> <span class="variable-name">prev_prompt_data</span>;
        <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">draw_prompt</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
            <span class="keyword">function</span> <span class="function-name">set</span>(<span class="js2-function-param">prompt</span>) {
                <span class="jcXcovered">prompt = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">apply_formatters</span></span><span class="jcXcovered">(prompt, {});</span>
                <span class="jcXcovered">prompt = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">normalize</span></span><span class="jcXcovered">(prompt);</span>
                <span class="jcXcovered">prompt = </span><span class="js2-function-call"><span class="jcXcovered">crlf</span></span><span class="jcXcovered">(prompt);</span>
                <span class="jcXcovered">last_rendered_prompt = prompt;</span>
                <span class="keyword">var</span> <span class="variable-name">lines</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_equal</span></span><span class="jcXcovered">(prompt, num_chars)</span>;
                <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">options</span></span><span class="jcXcovered"> = </span>{
                    <span class="js2-object-property">char_width</span>: settings.<span class="js2-object-property">char_width</span>
                };
                <span class="jcXcovered">prompt_last_line = lines[lines.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1];</span>
                <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">encoded_last_line</span></span><span class="jcXcovered"> = </span>$.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">encode</span>(lines[lines.<span class="js2-object-property">length</span> - 1], {
                    <span class="js2-object-property">tabs</span>: settings.<span class="js2-object-property">tabs</span>
                });
                <span class="keyword">var</span> <span class="variable-name">last_line</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(encoded_last_line, options)</span>;
                <span class="keyword">var</span> <span class="variable-name">formatted</span> = <span class="jcXcovered">lines.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, -1</span>).<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">line</span>) {
                    <span class="jcXnot-covered">lin</span>e = $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">encode</span>(line, {
                        <span class="js2-object-property">tabs</span>: settings.<span class="js2-object-property">tabs</span>
                    });
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">'&lt;span </span></span><span class="string">class="line"&gt;'</span> +
                        $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">format</span>(line, options) +
                        <span class="string">'&lt;/span&gt;'</span>;
                }).<span class="js2-function-call">concat</span>([last_line]).<span class="js2-function-call">join</span>(<span class="string">'\n'</span>);
                <span class="comment">// update prompt if changed
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (prompt_node.<span class="js2-function-call">html</span>() !== formatted) {
                    <span class="jcXcovered">prompt_node.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(formatted);</span>
                    <span class="jcXcovered">prompt_len = </span><span class="js2-function-call"><span class="jcXcovered">strlen</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(encoded_last_line));</span>
                }
            }
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                <span class="comment">// the data is used as cancelable reference because we have ref
</span>                <span class="comment">// data object that is hold in closure and we remove `set` function
</span>                <span class="comment">// so previous call to function prompt will be ignored
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (prev_prompt_data &amp;&amp; prev_prompt_data.<span class="js2-object-property">set</span>) {
                    <span class="jcXcovered">prev_prompt_data.</span><span class="js2-object-property"><span class="jcXcovered">set</span></span><span class="jcXcovered"> = $.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span><span class="jcXcovered">;</span>
                    <span class="comment">// remove reference for garbage collector
</span>                    <span class="jcXcovered">prev_prompt_data = </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">s</span></span><span class="keyword">witch</span> (<span class="keyword">typeof</span> prompt) {
                    <span class="keyword">case</span> <span class="string">'string'</span>:
                        <span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(prompt);</span>
                        <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                    <span class="keyword">case</span> <span class="string">'function'</span>:
                        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">data</span></span><span class="jcXcovered"> = </span>prev_prompt_data = {
                            <span class="js2-object-property">set</span>: set
                        };
                        <span class="jcXcovered">pro</span>mpt.<span class="js2-function-call">call</span>(self, <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                            <span class="jcXcovered">data.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(string);</span>
                        });
                        <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                }
            };
        })();
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">fire_change_command</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onCommandChange</span>)) {
                <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">onCommandChange</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, command);</span>
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">clean</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/((?!\\).)\\(?:&amp;#93;|])/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'$1&amp;#93;'</span></span><span class="jcXcovered">);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Command Line Methods
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">xtend</span>(self, {
            <span class="function-name">option</span>: <span class="keyword">function</span>(<span class="js2-function-param">name</span>, <span class="js2-function-param">value</span>) {
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> value === <span class="string">'undefined'</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> settings[name];</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">settings[name] = value;</span>
                }
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self;</span>
            },
            <span class="function-name">name</span>: <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string !== <span class="constant">undefined</span>) {
                    <span class="jcXcovered">name = string;</span>
                    <span class="keyword">var</span> <span class="variable-name">enabled</span> = <span class="jcXcovered">history &amp;&amp; history.</span><span class="js2-function-call"><span class="jcXcovered">enabled</span></span><span class="jcXcovered">() || </span><span class="negation-char"><span class="jcXcovered">!</span></span><span class="jcXcovered">history</span>;
                    <span class="jcXcovered">hi</span>story = <span class="keyword">new</span> <span class="js2-function-call">History</span>(
                        name,
                        settings.<span class="js2-object-property">historySize</span>,
                        settings.<span class="js2-object-property">history</span> === <span class="string">'memory'</span>
                    );
                    <span class="comment">// disable new history if old was disabled
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>enabled) {
                        <span class="jcXcovered">history.</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> name;</span>
                }
            },
            <span class="function-name">purge</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">history.</span><span class="js2-function-call"><span class="jcXcovered">clear</span></span><span class="jcXcovered">();</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="function-name">history</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> history;</span>
            },
            <span class="function-name">'delete'</span>: <span class="keyword">function</span>(<span class="js2-function-param">n</span>, <span class="js2-function-param">stay</span>) {
                <span class="keyword">var</span> <span class="variable-name">removed</span>, <span class="variable-name">string</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (n === 0) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">""</span></span><span class="jcXnot-covered">;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (n &lt; 0) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position &gt; 0) {
                        <span class="comment">// this may look weird but if n is negative we need
</span>                        <span class="comment">// to use +
</span>                        <span class="jcXcovered">removed = command.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, position).</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(n);</span>
                        <span class="jcXcovered">string = </span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command);</span>
                        <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, position + n) +
 </span>                           string.<span class="js2-function-call">slice</span>(position, string.<span class="js2-object-property">length</span>);
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>stay) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(position + n);</span>
                        }
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (command !== <span class="string">''</span>) {
                    <span class="jcXcovered">string = </span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position &lt; string.<span class="js2-object-property">length</span>) {
                        <span class="jcXcovered">removed = string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(position).</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, n);</span>
                        <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, position) +
         </span>                   string.<span class="js2-function-call">slice</span>(position + n, string.<span class="js2-object-property">length</span>);
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (removed) {
                    <span class="jcXcovered">command = </span><span class="js2-function-call"><span class="jcXcovered">clean</span></span><span class="jcXcovered">(string);</span>
                }
                <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                <span class="js2-function-call"><span class="jcXcovered">fix_textarea</span></span><span class="jcXcovered">();</span>
                <span class="js2-function-call"><span class="jcXcovered">fire_change_command</span></span><span class="jcXcovered">();</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> removed;</span>
            },
            <span class="function-name">set</span>: <span class="keyword">function</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">stay</span>, <span class="js2-function-param">silent</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string !== <span class="constant">undefined</span>) {
                    <span class="jcXcovered">command = </span><span class="js2-function-call"><span class="jcXcovered">clean</span></span><span class="jcXcovered">(string);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>stay) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">fix_textarea</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent) {
                        <span class="js2-function-call"><span class="jcXcovered">fire_change_command</span></span><span class="jcXcovered">();</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="function-name">keymap</span>: <span class="keyword">function</span>(<span class="js2-function-param">new_keymap</span>, <span class="js2-function-param">value</span>) {
                <span class="keyword">function</span> <span class="function-name">wrap</span>(<span class="js2-function-param">key</span>, <span class="js2-function-param">fn</span>) {
                    <span class="keyword">var</span> <span class="variable-name">original</span> = <span class="jcXcovered">default_keymap[key]</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(original)) {
                        <span class="jcXcovered">original = original.</span><span class="js2-function-call"><span class="jcXcovered">bind</span></span><span class="jcXcovered">(self);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">e</span>) {
                        <span class="comment">// new keymap function will get default as 2nd argument
</span>                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> fn.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, e, original);</span>
                    };
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> new_keymap === <span class="string">'undefined'</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> keymap;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> new_keymap === <span class="string">'string'</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> value === <span class="string">'undefined'</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (keymap[new_keymap]) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> keymap[new_keymap];</span>
                        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (default_keymap[new_keymap]) {
                            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> default_keymap[new_keymap];</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">keymap[new_keymap] = </span><span class="js2-function-call"><span class="jcXcovered">wrap</span></span><span class="jcXcovered">(new_keymap, value);</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">ke</span>ymap = $.<span class="js2-function-call">extend</span>(
                        {},
                        keymap ? keymap : default_keymap,
                        $.<span class="js2-function-call">omap</span>(new_keymap || {}, wrap)
                    );
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
                }
            },
            <span class="function-name">insert</span>: <span class="keyword">function</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">stay</span>) {
                <span class="keyword">var</span> <span class="variable-name">bare_command</span> = <span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command)</span>;
                <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(string).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position === bare_command.<span class="js2-object-property">length</span>) {
                    <span class="jcXcovered">string = bare_command + string;</span>
                }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (position === 0) {
                    <span class="jcXnot-covered">string = string + bare_command;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">string = bare_command.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(0, position) +</span>
                        string + bare_command.<span class="js2-function-call">slice</span>(position);
                }
                <span class="jcXcovered">command = </span><span class="js2-function-call"><span class="jcXcovered">clean</span></span><span class="jcXcovered">(string);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>stay) {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(len, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                }
                <span class="js2-function-call"><span class="jcXcovered">fix_textarea</span></span><span class="jcXcovered">();</span>
                <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                <span class="js2-function-call"><span class="jcXcovered">fire_change_command</span></span><span class="jcXcovered">();</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="function-name">get</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> command;</span>
            },
            <span class="function-name">commands</span>: <span class="keyword">function</span>(<span class="js2-function-param">commands</span>) {
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (commands) {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">commands</span></span><span class="jcXnot-covered"> = commands;</span>
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> commands;</span>
                }
            },
            <span class="function-name">destroy</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">doc.</span><span class="js2-function-call"><span class="jcXcovered">unbind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'keypress.cmd'</span></span><span class="jcXcovered">, keypress_event);</span>
                <span class="jcXcovered">doc.</span><span class="js2-function-call"><span class="jcXcovered">unbind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'keydown.cmd'</span></span><span class="jcXcovered">, keydown_event);</span>
                <span class="jcXcovered">doc.</span><span class="js2-function-call"><span class="jcXcovered">unbind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'input.cmd'</span></span><span class="jcXcovered">, input_event);</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">stopTime</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'blink'</span></span><span class="jcXcovered">, blink);</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cursor'</span></span>).<span class="js2-function-call">next</span>().<span class="js2-function-call">remove</span>().<span class="js2-function-call">end</span>().<span class="js2-function-call">prev</span>().<span class="js2-function-call">remove</span>().
                    <span class="js2-function-call">end</span>().<span class="js2-function-call">remove</span>();
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.prompt, .clipboard'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">removeClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'cmd'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">removeData</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'cmd'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">off</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cmd'</span></span><span class="jcXcovered">);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="function-name">column</span>: <span class="keyword">function</span>(<span class="js2-function-param">include_prompt</span>) {
                <span class="keyword">var</span> <span class="variable-name">before</span> = <span class="jcXcovered">command.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(0, position)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position === 0 || <span class="negation-char">!</span>command.<span class="js2-object-property">length</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> 0;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="string"><span class="jcXcovered">/\n?([^\n]*)$/</span></span>;
                <span class="keyword">var</span> <span class="variable-name">match</span> = <span class="jcXcovered">before.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(re)</span>;
                <span class="keyword">var</span> <span class="variable-name">col</span> = <span class="jcXcovered">match[1].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span><span class="js2-function-call">have_newlines</span>(before) &amp;&amp; include_prompt) {
                    <span class="jcXnot-covered">col += prompt_len;</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> col;</span>
            },
            <span class="function-name">prompt</span>: <span class="keyword">function</span>(<span class="js2-function-param">user_prompt</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (user_prompt === <span class="constant">true</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> last_rendered_prompt;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (user_prompt === <span class="constant">undefined</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> prompt;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> user_prompt === <span class="string">'string'</span> ||
                        <span class="keyword">typeof</span> user_prompt === <span class="string">'function'</span>) {
                        <span class="jcXcovered">prompt = user_prompt;</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'prompt must be a function or string'</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">draw_prompt</span></span><span class="jcXcovered">();</span>
                    <span class="comment">// we could check if command is longer then numchars-new
</span>                    <span class="comment">// prompt
</span>                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
                }
            },
            <span class="function-name">kill_text</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> kill_text;</span>
            },
            <span class="function-name">position</span>: <span class="keyword">function</span>(<span class="js2-function-param">n</span>, <span class="js2-function-param">relative</span>, <span class="js2-function-param">silent</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> n === <span class="string">'number'</span>) {
                    <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXcovered">position</span>;
                    <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (relative) {
                        <span class="jcXcovered">position += n;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (n &lt; 0) {
                        <span class="jcXcovered">position = 0;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (n &gt; len) {
                        <span class="jcXcovered">position = len;</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">position = n;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (pos !== position &amp;&amp; <span class="negation-char">!</span>silent) {
                        <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onPositionChange</span>)) {
                            <span class="jcXcovered">settings.</span><span class="js2-function-call"><span class="jcXcovered">onPositionChange</span></span><span class="jcXcovered">(position, formatted_position);</span>
                        }
                        <span class="js2-function-call"><span class="jcXcovered">fix_textarea</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> position;</span>
                }
            },
            <span class="function-name">refresh</span>: <span class="keyword">function</span>() {
                <span class="js2-function-call"><span class="jcXnot-covered">draw_prompt</span></span><span class="jcXnot-covered">();</span>
                <span class="js2-function-call"><span class="jcXnot-covered">redraw</span></span><span class="jcXnot-covered">();</span>
                <span class="js2-function-call"><span class="jcXnot-covered">fix_textarea</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">);</span>
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self;</span>
            },
            <span class="comment">// if formatter change length of the strings (like emoji demo) we need to keep
</span>            <span class="comment">// track of two different positions one for command and one for display
</span>            <span class="function-name">display_position</span>: <span class="keyword">function</span>(<span class="js2-function-param">n</span>, <span class="js2-function-param">relative</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (n === <span class="constant">undefined</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> formatted_position;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">string</span> = <span class="js2-function-call"><span class="jcXcovered">formatting</span></span><span class="jcXcovered">(command, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(string)</span>;
                    <span class="keyword">var</span> <span class="variable-name">command_len</span> = <span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(command).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                    <span class="keyword">var</span> <span class="variable-name">new_formatted_pos</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (relative) {
                        <span class="jcXcovered">new_formatted_pos = formatted_position + n;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (n &gt; len) {
                        <span class="jcXcovered">new_formatted_pos = len;</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">new_formatted_pos = n;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">text</span>(string).<span class="js2-object-property">length</span> === <span class="js2-function-call">length</span>(command)) {
                        <span class="jcXcovered">formatted_position = new_formatted_pos;</span>
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(new_formatted_pos);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (len === new_formatted_pos) {
                        <span class="jcXcovered">formatted_position = new_formatted_pos;</span>
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(command_len);</span>
                    }
                    <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="js2-function-call"><span class="jcXcovered">find_position</span></span><span class="jcXcovered">(command, new_formatted_pos)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (pos !== -1) {
                        <span class="jcXcovered">formatted_position = new_formatted_pos;</span>
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(pos);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
                }
            },
            <span class="js2-object-property">visible</span>: (<span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">visible</span> = <span class="jcXcovered">self.</span><span class="js2-object-property"><span class="jcXcovered">visible</span></span>;
                <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                    <span class="jcXcovered">visible.</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(self, []);</span>
                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">draw_prompt</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
                };
            })(),
            <span class="js2-object-property">show</span>: (<span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">show</span> = <span class="jcXcovered">self.</span><span class="js2-object-property"><span class="jcXcovered">show</span></span>;
                <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                    <span class="jcXnot-covered">show.</span><span class="js2-function-call"><span class="jcXnot-covered">apply</span></span><span class="jcXnot-covered">(self, []);</span>
                    <span class="js2-function-call"><span class="jcXnot-covered">redraw</span></span><span class="jcXnot-covered">();</span>
                    <span class="js2-function-call"><span class="jcXnot-covered">draw_prompt</span></span><span class="jcXnot-covered">();</span>
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self;</span>
                };
            })(),
            <span class="function-name">resize</span>: <span class="keyword">function</span>(<span class="js2-function-param">num</span>) {
                <span class="jcXcovered">char_width = </span><span class="js2-function-call"><span class="jcXcovered">get_char_width</span></span><span class="jcXcovered">();</span>
                <span class="keyword">var</span> <span class="variable-name">new_num_chars</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (num) {
                    <span class="jcXcovered">new_num_chars = num;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">new_num_chars = </span><span class="js2-function-call"><span class="jcXcovered">get_num_chars</span></span><span class="jcXcovered">(char_width);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (num_chars !== new_num_chars) {
                    <span class="jcXcovered">num_chars = new_num_chars;</span>
                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">draw_prompt</span></span><span class="jcXcovered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="function-name">invoke_key</span>: <span class="keyword">function</span>(<span class="js2-function-param">shortcut</span>) {
                <span class="keyword">var</span> <span class="variable-name">keys</span> = <span class="jcXcovered">shortcut.</span><span class="js2-function-call"><span class="jcXcovered">toUpperCase</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'+'</span></span><span class="jcXcovered">)</span>;
                <span class="keyword">var</span> <span class="variable-name">key</span> = <span class="jcXcovered">keys.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">()</span>;
                <span class="keyword">var</span> <span class="variable-name">ctrl</span> = <span class="jcXcovered">keys.</span><span class="js2-function-call"><span class="jcXcovered">indexOf</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'CTRL'</span></span><span class="jcXcovered">) !== -1</span>;
                <span class="keyword">var</span> <span class="variable-name">shift</span> = <span class="jcXcovered">keys.</span><span class="js2-function-call"><span class="jcXcovered">indexOf</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'SHIFT'</span></span><span class="jcXcovered">) !== -1</span>;
                <span class="keyword">var</span> <span class="variable-name">alt</span> = <span class="jcXcovered">keys.</span><span class="js2-function-call"><span class="jcXcovered">indexOf</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'ALT'</span></span><span class="jcXcovered">) !== -1</span>;
                <span class="keyword">var</span> <span class="variable-name">meta</span> = <span class="jcXcovered">keys.</span><span class="js2-function-call"><span class="jcXcovered">indexOf</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'META'</span></span><span class="jcXcovered">) !== -1</span>;
                <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">e</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">Event</span>(<span class="string">"keydown"</span>, {
                    <span class="js2-object-property">ctrlKey</span>: ctrl,
                    <span class="js2-object-property">shiftKey</span>: shift,
                    <span class="js2-object-property">altKey</span>: alt,
                    <span class="js2-object-property">metaKey</span>: meta,
                    <span class="js2-object-property">which</span>: reversed_keycodes[key],
                    <span class="js2-object-property">key</span>: key
                });
                <span class="keyword">var</span> <span class="variable-name">doc</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(document.</span><span class="js2-object-property"><span class="jcXcovered">documentElement</span></span><span class="jcXcovered"> || window)</span>;
                <span class="jcXcovered">doc.</span><span class="js2-function-call"><span class="jcXcovered">trigger</span></span><span class="jcXcovered">(e);</span>
                <span class="jcXcovered">e = $.</span><span class="js2-function-call"><span class="jcXcovered">Event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">"keypress"</span></span><span class="jcXcovered">);</span>
                <span class="jcXcovered">e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered"> = key;</span>
                <span class="jcXcovered">e.</span><span class="js2-object-property"><span class="jcXcovered">which</span></span><span class="jcXcovered"> = e.</span><span class="js2-object-property"><span class="jcXcovered">keyCode</span></span><span class="jcXcovered"> = 0;</span>
                <span class="jcXcovered">doc.</span><span class="js2-function-call"><span class="jcXcovered">trigger</span></span><span class="jcXcovered">(e);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="function-name">enable</span>: <span class="keyword">function</span>(<span class="js2-function-param">silent</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>enabled) {
                    <span class="jcXcovered">enabled = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'enabled'</span></span><span class="jcXcovered">);</span>
                    <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (clip.<span class="js2-function-call">is</span>(<span class="string">':not(:focus)'</span>)) {
                            <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">focus</span></span><span class="jcXcovered">();</span>
                        }
                        <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">caret</span></span><span class="jcXcovered">(position);</span>
                    } <span class="keyword">catch</span> (e) {
                        <span class="comment">// firefox throw NS_ERROR_FAILURE - ignore
</span>                    }
                    <span class="js2-function-call"><span class="jcXcovered">animation</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent &amp;&amp; <span class="js2-function-call">is_function</span>(prompt)) {
                        <span class="js2-function-call"><span class="jcXnot-covered">draw_prompt</span></span><span class="jcXnot-covered">();</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">fix_cursor</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">fix_textarea</span></span><span class="jcXcovered">();</span>
                }
                <span class="js2-function-call"><span class="jcXcovered">mobile_focus</span></span><span class="jcXcovered">();</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="function-name">isenabled</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> enabled;</span>
            },
            <span class="function-name">disable</span>: <span class="keyword">function</span>(<span class="js2-function-param">focus</span>) {
                <span class="jcXcovered">enabled = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">removeClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'enabled'</span></span><span class="jcXcovered">);</span>
                <span class="js2-function-call"><span class="jcXcovered">animation</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>focus) {
                    <span class="js2-function-call"><span class="jcXcovered">mobile_focus</span></span><span class="jcXcovered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="function-name">mask</span>: <span class="keyword">function</span>(<span class="js2-function-param">new_mask</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> new_mask === <span class="string">'undefined'</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> settings.</span><span class="js2-object-property"><span class="jcXcovered">mask</span></span><span class="jcXcovered">;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">mask</span></span><span class="jcXcovered"> = new_mask;</span>
                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
                }
            }
        });
        <span class="comment">//debug_object(self, 'cmd')('display_position');
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: INIT
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">name</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered"> || settings.</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span><span class="jcXcovered"> || </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">prompt</span> !== <span class="constant">false</span>) {
            <span class="jcXcovered">prompt = settings.</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span><span class="jcXcovered">;</span>
            <span class="js2-function-call"><span class="jcXcovered">draw_prompt</span></span><span class="jcXcovered">();</span>
        }
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">enabled</span> === <span class="constant">true</span>) {
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">();</span>
        }
        <span class="jcXcovered">char_width = </span><span class="js2-function-call"><span class="jcXcovered">get_char_width</span></span><span class="jcXcovered">();</span>
        <span class="jcXcovered">num_chars = </span><span class="js2-function-call"><span class="jcXcovered">get_num_chars</span></span><span class="jcXcovered">(char_width);</span>
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>settings.<span class="js2-object-property">history</span>) {
            <span class="jcXcovered">history.</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
        }
        <span class="keyword">var</span> <span class="variable-name">first_up_history</span> = <span class="constant"><span class="jcXcovered">true</span></span>;
        <span class="comment">// skip_keypress - hack for Android that was inserting characters on
</span>        <span class="comment">// backspace
</span>        <span class="keyword">var</span> <span class="variable-name">skip_keypress</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">dead_key</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">single_key</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">no_keypress</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">no_key</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">no_keydown</span> = <span class="constant"><span class="jcXcovered">true</span></span>;
        <span class="keyword">var</span> <span class="variable-name">backspace</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">process</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">hold</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">hold_pause</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">skip_insert</span>;
        <span class="comment">// we hold text before keydown to fix backspace for Android/Chrome/SwiftKey
</span>        <span class="comment">// keyboard that generate keycode 229 for all keys #296
</span>        <span class="keyword">var</span> <span class="variable-name">prev_command</span> = <span class="string"><span class="jcXcovered">''</span></span>;
        <span class="keyword">var</span> <span class="variable-name">prev_key</span>;
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Keydown Event Handler
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">is_backspace</span>(<span class="js2-function-param">e</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">toUpperCase</span></span><span class="jcXcovered">() === </span><span class="string"><span class="jcXcovered">'BACKSPACE'</span></span><span class="jcXcovered"> || e.</span><span class="js2-object-property"><span class="jcXcovered">which</span></span><span class="jcXcovered"> === 8;</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">is_single</span>(<span class="js2-function-param">e</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered"> &amp;&amp; e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> === 1 &amp;&amp; </span><span class="negation-char"><span class="jcXcovered">!</span></span><span class="jcXcovered">e.</span><span class="js2-object-property"><span class="jcXcovered">ctrlKey</span></span><span class="jcXcovered">;</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">clear_reverse_search_key</span>(<span class="js2-function-param">e</span>) {
            <span class="comment">// arrows / Home / End / ENTER
</span>            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> e.</span><span class="js2-object-property"><span class="jcXcovered">which</span></span><span class="jcXcovered"> === 35 || e.</span><span class="js2-object-property"><span class="jcXcovered">which</span></span><span class="jcXcovered"> === </span>36 ||
                e.<span class="js2-object-property">which</span> === 37 || e.<span class="js2-object-property">which</span> === 38 ||
                e.<span class="js2-object-property">which</span> === 39 || e.<span class="js2-object-property">which</span> === 40 ||
                e.<span class="js2-object-property">which</span> === 13 || e.<span class="js2-object-property">which</span> === 27;
        }
        <span class="keyword">var</span> <span class="variable-name">skip_keydown</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// function complexicity is 35 when adding this exception
</span>        <span class="comment">// eslint-disable-next-line complexity
</span>        <span class="keyword">function</span> <span class="function-name">keydown_event</span>(<span class="js2-function-param">e</span>) {
            <span class="js2-function-call"><span class="jcXcovered">debug</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'keydown "'</span></span><span class="jcXcovered"> + e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered"> + </span><span class="string"><span class="jcXcovered">'" '</span></span><span class="jcXcovered"> + e.</span><span class="js2-object-property"><span class="jcXcovered">fake</span></span><span class="jcXcovered"> + </span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered"> + e.</span><span class="js2-object-property"><span class="jcXcovered">which</span></span><span class="jcXcovered">);</span>
            <span class="keyword">var</span> <span class="variable-name">result</span>;
            <span class="jcXcovered">process = (e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered"> || </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">toLowerCase</span></span><span class="jcXcovered">() === </span><span class="string"><span class="jcXcovered">'process'</span></span><span class="jcXcovered"> || e.</span><span class="js2-object-property"><span class="jcXcovered">which</span></span><span class="jcXcovered"> === 0;</span>
            <span class="jcXcovered">dead_key = no_keypress &amp;&amp; single_key &amp;&amp; </span><span class="negation-char"><span class="jcXcovered">!</span></span><span class="js2-function-call"><span class="jcXcovered">is_backspace</span></span><span class="jcXcovered">(e);</span>
            <span class="comment">// special keys don't trigger keypress fix #293
</span>            <span class="keyword"><span class="jcXcovered">try</span></span><span class="jcXcovered"> {
                </span><span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>e.<span class="js2-object-property">fake</span>) {
                    <span class="jcXcovered">single_key = </span><span class="js2-function-call"><span class="jcXcovered">is_single</span></span><span class="jcXcovered">(e);</span>
                    <span class="comment">// chrome on android support key property but it's "Unidentified"
</span>                    <span class="jcXcovered">no_key = </span><span class="js2-function-call"><span class="jcXcovered">String</span></span><span class="jcXcovered">(e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">toLowerCase</span></span><span class="jcXcovered">() === </span><span class="string"><span class="jcXcovered">'unidentified'</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">backspace = </span><span class="js2-function-call"><span class="jcXcovered">is_backspace</span></span><span class="jcXcovered">(e);</span>
                }
            } <span class="keyword">catch</span> (exception) {}
            <span class="comment">// keydown created in input will have text already inserted and we
</span>            <span class="comment">// want text before input
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">key</span> === <span class="string">"Unidentified"</span>) {
                <span class="jcXnot-covered">no_keydown = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                <span class="comment">// android swift keyboard have always which == 229 we will triger proper
</span>                <span class="comment">// event in input with e.fake == true
</span>                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>e.<span class="js2-object-property">fake</span>) {
                <span class="jcXcovered">no_keydown = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            }
            <span class="jcXcovered">no_keypress = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
            <span class="comment">// Meta+V did bind input but it didin't happen because terminal paste
</span>            <span class="comment">// prevent native insert action
</span>            <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">off</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'input'</span></span><span class="jcXcovered">, paste);</span>
            <span class="keyword">var</span> <span class="variable-name">key</span> = <span class="js2-function-call"><span class="jcXcovered">get_key</span></span><span class="jcXcovered">(e)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">keydown</span>)) {
                <span class="jcXcovered">result = settings.</span><span class="js2-object-property"><span class="jcXcovered">keydown</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, e);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result !== <span class="constant">undefined</span>) {
                    <span class="comment">//skip_keypress = true;
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>result) {
                        <span class="jcXcovered">skip_insert = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
                }
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (key !== prev_key) {
                <span class="js2-function-call"><span class="jcXcovered">clear_hold</span></span><span class="jcXcovered">();</span>
            }
            <span class="comment">// CTRL+C hanlding is only exception of cmd aware terminal logic
</span>            <span class="comment">// cmd need to call CTRL+C keymap when terminal is not enabled
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled || (key === <span class="string">'CTRL+C'</span> &amp;&amp; <span class="js2-function-call">is_terminal_selected</span>(self))) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (hold) {
                    <span class="jcXcovered">prev_key = key;</span>
                    <span class="jcXcovered">key = </span><span class="string"><span class="jcXcovered">'HOLD+'</span></span><span class="jcXcovered"> + key;</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (hold_pause) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">holdRepeatTimeout</span> &gt; 0 &amp;&amp;
                        key.<span class="js2-function-call">indexOf</span>(settings.<span class="js2-object-property">repeatTimeoutKeys</span>) !== -1) {
                        <span class="jcXcovered">hold_pause = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                        <span class="jcXcovered">sel</span>f.<span class="js2-function-call">oneTime</span>(settings.<span class="js2-object-property">holdRepeatTimeout</span>, <span class="string">'delay'</span>, <span class="keyword">function</span>() {
                            <span class="jcXnot-covered">hold_pause = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                        });
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">sel</span>f.<span class="js2-function-call">oneTime</span>(settings.<span class="js2-object-property">holdTimeout</span>, <span class="string">'hold'</span>, <span class="keyword">function</span>() {
                        <span class="jcXcovered">hold = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    });
                    <span class="jcXcovered">prev_key = key;</span>
                }
                <span class="comment">// if e.fake ignore of space is handled in input and next keydown
</span>                <span class="comment">// is not triggered this is just in case code since on Android
</span>                <span class="comment">// keydown is not triggered only input so event is always fake on Android
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>e.<span class="js2-object-property">fake</span> &amp;&amp; is_android) {
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (skip_keydown) {
                        <span class="js2-function-call"><span class="jcXnot-covered">clear_hold</span></span><span class="jcXnot-covered">();</span>
                        <span class="jcXnot-covered">skip_keydown = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">mobile_ignore_key</span>(key)) {
                        <span class="jcXnot-covered">skip_keydown = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                    }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (<span class="js2-function-call">mobile_ignore_key</span>(prev_key)) {
                        <span class="comment">// just in case next key is different then space
</span>                        <span class="jcXnot-covered">skip_keydown = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                    }
                }
                <span class="js2-function-call"><span class="jcXcovered">restart_animation</span></span><span class="jcXcovered">();</span>
                <span class="comment">// CTRL+V don't fire keypress in IE11
</span>                <span class="jcXcovered">skip_insert = [</span><span class="string"><span class="jcXcovered">'CTRL+V'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'META+V'</span></span><span class="jcXcovered">].</span><span class="js2-function-call"><span class="jcXcovered">indexOf</span></span><span class="jcXcovered">(key) !== -1;</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">which</span> !== 38 &amp;&amp; <span class="negation-char">!</span>(e.<span class="js2-object-property">which</span> === 80 &amp;&amp; e.<span class="js2-object-property">ctrlKey</span>)) {
                    <span class="jcXcovered">first_up_history = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (reverse_search &amp;&amp; <span class="js2-function-call">clear_reverse_search_key</span>(e)) {
                    <span class="js2-function-call"><span class="jcXcovered">clear_reverse_state</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">draw_prompt</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">which</span> === 27) { <span class="comment">// ESC
</span>                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">set</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">which</span> === 13) {
                        <span class="jcXnot-covered">keydown_event.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(</span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">, e);</span>
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(keymap[key])) {
                    <span class="jcXcovered">result = keymap[key](e);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result === <span class="constant">true</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result !== <span class="constant">undefined</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (e.<span class="js2-object-property">altKey</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">skip_keypress = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                }
                <span class="comment">// this will prevent for instance backspace to go back one page
</span>                <span class="comment">//skip_keypress = true;
</span>                <span class="comment">//e.preventDefault();
</span>            }
        }
        <span class="keyword">function</span> <span class="function-name">clear_hold</span>() {
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">stopTime</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'hold'</span></span><span class="jcXcovered">);</span>
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">stopTime</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'delay'</span></span><span class="jcXcovered">);</span>
            <span class="jcXcovered">hold_pause = hold = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
        }
        <span class="keyword">var</span> <span class="variable-name">doc</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(document.</span><span class="js2-object-property"><span class="jcXcovered">documentElement</span></span><span class="jcXcovered"> || window)</span>;
        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">keymap</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">keymap</span></span><span class="jcXcovered"> || {});</span>
        <span class="keyword">function</span> <span class="function-name">keypress_event</span>(<span class="js2-function-param">e</span>) {
            <span class="js2-function-call"><span class="jcXcovered">debug</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'keypress "'</span></span><span class="jcXcovered"> + e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered"> + </span><span class="string"><span class="jcXcovered">'" '</span></span><span class="jcXcovered"> + e.</span><span class="js2-object-property"><span class="jcXcovered">fake</span></span><span class="jcXcovered">);</span>
            <span class="js2-function-call"><span class="jcXcovered">clear_hold</span></span><span class="jcXcovered">();</span>
            <span class="keyword">var</span> <span class="variable-name">result</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>e.<span class="js2-object-property">fake</span>) {
                <span class="jcXcovered">no_keypress = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ((e.<span class="js2-object-property">ctrlKey</span> || e.<span class="js2-object-property">metaKey</span>) &amp;&amp; <span class="negation-char">!</span>e.<span class="js2-object-property">altKey</span>) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (skip_keypress) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">keypress</span>)) {
                <span class="jcXcovered">result = settings.</span><span class="js2-object-property"><span class="jcXcovered">keypress</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, e);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result !== <span class="constant">undefined</span>) {
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>result) {
                        <span class="jcXnot-covered">skip_insert = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> result;</span>
                }
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">fake</span>) {
                    <span class="comment">// event created in input, we prevent inserting text
</span>                    <span class="comment">// in different interpreter when keydown called pop
</span>                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                }
                <span class="comment">// key polyfill is not correct for keypress
</span>                <span class="comment">// https://github.com/cvan/keyboardevent-key-polyfill/issues/15
</span>                <span class="keyword">var</span> <span class="variable-name">key</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (is_key_native) {
                    <span class="jcXcovered">key = e.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered">;</span>
                    <span class="comment">// fixing IE inconsistency #362
</span>                    <span class="keyword">var</span> <span class="variable-name">normalized</span> = <span class="jcXcovered">key.</span><span class="js2-function-call"><span class="jcXcovered">toUpperCase</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (key_mapping[normalized]) {
                        <span class="jcXnot-covered">key = key_mapping[normalized];</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>key || no_key) {
                    <span class="jcXnot-covered">key = String.</span><span class="js2-function-call"><span class="jcXnot-covered">fromCharCode</span></span><span class="jcXnot-covered">(e.</span><span class="js2-object-property"><span class="jcXnot-covered">which</span></span><span class="jcXnot-covered">);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">inArray</span>(e.<span class="js2-object-property">which</span>, [13, 0, 8]) &gt; -1) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">keyCode</span> === 123) { <span class="comment">// for F12 which === 0
</span>                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    <span class="comment">// which === 100 - d
</span>                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (key &amp;&amp; (<span class="negation-char">!</span>e.<span class="js2-object-property">ctrlKey</span> || (e.<span class="js2-object-property">ctrlKey</span> &amp;&amp; e.<span class="js2-object-property">ctrlKey</span>)) &amp;&amp;
                           (<span class="negation-char">!</span>(e.<span class="js2-object-property">altKey</span> &amp;&amp; e.<span class="js2-object-property">which</span> === 100) || e.<span class="js2-object-property">altKey</span>) &amp;&amp;
                           <span class="negation-char">!</span>dead_key) {
                    <span class="comment">// dead_key are handled by input event
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (reverse_search) {
                        <span class="jcXcovered">rev_search_str += key;</span>
                        <span class="js2-function-call"><span class="jcXcovered">reverse_history_search</span></span><span class="jcXcovered">();</span>
                        <span class="js2-function-call"><span class="jcXcovered">draw_reverse_prompt</span></span><span class="jcXcovered">();</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (key.<span class="js2-object-property">length</span> === 1) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">insert</span></span><span class="jcXcovered">(key);</span>
                    }
                }
            }
        }
        <span class="keyword">function</span> <span class="function-name">event</span>(<span class="js2-function-param">type</span>, <span class="js2-function-param">chr</span>, <span class="js2-function-param">which</span>) {
            <span class="keyword">var</span> <span class="variable-name">event</span> = <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">Event</span></span><span class="jcXcovered">(type)</span>;
            <span class="jcXcovered">event.</span><span class="js2-object-property"><span class="jcXcovered">which</span></span><span class="jcXcovered"> = which;</span>
            <span class="jcXcovered">event.</span><span class="js2-object-property"><span class="jcXcovered">key</span></span><span class="jcXcovered"> = chr;</span>
            <span class="jcXcovered">event.</span><span class="js2-object-property"><span class="jcXcovered">fake</span></span><span class="jcXcovered"> = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
            <span class="jcXcovered">doc.</span><span class="js2-function-call"><span class="jcXcovered">trigger</span></span><span class="jcXcovered">(event);</span>
        }
        <span class="keyword">var</span> <span class="variable-name">skip_input</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">function</span> <span class="function-name">input_event</span>() {
            <span class="js2-function-call"><span class="jcXcovered">debug</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'input '</span></span><span class="jcXcovered"> + no_keydown + </span><span class="string"><span class="jcXcovered">' || '</span></span><span class="jcXcovered"> + process + </span><span class="string"><span class="jcXcovered">' (</span></span><span class="string">('</span> + no_keypress +
                  <span class="string">' || '</span> + dead_key + <span class="string">') &amp;&amp; !'</span> + skip_insert + <span class="string">' &amp;&amp; ('</span> + single_key +
                  <span class="string">' || '</span> + no_key + <span class="string">') &amp;&amp; !'</span> + backspace + <span class="string">')'</span>);
            <span class="comment">// correct for fake space used for select all context menu hack
</span>            <span class="keyword">var</span> <span class="variable-name">val</span> = <span class="jcXcovered">clip.</span><span class="js2-function-call"><span class="jcXcovered">val</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>is_mobile) {
                <span class="jcXcovered">val = val.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^ /</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
            }
            <span class="comment">// Some Androids don't fire keypress - #39
</span>            <span class="comment">// if there is dead_key we also need to grab real character #158
</span>            <span class="comment">// Firefox/Android with google keyboard don't fire keydown and keyup #319
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ((no_keydown || process || ((no_keypress || dead_key) &amp;&amp; <span class="negation-char">!</span>skip_insert &amp;&amp;
                                          (single_key || no_key) &amp;&amp; <span class="negation-char">!</span>backspace)) &amp;&amp;
                val !== command) {
                <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXcovered">position</span>;
                <span class="comment">// backspace is set in keydown if no keydown we need to get new one
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (no_keydown) {
                    <span class="keyword">var</span> <span class="variable-name">cmd</span> = <span class="jcXcovered">prev_command</span>;
                    <span class="jcXcovered">backspace = cmd.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, cmd.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> === val.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (skip_input) {
                    <span class="jcXnot-covered">skip_input = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                    <span class="jcXnot-covered">clip.</span><span class="js2-function-call"><span class="jcXnot-covered">val</span></span><span class="jcXnot-covered">(command);</span>
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (reverse_search) {
                    <span class="jcXnot-covered">rev_search_str = val;</span>
                    <span class="js2-function-call"><span class="jcXnot-covered">reverse_history_search</span></span><span class="jcXnot-covered">();</span>
                    <span class="js2-function-call"><span class="jcXnot-covered">draw_reverse_prompt</span></span><span class="jcXnot-covered">();</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">str</span> = <span class="jcXcovered">val.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(position)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (str.<span class="js2-object-property">length</span> === 1 || backspace) {
                        <span class="keyword">var</span> <span class="variable-name">chr</span> = <span class="js2-function-call"><span class="jcXcovered">get_next_character</span></span><span class="jcXcovered">(str)</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">mobile_ignore_key</span>(chr)) {
                            <span class="jcXnot-covered">skip_input = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                        }
                        <span class="comment">// we trigger events so keypress and keydown callback work
</span>                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (no_keydown) {
                            <span class="keyword">var</span> <span class="variable-name">keycode</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (backspace) {
                                <span class="jcXcovered">keycode = 8;</span>
                            } <span class="keyword">else</span> {
                                <span class="jcXnot-covered">keycode = str.</span><span class="js2-function-call"><span class="jcXnot-covered">toUpperCase</span></span><span class="jcXnot-covered">().</span><span class="js2-function-call"><span class="jcXnot-covered">charCodeAt</span></span><span class="jcXnot-covered">(0);</span>
                            }
                            <span class="js2-function-call"><span class="jcXcovered">event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'keydown'</span></span><span class="jcXcovered">, backspace ? </span><span class="string"><span class="jcXcovered">'Backspace'</span></span><span class="jcXcovered"> : str, keycode);</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (no_keypress &amp;&amp; <span class="negation-char">!</span>backspace) {
                            <span class="js2-function-call"><span class="jcXcovered">event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'keypress'</span></span><span class="jcXcovered">, chr, str.</span><span class="js2-function-call"><span class="jcXcovered">charCodeAt</span></span><span class="jcXcovered">(0));</span>
                        }
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (backspace) {
                        <span class="jcXcovered">prev_command = command;</span>
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="comment">// if user return false in keydown we don't want to insert text
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (skip_insert) {
                        <span class="jcXnot-covered">skip_insert = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(val);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (backspace) {
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">position</span></span><span class="jcXnot-covered">(pos - 1);</span>
                } <span class="keyword">else</span> {
                    <span class="comment">// user enter more then one character if click on complete word
</span>                    <span class="comment">// on android
</span>                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(pos + Math.</span><span class="builtin"><span class="jcXcovered">abs</span></span><span class="jcXcovered">(val.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - prev_command.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">));</span>
                }
            }
            <span class="jcXcovered">prev_command = command;</span>
            <span class="jcXcovered">skip_insert = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            <span class="jcXcovered">no_keydown = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
        }
        <span class="jcXcovered">doc.</span><span class="js2-function-call"><span class="jcXcovered">bind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'keypress.cmd'</span></span><span class="jcXcovered">, keypress_event).</span><span class="js2-function-call"><span class="jcXcovered">bind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'keydown.cmd'</span></span><span class="jcXcovered">, keydo</span>wn_event)
            .<span class="js2-function-call">bind</span>(<span class="string">'keyup.cmd'</span>, clear_hold).<span class="js2-function-call">bind</span>(<span class="string">'input.cmd'</span>, input_event);
        <span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">func</span></span><span class="keyword">tion</span>() {
            <span class="keyword">var</span> <span class="variable-name">was_down</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
            <span class="keyword">var</span> <span class="variable-name">count</span> = <span class="jcXcovered">0</span>;
            <span class="jcXcovered">sel</span>f.<span class="js2-function-call">on</span>(<span class="string">'mousedown.cmd'</span>, <span class="keyword">function</span>() {
                <span class="jcXcovered">was_down = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
            }).<span class="js2-function-call">on</span>(<span class="string">'mouseup.cmd'</span>, <span class="keyword">function</span>(<span class="js2-function-param">e</span>) {
                <span class="keyword">function</span> <span class="function-name">trigger</span>() {
                    <span class="keyword">var</span> <span class="variable-name">$target</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(e.</span><span class="js2-object-property"><span class="jcXcovered">target</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>$target.<span class="js2-function-call">is</span>(<span class="string">'.prompt'</span>) &amp;&amp; down) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($target.<span class="js2-function-call">is</span>(<span class="string">'.cmd'</span>)) {
                                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">position</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">text</span></span><span class="jcXnot-covered">(command).</span><span class="js2-object-property"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered">);</span>
                            } <span class="keyword">else</span> {
                                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">display_position</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">get_char_pos</span></span><span class="jcXcovered">(e));</span>
                            }
                        }
                    }
                    <span class="jcXcovered">count = 0;</span>
                }
                <span class="comment">// we get button from event for testing normally it's on originalEvent
</span>                <span class="keyword">var</span> <span class="variable-name">button</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">originalEvent</span> === <span class="constant">undefined</span>) {
                    <span class="jcXcovered">button = e.</span><span class="js2-object-property"><span class="jcXcovered">button</span></span><span class="jcXcovered">;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">button = e.</span><span class="js2-object-property"><span class="jcXnot-covered">originalEvent</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">button</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (button === 0 &amp;&amp; <span class="js2-function-call">get_selected_html</span>() === <span class="string">''</span>) {
                    <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="string"><span class="jcXcovered">'click_'</span></span><span class="jcXcovered"> + id</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (++count === 1) {
                        <span class="keyword">var</span> <span class="variable-name">down</span> = <span class="jcXcovered">was_down</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">clickTimeout</span> === 0) {
                                <span class="js2-function-call"><span class="jcXcovered">trigger</span></span><span class="jcXcovered">();</span>
                            } <span class="keyword">else</span> {
                                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">oneTime</span></span><span class="jcXnot-covered">(settings.</span><span class="js2-object-property"><span class="jcXnot-covered">clickTimeout</span></span><span class="jcXnot-covered">, name, trigger);</span>
                            }
                        } <span class="keyword">else</span> {
                            <span class="jcXnot-covered">count = 0;</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">stopTime</span></span><span class="jcXnot-covered">(name);</span>
                        <span class="jcXnot-covered">count = 0;</span>
                    }
                }
                <span class="jcXcovered">was_down = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            });
        })();
        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'cmd'</span></span><span class="jcXcovered">, self);</span>
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>(<span class="string">'KeyboardEvent'</span> <span class="keyword">in</span> window &amp;&amp; <span class="string">'key'</span> <span class="keyword">in</span> window.<span class="js2-object-property">KeyboardEvent</span>.<span class="js2-object-property">prototype</span>)) {
            <span class="js2-function-call"><span class="jcXnot-covered">setTim</span></span><span class="js2-function-call">eout</span>(<span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'key event property not supported try https://github.'</span></span><span class="jcXnot-covered"> </span>+
                                <span class="string">'com/inexorabletash/polyfill/blob/master/keyboard.js'</span>);
            }, 0);
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
    }; <span class="comment">// cmd plugin
</span>    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">/* eslint-disable */</span>
    <span class="comment">// regex that match single character at begining and folowing combine character
</span>    <span class="comment">// https://en.wikipedia.org/wiki/Combining_character
</span>    <span class="keyword">var</span> <span class="variable-name">combine_chr_re</span> = <span class="string"><span class="jcXcovered">/^(.(?:[\u0300-\u036F]|[\u1AB0-\u1abE]|[\u1DC0-\u1DF9]|[\u1DFB-\u1DFF]|[\u20D0-\u20F0]|[\uFE20-\uFE2F])+)/</span></span>;
    <span class="comment">// source: https://mathiasbynens.be/notes/javascript-unicode
</span>    <span class="keyword">var</span> <span class="variable-name">astral_symbols_re</span> = <span class="string"><span class="jcXcovered">/[\uD800-\uDBFF][\uDC00-\uDFFF]/g</span></span>;
    <span class="comment">// source: https://github.com/mathiasbynens/emoji-regex
</span>    <span class="keyword">var</span> <span class="variable-name">emoji_re</span> = <span class="string"><span class="jcXcovered">/^(\uD83C\uDFF4(?:\uDB40\uDC67\uDB40\uDC62(?:\uDB40\uDC65\uDB40\uDC6E\uDB40\uDC67|\uDB40\uDC77\uDB40\uDC6C\uDB40\uDC73|\uDB40\uDC73\uDB40\uDC63\uDB40\uDC74)\uDB40\uDC7F|\u200D\u2620\uFE0F)|\uD83D\uDC69\u200D\uD83D\uDC69\u200D(?:\uD83D\uDC66\u200D\uD83D\uDC66|\uD83D\uDC67\u200D(?:\uD83D[\uDC66\uDC67]))|\uD83D\uDC68(?:\u200D(?:\u2764\uFE0F\u200D(?:\uD83D\uDC8B\u200D)?\uD83D\uDC68|(?:\uD83D[\uDC68\uDC69])\u200D(?:\uD83D\uDC66\u200D\uD83D\uDC66|\uD83D\uDC67\u200D(?:\uD83D[\uDC66\uDC67]))|\uD83D\uDC66\u200D\uD83D\uDC66|\uD83D\uDC67\u200D(?:\uD83D[\uDC66\uDC67])|\uD83C[\uDF3E\uDF73\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uD83E[\uDDB0-\uDDB3])|(?:\uD83C[\uDFFB-\uDFFF])\u200D(?:\uD83C[\uDF3E\uDF73\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uD83E[\uDDB0-\uDDB3]))|\uD83D\uDC69\u200D(?:\u2764\uFE0F\u200D(?:\uD83D\uDC8B\u200D(?:\uD83D[\uDC68\uDC69])|\uD83D[\uDC68\uDC69])|\uD83C[\uDF3E\uDF73\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uD83E[\uDDB0-\uDDB3])|\uD83D\uDC69\u200D\uD83D\uDC66\u200D\uD83D\uDC66|(?:\uD83D\uDC41\uFE0F\u200D\uD83D\uDDE8|\uD83D\uDC69(?:\uD83C[\uDFFB-\uDFFF])\u200D[\u2695\u2696\u2708]|\uD83D\uDC68(?:(?:\uD83C[\uDFFB-\uDFFF])\u200D[\u2695\u2696\u2708]|\u200D[\u2695\u2696\u2708])|(?:(?:\u26F9|\uD83C[\uDFCB\uDFCC]|\uD83D\uDD75)\uFE0F|\uD83D\uDC6F|\uD83E[\uDD3C\uDDDE\uDDDF])\u200D[\u2640\u2642]|(?:\u26F9|\uD83C[\uDFCB\uDFCC]|\uD83D\uDD75)(?:\uD83C[\uDFFB-\uDFFF])\u200D[\u2640\u2642]|(?:\uD83C[\uDFC3\uDFC4\uDFCA]|\uD83D[\uDC6E\uDC71\uDC73\uDC77\uDC81\uDC82\uDC86\uDC87\uDE45-\uDE47\uDE4B\uDE4D\uDE4E\uDEA3\uDEB4-\uDEB6]|\uD83E[\uDD26\uDD37-\uDD39\uDD3D\uDD3E\uDDB8\uDDB9\uDDD6-\uDDDD])(?:(?:\uD83C[\uDFFB-\uDFFF])\u200D[\u2640\u2642]|\u200D[\u2640\u2642])|\uD83D\uDC69\u200D[\u2695\u2696\u2708])\uFE0F|\uD83D\uDC69\u200D\uD83D\uDC67\u200D(?:\uD83D[\uDC66\uDC67])|\uD83D\uDC69\u200D\uD83D\uDC69\u200D(?:\uD83D[\uDC66\uDC67])|\uD83D\uDC68(?:\u200D(?:(?:\uD83D[\uDC68\uDC69])\u200D(?:\uD83D[\uDC66\uDC67])|\uD83D[\uDC66\uDC67])|\uD83C[\uDFFB-\uDFFF])|\uD83C\uDFF3\uFE0F\u200D\uD83C\uDF08|\uD83D\uDC69\u200D\uD83D\uDC67|\uD83D\uDC69(?:\uD83C[\uDFFB-\uDFFF])\u200D(?:\uD83C[\uDF3E\uDF73\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uD83E[\uDDB0-\uDDB3])|\uD83D\uDC69\u200D\uD83D\uDC66|\uD83C\uDDF6\uD83C\uDDE6|\uD83C\uDDFD\uD83C\uDDF0|\uD83C\uDDF4\uD83C\uDDF2|\uD83D\uDC69(?:\uD83C[\uDFFB-\uDFFF])|\uD83C\uDDED(?:\uD83C[\uDDF0\uDDF2\uDDF3\uDDF7\uDDF9\uDDFA])|\uD83C\uDDEC(?:\uD83C[\uDDE6\uDDE7\uDDE9-\uDDEE\uDDF1-\uDDF3\uDDF5-\uDDFA\uDDFC\uDDFE])|\uD83C\uDDEA(?:\uD83C[\uDDE6\uDDE8\uDDEA\uDDEC\uDDED\uDDF7-\uDDFA])|\uD83C\uDDE8(?:\uD83C[\uDDE6\uDDE8\uDDE9\uDDEB-\uDDEE\uDDF0-\uDDF5\uDDF7\uDDFA-\uDDFF])|\uD83C\uDDF2(?:\uD83C[\uDDE6\uDDE8-\uDDED\uDDF0-\uDDFF])|\uD83C\uDDF3(?:\uD83C[\uDDE6\uDDE8\uDDEA-\uDDEC\uDDEE\uDDF1\uDDF4\uDDF5\uDDF7\uDDFA\uDDFF])|\uD83C\uDDFC(?:\uD83C[\uDDEB\uDDF8])|\uD83C\uDDFA(?:\uD83C[\uDDE6\uDDEC\uDDF2\uDDF3\uDDF8\uDDFE\uDDFF])|\uD83C\uDDF0(?:\uD83C[\uDDEA\uDDEC-\uDDEE\uDDF2\uDDF3\uDDF5\uDDF7\uDDFC\uDDFE\uDDFF])|\uD83C\uDDEF(?:\uD83C[\uDDEA\uDDF2\uDDF4\uDDF5])|\uD83C\uDDF8(?:\uD83C[\uDDE6-\uDDEA\uDDEC-\uDDF4\uDDF7-\uDDF9\uDDFB\uDDFD-\uDDFF])|\uD83C\uDDEE(?:\uD83C[\uDDE8-\uDDEA\uDDF1-\uDDF4\uDDF6-\uDDF9])|\uD83C\uDDFF(?:\uD83C[\uDDE6\uDDF2\uDDFC])|\uD83C\uDDEB(?:\uD83C[\uDDEE-\uDDF0\uDDF2\uDDF4\uDDF7])|\uD83C\uDDF5(?:\uD83C[\uDDE6\uDDEA-\uDDED\uDDF0-\uDDF3\uDDF7-\uDDF9\uDDFC\uDDFE])|\uD83C\uDDE9(?:\uD83C[\uDDEA\uDDEC\uDDEF\uDDF0\uDDF2\uDDF4\uDDFF])|\uD83C\uDDF9(?:\uD83C[\uDDE6\uDDE8\uDDE9\uDDEB-\uDDED\uDDEF-\uDDF4\uDDF7\uDDF9\uDDFB\uDDFC\uDDFF])|\uD83C\uDDE7(?:\uD83C[\uDDE6\uDDE7\uDDE9-\uDDEF\uDDF1-\uDDF4\uDDF6-\uDDF9\uDDFB\uDDFC\uDDFE\uDDFF])|[#\*0-9]\uFE0F\u20E3|\uD83C\uDDF1(?:\uD83C[\uDDE6-\uDDE8\uDDEE\uDDF0\uDDF7-\uDDFB\uDDFE])|\uD83C\uDDE6(?:\uD83C[\uDDE8-\uDDEC\uDDEE\uDDF1\uDDF2\uDDF4\uDDF6-\uDDFA\uDDFC\uDDFD\uDDFF])|\uD83C\uDDF7(?:\uD83C[\uDDEA\uDDF4\uDDF8\uDDFA\uDDFC])|\uD83C\uDDFB(?:\uD83C[\uDDE6\uDDE8\uDDEA\uDDEC\uDDEE\uDDF3\uDDFA])|\uD83C\uDDFE(?:\uD83C[\uDDEA\uDDF9])|(?:\uD83C[\uDFC3\uDFC4\uDFCA]|\uD83D[\uDC6E\uDC71\uDC73\uDC77\uDC81\uDC82\uDC86\uDC87\uDE45-\uDE47\uDE4B\uDE4D\uDE4E\uDEA3\uDEB4-\uDEB6]|\uD83E[\uDD26\uDD37-\uDD39\uDD3D\uDD3E\uDDB8\uDDB9\uDDD6-\uDDDD])(?:\uD83C[\uDFFB-\uDFFF])|(?:\u26F9|\uD83C[\uDFCB\uDFCC]|\uD83D\uDD75)(?:\uD83C[\uDFFB-\uDFFF])|(?:[\u261D\u270A-\u270D]|\uD83C[\uDF85\uDFC2\uDFC7]|\uD83D[\uDC42\uDC43\uDC46-\uDC50\uDC66\uDC67\uDC70\uDC72\uDC74-\uDC76\uDC78\uDC7C\uDC83\uDC85\uDCAA\uDD74\uDD7A\uDD90\uDD95\uDD96\uDE4C\uDE4F\uDEC0\uDECC]|\uD83E[\uDD18-\uDD1C\uDD1E\uDD1F\uDD30-\uDD36\uDDB5\uDDB6\uDDD1-\uDDD5])(?:\uD83C[\uDFFB-\uDFFF])|(?:[\u231A\u231B\u23E9-\u23EC\u23F0\u23F3\u25FD\u25FE\u2614\u2615\u2648-\u2653\u267F\u2693\u26A1\u26AA\u26AB\u26BD\u26BE\u26C4\u26C5\u26CE\u26D4\u26EA\u26F2\u26F3\u26F5\u26FA\u26FD\u2705\u270A\u270B\u2728\u274C\u274E\u2753-\u2755\u2757\u2795-\u2797\u27B0\u27BF\u2B1B\u2B1C\u2B50\u2B55]|\uD83C[\uDC04\uDCCF\uDD8E\uDD91-\uDD9A\uDDE6-\uDDFF\uDE01\uDE1A\uDE2F\uDE32-\uDE36\uDE38-\uDE3A\uDE50\uDE51\uDF00-\uDF20\uDF2D-\uDF35\uDF37-\uDF7C\uDF7E-\uDF93\uDFA0-\uDFCA\uDFCF-\uDFD3\uDFE0-\uDFF0\uDFF4\uDFF8-\uDFFF]|\uD83D[\uDC00-\uDC3E\uDC40\uDC42-\uDCFC\uDCFF-\uDD3D\uDD4B-\uDD4E\uDD50-\uDD67\uDD7A\uDD95\uDD96\uDDA4\uDDFB-\uDE4F\uDE80-\uDEC5\uDECC\uDED0-\uDED2\uDEEB\uDEEC\uDEF4-\uDEF9]|\uD83E[\uDD10-\uDD3A\uDD3C-\uDD3E\uDD40-\uDD45\uDD47-\uDD70\uDD73-\uDD76\uDD7A\uDD7C-\uDDA2\uDDB0-\uDDB9\uDDC0-\uDDC2\uDDD0-\uDDFF])|(?:[#\*0-9\xA9\xAE\u203C\u2049\u2122\u2139\u2194-\u2199\u21A9\u21AA\u231A\u231B\u2328\u23CF\u23E9-\u23F3\u23F8-\u23FA\u24C2\u25AA\u25AB\u25B6\u25C0\u25FB-\u25FE\u2600-\u2604\u260E\u2611\u2614\u2615\u2618\u261D\u2620\u2622\u2623\u2626\u262A\u262E\u262F\u2638-\u263A\u2640\u2642\u2648-\u2653\u265F\u2660\u2663\u2665\u2666\u2668\u267B\u267E\u267F\u2692-\u2697\u2699\u269B\u269C\u26A0\u26A1\u26AA\u26AB\u26B0\u26B1\u26BD\u26BE\u26C4\u26C5\u26C8\u26CE\u26CF\u26D1\u26D3\u26D4\u26E9\u26EA\u26F0-\u26F5\u26F7-\u26FA\u26FD\u2702\u2705\u2708-\u270D\u270F\u2712\u2714\u2716\u271D\u2721\u2728\u2733\u2734\u2744\u2747\u274C\u274E\u2753-\u2755\u2757\u2763\u2764\u2795-\u2797\u27A1\u27B0\u27BF\u2934\u2935\u2B05-\u2B07\u2B1B\u2B1C\u2B50\u2B55\u3030\u303D\u3297\u3299]|\uD83C[\uDC04\uDCCF\uDD70\uDD71\uDD7E\uDD7F\uDD8E\uDD91-\uDD9A\uDDE6-\uDDFF\uDE01\uDE02\uDE1A\uDE2F\uDE32-\uDE3A\uDE50\uDE51\uDF00-\uDF21\uDF24-\uDF93\uDF96\uDF97\uDF99-\uDF9B\uDF9E-\uDFF0\uDFF3-\uDFF5\uDFF7-\uDFFF]|\uD83D[\uDC00-\uDCFD\uDCFF-\uDD3D\uDD49-\uDD4E\uDD50-\uDD67\uDD6F\uDD70\uDD73-\uDD7A\uDD87\uDD8A-\uDD8D\uDD90\uDD95\uDD96\uDDA4\uDDA5\uDDA8\uDDB1\uDDB2\uDDBC\uDDC2-\uDDC4\uDDD1-\uDDD3\uDDDC-\uDDDE\uDDE1\uDDE3\uDDE8\uDDEF\uDDF3\uDDFA-\uDE4F\uDE80-\uDEC5\uDECB-\uDED2\uDEE0-\uDEE5\uDEE9\uDEEB\uDEEC\uDEF0\uDEF3-\uDEF9]|\uD83E[\uDD10-\uDD3A\uDD3C-\uDD3E\uDD40-\uDD45\uDD47-\uDD70\uDD73-\uDD76\uDD7A\uDD7C-\uDDA2\uDDB0-\uDDB9\uDDC0-\uDDC2\uDDD0-\uDDFF])\uFE0F|(?:[\u261D\u26F9\u270A-\u270D]|\uD83C[\uDF85\uDFC2-\uDFC4\uDFC7\uDFCA-\uDFCC]|\uD83D[\uDC42\uDC43\uDC46-\uDC50\uDC66-\uDC69\uDC6E\uDC70-\uDC78\uDC7C\uDC81-\uDC83\uDC85-\uDC87\uDCAA\uDD74\uDD75\uDD7A\uDD90\uDD95\uDD96\uDE45-\uDE47\uDE4B-\uDE4F\uDEA3\uDEB4-\uDEB6\uDEC0\uDECC]|\uD83E[\uDD18-\uDD1C\uDD1E\uDD1F\uDD26\uDD30-\uDD39\uDD3D\uDD3E\uDDB5\uDDB6\uDDB8\uDDB9\uDDD1-\uDDDD]))/</span></span>;
    <span class="keyword">var</span> <span class="variable-name">entity_re</span> = <span class="string"><span class="jcXcovered">/^(&amp;(?:[a-z\d]+|#\d+|#x[a-f\d]+);)/i</span></span>;
    <span class="comment">// https://stackoverflow.com/questions/11381673/detecting-a-mobile-browser
</span>    <span class="keyword">var</span> <span class="variable-name">mobile_re</span> = <span class="string"><span class="jcXcovered">/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i</span></span>;
    <span class="keyword">var</span> <span class="variable-name">tablet_re</span> = <span class="string"><span class="jcXcovered">/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_split_re</span> = <span class="string"><span class="jcXcovered">/(\[\[[!gbiuso]*;[^;]*;[^\]]*\](?:[^\]]*[^\\](\\\\)*\\\][^\]]*|[^\]]*|[^[]*\[[^\]]*)\]?)/i</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_parts_re</span> = <span class="string"><span class="jcXcovered">/\[\[([!gbiuso]*);([^;]*);([^;\]]*);?([^;\]]*);?([^\]]*)\]([^\]\\]*\\\][^\]]*|[^\]]*|[^[]*\[[^\]]+)\]?/gi</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_re</span> = <span class="string"><span class="jcXcovered">/\[\[([!gbiuso]*;[^;\]]*;[^;\]]*(?:;|[^\]()]*);?[^\]]*)\]([^\]]*\\\][^\]]*|[^\]]*|[^[]*\[[^\]]*)\]?/gi</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_exist_re</span> = <span class="string"><span class="jcXcovered">/\[\[([!gbiuso]*;[^;\]]*;[^;\]]*(?:;|[^\]()]*);?[^\]]*)\]([^\]]*\\\][^\]]*|[^\]]*|[^[]*\[[^\]]*)\]/gi</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_full_re</span> = <span class="string"><span class="jcXcovered">/^\[\[([!gbiuso]*;[^;\]]*;[^;\]]*(?:;|[^\]()]*);?[^\]]*)\]([^\]]*\\\][^\]]*|[^\]]*|[^[]*\[[^\]]*)\]$/gi</span></span>;
    <span class="keyword">var</span> <span class="variable-name">color_hex_re</span> = <span class="string"><span class="jcXcovered">/^#([0-9a-f]{3}|[0-9a-f]{6})$/i</span></span>;
    <span class="keyword">var</span> <span class="variable-name">url_re</span> = <span class="string"><span class="jcXcovered">/(\bhttps?:\/\/(?:(?:(?!&amp;[^;]+;)|(?=&amp;amp;))[^\s"'&lt;&gt;\][)])+)/gi</span></span>;
    <span class="keyword">var</span> <span class="variable-name">url_nf_re</span> = <span class="string"><span class="jcXcovered">/\b(?![^\s[\]]*])(https?:\/\/(?:(?:(?!&amp;[^;]+;)|(?=&amp;amp;))[^\s"'&lt;&gt;\][)])+)/gi</span></span>;
    <span class="keyword">var</span> <span class="variable-name">email_re</span> = <span class="string"><span class="jcXcovered">/((([^&lt;&gt;('")[\]\\.,;:\s@"]+(\.[^&lt;&gt;()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,})))/g</span></span>;
    <span class="keyword">var</span> <span class="variable-name">url_full_re</span> = <span class="string"><span class="jcXcovered">/^(https?:\/\/(?:(?:(?!&amp;[^;]+;)|(?=&amp;amp;))[^\s"'&lt;&gt;\][)])+)$/gi</span></span>;
    <span class="keyword">var</span> <span class="variable-name">email_full_re</span> = <span class="string"><span class="jcXcovered">/^((([^&lt;&gt;('")[\]\\.,;:\s@"]+(\.[^&lt;&gt;()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,})))$/g</span></span>;
    <span class="keyword">var</span> <span class="variable-name">command_re</span> = <span class="string"><span class="jcXcovered">/((?:"[^"\\]*(?:\\[\S\s][^"\\]*)*"|'[^'\\]*(?:\\[\S\s][^'\\]*)*'|\/[^\/\\]*(?:\\[\S\s][^\/\\]*)*\/[gimsuy]*(?=\s|$)|(?:\\\s|\S))+)(?=\s|$)/gi</span></span>;
    <span class="keyword">var</span> <span class="variable-name">extended_command_re</span> = <span class="string"><span class="jcXcovered">/^\s*((terminal|cmd)::([a-z_]+)\(([\s\S]*)\))\s*$/</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_begin_re</span> = <span class="string"><span class="jcXcovered">/(\[\[[!gbiuso]*;[^;]*;[^\]]*\])/i</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_start_re</span> = <span class="string"><span class="jcXcovered">/^(\[\[[!gbiuso]*;[^;]*;[^\]]*\])/i</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_end_re</span> = <span class="string"><span class="jcXcovered">/\[\[[!gbiuso]*;[^;]*;[^\]]*\]?$/i</span></span>;
    <span class="keyword">var</span> <span class="variable-name">format_exec_re</span> = <span class="string"><span class="jcXcovered">/(\[\[(?:[^\][]|\\\])+\]\])/</span></span>;
    <span class="keyword">var</span> <span class="variable-name">float_re</span> = <span class="string"><span class="jcXcovered">/^[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?$/</span></span>;
    <span class="keyword">var</span> <span class="variable-name">re_re</span> = <span class="string"><span class="jcXcovered">/^\/((?:\\\/|[^/]|\[[^\]]*\/[^\]]*\])+)\/([gimsuy]*)$/</span></span>;
    <span class="keyword">var</span> <span class="variable-name">string_re</span> = <span class="string"><span class="jcXcovered">/("(?:[^"\\]|\\(?:\\\\)*"|\\\\)*"|'(?:[^'\\]|\\(?:\\\\)*'|\\\\)*')/</span></span>;
    <span class="keyword">var</span> <span class="variable-name">unclosed_strings_re</span> = <span class="string"><span class="jcXcovered">/^(?=((?:[^"']+|"[^"\\]*(?:\\[^][^"\\]*)*"|'[^'\\]*(?:\\[^][^'\\]*)*')*))\1./</span></span>;
    <span class="comment">/* eslint-enable */</span>
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// :: TOOLS
</span>    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// taken from https://hacks.mozilla.org/2011/09/detecting-and-generating-
</span>    <span class="comment">// css-animations-in-javascript/
</span>    <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">animation_supported</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
        <span class="keyword">var</span> <span class="variable-name">animation</span> = <span class="constant"><span class="jcXcovered">false</span></span>,
            <span class="variable-name">domPrefixes</span> = <span class="string"><span class="jcXcovered">'Webkit Moz O ms Khtml'</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">)</span>,
            <span class="variable-name">elm</span> = <span class="jcXcovered">document.</span><span class="js2-function-call"><span class="jcXcovered">createElement</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'div'</span></span><span class="jcXcovered">)</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (elm.<span class="js2-object-property">style</span>.<span class="js2-object-property">animationName</span>) {
            <span class="jcXnot-covered">animation = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (animation === <span class="constant">false</span>) {
            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>; i &lt; domPrefixes.<span class="js2-object-property">length</span>; i++) {
                <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="jcXcovered">domPrefixes[i] + </span><span class="string"><span class="jcXcovered">'AnimationName'</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (elm.<span class="js2-object-property">style</span>[name] !== <span class="constant">undefined</span>) {
                    <span class="jcXnot-covered">animation = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                    <span class="keyword"><span class="jcXnot-covered">break</span></span><span class="jcXnot-covered">;</span>
                }
            }
        }
        <span class="jcXcovered">elm = </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> animation;</span>
    })();
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">is_ch_unit_supported</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
        <span class="keyword">var</span> <span class="variable-name">agent</span> = <span class="jcXcovered">window.</span><span class="js2-object-property"><span class="jcXcovered">navigator</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">userAgent</span></span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (agent.<span class="js2-function-call">match</span>(<span class="string">/MSIE|Trident/</span>) &amp;&amp; <span class="negation-char">!</span>agent.<span class="js2-function-call">match</span>(<span class="string">/IEMobile/</span>)) {
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="keyword">var</span> <span class="variable-name">div</span> = <span class="jcXcovered">document.</span><span class="js2-function-call"><span class="jcXcovered">createElement</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'div'</span></span><span class="jcXcovered">)</span>;
        <span class="jcXcovered">div.</span><span class="js2-object-property"><span class="jcXcovered">style</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">width</span></span><span class="jcXcovered"> = </span><span class="string"><span class="jcXcovered">'1ch'</span></span><span class="jcXcovered">;</span>
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> div.</span><span class="js2-object-property"><span class="jcXcovered">style</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">width</span></span><span class="jcXcovered"> === </span><span class="string"><span class="jcXcovered">'1ch'</span></span><span class="jcXcovered">;</span>
    })();
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">is_css_variables_supported</span> = <span class="jcXcovered">window.</span><span class="js2-object-property"><span class="jcXcovered">CSS</span></span><span class="jcXcovered"> </span>&amp;&amp; window.<span class="js2-object-property">CSS</span>.<span class="js2-object-property">supports</span> &amp;&amp;
            window.<span class="js2-object-property">CSS</span>.<span class="js2-function-call">supports</span>(<span class="string">'--fake-var'</span>, 0);
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">is_android</span> = <span class="jcXcovered">navigator.</span><span class="js2-object-property"><span class="jcXcovered">userAgent</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">toLowerCase</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">indexOf</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'android'</span></span><span class="jcXcovered">) !== -1</span>;
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">is_key_native</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span> <span class="function-name">is_key_native</span>() {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>(<span class="string">'KeyboardEvent'</span> <span class="keyword">in</span> window &amp;&amp; <span class="string">'key'</span> <span class="keyword">in</span> window.<span class="js2-object-property">KeyboardEvent</span>.<span class="js2-object-property">prototype</span>)) {
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="keyword">var</span> <span class="variable-name">proto</span> = <span class="jcXcovered">window.</span><span class="js2-object-property"><span class="jcXcovered">KeyboardEvent</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">prototype</span></span>;
        <span class="keyword">var</span> <span class="variable-name">get</span> = <span class="jcXcovered">Object.</span><span class="js2-function-call"><span class="jcXcovered">getOwnPropertyDescriptor</span></span><span class="jcXcovered">(proto, </span><span class="string"><span class="jcXcovered">'key'</span></span><span class="jcXcovered">).</span><span class="js2-object-property"><span class="jcXcovered">get</span></span>;
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="negation-char"><span class="jcXcovered">!!</span></span><span class="jcXcovered">get.</span><span class="js2-function-call"><span class="jcXcovered">toString</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\[native code\]/</span></span><span class="jcXcovered">);</span>
    })();
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">is_mobile</span> = <span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">function</span></span><span class="jcXcovered">(</span><span class="js2-function-param"><span class="jcXcovered">a</span></span><span class="jcXcovered">) {
        </span><span class="keyword"><span class="jcXcovered">var</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">check</span></span><span class="jcXcovered"> = </span><span class="constant"><span class="jcXcovered"><span class="jcXcovered">false</span></span></span><span class="jcXcovered">;
 </span>       <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (mobile_re.<span class="js2-function-call">test</span>(a) || tablet_re.<span class="js2-function-call">test</span>(a.<span class="js2-function-call">substr</span>(0, 4))) {
            <span class="jcXnot-covered">check = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> check;</span>
    })(navigator.<span class="js2-object-property">userAgent</span> || navigator.<span class="js2-object-property">vendor</span> || window.<span class="js2-object-property">opera</span>);

    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// IE ch unit bug detection - better that UserAgent that can be changed
</span>    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">ch_unit_bug</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
    <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">unction</span>() {
        <span class="keyword">function</span> <span class="function-name">width</span>(<span class="js2-function-param">e</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> e[0].</span><span class="js2-function-call"><span class="jcXcovered">getBoundingClientRect</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">width</span></span><span class="jcXcovered">;</span>
        }
        <span class="keyword">var</span> <span class="variable-name">base</span> = <span class="string"><span class="jcXcovered">'&lt;span style="font-family: monospace;visibility:hidden;'</span></span>;
        <span class="keyword">var</span> <span class="variable-name">ch</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(base + </span><span class="string"><span class="jcXcovered">'width:1ch;overflow: hidden"&gt;&amp;nbsp;&lt;/span&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">appendTo</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'body'</span></span><span class="jcXcovered">)</span>;
        <span class="keyword">var</span> <span class="variable-name">space</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(base + </span><span class="string"><span class="jcXcovered">'"&gt;&amp;nbsp;&lt;/span&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">appendTo</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'body'</span></span><span class="jcXcovered">)</span>;
        <span class="jcXcovered">ch_unit_bug = </span><span class="js2-function-call"><span class="jcXcovered">width</span></span><span class="jcXcovered">(ch) !== </span><span class="js2-function-call"><span class="jcXcovered">width</span></span><span class="jcXcovered">(space);</span>
        <span class="jcXcovered">ch.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
        <span class="jcXcovered">space.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
    });

    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">strlen</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> wcwidth === <span class="string">'undefined'</span>) {
            <span class="keyword"><span class="jcXnot-covered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> $.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered">(string);</span>
            };
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> wcwidth;</span>
        }
    })();
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">bare_text</span>(<span class="js2-function-param">string</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>string.<span class="js2-function-call">match</span>(<span class="string">/&amp;/</span>)) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;span&gt;'</span></span><span class="jcXcovered"> + </span><span class="js2-function-call"><span class="jcXcovered">safe</span></span><span class="jcXcovered">(string) + </span><span class="string"><span class="jcXcovered">'&lt;/span&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">();</span>
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">text</span>(<span class="js2-function-param">string</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">bare_text</span></span><span class="jcXcovered">($.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">strip</span></span><span class="jcXcovered">(string));</span>
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">safe</span>(<span class="js2-function-param">string</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>string.<span class="js2-function-call">match</span>(<span class="string">/[&lt;&gt;&amp;]/</span>)) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/&amp;(?![^;]+;)/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'&amp;amp;'</span></span><span class="jcXcovered">)
  </span>          .<span class="js2-function-call">replace</span>(<span class="string">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>).<span class="js2-function-call">replace</span>(<span class="string">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>);
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">crlf</span>(<span class="js2-function-param">string</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\r/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">char_len</span>(<span class="js2-function-param">chr</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> entity_re.</span><span class="js2-function-call"><span class="jcXcovered">test</span></span><span class="jcXcovered">(chr) ? 1 : chr.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// :: function that return character from beginning of the string
</span>    <span class="comment">// :: counting emoji, suroggate pairs and combine characters
</span>    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">get_next_character</span>(<span class="js2-function-param">string</span>) {
        <span class="keyword">var</span> <span class="variable-name">match_entity</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(entity_re)</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (match_entity) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> match_entity[1];</span>
        }
        <span class="keyword">var</span> <span class="variable-name">match_emoji</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(emoji_re)</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (match_emoji) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> match_emoji[1];</span>
        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (string.<span class="js2-function-call">slice</span>(0, 2).<span class="js2-function-call">replace</span>(astral_symbols_re, <span class="string">'_'</span>) === 1) {
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">slice</span>(1).<span class="js2-function-call">match</span>(combine_chr_re)) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> string.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(0, 3);</span>
            }
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> string.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(0, 2);</span>
        } <span class="keyword">else</span> {
            <span class="keyword">var</span> <span class="variable-name">match_combo</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(combine_chr_re)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (match_combo) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> match_combo[1];</span>
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string[0];</span>
        }
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// normalize position for counting emoji and extra chars
</span>    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">normalize_position</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">position</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position === 0) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> position;</span>
        }
        <span class="jcXcovered">string = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">strip</span></span><span class="jcXcovered">(string);</span>
        <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">spli</span></span><span class="js2-function-call">t_characters</span>(string).<span class="js2-function-call">reduce</span>(<span class="keyword">function</span>(<span class="js2-function-param">acc</span>, <span class="js2-function-param">chr</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> acc === <span class="string">'number'</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> acc;</span>
            }
            <span class="keyword">var</span> <span class="variable-name">length</span> = <span class="jcXcovered">acc.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> + </span><span class="js2-function-call"><span class="jcXcovered">char_len</span></span><span class="jcXcovered">(chr)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (length &gt;= position) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> acc.</span><span class="js2-object-property"><span class="jcXcovered">position</span></span><span class="jcXcovered"> + 1;</span>
            }
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> {
                <span class="js2-object-property">position</span>: acc.<span class="js2-object-property">position</span> + 1,
                <span class="js2-object-property">length</span>: length
            };
        }, {<span class="js2-object-property">position</span>: 0, <span class="js2-object-property">length</span>: 0});
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> result === <span class="string">'number'</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> result.</span><span class="js2-object-property"><span class="jcXnot-covered">position</span></span><span class="jcXnot-covered">;</span>
        }
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">char_width_prop</span>(<span class="js2-function-param">len</span>, <span class="js2-function-param">options</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (is_ch_unit_supported) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'width: '</span></span><span class="jcXcovered"> + len + </span><span class="string"><span class="jcXcovered">'ch'</span></span><span class="jcXcovered">;</span>
        }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (<span class="negation-char">!</span>is_css_variables_supported) {
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">char_width</span>) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">'width: '</span></span><span class="jcXnot-covered"> + (options.</span><span class="js2-object-property"><span class="jcXnot-covered">char_width</span></span><span class="jcXnot-covered"> * len) + </span><span class="string"><span class="jcXnot-covered">'px'</span></span><span class="jcXnot-covered">;</span>
            }
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">'--length: '</span></span><span class="jcXnot-covered"> + len;</span>
        }
        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">;</span>
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// options {char_width}
</span>    <span class="keyword">function</span> <span class="function-name">extra_css</span>(<span class="js2-function-param">text</span>, <span class="js2-function-param">options</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> wcwidth !== <span class="string">'undefined'</span>) {
            <span class="keyword">var</span> <span class="variable-name">bare</span> = <span class="js2-function-call"><span class="jcXcovered">bare_text</span></span><span class="jcXcovered">(text)</span>;
            <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="js2-function-call"><span class="jcXcovered">strlen</span></span><span class="jcXcovered">(bare)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (len !== $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">length</span>(bare)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">char_width_prop</span></span><span class="jcXcovered">(len, options);</span>
            }
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">wide_characters</span>(<span class="js2-function-param">text</span>, <span class="js2-function-param">options</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> wcwidth !== <span class="string">'undefined'</span>) {
            <span class="keyword">var</span> <span class="variable-name">bare</span> = <span class="js2-function-call"><span class="jcXcovered">bare_text</span></span><span class="jcXcovered">(text)</span>;
            <span class="keyword">var</span> <span class="variable-name">chars</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_characters</span></span><span class="jcXcovered">(bare)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (chars.<span class="js2-object-property">length</span> === 1) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> text;</span>
            }
            <span class="keyword">var</span> <span class="variable-name">sp</span><span class="variable-name"><span class="jcXcovered">ecs</span></span><span class="jcXcovered"> = </span>chars.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">chr</span>) {
                <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> {
                    <span class="js2-object-property">len</span>: <span class="js2-function-call">strlen</span>(chr),
                    <span class="js2-object-property">chr</span>: chr
                };
            }).<span class="js2-function-call">reduce</span>(<span class="keyword">function</span>(<span class="js2-function-param">arr</span>, <span class="js2-function-param">spec</span>) {
                <span class="keyword">var</span> <span class="variable-name">last</span> = <span class="jcXcovered">arr[arr.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1]</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (last) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (last.<span class="js2-object-property">len</span> !== spec.<span class="js2-object-property">len</span>) {
                        <span class="keyword"><span class="jcXnot-covered">retu</span></span><span class="keyword">rn</span> arr.<span class="js2-function-call">concat</span>([{
                            <span class="js2-object-property">sum</span>: spec.<span class="js2-object-property">len</span>,
                            <span class="js2-object-property">len</span>: spec.<span class="js2-object-property">len</span>,
                            <span class="js2-object-property">str</span>: spec.<span class="js2-object-property">chr</span>
                        }]);
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">arr.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">();</span>
                        <span class="keyword"><span class="jcXcovered">retu</span></span><span class="keyword">rn</span> arr.<span class="js2-function-call">concat</span>([{
                            <span class="js2-object-property">sum</span>: last.<span class="js2-object-property">sum</span> + spec.<span class="js2-object-property">len</span>,
                            <span class="js2-object-property">len</span>: last.<span class="js2-object-property">len</span>,
                            <span class="js2-object-property">str</span>: last.<span class="js2-object-property">str</span> + spec.<span class="js2-object-property">chr</span>
                        }]);
                    }
                }
                <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> [{
                    <span class="js2-object-property">sum</span>: spec.<span class="js2-object-property">len</span>,
                    <span class="js2-object-property">str</span>: spec.<span class="js2-object-property">chr</span>,
                    <span class="js2-object-property">len</span>: spec.<span class="js2-object-property">len</span>
                }];
            }, []);
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> specs</span>.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">spec</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (spec.<span class="js2-object-property">len</span> === 1) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> spec.</span><span class="js2-object-property"><span class="jcXnot-covered">str</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">style</span> = <span class="js2-function-call"><span class="jcXcovered">char_width_prop</span></span><span class="jcXcovered">(spec.</span><span class="js2-object-property"><span class="jcXcovered">sum</span></span><span class="jcXcovered">, options)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (spec.<span class="js2-object-property">sum</span> === chars.<span class="js2-object-property">length</span> || <span class="negation-char">!</span>style.<span class="js2-object-property">length</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">'&lt;span&gt;'</span></span><span class="jcXnot-covered"> + spec.</span><span class="js2-object-property"><span class="jcXnot-covered">str</span></span><span class="jcXnot-covered"> + </span><span class="string"><span class="jcXnot-covered">'&lt;/span&gt;'</span></span><span class="jcXnot-covered">;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'&lt;span style="'</span></span><span class="jcXcovered"> + style + </span><span class="string"><span class="jcXcovered">'"&gt;'</span></span><span class="jcXcovered"> + spec.</span><span class="js2-object-property"><span class="jcXcovered">str</span></span><span class="jcXcovered"> + </span><span class="string"><span class="jcXcovered">'&lt;/span&gt;'</span></span><span class="jcXcovered">;</span>
                }
            }).<span class="js2-function-call">join</span>(<span class="string">''</span>);
        }
        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> text;</span>
    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="comment">// :: Binary search utility
</span>    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">binary_search</span>(<span class="js2-function-param">start</span>, <span class="js2-function-param">end</span>, <span class="js2-function-param">search_pos</span>, <span class="js2-function-param">compare_fn</span>) {
        <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="jcXcovered">end - start</span>;
        <span class="keyword">var</span> <span class="variable-name">mid</span> = <span class="jcXcovered">start + Math.</span><span class="builtin"><span class="jcXcovered">floor</span></span><span class="jcXcovered">(len / 2)</span>;
        <span class="keyword">var</span> <span class="variable-name">cmp</span> = <span class="js2-function-call"><span class="jcXcovered">compare_fn</span></span><span class="jcXcovered">(search_pos, mid)</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (cmp === 0) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> mid;</span>
        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (cmp &gt; 0 &amp;&amp; len &gt; 1) {
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="js2-function-call">binary_search</span>(
                mid,
                end,
                search_pos,
                compare_fn
            );
        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (cmp &lt; 0 &amp;&amp; len &gt; 1) {
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="js2-function-call">binary_search</span>(
                start,
                mid,
                search_pos,
                compare_fn
            );
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> -1;</span>
        }
    }
    <span class="comment">// -----------------------------------------------------------------
</span>    <span class="comment">// :: selection utilities - should work in modern browser including IE9
</span>    <span class="comment">// -----------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">is_terminal_selected</span>(<span class="js2-function-param">cmd</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(window.<span class="js2-object-property">getSelection</span>)) {
            <span class="keyword">var</span> <span class="variable-name">selection</span> = <span class="jcXnot-covered">window.</span><span class="js2-function-call"><span class="jcXnot-covered">getSelection</span></span><span class="jcXnot-covered">()</span>;
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (selection.<span class="js2-function-call">toString</span>()) {
                <span class="keyword">var</span> <span class="variable-name">node</span> = <span class="jcXnot-covered">selection.</span><span class="js2-function-call"><span class="jcXnot-covered">getRangeAt</span></span><span class="jcXnot-covered">(0).</span><span class="js2-object-property"><span class="jcXnot-covered">startContainer</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">parentNode</span></span>;
                <span class="keyword">var</span> <span class="variable-name">term</span> = <span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(node).</span><span class="js2-function-call"><span class="jcXnot-covered">closest</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'.terminal'</span></span><span class="jcXnot-covered">)</span>;
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> term.</span><span class="js2-object-property"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered"> &amp;&amp; (cmd &amp;&amp; term.</span><span class="js2-function-call"><span class="jcXnot-covered">find</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'.cmd'</span></span><span class="jcXnot-covered">).</span><span class="js2-function-call"><span class="jcXnot-covered">is</span></span><span class="jcXnot-covered">(cmd) || </span><span class="negation-char"><span class="jcXnot-covered">!</span></span><span class="jcXnot-covered">cmd);</span>
            }
        }
    }
    <span class="comment">// -----------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">get_selected_html</span>() {
        <span class="keyword">var</span> <span class="variable-name">html</span> = <span class="string"><span class="jcXcovered">''</span></span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(window.<span class="js2-object-property">getSelection</span>)) {
            <span class="keyword">var</span> <span class="variable-name">sel</span> = <span class="jcXnot-covered">window.</span><span class="js2-function-call"><span class="jcXnot-covered">getSelection</span></span><span class="jcXnot-covered">()</span>;
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (sel.<span class="js2-object-property">rangeCount</span>) {
                <span class="keyword">var</span> <span class="variable-name">container</span> = <span class="jcXnot-covered">document.</span><span class="js2-function-call"><span class="jcXnot-covered">createElement</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'div'</span></span><span class="jcXnot-covered">)</span>;
                <span class="keyword"><span class="jcXnot-covered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXnot-covered">0</span>, <span class="variable-name">len</span> = <span class="jcXnot-covered">sel.</span><span class="js2-object-property"><span class="jcXnot-covered">rangeCount</span></span>; i &lt; len; ++i) {
                    <span class="jcXnot-covered">container.</span><span class="js2-function-call"><span class="jcXnot-covered">appendChild</span></span><span class="jcXnot-covered">(sel.</span><span class="js2-function-call"><span class="jcXnot-covered">getRangeAt</span></span><span class="jcXnot-covered">(i).</span><span class="js2-function-call"><span class="jcXnot-covered">cloneContents</span></span><span class="jcXnot-covered">());</span>
                }
                <span class="jcXnot-covered">html = container.</span><span class="js2-object-property"><span class="jcXnot-covered">innerHTML</span></span><span class="jcXnot-covered">;</span>
            }
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> html;</span>
    }
    <span class="comment">// -----------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">with_selection</span>(<span class="js2-function-param">fn</span>) {
        <span class="keyword">var</span> <span class="variable-name">html</span> = <span class="string"><span class="jcXcovered">''</span></span>;
        <span class="keyword">var</span> <span class="variable-name">ranges</span> = <span class="jcXcovered">[]</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(window.<span class="js2-object-property">getSelection</span>)) {
            <span class="keyword">var</span> <span class="variable-name">selection</span> = <span class="jcXnot-covered">window.</span><span class="js2-function-call"><span class="jcXnot-covered">getSelection</span></span><span class="jcXnot-covered">()</span>;
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (selection.<span class="js2-object-property">rangeCount</span>) {
                <span class="keyword">var</span> <span class="variable-name">container</span> = <span class="jcXnot-covered">document.</span><span class="js2-function-call"><span class="jcXnot-covered">createElement</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">"div"</span></span><span class="jcXnot-covered">)</span>;
                <span class="keyword"><span class="jcXnot-covered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXnot-covered">0</span>, <span class="variable-name">len</span> = <span class="jcXnot-covered">selection.</span><span class="js2-object-property"><span class="jcXnot-covered">rangeCount</span></span>; i &lt; len; ++i) {
                    <span class="keyword">var</span> <span class="variable-name">range</span> = <span class="jcXnot-covered">selection.</span><span class="js2-function-call"><span class="jcXnot-covered">getRangeAt</span></span><span class="jcXnot-covered">(i).</span><span class="js2-function-call"><span class="jcXnot-covered">cloneRange</span></span><span class="jcXnot-covered">()</span>;
                    <span class="jcXnot-covered">ranges.</span><span class="js2-function-call"><span class="jcXnot-covered">push</span></span><span class="jcXnot-covered">(range);</span>
                    <span class="jcXnot-covered">container.</span><span class="js2-function-call"><span class="jcXnot-covered">appendChild</span></span><span class="jcXnot-covered">(range.</span><span class="js2-function-call"><span class="jcXnot-covered">cloneContents</span></span><span class="jcXnot-covered">());</span>
                }
                <span class="jcXnot-covered">html = container.</span><span class="js2-object-property"><span class="jcXnot-covered">innerHTML</span></span><span class="jcXnot-covered">;</span>
            }
        }
        <span class="js2-function-call"><span class="jcXcovered">fn</span></span><span class="jcXcovered">(html);</span>
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ranges.<span class="js2-object-property">length</span>) {
            <span class="jcXnot-covered">selection.</span><span class="js2-function-call"><span class="jcXnot-covered">removeAllRanges</span></span><span class="jcXnot-covered">();</span>
            <span class="jcXnot-covered">ran</span>ges.<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">range</span>) {
                <span class="jcXnot-covered">selection.</span><span class="js2-function-call"><span class="jcXnot-covered">addRange</span></span><span class="jcXnot-covered">(range);</span>
            });
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> html !== </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
    }
    <span class="comment">// -----------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">process_selected_line</span>() {
        <span class="keyword">var</span> <span class="variable-name">$self</span> = <span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(</span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">)</span>;
        <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXnot-covered">$self.</span><span class="js2-function-call"><span class="jcXnot-covered">text</span></span><span class="jcXnot-covered">()</span>;
        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> ($self.<span class="js2-function-call">hasClass</span>(<span class="string">'end-line'</span>)) {
            <span class="jcXnot-covered">result += </span><span class="string"><span class="jcXnot-covered">'\n'</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> result;</span>
    }
    <span class="comment">// -----------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">process_div</span>(<span class="js2-function-param">element</span>) {
        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(element).</span><span class="js2-function-call"><span class="jcXnot-covered">find</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'&gt; div'</span></span><span class="jcXnot-covered">)
            .</span><span class="js2-function-call"><span class="jcXnot-covered">map</span></span><span class="jcXnot-covered">(process_selected_li</span>ne).<span class="js2-function-call">get</span>().<span class="js2-function-call">join</span>(<span class="string">'\n'</span>).<span class="js2-function-call">replace</span>(<span class="string">/\n$/</span>, <span class="string">''</span>);
    }
    <span class="comment">// -----------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">process_selected_html</span>(<span class="js2-function-param">html</span>) {
        <span class="keyword">var</span> <span class="variable-name">stdout</span>;
        <span class="keyword">var</span> <span class="variable-name">text</span> = <span class="string"><span class="jcXnot-covered">''</span></span>;
        <span class="keyword">var</span> <span class="variable-name">$html</span> = <span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'&lt;div&gt;'</span></span><span class="jcXnot-covered"> + html + </span><span class="string"><span class="jcXnot-covered">'&lt;/div&gt;'</span></span><span class="jcXnot-covered">)</span>;
        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (html.<span class="js2-function-call">match</span>(<span class="string">/&lt;\/div&gt;/</span>)) {
            <span class="comment">// match multiple echo output
</span>            <span class="jcXnot-covered">stdout = $html.</span><span class="js2-function-call"><span class="jcXnot-covered">find</span></span><span class="jcXnot-covered">(</span><span class="string">'div[data-index]'</span>).<span class="js2-function-call">map</span>(<span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">process_div</span></span><span class="jcXnot-covered">(</span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">);</span>
            }).<span class="js2-function-call">get</span>().<span class="js2-function-call">join</span>(<span class="string">'\n'</span>);
            <span class="comment">// match insdie single echo output
</span>            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>stdout &amp;&amp; html.<span class="js2-function-call">match</span>(<span class="string">/style="width: 100%;?"/</span>)) {
                <span class="jcXnot-covered">stdout = </span><span class="js2-function-call"><span class="jcXnot-covered">process_div</span></span><span class="jcXnot-covered">($html);</span>
            }
            <span class="jcXnot-covered">text = stdout;</span>
        }
        <span class="keyword">var</span> <span class="variable-name">$prompt</span> = <span class="jcXnot-covered">$html.</span><span class="js2-function-call"><span class="jcXnot-covered">find</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'.prompt'</span></span><span class="jcXnot-covered">)</span>;
        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> ($prompt.<span class="js2-object-property">length</span>) {
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (text.<span class="js2-object-property">length</span>) {
                <span class="jcXnot-covered">text += </span><span class="string"><span class="jcXnot-covered">'\n'</span></span><span class="jcXnot-covered">;</span>
            }
            <span class="jcXnot-covered">text += $prompt.</span><span class="js2-function-call"><span class="jcXnot-covered">text</span></span><span class="jcXnot-covered">();</span>
        }
        <span class="keyword">var</span> <span class="variable-name">$cmd_lines</span> = <span class="jcXnot-covered">$html.</span><span class="js2-function-call"><span class="jcXnot-covered">find</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'[role="presentation"]'</span></span><span class="jcXnot-covered">)</span>;
        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> ($cmd_lines.<span class="js2-object-property">length</span>) {
            <span class="jcXnot-covered">text += $cmd_lines.</span><span class="js2-function-call"><span class="jcXnot-covered">map</span></span><span class="jcXnot-covered">(process_selected_line).</span><span class="js2-function-call"><span class="jcXnot-covered">get</span></span><span class="jcXnot-covered">().</span><span class="js2-function-call"><span class="jcXnot-covered">join</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">);</span>
        }
        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>text.<span class="js2-object-property">length</span> &amp;&amp; html) {
            <span class="jcXnot-covered">text = $html.</span><span class="js2-function-call"><span class="jcXnot-covered">text</span></span><span class="jcXnot-covered">();</span>
        }
        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> text.</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/\xA0/g</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">' '</span></span><span class="jcXnot-covered">);</span> <span class="comment">// fix &amp;nbsp; space
</span>    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="comment">// :: copy given DOM element text to clipboard
</span>    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">text_to_clipboard</span>;
    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(document.<span class="js2-object-property">queryCommandSupported</span>) &amp;&amp;
        document.<span class="js2-function-call">queryCommandSupported</span>(<span class="string">'copy'</span>)) {
        <span class="function-name"><span class="jcXnot-covered">te</span></span><span class="function-name">xt_to_clipboard</span> = <span class="keyword">function</span> <span class="function-name">text_to_clipboard</span>(<span class="js2-function-param">$textarea</span>, <span class="js2-function-param">text</span>) {
            <span class="keyword">var</span> <span class="variable-name">val</span> = <span class="jcXnot-covered">$textarea.</span><span class="js2-function-call"><span class="jcXnot-covered">val</span></span><span class="jcXnot-covered">()</span>;
            <span class="keyword">var</span> <span class="variable-name">had_focus</span> = <span class="jcXnot-covered">$textarea.</span><span class="js2-function-call"><span class="jcXnot-covered">is</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">':focus'</span></span><span class="jcXnot-covered">)</span>;
            <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXnot-covered">$textarea.</span><span class="js2-function-call"><span class="jcXnot-covered">caret</span></span><span class="jcXnot-covered">()</span>;
            <span class="jcXnot-covered">$textarea.</span><span class="js2-function-call"><span class="jcXnot-covered">val</span></span><span class="jcXnot-covered">(text).</span><span class="js2-function-call"><span class="jcXnot-covered">focus</span></span><span class="jcXnot-covered">();</span>
            <span class="jcXnot-covered">$textarea[0].</span><span class="js2-function-call"><span class="jcXnot-covered">select</span></span><span class="jcXnot-covered">();</span>
            <span class="jcXnot-covered">document.</span><span class="js2-function-call"><span class="jcXnot-covered">execCommand</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'copy'</span></span><span class="jcXnot-covered">);</span>
            <span class="jcXnot-covered">$textarea.</span><span class="js2-function-call"><span class="jcXnot-covered">val</span></span><span class="jcXnot-covered">(val);</span>
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (had_focus) {
                <span class="jcXnot-covered">$textarea.</span><span class="js2-function-call"><span class="jcXnot-covered">caret</span></span><span class="jcXnot-covered">(pos);</span>
            }
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
        };
    } <span class="keyword">else</span> {
        <span class="jcXcovered">text_to_clipboard = $.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span><span class="jcXcovered">;</span>
    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">get_textarea_selection</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
        <span class="keyword">var</span> <span class="variable-name">textarea</span> = <span class="jcXcovered">document.</span><span class="js2-function-call"><span class="jcXcovered">createElement</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'textarea'</span></span><span class="jcXcovered">)</span>;
        <span class="keyword">var</span> <span class="variable-name">selectionStart</span> = <span class="string"><span class="jcXcovered">'selectionStart'</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">in</span></span><span class="jcXcovered"> textarea</span>;
        <span class="jcXcovered">textarea = </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (selectionStart) {
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">textarea</span>) {
                <span class="keyword">var</span> <span class="variable-name">length</span> = <span class="jcXcovered">textarea.</span><span class="js2-object-property"><span class="jcXcovered">selectionEnd</span></span><span class="jcXcovered"> - textarea.</span><span class="js2-object-property"><span class="jcXcovered">selectionStart</span></span>;
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> textarea.</span><span class="js2-object-property"><span class="jcXcovered">value</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">substr</span></span><span class="jcXcovered">(textarea.</span><span class="js2-object-property"><span class="jcXcovered">selectionStart</span></span><span class="jcXcovered">, length);</span>
            };
        }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (document.<span class="js2-object-property">selection</span>) {
            <span class="keyword"><span class="jcXnot-covered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">range</span> = <span class="jcXnot-covered">document.</span><span class="js2-object-property"><span class="jcXnot-covered">selection</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">createRange</span></span><span class="jcXnot-covered">()</span>;
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> range.</span><span class="js2-function-call"><span class="jcXnot-covered">text</span></span><span class="jcXnot-covered">();</span>
            };
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXnot-covered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">;</span>
            };
        }
    })();
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">clear_textarea_selection</span>(<span class="js2-function-param">textarea</span>) {
        <span class="jcXnot-covered">textarea.</span><span class="js2-object-property"><span class="jcXnot-covered">selectionStart</span></span><span class="jcXnot-covered"> = textarea.</span><span class="js2-object-property"><span class="jcXnot-covered">selectionEnd</span></span><span class="jcXnot-covered"> = 0;</span>
    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="comment">// :: return string that are common in all elements of the array
</span>    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">common_string</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">array</span>, <span class="js2-function-param">matchCase</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>array.<span class="js2-object-property">length</span>) {
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="keyword">var</span> <span class="variable-name">type</span> = <span class="js2-function-call"><span class="jcXcovered">string_case</span></span><span class="jcXcovered">(string)</span>;
        <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">[]</span>;
        <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">j</span> = <span class="jcXcovered">string.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>; j &lt; array[0].<span class="js2-object-property">length</span>; ++j) {
            <span class="keyword">var</span> <span class="variable-name">push</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
            <span class="keyword">var</span> <span class="variable-name">candidate</span> = <span class="jcXcovered">array[0].</span><span class="js2-function-call"><span class="jcXcovered">charAt</span></span><span class="jcXcovered">(j)</span>,
                <span class="variable-name">candidateLower</span> = <span class="jcXcovered">candidate.</span><span class="js2-function-call"><span class="jcXcovered">toLowerCase</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">1</span>; i &lt; array.<span class="js2-object-property">length</span>; ++i) {
                <span class="jcXcovered">push = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                <span class="keyword">var</span> <span class="variable-name">current</span> = <span class="jcXcovered">array[i].</span><span class="js2-function-call"><span class="jcXcovered">charAt</span></span><span class="jcXcovered">(j)</span>,
                    <span class="variable-name">currentLower</span> = <span class="jcXcovered">current.</span><span class="js2-function-call"><span class="jcXcovered">toLowerCase</span></span><span class="jcXcovered">()</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (candidate !== current) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (matchCase || type === <span class="string">'mixed'</span>) {
                        <span class="jcXcovered">push = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                        <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (candidateLower === currentLower) {
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (type === <span class="string">'lower'</span>) {
                            <span class="jcXnot-covered">candidate = candidate.</span><span class="js2-function-call"><span class="jcXnot-covered">toLowerCase</span></span><span class="jcXnot-covered">();</span>
                        }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (type === <span class="string">'upper'</span>) {
                            <span class="jcXnot-covered">candidate = candidate.</span><span class="js2-function-call"><span class="jcXnot-covered">toUpperCase</span></span><span class="jcXnot-covered">();</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXnot-covered">push = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                            <span class="keyword"><span class="jcXnot-covered">break</span></span><span class="jcXnot-covered">;</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">push = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                        <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                    }
                }
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (push) {
                <span class="jcXcovered">result.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(candidate);</span>
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
            }
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string + result.</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">trigger_terminal_change</span>(<span class="js2-function-param">next</span>) {
        <span class="jcXcovered">ter</span>minals.<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">term</span>) {
            <span class="jcXcovered">term.</span><span class="js2-function-call"><span class="jcXcovered">settings</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">onTerminalChange</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(term, next);</span>
        });
    }
    <span class="comment">// ---------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">select</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (window.<span class="js2-object-property">getSelection</span>) {
            <span class="keyword">var</span> <span class="variable-name">selection</span> = <span class="jcXnot-covered">window.</span><span class="js2-function-call"><span class="jcXnot-covered">getSelection</span></span><span class="jcXnot-covered">()</span>;
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (selection.<span class="js2-object-property">setBaseAndExtent</span>) {
                <span class="keyword"><span class="jcXnot-covered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">start</span>, <span class="js2-function-param">end</span>) {
                    <span class="keyword">var</span> <span class="variable-name">selection</span> = <span class="jcXnot-covered">window.</span><span class="js2-function-call"><span class="jcXnot-covered">getSelection</span></span><span class="jcXnot-covered">()</span>;
                    <span class="jcXnot-covered">selection.</span><span class="js2-function-call"><span class="jcXnot-covered">setBaseAndExtent</span></span><span class="jcXnot-covered">(start, 0, end, 1);</span>
                };
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXnot-covered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">start</span>, <span class="js2-function-param">end</span>) {
                    <span class="keyword">var</span> <span class="variable-name">selection</span> = <span class="jcXnot-covered">window.</span><span class="js2-function-call"><span class="jcXnot-covered">getSelection</span></span><span class="jcXnot-covered">()</span>;
                    <span class="keyword">var</span> <span class="variable-name">range</span> = <span class="jcXnot-covered">document.</span><span class="js2-function-call"><span class="jcXnot-covered">createRange</span></span><span class="jcXnot-covered">()</span>;
                    <span class="jcXnot-covered">range.</span><span class="js2-function-call"><span class="jcXnot-covered">setStart</span></span><span class="jcXnot-covered">(start, 0);</span>
                    <span class="jcXnot-covered">range.</span><span class="js2-function-call"><span class="jcXnot-covered">setEnd</span></span><span class="jcXnot-covered">(end, end.</span><span class="js2-object-property"><span class="jcXnot-covered">childNodes</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered">);</span>
                    <span class="jcXnot-covered">selection.</span><span class="js2-function-call"><span class="jcXnot-covered">removeAllRanges</span></span><span class="jcXnot-covered">();</span>
                    <span class="jcXnot-covered">selection.</span><span class="js2-function-call"><span class="jcXnot-covered">addRange</span></span><span class="jcXnot-covered">(range);</span>
                };
            }
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span><span class="jcXcovered">;</span>
        }
    })();
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">process_command</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">fn</span>) {
        <span class="keyword">var</span> <span class="variable-name">array</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(command_re) || []</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (array.<span class="js2-object-property">length</span>) {
            <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="jcXcovered">array.</span><span class="js2-function-call"><span class="jcXcovered">shift</span></span><span class="jcXcovered">()</span>;
            <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">args</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">map</span>(array, <span class="keyword">function</span>(<span class="js2-function-param">arg</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arg.<span class="js2-function-call">match</span>(<span class="string">/^["']/</span>)) {
                    <span class="jcXcovered">arg = arg.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\n/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'\\u0000\\u0000\\u0000\\u0000'</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">arg = </span><span class="js2-function-call"><span class="jcXcovered">fn</span></span><span class="jcXcovered">(arg);</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> arg.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\x00\x00\x00\x00/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">fn</span></span><span class="jcXcovered">(arg);</span>
            });
            <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">quotes</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">map</span>(array, <span class="keyword">function</span>(<span class="js2-function-param">arg</span>) {
                <span class="keyword">var</span> <span class="variable-name">m</span> = <span class="jcXcovered">arg.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^(['"]).*\1$/</span></span><span class="jcXcovered">)</span>;
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> m &amp;&amp; m[1] || </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
            });
            <span class="keyword">var</span> <span class="variable-name">rest</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(name.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">trim</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> {
                <span class="js2-object-property">command</span>: string,
                <span class="js2-object-property">name</span>: name,
                <span class="js2-object-property">args</span>: args,
                <span class="js2-object-property">args_quotes</span>: quotes,
                <span class="js2-object-property">rest</span>: rest
            };
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXnot-covered">re</span></span><span class="keyword">turn</span> {
                <span class="js2-object-property">command</span>: string,
                <span class="js2-object-property">name</span>: <span class="string">''</span>,
                <span class="js2-object-property">args</span>: [],
                <span class="js2-object-property">args_quotes</span>: quotes,
                <span class="js2-object-property">rest</span>: <span class="string">''</span>
            };
        }
    }
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="jcXcovered">$.</span><span class="js2-object-property">terminal</span> = {
        <span class="js2-object-property">version</span>: <span class="string">'{{VER}}'</span>,
        <span class="js2-object-property">date</span>: <span class="string">'{{DATE}}'</span>,
        <span class="comment">// colors from https://www.w3.org/wiki/CSS/Properties/color/keywords
</span>        <span class="js2-object-property">color_names</span>: [
            <span class="string">'transparent'</span>, <span class="string">'currentcolor'</span>, <span class="string">'black'</span>, <span class="string">'silver'</span>, <span class="string">'gray'</span>, <span class="string">'white'</span>,
            <span class="string">'maroon'</span>, <span class="string">'red'</span>, <span class="string">'purple'</span>, <span class="string">'fuchsia'</span>, <span class="string">'green'</span>, <span class="string">'lime'</span>, <span class="string">'olive'</span>,
            <span class="string">'yellow'</span>, <span class="string">'navy'</span>, <span class="string">'blue'</span>, <span class="string">'teal'</span>, <span class="string">'aqua'</span>, <span class="string">'aliceblue'</span>,
            <span class="string">'antiquewhite'</span>, <span class="string">'aqua'</span>, <span class="string">'aquamarine'</span>, <span class="string">'azure'</span>, <span class="string">'beige'</span>, <span class="string">'bisque'</span>,
            <span class="string">'black'</span>, <span class="string">'blanchedalmond'</span>, <span class="string">'blue'</span>, <span class="string">'blueviolet'</span>, <span class="string">'brown'</span>,
            <span class="string">'burlywood'</span>, <span class="string">'cadetblue'</span>, <span class="string">'chartreuse'</span>, <span class="string">'chocolate'</span>, <span class="string">'coral'</span>,
            <span class="string">'cornflowerblue'</span>, <span class="string">'cornsilk'</span>, <span class="string">'crimson'</span>, <span class="string">'cyan'</span>, <span class="string">'darkblue'</span>,
            <span class="string">'darkcyan'</span>, <span class="string">'darkgoldenrod'</span>, <span class="string">'darkgray'</span>, <span class="string">'darkgreen'</span>, <span class="string">'darkgrey'</span>,
            <span class="string">'darkkhaki'</span>, <span class="string">'darkmagenta'</span>, <span class="string">'darkolivegreen'</span>, <span class="string">'darkorange'</span>,
            <span class="string">'darkorchid'</span>, <span class="string">'darkred'</span>, <span class="string">'darksalmon'</span>, <span class="string">'darkseagreen'</span>,
            <span class="string">'darkslateblue'</span>, <span class="string">'darkslategray'</span>, <span class="string">'darkslategrey'</span>, <span class="string">'darkturquoise'</span>,
            <span class="string">'darkviolet'</span>, <span class="string">'deeppink'</span>, <span class="string">'deepskyblue'</span>, <span class="string">'dimgray'</span>, <span class="string">'dimgrey'</span>,
            <span class="string">'dodgerblue'</span>, <span class="string">'firebrick'</span>, <span class="string">'floralwhite'</span>, <span class="string">'forestgreen'</span>, <span class="string">'fuchsia'</span>,
            <span class="string">'gainsboro'</span>, <span class="string">'ghostwhite'</span>, <span class="string">'gold'</span>, <span class="string">'goldenrod'</span>, <span class="string">'gray'</span>, <span class="string">'green'</span>,
            <span class="string">'greenyellow'</span>, <span class="string">'grey'</span>, <span class="string">'honeydew'</span>, <span class="string">'hotpink'</span>, <span class="string">'indianred'</span>, <span class="string">'indigo'</span>,
            <span class="string">'ivory'</span>, <span class="string">'khaki'</span>, <span class="string">'lavender'</span>, <span class="string">'lavenderblush'</span>, <span class="string">'lawngreen'</span>,
            <span class="string">'lemonchiffon'</span>, <span class="string">'lightblue'</span>, <span class="string">'lightcoral'</span>, <span class="string">'lightcyan'</span>,
            <span class="string">'lightgoldenrodyellow'</span>, <span class="string">'lightgray'</span>, <span class="string">'lightgreen'</span>, <span class="string">'lightgrey'</span>,
            <span class="string">'lightpink'</span>, <span class="string">'lightsalmon'</span>, <span class="string">'lightseagreen'</span>, <span class="string">'lightskyblue'</span>,
            <span class="string">'lightslategray'</span>, <span class="string">'lightslategrey'</span>, <span class="string">'lightsteelblue'</span>, <span class="string">'lightyellow'</span>,
            <span class="string">'lime'</span>, <span class="string">'limegreen'</span>, <span class="string">'linen'</span>, <span class="string">'magenta'</span>, <span class="string">'maroon'</span>,
            <span class="string">'mediumaquamarine'</span>, <span class="string">'mediumblue'</span>, <span class="string">'mediumorchid'</span>, <span class="string">'mediumpurple'</span>,
            <span class="string">'mediumseagreen'</span>, <span class="string">'mediumslateblue'</span>, <span class="string">'mediumspringgreen'</span>,
            <span class="string">'mediumturquoise'</span>, <span class="string">'mediumvioletred'</span>, <span class="string">'midnightblue'</span>, <span class="string">'mintcream'</span>,
            <span class="string">'mistyrose'</span>, <span class="string">'moccasin'</span>, <span class="string">'navajowhite'</span>, <span class="string">'navy'</span>, <span class="string">'oldlace'</span>, <span class="string">'olive'</span>,
            <span class="string">'olivedrab'</span>, <span class="string">'orange'</span>, <span class="string">'orangered'</span>, <span class="string">'orchid'</span>, <span class="string">'palegoldenrod'</span>,
            <span class="string">'palegreen'</span>, <span class="string">'paleturquoise'</span>, <span class="string">'palevioletred'</span>, <span class="string">'papayawhip'</span>,
            <span class="string">'peachpuff'</span>, <span class="string">'peru'</span>, <span class="string">'pink'</span>, <span class="string">'plum'</span>, <span class="string">'powderblue'</span>, <span class="string">'purple'</span>, <span class="string">'red'</span>,
            <span class="string">'rosybrown'</span>, <span class="string">'royalblue'</span>, <span class="string">'saddlebrown'</span>, <span class="string">'salmon'</span>, <span class="string">'sandybrown'</span>,
            <span class="string">'seagreen'</span>, <span class="string">'seashell'</span>, <span class="string">'sienna'</span>, <span class="string">'silver'</span>, <span class="string">'skyblue'</span>, <span class="string">'slateblue'</span>,
            <span class="string">'slategray'</span>, <span class="string">'slategrey'</span>, <span class="string">'snow'</span>, <span class="string">'springgreen'</span>, <span class="string">'steelblue'</span>, <span class="string">'tan'</span>,
            <span class="string">'teal'</span>, <span class="string">'thistle'</span>, <span class="string">'tomato'</span>, <span class="string">'turquoise'</span>, <span class="string">'violet'</span>, <span class="string">'wheat'</span>,
            <span class="string">'white'</span>, <span class="string">'whitesmoke'</span>, <span class="string">'yellow'</span>, <span class="string">'yellowgreen'</span>, <span class="string">'rebeccapurple'</span>],
        <span class="comment">// for unit tests
</span>        <span class="js2-object-property">Cycle</span>: Cycle,
        <span class="js2-object-property">History</span>: History,
        <span class="js2-object-property">Stack</span>: Stack,
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Validate html color (it can be name or hex)
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">valid_color</span>: <span class="keyword">function</span> <span class="function-name">valid_color</span>(<span class="js2-function-param">color</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (color.<span class="js2-function-call">match</span>(color_hex_re)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">inArray</span></span><span class="jcXcovered">(color.</span><span class="js2-function-call"><span class="jcXcovered">toLowerCase</span></span><span class="jcXcovered">(), $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">color_names</span></span><span class="jcXcovered">) !== -1;</span>
            }
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: function check if given string contain invalid strings
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">unclosed_strings</span>: <span class="keyword">function</span> <span class="function-name">unclosed_strings</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="negation-char"><span class="jcXcovered">!!</span></span><span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(unclosed_strings_re);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Escape all special regex characters, so it can be use as regex to
</span>        <span class="comment">// :: match exact string that contain those characters
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">escape_regex</span>: <span class="keyword">function</span> <span class="function-name">escape_regex</span>(<span class="js2-function-param">str</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> str === <span class="string">'string'</span>) {
                <span class="keyword">var</span> <span class="variable-name">special</span> = <span class="string"><span class="jcXcovered">/([-\\^$[\]()+{}?*.|])/g</span></span>;
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> str.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(special, </span><span class="string"><span class="jcXcovered">'\\$1'</span></span><span class="jcXcovered">);</span>
            }
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: test if string contain formatting
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">have_formatting</span>: <span class="keyword">function</span> <span class="function-name">have_formatting</span>(<span class="js2-function-param">str</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">typeof</span></span><span class="jcXcovered"> str === </span><span class="string"><span class="jcXcovered">'string'</span></span><span class="jcXcovered"> &amp;&amp; </span><span class="negation-char"><span class="jcXcovered">!!</span></span><span class="jcXcovered">str.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(format_exist_re);</span>
        },
        <span class="function-name">is_formatting</span>: <span class="keyword">function</span> <span class="function-name">is_formatting</span>(<span class="js2-function-param">str</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">typeof</span></span><span class="jcXcovered"> str === </span><span class="string"><span class="jcXcovered">'string'</span></span><span class="jcXcovered"> &amp;&amp; </span><span class="negation-char"><span class="jcXcovered">!!</span></span><span class="jcXcovered">str.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(format_full_re);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: return array of formatting and text between them
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">format_split</span>: <span class="keyword">function</span> <span class="function-name">format_split</span>(<span class="js2-function-param">str</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> str.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(format_split_re).</span><span class="js2-function-call"><span class="jcXcovered">filter</span></span><span class="jcXcovered">(Boolean);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: replace that return position after replace for working with
</span>        <span class="comment">// :: replacement that change length of the string
</span>        <span class="comment">// :: source https://stackoverflow.com/a/46756077/387194
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">tracking_replace</span>: <span class="keyword">function</span> <span class="function-name">tracking_replace</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">rex</span>, <span class="js2-function-param">replacement</span>, <span class="js2-function-param">position</span>) {
            <span class="keyword">function</span> <span class="function-name">substring</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">start</span>, <span class="js2-function-param">end</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(start, end);</span>
            }
            <span class="keyword">function</span> <span class="function-name">length</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">strip</span></span><span class="jcXcovered">(string).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
            }
            <span class="keyword">var</span> <span class="variable-name">new_string</span> = <span class="string"><span class="jcXcovered">""</span></span>;
            <span class="keyword">var</span> <span class="variable-name">match</span>;
            <span class="keyword">var</span> <span class="variable-name">index</span> = <span class="jcXcovered">0</span>;
            <span class="keyword">var</span> <span class="variable-name">rep_string</span>;
            <span class="keyword">var</span> <span class="variable-name">new_position</span> = <span class="jcXcovered">position</span>;
            <span class="keyword">var</span> <span class="variable-name">start</span>;
            <span class="jcXcovered">rex.</span><span class="js2-object-property"><span class="jcXcovered">lastIndex</span></span><span class="jcXcovered"> = 0;</span> <span class="comment">// Just to be sure
</span>            <span class="keyword"><span class="jcXcovered">w</span></span><span class="keyword">hile</span> ((match = rex.<span class="js2-function-call">exec</span>(string))) {
                <span class="comment">// if regex don't have g flag lastIndex will not work
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (rex.<span class="js2-object-property">global</span>) {
                    <span class="comment">// Add any of the original string we just skipped
</span>                    <span class="keyword">var</span> <span class="variable-name">last_index</span> = <span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, 0, rex.</span><span class="js2-object-property"><span class="jcXcovered">lastIndex</span></span><span class="jcXcovered">))</span>;
                    <span class="jcXcovered">start = last_index - </span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(match[0]);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">start = match.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">last_index = start + </span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(match[0]);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (index &lt; start) {
                    <span class="jcXcovered">new_string += </span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, index, start);</span>
                }
                <span class="jcXcovered">index = last_index;</span>
                <span class="comment">// Build the replacement string. This just handles $$ and $n,
</span>                <span class="comment">// you may want to add handling for $`, $', and $&amp;.
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> replacement === <span class="string">'function'</span>) {
                    <span class="jcXnot-covered">rep_string = replacement.</span><span class="js2-function-call"><span class="jcXnot-covered">apply</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">null</span></span><span class="jcXnot-covered">, match);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">rep</span>_string = replacement.<span class="js2-function-call">replace</span>(<span class="string">/\$(\$|\d)/g</span>, <span class="keyword">function</span>(<span class="js2-function-param">m</span>, <span class="js2-function-param">c0</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (c0 === <span class="string">"$"</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">"$"</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> match[c0];</span>
                    });
                }
                <span class="comment">// Add on the replacement
</span>                <span class="jcXcovered">new_string += rep_string;</span>
                <span class="comment">// If the position is affected...
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (start &lt; position) {
                    <span class="comment">// ... update it:
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (last_index &lt; position) {
                        <span class="comment">// It's after the replacement, move it
</span>                        <span class="jcXcovered">ne</span>w_position = Math.<span class="builtin">max</span>(
                            0,
                            new_position +
                            <span class="js2-function-call">length</span>(rep_string) -
                            <span class="js2-function-call">length</span>(match[0])
                        );
                    } <span class="keyword">else</span> {
                        <span class="comment">// It's *in* the replacement, put it just after
</span>                        <span class="jcXcovered">new_position += </span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(rep_string) - (position - start);</span>
                    }
                }
                <span class="comment">// If the regular expression doesn't have the g flag, break here so
</span>                <span class="comment">// we do just one replacement (and so we don't have an endless loop!)
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>rex.<span class="js2-object-property">global</span>) {
                    <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                }
            }
            <span class="comment">// Add on any trailing text in the string
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (index &lt; <span class="js2-function-call">length</span>(string)) {
                <span class="jcXcovered">new_string += </span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, index);</span>
            }
            <span class="comment">// Return the string and the updated position
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string === new_string) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> [string, position];</span>
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> [new_string, new_position];</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: helper function used by substring and split_equal it loop over
</span>        <span class="comment">// :: string and execute callback with text count and other data
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">iterate_formatting</span>: <span class="keyword">function</span> <span class="function-name">iterate_formatting</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">callback</span>) {
            <span class="keyword">function</span> <span class="function-name">is_space</span>(<span class="js2-function-param">i</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(i - 6, i) === </span><span class="string"><span class="jcXcovered">'&amp;nbs</span></span><span class="string">p;'</span> ||
                    string.<span class="js2-function-call">slice</span>(i - 1, i).<span class="js2-function-call">match</span>(<span class="string">/\s/</span>);
            }
            <span class="comment">// ----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">match_entity</span>(<span class="js2-function-param">index</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(index).</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(entity_re);</span>
            }
            <span class="comment">// ----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">is_open_formatting</span>(<span class="js2-function-param">i</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string[i] === </span><span class="string"><span class="jcXcovered">'['</span></span><span class="jcXcovered"> &amp;&amp; string[i + 1] === </span><span class="string"><span class="jcXcovered">'['</span></span><span class="jcXcovered">;</span>
            }
            <span class="comment">// ----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">is_escape_bracket</span>(<span class="js2-function-param">i</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string[i - 1] !== </span><span class="string"><span class="jcXcovered">'</span></span><span class="string">\\'</span> &amp;&amp; string[i] === <span class="string">'\\'</span> &amp;&amp;
                    string[i + 1] === <span class="string">']'</span>;
            }
            <span class="comment">// ----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">is_text</span>(<span class="js2-function-param">i</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> not_forma</span>tting &amp;&amp; (string[i] !== <span class="string">']'</span> || <span class="negation-char">!</span>have_formatting)
                    &amp;&amp; <span class="negation-char">!</span>opening;
            }
            <span class="comment">// ----------------------------------------------------------------
</span>            <span class="keyword">var</span> <span class="variable-name">have_formatting</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">have_formatting</span></span><span class="jcXcovered">(string)</span>;
            <span class="keyword">var</span> <span class="variable-name">formatting</span> = <span class="string"><span class="jcXcovered">''</span></span>;
            <span class="keyword">var</span> <span class="variable-name">in_text</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
            <span class="keyword">var</span> <span class="variable-name">count</span> = <span class="jcXcovered">0</span>;
            <span class="keyword">var</span> <span class="variable-name">match</span>;
            <span class="keyword">var</span> <span class="variable-name">space</span> = <span class="jcXcovered">-1</span>;
            <span class="keyword">var</span> <span class="variable-name">space_count</span> = <span class="jcXcovered">-1</span>;
            <span class="keyword">var</span> <span class="variable-name">prev_space</span>;
            <span class="keyword">var</span> <span class="variable-name">length</span> = <span class="jcXcovered">0</span>;
            <span class="keyword">var</span> <span class="variable-name">offset</span> = <span class="jcXcovered">0</span>;
            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>; i &lt; string.<span class="js2-object-property">length</span>; i++) {
                <span class="keyword">var</span> <span class="variable-name">substring</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(i)</span>;
                <span class="jcXcovered">match = substring.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(format_start_re);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (match) {
                    <span class="jcXcovered">formatting = match[1];</span>
                    <span class="jcXcovered">in_text = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (formatting) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string[i] === <span class="string">']'</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (in_text) {
                            <span class="jcXcovered">formatting = </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                            <span class="jcXcovered">in_text = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">in_text = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                        }
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">in_text = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">not_formatting</span> = <span class="jcXcovered">(formatting &amp;&amp; in_text) || </span><span class="negation-char"><span class="jcXcovered">!</span></span><span class="jcXcovered">formatting</span>;
                <span class="keyword">var</span> <span class="variable-name">opening</span> = <span class="js2-function-call"><span class="jcXcovered">is_open_formatting</span></span><span class="jcXcovered">(i)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_space</span>(i) &amp;&amp; (not_formatting || opening)) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (space === -1 &amp;&amp; prev_space !== i || space !== -1) {
                        <span class="jcXcovered">space = i;</span>
                        <span class="jcXcovered">space_count = count;</span>
                    }
                }
                <span class="keyword">var</span> <span class="variable-name">braket</span> = <span class="jcXcovered">string[i].</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/[[\]]/</span></span><span class="jcXcovered">)</span>;
                <span class="jcXcovered">offset = 0;</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (not_formatting) {
                    <span class="comment">// treat entity as one character
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string[i] === <span class="string">'&amp;'</span>) {
                        <span class="jcXcovered">match = </span><span class="js2-function-call"><span class="jcXcovered">match_entity</span></span><span class="jcXcovered">(i);</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (match) {
                            <span class="jcXcovered">i += match[1].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 2;</span> <span class="comment">// 2 because continue adds 1 to i
</span>                            <span class="keyword"><span class="jcXcovered">continue</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="jcXnot-covered">++count;</span>
                        <span class="jcXnot-covered">++length;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_escape_bracket</span>(i)) {
                        <span class="comment">// escape \] and \\ counts as one character
</span>                        <span class="jcXnot-covered">++count;</span>
                        <span class="jcXnot-covered">++length;</span>
                        <span class="jcXnot-covered">offset = 1;</span>
                        <span class="jcXnot-covered">i += 1;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="negation-char">!</span>braket || <span class="negation-char">!</span>have_formatting) {
                        <span class="jcXcovered">++count;</span>
                        <span class="jcXcovered">++length;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_text</span>(i)) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">strlen</span>(string[i]) === 2) {
                        <span class="jcXcovered">length++;</span>
                    }
                    <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">data</span></span><span class="jcXcovered"> = </span>{
                        <span class="js2-object-property">count</span>: count,
                        <span class="js2-object-property">index</span>: i - offset,
                        <span class="js2-object-property">formatting</span>: formatting,
                        <span class="js2-object-property">length</span>: length,
                        <span class="js2-object-property">text</span>: in_text,
                        <span class="js2-object-property">size</span>: offset + 1,
                        <span class="js2-object-property">space</span>: space,
                        <span class="js2-object-property">space_count</span>: space_count
                    };
                    <span class="keyword">var</span> <span class="variable-name">ret</span> = <span class="js2-function-call"><span class="jcXcovered">callback</span></span><span class="jcXcovered">(data)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ret === <span class="constant">false</span>) {
                        <span class="keyword"><span class="jcXnot-covered">break</span></span><span class="jcXnot-covered">;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (ret) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ret.<span class="js2-object-property">count</span> !== <span class="constant">undefined</span>) {
                            <span class="jcXnot-covered">count = ret.</span><span class="js2-object-property"><span class="jcXnot-covered">count</span></span><span class="jcXnot-covered">;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ret.<span class="js2-object-property">length</span> !== <span class="constant">undefined</span>) {
                            <span class="jcXcovered">length = ret.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ret.<span class="js2-object-property">space</span> !== <span class="constant">undefined</span>) {
                            <span class="jcXcovered">prev_space = space;</span>
                            <span class="jcXcovered">space = ret.</span><span class="js2-object-property"><span class="jcXcovered">space</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ret.<span class="js2-object-property">index</span> !== <span class="constant">undefined</span>) {
                            <span class="jcXcovered">i = ret.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">;</span>
                            <span class="keyword"><span class="jcXcovered">continue</span></span><span class="jcXcovered">;</span>
                        }
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (i === string.<span class="js2-object-property">length</span> - 1) {
                    <span class="js2-function-call"><span class="jcXcovered">cal</span></span><span class="js2-function-call">lback</span>({
                        <span class="js2-object-property">count</span>: count + 1,
                        <span class="js2-object-property">index</span>: i,
                        <span class="js2-object-property">formatting</span>: formatting,
                        <span class="js2-object-property">length</span>: 0,
                        <span class="js2-object-property">text</span>: in_text,
                        <span class="js2-object-property">space</span>: space
                    });
                }
                <span class="comment">// handle emoji, suroggate pairs and combine characters
</span>                <span class="keyword">var</span> <span class="variable-name">char</span> = <span class="js2-function-call"><span class="jcXcovered">get_next_character</span></span><span class="jcXcovered">(substring)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (char.<span class="js2-object-property">length</span> &gt; 1) {
                    <span class="jcXcovered">i += char.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1;</span>
                }
            }
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: formatting aware substring function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">substring</span>: <span class="keyword">function</span> <span class="function-name">substring</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">start_index</span>, <span class="js2-function-param">end_index</span>) {
            <span class="keyword">var</span> <span class="variable-name">chars</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_characters</span></span><span class="jcXcovered">(string)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>chars.<span class="js2-function-call">slice</span>(start_index, end_index).<span class="js2-object-property">length</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>$.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">have_formatting</span>(string)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> chars.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(start_index, end_index).</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
            }
            <span class="keyword">var</span> <span class="variable-name">start</span> = <span class="jcXcovered">0</span>;
            <span class="keyword">var</span> <span class="variable-name">end</span>;
            <span class="keyword">var</span> <span class="variable-name">start_formatting</span> = <span class="string"><span class="jcXcovered">''</span></span>;
            <span class="keyword">var</span> <span class="variable-name">end_formatting</span> = <span class="string"><span class="jcXcovered">''</span></span>;
            <span class="keyword">var</span> <span class="variable-name">prev_index</span>;
            <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="string"><span class="jcXcovered">/(&amp;[^;]+);$/</span></span>;
            <span class="keyword">var</span> <span class="variable-name">offset</span> = <span class="jcXcovered">1</span>;
            <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">t</span></span><span class="js2-object-property">erminal</span>.<span class="js2-function-call">iterate_formatting</span>(string, <span class="keyword">function</span>(<span class="js2-function-param">data</span>) {
                <span class="keyword">var</span> <span class="variable-name">m</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (start_index &amp;&amp; data.<span class="js2-object-property">count</span> === start_index + 1) {
                    <span class="jcXcovered">start = data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">;</span>
                    <span class="comment">// correct index for html entity
</span>                    <span class="jcXcovered">m = string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, start + 1).</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(re);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (m) {
                        <span class="jcXcovered">start -= m[1].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-object-property">formatting</span>) {
                        <span class="jcXcovered">start_formatting = data.</span><span class="js2-object-property"><span class="jcXcovered">formatting</span></span><span class="jcXcovered">;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (end_index &amp;&amp; data.<span class="js2-object-property">count</span> === end_index) {
                    <span class="jcXcovered">end_formatting = data.</span><span class="js2-object-property"><span class="jcXcovered">formatting</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">prev_index = data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">offset = data.</span><span class="js2-object-property"><span class="jcXcovered">size</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-object-property">count</span> === end_index + 1) {
                    <span class="jcXcovered">end = data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">m = string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, end + 1).</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(re);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (m) {
                        <span class="jcXcovered">end -= m[1].</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-object-property">formatting</span>) {
                        <span class="jcXcovered">end = prev_index + offset;</span>
                    }
                }
            });
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (start_index &amp;&amp; <span class="negation-char">!</span>start) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (end === <span class="constant">undefined</span>) {
                <span class="jcXcovered">end = string.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
            }
            <span class="jcXcovered">string = start_formatting + string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(start, end);</span>
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (end_formatting) {
                <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/(\[\[^\]]+)?\]$/</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                <span class="jcXcovered">string += </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">;</span>
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: add format text as 5th paramter to formatting it's used for
</span>        <span class="comment">// :: data attribute in format function - and fix unclosed &amp;
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">normalize</span>: <span class="keyword">function</span> <span class="function-name">normalize</span>(<span class="js2-function-param">string</span>) {
            <span class="jcXcovered">str</span>ing = string.<span class="js2-function-call">replace</span>(format_re, <span class="keyword">function</span>(<span class="js2-function-param">_</span>, <span class="js2-function-param">format</span>, <span class="js2-function-param">text</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (text === <span class="string">''</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword">function</span> <span class="function-name">safe</span>(<span class="js2-function-param">string</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\\\]/g</span></span>, <span class="string">'&amp;#93;'</span>).<span class="js2-function-call">replace</span>(<span class="string">/\n/g</span>, <span class="string">'\\n'</span>)
                        .<span class="js2-function-call">replace</span>(<span class="string">/&amp;nbsp;/g</span>, <span class="string">' '</span>);
                }
                <span class="jcXcovered">format = </span><span class="js2-function-call"><span class="jcXcovered">safe</span></span><span class="jcXcovered">(format);</span>
                <span class="keyword">var</span> <span class="variable-name">semicolons</span> = <span class="jcXcovered">format.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/;/g</span></span><span class="jcXcovered">).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                <span class="comment">// missing semicolons
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (semicolons &gt;= 4) {
                    <span class="keyword">var</span> <span class="variable-name">args</span> = <span class="jcXcovered">format.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/;/</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword">var</span> <span class="variable-name">start</span> = <span class="jcXcovered">args.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, 4).</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">';'</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword">var</span> <span class="variable-name">arg</span> = <span class="jcXcovered">args.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(4).</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">';'</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'[['</span></span><span class="jcXcovered"> + start + </span><span class="string"><span class="jcXcovered">';'</span></span><span class="jcXcovered"> + (arg || text) + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered"> + text + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (semicolons === 2) {
                    <span class="jcXcovered">semicolons = </span><span class="string"><span class="jcXcovered">';;'</span></span><span class="jcXcovered">;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (semicolons === 3) {
                    <span class="jcXcovered">semicolons = </span><span class="string"><span class="jcXcovered">';'</span></span><span class="jcXcovered">;</span>
                }
                <span class="comment">// return '[[' + format + ']' + text + ']';
</span>                <span class="comment">// closing braket will break formatting so we need to escape
</span>                <span class="comment">// those using html entity equvalent
</span>                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'[['</span></span><span class="jcXcovered"> + format + semicolons + </span><span class="js2-function-call"><span class="jcXcovered">safe</span></span><span class="jcXcovered">(text) + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered"> + text + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">;</span>
            });
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">amp</span></span><span class="jcXcovered">(string);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: split text into lines with equal length so each line can be
</span>        <span class="comment">// :: rendered separately (text formatting can be longer then a line).
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">split_equal</span>: <span class="keyword">function</span> <span class="function-name">split_equal</span>(<span class="js2-function-param">str</span>, <span class="js2-function-param">length</span>, <span class="js2-function-param">keep_words</span>) {
            <span class="keyword">var</span> <span class="variable-name">prev_format</span> = <span class="string"><span class="jcXcovered">''</span></span>;
            <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">[]</span>;
            <span class="keyword">var</span> <span class="variable-name">array</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">normalize</span></span><span class="jcXcovered">(str).</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\n/g</span></span><span class="jcXcovered">)</span>;
            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>, <span class="variable-name">len</span> = <span class="jcXcovered">array.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>; i &lt; len; ++i) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (array[i] === <span class="string">''</span>) {
                    <span class="jcXcovered">result.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    <span class="keyword"><span class="jcXcovered">continue</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">line</span> = <span class="jcXcovered">array[i]</span>;
                <span class="keyword">var</span> <span class="variable-name">first_index</span> = <span class="jcXcovered">0</span>;
                <span class="keyword">var</span> <span class="variable-name">output</span>;
                <span class="keyword">var</span> <span class="variable-name">line_length</span> = <span class="jcXcovered">line.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                <span class="keyword">var</span> <span class="variable-name">chars</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_characters</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(line))</span>;
                <span class="keyword">var</span> <span class="variable-name">last_char</span> = <span class="jcXcovered">chars[chars.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1]</span>;
                <span class="keyword">var</span> <span class="variable-name">end_index</span> = <span class="jcXcovered">line_length - (last_char ? last_char.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> : 1)</span>;
                <span class="keyword">var</span> <span class="variable-name">last_bracket</span> = <span class="negation-char"><span class="jcXcovered">!!</span></span><span class="jcXcovered">line.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\[\[[^\]]+\](?:[^\][]|\\\])+\]$/</span></span><span class="jcXcovered">)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (last_bracket) {
                    <span class="jcXcovered">end_index -= 1;</span>
                }
                <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">t</span></span><span class="js2-object-property">erminal</span>.<span class="js2-function-call">iterate_formatting</span>(line, <span class="keyword">function</span>(<span class="js2-function-param">data</span>) {
                    <span class="keyword">var</span> <span class="variable-name">last_iteraction</span> = <span class="jcXcovered">data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered"> === end_index</span>;
                    <span class="keyword">var</span> <span class="variable-name">chr</span>, <span class="variable-name">substring</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-object-property">length</span> &gt;= length || last_iteraction ||
                        (data.<span class="js2-object-property">length</span> === length - 1 &amp;&amp;
                         <span class="js2-function-call">strlen</span>(line[data.<span class="js2-object-property">index</span> + 1]) === 2)) {
                        <span class="keyword">var</span> <span class="variable-name">can_break</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
                        <span class="comment">// TODO: this need work
</span>                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (keep_words &amp;&amp; data.<span class="js2-object-property">space</span> !== -1) {
                            <span class="comment">// replace html entities with characters
</span>                            <span class="keyword">var</span> <span class="variable-name">stripped</span> = <span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(line).</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(data.</span><span class="js2-object-property"><span class="jcXcovered">space_count</span></span><span class="jcXcovered">)</span>;
                            <span class="comment">// real length, not counting formatting
</span>                            <span class="jcXcovered">stripped = stripped.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, length).</span><span class="js2-function-call"><span class="jcXcovered">trim</span></span><span class="jcXcovered">();</span>
                            <span class="keyword">var</span> <span class="variable-name">text_len</span> = <span class="js2-function-call"><span class="jcXcovered">strlen</span></span><span class="jcXcovered">(stripped)</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (stripped.<span class="js2-function-call">match</span>(<span class="string">/\s/</span>) || text_len &lt; length) {
                                <span class="jcXcovered">can_break = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                            }
                        }
                        <span class="comment">// if words is true we split at last space and make next loop
</span>                        <span class="comment">// continue where the space where located
</span>                        <span class="keyword">var</span> <span class="variable-name">new_index</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (keep_words &amp;&amp; data.<span class="js2-object-property">space</span> !== -1 &amp;&amp;
                            data.<span class="js2-object-property">index</span> !== line_length - 1 &amp;&amp; can_break) {
                            <span class="jcXcovered">output = line.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(first_index, data.</span><span class="js2-object-property"><span class="jcXcovered">space</span></span><span class="jcXcovered">);</span>
                            <span class="jcXcovered">new_index = data.</span><span class="js2-object-property"><span class="jcXcovered">space</span></span><span class="jcXcovered"> - 1;</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">substring = line.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">);</span>
                            <span class="jcXcovered">chr = </span><span class="js2-function-call"><span class="jcXcovered">get_next_character</span></span><span class="jcXcovered">(substring);</span>
                            <span class="jcXcovered">output = line.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(first_index, data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">) + chr;</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (last_iteraction &amp;&amp; last_bracket &amp;&amp; chr !== <span class="string">']'</span>) {
                                <span class="jcXcovered">output += </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">;</span>
                            }
                            <span class="jcXcovered">new_index = data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered"> + chr.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (keep_words) {
                            <span class="jcXcovered">output = output.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^(&amp;nbsp;|\s)+|(&amp;nbsp;|\s)+$/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="jcXcovered">first_index = (new_index || data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">) + 1;</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (prev_format) {
                            <span class="keyword">var</span> <span class="variable-name">closed_formatting</span> = <span class="jcXcovered">output.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^[^\]]*\]/</span></span><span class="jcXcovered">)</span>;
                            <span class="jcXcovered">output = prev_format + output;</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (closed_formatting) {
                                <span class="jcXcovered">prev_format = </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                            }
                        }
                        <span class="keyword">var</span> <span class="variable-name">matched</span> = <span class="jcXcovered">output.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(format_re)</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (matched) {
                            <span class="keyword">var</span> <span class="variable-name">last</span> = <span class="jcXcovered">matched[matched.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1]</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (last[last.<span class="js2-object-property">length</span> - 1] !== <span class="string">']'</span>) {
                                <span class="jcXcovered">prev_format = last.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(format_begin_re)[1];</span>
                                <span class="jcXcovered">output += </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">;</span>
                            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (output.<span class="js2-function-call">match</span>(format_end_re)) {
                                <span class="jcXcovered">output = output.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(format_end_re, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                                <span class="jcXcovered">prev_format = last.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(format_begin_re)[1];</span>
                            }
                        }
                        <span class="jcXcovered">result.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(output);</span>
                        <span class="comment">// modify loop by returing new data
</span>                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> {</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">: new_index, </span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">: 0, </span><span class="js2-object-property"><span class="jcXcovered">space</span></span><span class="jcXcovered">: -1};</span>
                    }
                });
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Escape &amp; that's not part of entity
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">amp</span>: <span class="keyword">function</span> <span class="function-name">amp</span>(<span class="js2-function-param">str</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> str.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/&amp;(?!#[0-9]+;|#x[0-9a-f]+;|[a-z]+;)/gi</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'&amp;amp;'</span></span><span class="jcXcovered">);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Encode formating as html for insertion into DOM
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">encode</span>: <span class="keyword">function</span> <span class="function-name">encode</span>(<span class="js2-function-param">str</span>, <span class="js2-function-param">options</span>) {
            <span class="keyword">var</span> <span class="variable-name">setting</span><span class="variable-name"><span class="jcXcovered">s</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>({
                <span class="js2-object-property">tabs</span>: 4,
                <span class="js2-object-property">before</span>: <span class="string">''</span>
            }, options);
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call">amp</span>(str).<span class="js2-function-call">replace</span>(<span class="string">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>).<span class="js2-function-call">replace</span>(<span class="string">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>)
                .<span class="js2-function-call">replace</span>(<span class="string">/ /g</span>, <span class="string">'&amp;nbsp;'</span>).<span class="js2-function-call">split</span>(<span class="string">'\n'</span>).<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">line</span>) {
                    <span class="keyword">var</span> <span class="variable-name">splitted</span> = <span class="jcXcovered">line.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/((?:\[\[[^\]]+\])?\t(?:\])?)/</span></span><span class="jcXcovered">)</span>;
                    <span class="jcXcovered">splitted = splitted.</span><span class="js2-function-call"><span class="jcXcovered">filter</span></span><span class="jcXcovered">(Boolean);</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> split</span>ted.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">str</span>, <span class="js2-function-param">i</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (str.<span class="js2-function-call">match</span>(<span class="string">/\t/</span>)) {
                            <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> str.<span class="js2-function-call">replace</span>(<span class="string">/\t([^\t]*)$/</span>, <span class="keyword">function</span>(<span class="js2-function-param">_</span>, <span class="js2-function-param">end</span>) {
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (i !== 0 &amp;&amp; splitted[i - 1].<span class="js2-function-call">match</span>(<span class="string">/\t\]?$/</span>)) {
                                    <span class="keyword">var</span> <span class="variable-name">sp</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">Array</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">tabs</span></span><span class="jcXcovered"> + 1).</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&amp;nbsp;'</span></span><span class="jcXcovered">)</span>;
                                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> sp + end;</span>
                                } <span class="keyword">else</span> {
                                    <span class="keyword">var</span> <span class="variable-name">before</span> = <span class="jcXcovered">splitted.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(i - 1, i).</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">)</span>;
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">before</span> &amp;&amp; i &lt;= 1) {
                                        <span class="jcXcovered">before = settings.</span><span class="js2-object-property"><span class="jcXcovered">before</span></span><span class="jcXcovered"> + before;</span>
                                    }
                                    <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(before)</span>;
                                    <span class="keyword">var</span> <span class="variable-name">chars</span> = <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">tabs</span></span><span class="jcXcovered"> - (len % settings.</span><span class="js2-object-property"><span class="jcXcovered">tabs</span></span><span class="jcXcovered">)</span>;
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (chars === 0) {
                                        <span class="jcXnot-covered">chars = 4;</span>
                                    }
                                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">Array</span></span><span class="jcXcovered">(chars + 1).</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&amp;nbsp;'</span></span><span class="jcXcovered">) + end;</span>
                                }
                            });
                        }
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> str;</span>
                    }).<span class="js2-function-call">join</span>(<span class="string">''</span>);
                }).<span class="js2-function-call">join</span>(<span class="string">'\n'</span>);
        },
        <span class="comment">// -----------------------------------------------------------------------
</span>        <span class="comment">// :: Default formatter that allow for nested formatting, example:
</span>        <span class="comment">// :: [[;;#000]hello [[;#f00;]red] world]
</span>        <span class="comment">// -----------------------------------------------------------------------
</span>        <span class="function-name">nested_formatting</span>: <span class="keyword">function</span> <span class="function-name">nested_formatting</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>$.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">have_formatting</span>(string)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
            }
            <span class="keyword">var</span> <span class="variable-name">stack</span> = <span class="jcXcovered">[]</span>;
            <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="string"><span class="jcXcovered">/((?:\[\[(?:[^\][]|\\\])+\])?(?:[^\][]|\\\])*\]?)/</span></span>;
            <span class="keyword">var</span> <span class="variable-name">format_re</span> = <span class="string"><span class="jcXcovered">/(\[\[(?:[^\][]|\\\])+\])[\s\S]*/</span></span>;
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> strin</span>g.<span class="js2-function-call">split</span>(re).<span class="js2-function-call">filter</span>(Boolean).<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">match</span>(<span class="string">/^\[\[/</span>)) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>$.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">is_formatting</span>(string)) {
                        <span class="jcXcovered">string += </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">;</span>
                        <span class="jcXcovered">stack.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(format_re, </span><span class="string"><span class="jcXcovered">'$1'</span></span><span class="jcXcovered">));</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">pop</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">match</span>(<span class="string">/\]/</span>)) {
                        <span class="jcXcovered">pop = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (stack.<span class="js2-object-property">length</span>) {
                        <span class="jcXcovered">string = stack[stack.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1] + string;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (pop) {
                        <span class="jcXcovered">stack.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">();</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (stack.<span class="js2-object-property">length</span>) {
                        <span class="jcXnot-covered">string += </span><span class="string"><span class="jcXnot-covered">']'</span></span><span class="jcXnot-covered">;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
            }).<span class="js2-function-call">join</span>(<span class="string">''</span>);
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: safe function that will render text as it is
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">escape_formatting</span>: <span class="keyword">function</span> <span class="function-name">escape_formatting</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_brackets</span></span><span class="jcXcovered">(string);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: apply custom formatters only to text
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">apply_formatters</span>: <span class="keyword">function</span> <span class="function-name">apply_formatters</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">settings</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string === <span class="string">""</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> settings.<span class="js2-object-property">position</span> === <span class="string">'number'</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> [</span><span class="string"><span class="jcXcovered">""</span></span><span class="jcXcovered">, settings.</span><span class="js2-object-property"><span class="jcXcovered">position</span></span><span class="jcXcovered">];</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">""</span></span><span class="jcXcovered">;</span>
                }
            }
            <span class="keyword">function</span> <span class="function-name">test_lengths</span>(<span class="js2-function-param">formatter</span>, <span class="js2-function-param">index</span>, <span class="js2-function-param">ret</span>, <span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>formatter.<span class="js2-object-property">__no_warn__</span> &amp;&amp;
                    $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">length</span>(ret) !== $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">length</span>(string)) {
                    <span class="js2-function-call"><span class="jcXnot-covered">warn</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'Your formatter['</span></span><span class="jcXnot-covered"> + index + </span><span class="string"><span class="jcXnot-covered">'] change length of </span></span><span class="string">the string, '</span> +
                         <span class="string">'you should use [regex, replacement] formatter or function '</span> +
                         <span class="string">' that return [replacement, position] instead'</span>);
                }
            }
            <span class="keyword">var</span> <span class="variable-name">formatters</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">defaults</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">formatters</span></span>;
            <span class="jcXcovered">settings = settings || {};</span>
            <span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>;
            <span class="keyword">function</span> <span class="function-name">apply_function_formatter</span>(<span class="js2-function-param">formatter</span>, <span class="js2-function-param">input</span>) {
                <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">options</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>({}, settings, {
                    <span class="js2-object-property">position</span>: input[1]
                });
                <span class="keyword">var</span> <span class="variable-name">ret</span> = <span class="js2-function-call"><span class="jcXcovered">formatter</span></span><span class="jcXcovered">(input[0], options)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> ret === <span class="string">'string'</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">test_lengths</span></span><span class="jcXcovered">(formatter, i - 1, ret, input[0]);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> ret === <span class="string">'string'</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> [ret, options.</span><span class="js2-object-property"><span class="jcXcovered">position</span></span><span class="jcXcovered">];</span>
                    }
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> input;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_array</span>(ret) &amp;&amp; ret.<span class="js2-object-property">length</span> === 2) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> ret;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> input;</span>
                }
            }
            <span class="keyword">var</span> <span class="variable-name">input</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> settings.<span class="js2-object-property">position</span> === <span class="string">'number'</span>) {
                <span class="jcXcovered">input = [string, settings.</span><span class="js2-object-property"><span class="jcXcovered">position</span></span><span class="jcXcovered">];</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">input = [string, 0];</span>
            }
            <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                <span class="keyword">var</span> <span class="variable-name">resul</span><span class="variable-name"><span class="jcXcovered">t</span></span><span class="jcXcovered"> = </span>formatters.<span class="js2-function-call">reduce</span>(<span class="keyword">function</span>(<span class="js2-function-param">input</span>, <span class="js2-function-param">formatter</span>) {
                    <span class="jcXcovered">i++;</span>
                    <span class="comment">// __meta__ is for safe formatter that can handle formatters
</span>                    <span class="comment">// inside formatters. for other usage we use format_split so one
</span>                    <span class="comment">// formatter don't mess with formatter that was previous
</span>                    <span class="comment">// on the list
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> formatter === <span class="string">'function'</span> &amp;&amp; formatter.<span class="js2-object-property">__meta__</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">apply_function_formatter</span></span><span class="jcXcovered">(formatter, input);</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword">var</span> <span class="variable-name">length</span> = <span class="jcXcovered">0</span>;
                        <span class="keyword">var</span> <span class="variable-name">found_position</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
                        <span class="keyword">var</span> <span class="variable-name">splitted</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">format_split</span></span><span class="jcXcovered">(input[0])</span>;
                        <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">partials</span></span><span class="jcXcovered"> = </span>splitted.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                            <span class="keyword">var</span> <span class="variable-name">position</span>;
                            <span class="keyword">var</span> <span class="variable-name">this_len</span> = <span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(string).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                            <span class="comment">// first position that match is used for this partial
</span>                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (input[1] &lt;= length + this_len &amp;&amp; <span class="negation-char">!</span>found_position) {
                                <span class="jcXcovered">position = input[1] - length;</span>
                                <span class="jcXcovered">found_position = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                            } <span class="keyword">else</span> {
                                <span class="comment">// -1 indicate that we will not track position because it
</span>                                <span class="comment">// was in one of the previous parial strings
</span>                                <span class="jcXcovered">position = -1;</span>
                            }
                            <span class="comment">// length is used to correct position after replace
</span>                            <span class="keyword">var</span> <span class="variable-name">length_before</span> = <span class="jcXcovered">length</span>;
                            <span class="keyword">var</span> <span class="variable-name">result</span>;
                            <span class="jcXcovered">length += this_len;</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">is_formatting</span>(string)) {
                                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> [string, -1];</span>
                            } <span class="keyword">else</span> {
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_array</span>(formatter)) {
                                    <span class="keyword">var</span> <span class="variable-name">options</span> = <span class="jcXcovered">formatter[2] || {}</span>;
                                    <span class="jcXcovered">result = [string, position &lt; 0 ? 0 : position];</span>
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result[0].<span class="js2-function-call">match</span>(formatter[0])) {
                                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">loop</span>) {
                                            <span class="keyword"><span class="jcXcovered">w</span></span><span class="keyword">hile</span> (result[0].<span class="js2-function-call">match</span>(formatter[0])) {
                                                <span class="jcXcovered">re</span>sult = $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">tracking_replace</span>(
                                                    result[0],
                                                    formatter[0],
                                                    formatter[1],
                                                    result[1]
                                                );
                                            }
                                        } <span class="keyword">else</span> {
                                            <span class="jcXcovered">re</span>sult = $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">tracking_replace</span>(
                                                result[0],
                                                formatter[0],
                                                formatter[1],
                                                result[1]
                                            );
                                        }
                                    }
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position &lt; 0) {
                                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> [result[0], -1];</span>
                                    }
                                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> formatter === <span class="string">'function'</span>) {
                                    <span class="jcXcovered">res</span>ult = <span class="js2-function-call">apply_function_formatter</span>(formatter, [
                                        string, position
                                    ]);
                                }
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> result !== <span class="string">'undefined'</span>) {
                                    <span class="comment">// correct position becuase it's relative
</span>                                    <span class="comment">// to partial and we need global for whole string
</span>                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result[1] !== -1) {
                                        <span class="jcXcovered">result[1] += length_before;</span>
                                    }
                                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
                                }
                                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> [string, -1];</span>
                            }
                        });
                        <span class="keyword">var</span> <span class="variable-name">p</span><span class="variable-name"><span class="jcXcovered">osition_partial</span></span><span class="jcXcovered"> = </span>partials.<span class="js2-function-call">filter</span>(<span class="keyword">function</span>(<span class="js2-function-param">partial</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> partial[1] !== -1;</span>
                        })[0];
                        <span class="keyword">var</span> <span class="variable-name">string</span> <span class="jcXcovered">= </span>partials.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">partial</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> partial[0];</span>
                        }).<span class="js2-function-call">join</span>(<span class="string">''</span>);
                        <span class="keyword">var</span> <span class="variable-name">position</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> position_partial === <span class="string">'undefined'</span>) {
                            <span class="jcXcovered">position = input[1];</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">position = position_partial[1];</span>
                        }
                        <span class="comment">// to make sure that output position is not outside the string
</span>                        <span class="keyword">var</span> <span class="variable-name">max</span> = <span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(string).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position &gt; max) {
                            <span class="jcXcovered">position = max;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string === input[0]) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> input;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> [string, position];</span>
                    }
                }, input);
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> settings.<span class="js2-object-property">position</span> === <span class="string">'number'</span>) {
                    <span class="keyword">var</span> <span class="variable-name">codepoint_len</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">strip</span></span><span class="jcXcovered">(result[0]).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">length</span>(result[0]) &lt; codepoint_len) {
                        <span class="keyword">var</span> <span class="variable-name">position</span> = <span class="jcXcovered">result[1]</span>;
                        <span class="jcXcovered">position = </span><span class="js2-function-call"><span class="jcXcovered">normalize_position</span></span><span class="jcXcovered">(result[0], position);</span>
                        <span class="keyword">var</span> <span class="variable-name">max</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(result[0])</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (position &gt; max) {
                            <span class="jcXnot-covered">position = max;</span>
                        }
                        <span class="jcXcovered">result[1] = position;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result[0];</span>
                }
            } <span class="keyword">catch</span> (e) {
                <span class="keyword">var</span> <span class="variable-name">msg</span> = <span class="string"><span class="jcXcovered">'Error in formatter ['</span></span><span class="jcXcovered"> + (i - 1) + </span><span class="string"><span class="jcXcovered">']'</span></span>;
                <span class="jcXcovered">formatters.</span><span class="js2-function-call"><span class="jcXcovered">splice</span></span><span class="jcXcovered">(i - 1);</span>
                <span class="keyword"><span class="jcXcovered">throw</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">Exception</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'formatting'</span></span><span class="jcXcovered">, msg, e.</span><span class="js2-object-property"><span class="jcXcovered">stack</span></span><span class="jcXcovered">);</span>
            }
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Replace terminal formatting with html
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">format</span>: <span class="keyword">function</span> <span class="function-name">format</span>(<span class="js2-function-param">str</span>, <span class="js2-function-param">options</span>) {
            <span class="keyword">var</span> <span class="variable-name">settings</span> = <span class="jcXcovered">$.</span><span class="js2-function-call">extend</span>({}, {
                <span class="js2-object-property">linksNoReferrer</span>: <span class="constant">false</span>,
                <span class="js2-object-property">linksNoFollow</span>: <span class="constant">false</span>,
                <span class="js2-object-property">allowedAttributes</span>: [],
                <span class="js2-object-property">char_width</span>: <span class="constant">undefined</span>,
                <span class="js2-object-property">escape</span>: <span class="constant">true</span>,
                <span class="js2-object-property">anyLinks</span>: <span class="constant">false</span>
            }, options || {});
            <span class="keyword">function</span> <span class="function-name">filter_attr_names</span>(<span class="js2-function-param">names</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (names.<span class="js2-object-property">length</span> &amp;&amp; settings.<span class="js2-object-property">allowedAttributes</span>.<span class="js2-object-property">length</span>) {
                    <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> names.<span class="js2-function-call">filter</span>(<span class="keyword">function</span>(<span class="js2-function-param">name</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (name === <span class="string">'data-text'</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="keyword">var</span> <span class="variable-name">allowed</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
                        <span class="keyword">var</span> <span class="variable-name">filters</span> = <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">allowedAttributes</span></span>;
                        <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>; i &lt; filters.<span class="js2-object-property">length</span>; ++i) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (filters[i] <span class="keyword">instanceof</span> RegExp) {
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (filters[i].<span class="js2-function-call">test</span>(name)) {
                                    <span class="jcXcovered">allowed = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                                    <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                                }
                            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (filters[i] === name) {
                                <span class="jcXcovered">allowed = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                                <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                            }
                        }
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> allowed;</span>
                    });
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> [];</span>
            }
            <span class="keyword">function</span> <span class="function-name">format</span>(<span class="js2-function-param">s</span>, <span class="js2-function-param">style</span>, <span class="js2-function-param">color</span>, <span class="js2-function-param">background</span>, <span class="js2-function-param">_class</span>, <span class="js2-function-param">data_text</span>, <span class="js2-function-param">text</span>) {
                <span class="keyword">var</span> <span class="variable-name">attrs</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data_text.<span class="js2-function-call">match</span>(<span class="string">/;/</span>)) {
                    <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                        <span class="keyword">var</span> <span class="variable-name">splitted</span> = <span class="jcXcovered">data_text.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">';'</span></span><span class="jcXcovered">)</span>;
                        <span class="keyword">var</span> <span class="variable-name">str</span> = <span class="jcXcovered">splitted.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(1).</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">';'</span></span><span class="jcXcovered">)</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (str.<span class="js2-function-call">match</span>(<span class="string">/^\s*\{[^}]*\}\s*$/</span>)) {
                            <span class="jcXcovered">attrs = JSON.</span><span class="js2-function-call"><span class="jcXcovered">parse</span></span><span class="jcXcovered">(str);</span>
                            <span class="jcXcovered">data_text = splitted[0];</span>
                        }
                    } <span class="keyword">catch</span> (e) {
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (text === <span class="string">''</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span> <span class="comment">//'&lt;span&gt;&amp;nbsp;&lt;/span&gt;';
</span>                }
                <span class="jcXcovered">text = </span><span class="js2-function-call"><span class="jcXcovered">safe</span></span><span class="jcXcovered">(text);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">escape</span>) {
                    <span class="comment">// inside formatting we need to unescape escaped slashes
</span>                    <span class="comment">// but this escape is not needed when echo - don't know why
</span>                    <span class="jcXcovered">text = text.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\\\\/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'\\'</span></span><span class="jcXcovered">);</span>
                }
                <span class="keyword">var</span> <span class="variable-name">style_str</span> = <span class="string"><span class="jcXcovered">''</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'b'</span>) !== -1) {
                    <span class="jcXcovered">style_str += </span><span class="string"><span class="jcXcovered">'font-weight:bold;'</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">text_decoration</span> = <span class="jcXcovered">[]</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'u'</span>) !== -1) {
                    <span class="jcXcovered">text_decoration.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'underline'</span></span><span class="jcXcovered">);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'s'</span>) !== -1) {
                    <span class="jcXcovered">text_decoration.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'line-through'</span></span><span class="jcXcovered">);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'o'</span>) !== -1) {
                    <span class="jcXcovered">text_decoration.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'overline'</span></span><span class="jcXcovered">);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (text_decoration.<span class="js2-object-property">length</span>) {
                    <span class="jcXcovered">style_str += </span><span class="string"><span class="jcXcovered">'text-decoration:'</span></span><span class="jcXcovered"> +
  </span>                      text_decoration.<span class="js2-function-call">join</span>(<span class="string">' '</span>) + <span class="string">';'</span>;
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'i'</span>) !== -1) {
                    <span class="jcXcovered">style_str += </span><span class="string"><span class="jcXcovered">'font-style:italic;'</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">valid_color</span>(color)) {
                    <span class="jcXcovered">style_str += </span><span class="string"><span class="jcXcovered">'color:'</span></span><span class="jcXcovered"> + color</span> + <span class="string">';'</span> +
                        <span class="string">'--color:'</span> + color + <span class="string">';'</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'!'</span>) !== -1) {
                        <span class="jcXnot-covered">style_str += </span><span class="string"><span class="jcXnot-covered">'--link-color:'</span></span><span class="jcXnot-covered"> + color + </span><span class="string"><span class="jcXnot-covered">';'</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'g'</span>) !== -1) {
                        <span class="jcXcovered">style_str += </span><span class="string"><span class="jcXcovered">'text-shadow:0 0 5px '</span></span><span class="jcXcovered"> + color + </span><span class="string"><span class="jcXcovered">';'</span></span><span class="jcXcovered">;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">valid_color</span>(background)) {
                    <span class="jcXcovered">style_str += </span><span class="string"><span class="jcXcovered">'background-color:'</span></span><span class="jcXcovered"> + background + </span><span class="string"><span class="jcXcovered">';'</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">data</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data_text === <span class="string">''</span>) {
                    <span class="jcXcovered">data = text;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">data = data_text.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/&amp;#93;/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">)
         </span>               .<span class="js2-function-call">replace</span>(<span class="string">/&gt;/g</span>, <span class="string">'&amp;gt;'</span>).<span class="js2-function-call">replace</span>(<span class="string">/&lt;/g</span>, <span class="string">'&amp;lt;'</span>);
                }
                <span class="keyword">var</span> <span class="variable-name">extra</span> = <span class="js2-function-call"><span class="jcXcovered">extra_css</span></span><span class="jcXcovered">(text, options)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (extra) {
                    <span class="jcXcovered">text = </span><span class="js2-function-call"><span class="jcXcovered">wide_characters</span></span><span class="jcXcovered">(text, options);</span>
                    <span class="jcXcovered">style_str += extra;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">result</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'!'</span>) !== -1) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-function-call">match</span>(email_re)) {
                        <span class="jcXcovered">result = </span><span class="string"><span class="jcXcovered">'&lt;a href="mailto:'</span></span><span class="jcXcovered"> + data + </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                    } <span class="keyword">else</span> {
                        <span class="comment">// only http and ftp links (prevent javascript)
</span>                        <span class="comment">// unless user force it with anyLinks option
</span>                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>settings.<span class="js2-object-property">anyLinks</span> &amp;&amp;
                            <span class="negation-char">!</span>data.<span class="js2-function-call">match</span>(<span class="string">/^((https?|ftp):\/\/|\.{0,2}\/)/</span>)) {
                            <span class="jcXcovered">data = </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="jcXcovered">result = </span><span class="string"><span class="jcXcovered">'&lt;a target="_blank"'</span></span><span class="jcXcovered">;</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data) {
                            <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">' href="'</span></span><span class="jcXcovered"> + data + </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="keyword">var</span> <span class="variable-name">rel</span> = <span class="jcXcovered">[</span><span class="string"><span class="jcXcovered">"noopener"</span></span><span class="jcXcovered">]</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">linksNoReferrer</span>) {
                            <span class="jcXcovered">rel.</span><span class="js2-function-call"><span class="jcXcovered">unshift</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">"noreferrer"</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">linksNoFollow</span>) {
                            <span class="jcXcovered">rel.</span><span class="js2-function-call"><span class="jcXcovered">unshift</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">"nofollow"</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">' rel="'</span></span><span class="jcXcovered"> + rel.</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">) + </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="comment">// make focus to terminal textarea that will enable
</span>                    <span class="comment">// terminal when pressing tab and terminal is disabled
</span>                    <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">' tabindex="1000"'</span></span><span class="jcXcovered">;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">result = </span><span class="string"><span class="jcXcovered">'&lt;span'</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style_str !== <span class="string">''</span>) {
                    <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">' style="'</span></span><span class="jcXcovered"> + style_str + </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (attrs) {
                    <span class="keyword">var</span> <span class="variable-name">keys</span> = <span class="js2-function-call"><span class="jcXcovered">filter_attr_names</span></span><span class="jcXcovered">(Object.</span><span class="js2-function-call"><span class="jcXcovered">keys</span></span><span class="jcXcovered">(attrs))</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (keys.<span class="js2-object-property">length</span>) {
                        <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">' '</span></span> + keys.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">name</span>) {
                            <span class="keyword">var</span> <span class="variable-name">value</span> = <span class="jcXcovered">attrs[name].</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/"/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'&amp;quot;'</span></span><span class="jcXcovered">)</span>;
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> name + </span><span class="string"><span class="jcXcovered">'="'</span></span><span class="jcXcovered"> + value + </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                        }).<span class="js2-function-call">join</span>(<span class="string">' '</span>);
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (_class !== <span class="string">''</span>) {
                    <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">' class="'</span></span><span class="jcXcovered"> + _class + </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style.<span class="js2-function-call">indexOf</span>(<span class="string">'!'</span>) !== -1) {
                    <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">'&gt;'</span></span><span class="jcXcovered"> + text + </span><span class="string"><span class="jcXcovered">'&lt;/a&gt;'</span></span><span class="jcXcovered">;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">result += </span><span class="string"><span class="jcXcovered">' data-text</span></span><span class="string">="'</span> + data.<span class="js2-function-call">replace</span>(<span class="string">/"/g</span>, <span class="string">'&amp;quot;'</span>) + <span class="string">'"&gt;'</span> +
                        text + <span class="string">'&lt;/span&gt;'</span>;
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> str === <span class="string">'string'</span>) {
                <span class="comment">// support for formating foo[[u;;]bar]baz[[b;#fff;]quux]zzz
</span>                <span class="keyword">var</span> <span class="variable-name">splitted</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">format_split</span></span><span class="jcXcovered">(str)</span>;
                <span class="jcXcovered">str = $.</span><span class="js2-function-call"><span class="jcXcovered">map</span></span><span class="jcXcovered">(</span>splitted, <span class="keyword">function</span>(<span class="js2-function-param">text</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (text === <span class="string">''</span>) {
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> text;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">is_formatting</span>(text)) {
                        <span class="comment">// fix &amp;nbsp; inside formatting because encode is called
</span>                        <span class="comment">// before format
</span>                        <span class="jcXcovered">tex</span>t = text.<span class="js2-function-call">replace</span>(<span class="string">/\[\[[^\]]+\]/</span>, <span class="keyword">function</span>(<span class="js2-function-param">text</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> text.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/&amp;nbsp;/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">);</span>
                        });
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> text.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(format_parts_re, format);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">text = </span><span class="js2-function-call"><span class="jcXcovered">safe</span></span><span class="jcXcovered">(text);</span>
                        <span class="keyword">var</span> <span class="variable-name">extra</span> = <span class="js2-function-call"><span class="jcXcovered">extra_css</span></span><span class="jcXcovered">(text, options)</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (extra.<span class="js2-object-property">length</span>) {
                            <span class="jcXcovered">text = </span><span class="js2-function-call"><span class="jcXcovered">wide_characters</span></span><span class="jcXcovered">(text, options);</span>
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'&lt;span style="'</span></span><span class="jcXcovered"> + extra + </span><span class="string"><span class="jcXcovered">'"&gt;'</span></span><span class="jcXcovered"> + text + </span><span class="string"><span class="jcXcovered">'&lt;/span&gt;'</span></span><span class="jcXcovered">;</span>
                        } <span class="keyword">else</span> {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'&lt;span&gt;'</span></span><span class="jcXcovered"> + text + </span><span class="string"><span class="jcXcovered">'&lt;/span&gt;'</span></span><span class="jcXcovered">;</span>
                        }
                    }
                }).<span class="js2-function-call">join</span>(<span class="string">''</span>);
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> str.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/&lt;span&gt;&lt;br\s*\/?&gt;&lt;\/span&gt;/gi</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'&lt;br/&gt;'</span></span><span class="jcXcovered">);</span>
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">;</span>
            }
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Replace brackets with html entities
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">escape_brackets</span>: <span class="keyword">function</span> <span class="function-name">escape_brackets</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\[/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'&amp;#91;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\]/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'&amp;#93;'</span></span><span class="jcXcovered">);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: complmentary function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">unescape_brackets</span>: <span class="keyword">function</span> <span class="function-name">unescape_brackets</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/&amp;#91;/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'['</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/&amp;#93;/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: return number of characters without formatting
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">length</span>: <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_characters</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">text</span></span><span class="jcXcovered">(string)).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: split characters handling emoji, surogate pairs and combine chars
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">split_characters</span>: <span class="keyword">function</span> <span class="function-name">split_characters</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">[]</span>;
            <span class="keyword"><span class="jcXcovered">w</span></span><span class="keyword">hile</span> (string.<span class="js2-object-property">length</span>) {
                <span class="keyword">var</span> <span class="variable-name">chr</span> = <span class="js2-function-call"><span class="jcXcovered">get_next_character</span></span><span class="jcXcovered">(string)</span>;
                <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(chr.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">);</span>
                <span class="jcXcovered">result.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(chr);</span>
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: return string where array items are in columns padded spaces
</span>        <span class="comment">// :: after adding align tabs arr.join('\t\t') looks much better
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">columns</span>: <span class="keyword">function</span>(<span class="js2-function-param">array</span>, <span class="js2-function-param">cols</span>, <span class="js2-function-param">space</span>) {
            <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">no_formatting</span></span><span class="jcXcovered"> = </span>array.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">strip</span></span><span class="jcXcovered">(string);</span>
            });
            <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">lengths</span></span><span class="jcXcovered"> = </span>no_formatting.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">strlen</span></span><span class="jcXcovered">(string);</span>
            });
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> space === <span class="string">'undefined'</span>) {
                <span class="jcXcovered">space = 4;</span>
            }
            <span class="keyword">var</span> <span class="variable-name">length</span> = <span class="jcXcovered">Math.</span><span class="js2-object-property"><span class="jcXcovered">max</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">, lengths) + space</span>;
            <span class="comment">// we need value - 1 because index starts from 0
</span>            <span class="keyword">var</span> <span class="variable-name">column_limit</span> = <span class="jcXcovered">Math.</span><span class="builtin"><span class="jcXcovered">floor</span></span><span class="jcXcovered">(cols / length) - 1</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (column_limit &lt; 1) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> array.</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">);</span>
            }
            <span class="keyword">var</span> <span class="variable-name">lines</span> = <span class="jcXcovered">[]</span>;
            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>, <span class="variable-name">len</span> = <span class="jcXcovered">array.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>; i &lt; len; i += column_limit) {
                <span class="keyword">var</span> <span class="variable-name">line</span> = <span class="jcXcovered">array.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(i, i + column_limit)</span>;
                <span class="keyword">var</span> <span class="variable-name">last</span> = <span class="jcXcovered">line.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">()</span>;
                <span class="jcXcovered">lines.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(line.</span><span class="js2-function-call"><span class="jcXcovered">reduce</span></span><span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">unction</span>(<span class="js2-function-param">acc</span>, <span class="js2-function-param">string</span>) {
                    <span class="keyword">var</span> <span class="variable-name">stripped</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">strip</span></span><span class="jcXcovered">(string)</span>;
                    <span class="keyword">var</span> <span class="variable-name">pad</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">Array</span></span><span class="jcXcovered">(length - stripped.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> + 1).</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">)</span>;
                    <span class="jcXcovered">acc.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(string + pad);</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> acc;</span>
                }, []).<span class="js2-function-call">join</span>(<span class="string">''</span>) + last);
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> lines.</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Remove formatting from text
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">strip</span>: <span class="keyword">function</span> <span class="function-name">strip</span>(<span class="js2-function-param">str</span>) {
            <span class="jcXcovered">str = str.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(format_parts_re, </span><span class="string"><span class="jcXcovered">'$6'</span></span><span class="jcXcovered">);</span>
            <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> str.<span class="js2-function-call">replace</span>(<span class="string">/\\([[\]])/g</span>, <span class="keyword">function</span>(<span class="js2-function-param">whole</span>, <span class="js2-function-param">bracket</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> bracket;</span>
            });
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Return active terminal
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">active</span>: <span class="keyword">function</span> <span class="function-name">active</span>() {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> terminals.</span><span class="js2-function-call"><span class="jcXcovered">front</span></span><span class="jcXcovered">();</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Implmentation detail id is always length of terminals Cycle
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">last_id</span>: <span class="keyword">function</span> <span class="function-name">last_id</span>() {
            <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> len - 1;</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Function that works with strings like 'asd' 'asd\' asd' "asd asd"
</span>        <span class="comment">// :: asd\ 123 -n -b / [^ ]+ / /\s+/ asd\ a it creates a regex and
</span>        <span class="comment">// :: numbers and replaces escape characters in double quotes
</span>        <span class="comment">// :: if strict is set to false it only strips single and double quotes
</span>        <span class="comment">// :: and escapes spaces
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">parse_argument</span>: <span class="keyword">function</span> <span class="function-name">parse_argument</span>(<span class="js2-function-param">arg</span>, <span class="js2-function-param">strict</span>) {
            <span class="keyword">function</span> <span class="function-name">parse_string</span>(<span class="js2-function-param">string</span>) {
                <span class="comment">// split string to string literals and non-strings
</span>                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> strin</span>g.<span class="js2-function-call">split</span>(string_re).<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                    <span class="comment">// remove quotes if before are even number of slashes
</span>                    <span class="comment">// we don't remove slases becuase they are handled by JSON.parse
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">match</span>(<span class="string">/^['"]/</span>)) {
                        <span class="comment">// fixing regex to match empty string is not worth it
</span>                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string === <span class="string">'""'</span> || string === <span class="string">"''"</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="keyword">var</span> <span class="variable-name">quote</span> = <span class="jcXcovered">string[0]</span>;
                        <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">RegExp</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">"(^|(?:\\\\(?:\\\\)*)?)"</span></span><span class="jcXcovered"> + quote, </span><span class="string"><span class="jcXcovered">"g"</span></span><span class="jcXcovered">)</span>;
                        <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(re, </span><span class="string"><span class="jcXcovered">"$1"</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="jcXcovered">string = </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered"> + string + </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                    <span class="comment">// use build in function to parse rest of escaped characters
</span>                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> JSON.</span><span class="js2-function-call"><span class="jcXcovered">parse</span></span><span class="jcXcovered">(string);</span>
                }).<span class="js2-function-call">join</span>(<span class="string">''</span>);
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (strict === <span class="constant">false</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arg[0] === <span class="string">"'"</span> &amp;&amp; arg[arg.<span class="js2-object-property">length</span> - 1] === <span class="string">"'"</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> arg.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^'|'$/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (arg[0] === <span class="string">'"'</span> &amp;&amp; arg[arg.<span class="js2-object-property">length</span> - 1] === <span class="string">'"'</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> arg.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^"|"$/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\\([" ])/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'$1'</span></span><span class="jcXcovered">);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (arg.<span class="js2-function-call">match</span>(<span class="string">/\/.*\/[gimy]*$/</span>)) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> arg;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (arg.<span class="js2-function-call">match</span>(<span class="string">/['"]]/</span>)) {
                    <span class="comment">// part of arg is in quote
</span>                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">parse_string</span></span><span class="jcXnot-covered">(arg);</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> arg.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\\ /g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">);</span>
                }
            }
            <span class="keyword">var</span> <span class="variable-name">regex</span> = <span class="jcXcovered">arg.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(re_re)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (regex) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">RegExp</span></span><span class="jcXcovered">(regex[1], regex[2]);</span>
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (arg.<span class="js2-function-call">match</span>(<span class="string">/['"]/</span>)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">parse_string</span></span><span class="jcXcovered">(arg);</span>
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (arg.<span class="js2-function-call">match</span>(<span class="string">/^-?[0-9]+$/</span>)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="builtin"><span class="jcXcovered">parseInt</span></span><span class="jcXcovered">(arg, 10);</span>
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (arg.<span class="js2-function-call">match</span>(float_re)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="builtin"><span class="jcXcovered">parseFloat</span></span><span class="jcXcovered">(arg);</span>
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> arg.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\\(['"() ])/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'$1'</span></span><span class="jcXcovered">);</span>
            }
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: function split and parse arguments
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">parse_arguments</span>: <span class="keyword">function</span> <span class="function-name">parse_arguments</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">map</span></span><span class="jcXcovered">(string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(command_re) || [], $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">parse_argument</span></span><span class="jcXcovered">);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Function split and strips single and double quotes
</span>        <span class="comment">// :: and escapes spaces
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">split_arguments</span>: <span class="keyword">function</span> <span class="function-name">split_arguments</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> $.<span class="js2-function-call">map</span>(string.<span class="js2-function-call">match</span>(command_re) || [], <span class="keyword">function</span>(<span class="js2-function-param">arg</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">parse_argument</span></span><span class="jcXcovered">(arg, </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">);</span>
            });
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Function that returns an object {name,args}. Arguments are parsed
</span>        <span class="comment">// :: using the function parse_arguments
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">parse_command</span>: <span class="keyword">function</span> <span class="function-name">parse_command</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">process_command</span></span><span class="jcXcovered">(string, $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">parse_argument</span></span><span class="jcXcovered">);</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Same as parse_command but arguments are parsed using split_arguments
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">split_command</span>: <span class="keyword">function</span> <span class="function-name">split_command</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> <span class="js2-function-call">process_command</span>(string, <span class="keyword">function</span>(<span class="js2-function-param">arg</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">parse_argument</span></span><span class="jcXcovered">(arg, </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">);</span>
            });
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :; function that parse arguments like yargs library
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">parse_options</span>: <span class="keyword">function</span> <span class="function-name">parse_options</span>(<span class="js2-function-param">arg</span>, <span class="js2-function-param">options</span>) {
            <span class="keyword">var</span> <span class="variable-name">setting</span><span class="variable-name"><span class="jcXcovered">s</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>({}, {
                <span class="js2-object-property">boolean</span>: []
            }, options);
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> arg === <span class="string">'string'</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">parse_options</span></span><span class="jcXcovered">($.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_arguments</span></span><span class="jcXcovered">(arg), options);</span>
            }
            <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">result</span></span><span class="jcXcovered"> = </span>{
                <span class="js2-object-property">_</span>: []
            };
            <span class="keyword">function</span> <span class="function-name">token</span>(<span class="js2-function-param">value</span>) {
                <span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">value</span></span><span class="jcXcovered"> = value;</span>
            }
            <span class="keyword">var</span> <span class="variable-name">rest</span><span class="jcXcovered"> = </span>arg.<span class="js2-function-call">reduce</span>(<span class="keyword">function</span>(<span class="js2-function-param">acc</span>, <span class="js2-function-param">arg</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> arg !== <span class="string">'string'</span>) {
                    <span class="jcXnot-covered">arg = </span><span class="js2-function-call"><span class="jcXnot-covered">String</span></span><span class="jcXnot-covered">(arg);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arg.<span class="js2-function-call">match</span>(<span class="string">/^-/</span>) &amp;&amp; acc <span class="keyword">instanceof</span> token) {
                    <span class="jcXcovered">result[acc.</span><span class="js2-object-property"><span class="jcXcovered">value</span></span><span class="jcXcovered">] = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arg.<span class="js2-function-call">match</span>(<span class="string">/^--/</span>)) {
                    <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="jcXcovered">arg.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^--/</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">boolean</span>.<span class="js2-function-call">indexOf</span>(name) === -1) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">token</span></span><span class="jcXcovered">(name);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">result[name] = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (arg.<span class="js2-function-call">match</span>(<span class="string">/^-/</span>)) {
                    <span class="keyword">var</span> <span class="variable-name">single</span> = <span class="jcXcovered">arg.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^-/</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">boolean</span>.<span class="js2-function-call">indexOf</span>(single.<span class="js2-function-call">slice</span>(-1)[0]) === -1) {
                        <span class="keyword">var</span> <span class="variable-name">last</span> = <span class="jcXcovered">single.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">()</span>;
                    }
                    <span class="jcXcovered">sin</span>gle.<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">single</span>) {
                        <span class="jcXcovered">result[single] = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    });
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (last) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">token</span></span><span class="jcXcovered">(last);</span>
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (acc <span class="keyword">instanceof</span> token) {
                    <span class="jcXcovered">result[acc.</span><span class="js2-object-property"><span class="jcXcovered">value</span></span><span class="jcXcovered">] = arg;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (arg) {
                    <span class="jcXcovered">result.</span><span class="js2-object-property"><span class="jcXcovered">_</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(arg);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">;</span>
            }, <span class="constant">null</span>);
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (rest <span class="keyword">instanceof</span> token) {
                <span class="jcXcovered">result[rest.</span><span class="js2-object-property"><span class="jcXcovered">value</span></span><span class="jcXcovered">] = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: function executed for each text inside [[ .... ]] in echo
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">extended_command</span>: <span class="keyword">function</span> <span class="function-name">extended_command</span>(<span class="js2-function-param">term</span>, <span class="js2-function-param">string</span>, <span class="js2-function-param">options</span>) {
            <span class="keyword">var</span> <span class="variable-name">setting</span><span class="variable-name"><span class="jcXcovered">s</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>({
                <span class="js2-object-property">invokeMethods</span>: <span class="constant">false</span>
            }, options);
            <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                <span class="jcXcovered">change_hash = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                <span class="keyword">var</span> <span class="variable-name">m</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(extended_command_re)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (m) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>settings.<span class="js2-object-property">invokeMethods</span>) {
                        <span class="js2-function-call"><span class="jcXnot-covered">warn</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'To invoke terminal or c</span></span><span class="string">md methods you need to enable '</span> +
                             <span class="string">'invokeMethods option'</span>);
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="jcXcovered">string = m[1];</span>
                    <span class="keyword">var</span> <span class="variable-name">obj</span> = <span class="jcXcovered">m[2] === </span><span class="string"><span class="jcXcovered">'terminal'</span></span><span class="jcXcovered"> ? term : term.</span><span class="js2-function-call"><span class="jcXcovered">cmd</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword">var</span> <span class="variable-name">fn</span> = <span class="jcXcovered">m[3]</span>;
                    <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                        <span class="keyword">var</span> <span class="variable-name">args</span> = <span class="builtin"><span class="jcXcovered">eval</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'['</span></span><span class="jcXcovered"> + m[4] + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">)</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>obj[fn]) {
                            <span class="jcXnot-covered">term.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'Unknow function '</span></span><span class="jcXnot-covered"> + fn);</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">obj[fn].</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(term, args);</span>
                        }
                    } <span class="keyword">catch</span> (e) {
                        <span class="jcXnot-covered">term.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'Invalid invocation in '</span></span><span class="jcXnot-covered"> +
         </span>                          $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">escape_brackets</span>(string));
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">ter</span>m.<span class="js2-function-call">exec</span>(string, <span class="constant">true</span>).<span class="js2-function-call">done</span>(<span class="keyword">function</span>() {
                        <span class="jcXcovered">change_hash = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    });
                }
            } <span class="keyword">catch</span> (e) {
                <span class="comment">// error is process in exec
</span>            }
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: ES6 iterator for a given string that handle emoji and formatting
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">iterator</span>: <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword">function</span> <span class="function-name">formatting</span>(<span class="js2-function-param">string</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">is_formatting</span>(string)) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">match</span>(<span class="string">/\]\\\]/</span>)) {
                        <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\]\\\]/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">']\\\\]'</span></span><span class="jcXcovered">);</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> Symbol === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> Symbol.<span class="js2-object-property">iterator</span> === <span class="string">'symbol'</span>) {
                <span class="keyword">var</span> <span class="variable-name">len</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">(string)</span>;
                <span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>;
                <span class="keyword">var</span> <span class="variable-name">obj</span> = <span class="jcXcovered">{}</span>;
                <span class="jcXcovered">ob</span>j[Symbol.<span class="js2-object-property">iterator</span>] = <span class="keyword">function</span>() {
                    <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> {
                        <span class="function-name">next</span>: <span class="keyword">function</span>() {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (i &lt; len) {
                                <span class="keyword">var</span> <span class="variable-name">text</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">substring</span></span><span class="jcXcovered">(string, i, i + 1)</span>;
                                <span class="jcXcovered">i++;</span>
                                <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> {
                                    <span class="js2-object-property">value</span>: <span class="js2-function-call">formatting</span>(text)
                                };
                            } <span class="keyword">else</span> {
                                <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> {
                                    <span class="js2-object-property">done</span>: <span class="constant">true</span>
                                };
                            }
                        }
                    };
                };
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> obj;</span>
            }
        },
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: object that can be used in string methods intead of regex
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="js2-object-property">formatter</span>: <span class="keyword">new</span> (<span class="keyword">function</span>() {
            <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>[Symbol.<span class="js2-object-property">split</span>] = <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">format_split</span></span><span class="jcXcovered">(string);</span>
                };
                <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>[Symbol.<span class="js2-object-property">match</span>] = <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(format_re);</span>
                };
                <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>[Symbol.<span class="js2-object-property">replace</span>] = <span class="keyword">function</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">replacer</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(format_parts_re, replacer);</span>
                };
                <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>[Symbol.<span class="js2-object-property">search</span>] = <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">search</span></span><span class="jcXcovered">(format_re);</span>
                };
            } <span class="keyword">catch</span> (e) {
            }
        })(),
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: helper function that add formatter before nested_formatting
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="function-name">new_formatter</span>: <span class="keyword">function</span>(<span class="js2-function-param">formatter</span>) {
            <span class="keyword">var</span> <span class="variable-name">formatters</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">defaults</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">formatters</span></span>;
            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>; i &lt; formatters.<span class="js2-object-property">length</span>; ++i) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (formatters[i] === $.<span class="js2-object-property">terminal</span>.<span class="js2-object-property">nested_formatting</span>) {
                    <span class="jcXcovered">formatters.</span><span class="js2-function-call"><span class="jcXcovered">splice</span></span><span class="jcXcovered">(i, 0, formatter);</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                }
            }
            <span class="jcXcovered">formatters.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(formatter);</span>
        }
    };
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="jcXcovered">$.</span><span class="js2-object-property">terminal</span>.<span class="function-name">Exception</span> = <span class="keyword">function</span> <span class="function-name">Terminal_Exception</span>(<span class="js2-function-param">type</span>, <span class="js2-function-param">message</span>, <span class="js2-function-param">stack</span>) {
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arguments.<span class="js2-object-property">length</span> === 1) {
            <span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">message</span></span><span class="jcXcovered"> = arguments[0];</span>
            <span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">type</span></span><span class="jcXcovered"> = </span><span class="string"><span class="jcXcovered">'TERMINAL'</span></span><span class="jcXcovered">;</span>
        } <span class="keyword">else</span> {
            <span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">type</span></span><span class="jcXcovered"> = type;</span>
            <span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">message</span></span><span class="jcXcovered"> = message;</span>
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (stack) {
                <span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">stack</span></span><span class="jcXcovered"> = stack;</span>
            }
        }
    };
    <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">Exception</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">prototype</span></span><span class="jcXcovered"> = </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">Error</span></span><span class="jcXcovered">();</span>
    <span class="jcXcovered">$.</span><span class="js2-object-property">terminal</span>.<span class="js2-object-property">Exception</span>.<span class="js2-object-property">prototype</span>.<span class="function-name">toString</span> = <span class="keyword">function</span>() {
        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">message</span></span><span class="jcXnot-covered"> + </span><span class="string"><span class="jcXnot-covered">'\n'</span></span><span class="jcXnot-covered"> + </span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">stack</span></span><span class="jcXnot-covered">;</span>
    };
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// Helper plugins and functions
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="jcXcovered">$.</span><span class="js2-object-property">fn</span>.<span class="function-name">visible</span> = <span class="keyword">function</span>() {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'visibility'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'visible'</span></span><span class="jcXcovered">);</span>
    };
    <span class="jcXcovered">$.</span><span class="js2-object-property">fn</span>.<span class="function-name">hidden</span> = <span class="keyword">function</span>() {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'visibility'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'hidden'</span></span><span class="jcXcovered">);</span>
    };
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">warnings</span> = <span class="jcXcovered">[]</span>;
    <span class="keyword">function</span> <span class="function-name">warn</span>(<span class="js2-function-param">msg</span>) {
        <span class="jcXnot-covered">msg = </span><span class="string"><span class="jcXnot-covered">'[jQuery Terminal] '</span></span><span class="jcXnot-covered"> + msg;</span>
        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (warnings.<span class="js2-function-call">indexOf</span>(msg) === -1) {
            <span class="jcXnot-covered">warnings.</span><span class="js2-function-call"><span class="jcXnot-covered">push</span></span><span class="jcXnot-covered">(msg);</span>
            <span class="comment">/* eslint-disable */</span>
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (console) {
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (console.<span class="js2-object-property">warn</span>) {
                    <span class="jcXnot-covered">console.</span><span class="js2-function-call"><span class="jcXnot-covered">warn</span></span><span class="jcXnot-covered">(msg);</span>
                }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (console.<span class="js2-object-property">log</span>) {
                    <span class="jcXnot-covered">console.</span><span class="js2-function-call"><span class="jcXnot-covered">log</span></span><span class="jcXnot-covered">(msg);</span>
                }
                <span class="comment">/* eslint-enable */</span>
            } <span class="keyword">else</span> {
                <span class="comment">// prevent catching in outer try..catch
</span>                <span class="js2-function-call"><span class="jcXnot-covered">setTim</span></span><span class="js2-function-call">eout</span>(<span class="keyword">function</span>() {
                    <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'WARN: '</span></span><span class="jcXnot-covered"> + msg);</span>
                }, 0);
            }
        }
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// JSON-RPC CALL
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">ids</span> = <span class="jcXcovered">{}</span>; <span class="comment">// list of url based ids of JSON-RPC
</span>    <span class="jcXcovered">$.</span><span class="function-name">jrpc</span> = <span class="keyword">function</span>(<span class="js2-function-param">url</span>, <span class="js2-function-param">method</span>, <span class="js2-function-param">params</span>, <span class="js2-function-param">success</span>, <span class="js2-function-param">error</span>) {
        <span class="keyword">var</span> <span class="variable-name">deferred</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">Deferred</span></span><span class="jcXcovered">()</span>;
        <span class="keyword">var</span> <span class="variable-name">options</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">isPlainObject</span>(url)) {
            <span class="jcXcovered">options = url;</span>
        } <span class="keyword">else</span> {
            <span class="jcXnot-covered">op</span>tions = {
                <span class="js2-object-property">url</span>: url,
                <span class="js2-object-property">method</span>: method,
                <span class="js2-object-property">params</span>: params,
                <span class="js2-object-property">success</span>: success,
                <span class="js2-object-property">error</span>: error
            };
        }
        <span class="keyword">function</span> <span class="function-name">validJSONRPC</span>(<span class="js2-function-param">response</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">isNumeric</span></span><span class="jcXcovered">(response.</span><span class="js2-object-property"><span class="jcXcovered">id</span></span><span class="jcXcovered">) &amp;&amp;
         </span>       (<span class="keyword">typeof</span> response.<span class="js2-object-property">result</span> !== <span class="string">'undefined'</span> ||
                 <span class="keyword">typeof</span> response.<span class="js2-object-property">error</span> !== <span class="string">'undefined'</span>);
        }
        <span class="jcXcovered">ids[options.</span><span class="js2-object-property"><span class="jcXcovered">url</span></span><span class="jcXcovered">] = ids[options.</span><span class="js2-object-property"><span class="jcXcovered">url</span></span><span class="jcXcovered">] || 0;</span>
        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">request</span></span><span class="jcXcovered"> = </span>{
            <span class="js2-object-property">'jsonrpc'</span>: <span class="string">'2.0'</span>,
            <span class="js2-object-property">'method'</span>: options.<span class="js2-object-property">method</span>,
            <span class="js2-object-property">'params'</span>: options.<span class="js2-object-property">params</span>,
            <span class="js2-object-property">'id'</span>: ++ids[options.<span class="js2-object-property">url</span>]
        };
        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">a</span></span><span class="js2-function-call">jax</span>({
            <span class="js2-object-property">url</span>: options.<span class="js2-object-property">url</span>,
            <span class="function-name">beforeSend</span>: <span class="keyword">function</span> <span class="function-name">beforeSend</span>(<span class="js2-function-param">jxhr</span>, <span class="js2-function-param">settings</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(options.<span class="js2-object-property">request</span>)) {
                    <span class="jcXcovered">options.</span><span class="js2-function-call"><span class="jcXcovered">request</span></span><span class="jcXcovered">(jxhr, request);</span>
                }
                <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">data</span></span><span class="jcXcovered"> = JSON.</span><span class="js2-function-call"><span class="jcXcovered">stringify</span></span><span class="jcXcovered">(request);</span>
            },
            <span class="function-name">success</span>: <span class="keyword">function</span> <span class="function-name">success</span>(<span class="js2-function-param">response</span>, <span class="js2-function-param">status</span>, <span class="js2-function-param">jqXHR</span>) {
                <span class="keyword">var</span> <span class="variable-name">content_type</span> = <span class="jcXcovered">jqXHR.</span><span class="js2-function-call"><span class="jcXcovered">getResponseHeader</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'Content-Type'</span></span><span class="jcXcovered">)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>content_type.<span class="js2-function-call">match</span>(<span class="string">/(application|text)\/json/</span>)) {
                    <span class="js2-function-call"><span class="jcXnot-covered">warn</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'Response Content-</span></span><span class="string">Type is neither application/json'</span> +
                         <span class="string">' nor text/json'</span>);
                }
                <span class="keyword">var</span> <span class="variable-name">json</span>;
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="jcXcovered">json = JSON.</span><span class="js2-function-call"><span class="jcXcovered">parse</span></span><span class="jcXcovered">(response);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">error</span>) {
                        <span class="jcXcovered">options.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(jqXHR, </span><span class="string"><span class="jcXcovered">'Invalid JSON'</span></span><span class="jcXcovered">, e);</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> $.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">Exception</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'JSON'</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">'Invalid JSON'</span></span><span class="jcXnot-covered">, e.</span><span class="js2-object-property"><span class="jcXnot-covered">stack</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="jcXcovered">deferred.</span><span class="js2-function-call"><span class="jcXcovered">reject</span></span><span class="jcXcovered">({</span><span class="js2-object-property"><span class="jcXcovered">message</span></span><span class="jcXcovered">: </span><span class="string"><span class="jcXcovered">'Invalid JSON'</span></span><span class="jcXcovered">, </span><span class="js2-object-property"><span class="jcXcovered">response</span></span><span class="jcXcovered">: response});</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(options.<span class="js2-object-property">response</span>)) {
                    <span class="jcXcovered">options.</span><span class="js2-function-call"><span class="jcXcovered">response</span></span><span class="jcXcovered">(jqXHR, json);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">validJSONRPC</span>(json) || options.<span class="js2-object-property">method</span> === <span class="string">'system.describe'</span>) {
                    <span class="comment">// don't catch errors in success callback
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">success</span>) {
                        <span class="jcXcovered">options.</span><span class="js2-function-call"><span class="jcXcovered">success</span></span><span class="jcXcovered">(json, status, jqXHR);</span>
                    }
                    <span class="jcXcovered">deferred.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">(json);</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">error</span>) {
                        <span class="jcXcovered">options.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(jqXHR, </span><span class="string"><span class="jcXcovered">'Invalid JSON-RPC'</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="jcXcovered">deferred.</span><span class="js2-function-call"><span class="jcXcovered">reject</span></span><span class="jcXcovered">({</span><span class="js2-object-property"><span class="jcXcovered">message</span></span><span class="jcXcovered">: </span><span class="string"><span class="jcXcovered">'Invalid JSON-RPC'</span></span><span class="jcXcovered">, </span><span class="js2-object-property"><span class="jcXcovered">response</span></span><span class="jcXcovered">: response});</span>
                }
            },
            <span class="js2-object-property">error</span>: options.<span class="js2-object-property">error</span>,
            <span class="js2-object-property">contentType</span>: <span class="string">'application/json'</span>,
            <span class="js2-object-property">dataType</span>: <span class="string">'text'</span>,
            <span class="js2-object-property">async</span>: <span class="constant">true</span>,
            <span class="js2-object-property">cache</span>: <span class="constant">false</span>,
            <span class="comment">// timeout: 1,
</span>            <span class="js2-object-property">type</span>: <span class="string">'POST'</span>
        });
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> deferred.</span><span class="js2-function-call"><span class="jcXcovered">promise</span></span><span class="jcXcovered">();</span>
    };

    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">/*
    function is_scrolled_into_view(elem) {
        var docViewTop = $(window).scrollTop();
        var docViewBottom = docViewTop + $(window).height();

        var elemTop = $(elem).offset().top;
        var elemBottom = elemTop + $(elem).height();

        return ((elemBottom &gt;= docViewTop) &amp;&amp; (elemTop &lt;= docViewBottom));
    }
    */</span>
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">terminal_ready</span>(<span class="js2-function-param">term</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="negation-char"><span class="jcXcovered">!!</span></span><span class="jcXcovered">(term.</span><span class="js2-function-call"><span class="jcXcovered">closest</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'body'</span></span><span class="jcXcovered">).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> &amp;</span>&amp;
                  term.<span class="js2-function-call">is</span>(<span class="string">':visible'</span>) &amp;&amp;
                  term.<span class="js2-function-call">find</span>(<span class="string">'.prompt'</span>).<span class="js2-object-property">length</span>);
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Create fake terminal to calcualte the dimention of one character
</span>    <span class="comment">// :: this will make terminal work if terminal div is not added to the
</span>    <span class="comment">// :: DOM at init like with:
</span>    <span class="comment">// :: $('&lt;div/&gt;').terminal().echo('foo bar').appendTo('body');
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">get_char_size</span>(<span class="js2-function-param">term</span>) {
        <span class="keyword">var</span> <span class="variable-name">rect</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">terminal_ready</span>(term)) {
            <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">$prompt</span></span><span class="jcXcovered"> = </span>term.<span class="js2-function-call">find</span>(<span class="string">'.prompt'</span>).<span class="js2-function-call">clone</span>().<span class="js2-function-call">css</span>({
                <span class="js2-object-property">visiblity</span>: <span class="string">'hidden'</span>,
                <span class="js2-object-property">position</span>: <span class="string">'absolute'</span>
            });
            <span class="jcXcovered">$prompt.</span><span class="js2-function-call"><span class="jcXcovered">appendTo</span></span><span class="jcXcovered">(term.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cmd'</span></span><span class="jcXcovered">)).</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&amp;nbsp;'</span></span><span class="jcXcovered">);</span>
            <span class="jcXcovered">rect = $prompt[0].</span><span class="js2-function-call"><span class="jcXcovered">getBoundingClientRect</span></span><span class="jcXcovered">();</span>
            <span class="jcXcovered">$prompt.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
        } <span class="keyword">else</span> {
            <span class="keyword">var</span> <span class="variable-name">temp</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;div cl</span></span><span class="string">ass="terminal temp"&gt;&lt;div class="terminal-wrapper"&gt;'</span> +
                         <span class="string">'&lt;div class="terminal-output"&gt;&lt;div&gt;&lt;div class="line" style'</span> +
                         <span class="string">'="float: left"&gt;&lt;span&gt;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;'</span>)
                .<span class="js2-function-call">appendTo</span>(<span class="string">'body'</span>);
            <span class="jcXcovered">temp.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(term.</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'class'</span></span><span class="jcXcovered">)).</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'id'</span></span><span class="jcXcovered">, term.</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'id'</span></span><span class="jcXcovered">));</span>
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (term) {
                <span class="keyword">var</span> <span class="variable-name">style</span> = <span class="jcXcovered">term.</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'style'</span></span><span class="jcXcovered">)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (style) {
                    <span class="jcXcovered">style = style</span>.<span class="js2-function-call">split</span>(<span class="string">/\s*;\s*/</span>).<span class="js2-function-call">filter</span>(<span class="keyword">function</span>(<span class="js2-function-param">s</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="negation-char"><span class="jcXcovered">!</span></span><span class="jcXcovered">s.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/display\s*:\s*none/i</span></span><span class="jcXcovered">);</span>
                    }).<span class="js2-function-call">join</span>(<span class="string">';'</span>);
                    <span class="jcXcovered">temp.</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'style'</span></span><span class="jcXcovered">, style);</span>
                }
            }
            <span class="jcXcovered">rect = temp.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.line'</span></span><span class="jcXcovered">)[0].</span><span class="js2-function-call"><span class="jcXcovered">getBoundingClientRect</span></span><span class="jcXcovered">();</span>
        }
        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">result</span></span><span class="jcXcovered"> = </span>{
            <span class="js2-object-property">width</span>: rect.<span class="js2-object-property">width</span>,
            <span class="js2-object-property">height</span>: rect.<span class="js2-object-property">height</span>
        };
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (temp) {
            <span class="jcXcovered">temp.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
        }
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result;</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: calculate numbers of characters
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">get_num_chars</span>(<span class="js2-function-param">terminal</span>, <span class="js2-function-param">char_size</span>) {
        <span class="keyword">var</span> <span class="variable-name">width</span> = <span class="jcXcovered">terminal.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.terminal-fill'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">width</span></span><span class="jcXcovered">()</span>;
        <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">Math.</span><span class="builtin"><span class="jcXcovered">floor</span></span><span class="jcXcovered">(width / char_size.</span><span class="js2-object-property"><span class="jcXcovered">width</span></span><span class="jcXcovered">)</span>;
        <span class="comment">// random number to not get NaN in node.js but big enough to
</span>        <span class="comment">// not wrap exception
</span>        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> result || 1000;</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Calculate number of lines that fit without scroll
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">get_num_rows</span>(<span class="js2-function-param">terminal</span>, <span class="js2-function-param">char_size</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> Math.</span><span class="builtin"><span class="jcXcovered">floor</span></span><span class="jcXcovered">(terminal.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.terminal-fill'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">height</span></span><span class="jcXcovered">() / char_size.</span><span class="js2-object-property"><span class="jcXcovered">height</span></span><span class="jcXcovered">);</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">all</span>(<span class="js2-function-param">array</span>, <span class="js2-function-param">fn</span>) {
        <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">same</span></span><span class="jcXcovered"> = </span>array.<span class="js2-function-call">filter</span>(<span class="keyword">function</span>(<span class="js2-function-param">item</span>) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> item[fn]() === item;</span>
        });
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> same.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> === array.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">string_case</span>(<span class="js2-function-param">string</span>) {
        <span class="keyword">var</span> <span class="variable-name">array</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">)</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">all</span>(array, <span class="string">'toLowerCase'</span>)) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'lower'</span></span><span class="jcXcovered">;</span>
        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">all</span>(array, <span class="string">'toUpperCase'</span>)) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'upper'</span></span><span class="jcXcovered">;</span>
        } <span class="keyword">else</span> {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'mixed'</span></span><span class="jcXcovered">;</span>
        }
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">same_case</span>(<span class="js2-function-param">string</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">string_case</span></span><span class="jcXcovered">(string) !== </span><span class="string"><span class="jcXcovered">'mixed'</span></span><span class="jcXcovered">;</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// fix for jQuery bug
</span>    <span class="keyword">function</span> <span class="function-name">is_function</span>(<span class="js2-function-param">object</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">get_type</span></span><span class="jcXcovered">(object) === </span><span class="string"><span class="jcXcovered">'function'</span></span><span class="jcXcovered">;</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">is_array</span>(<span class="js2-function-param">object</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">get_type</span></span><span class="jcXcovered">(object) === </span><span class="string"><span class="jcXcovered">'array'</span></span><span class="jcXcovered">;</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">function</span> <span class="function-name">get_type</span>(<span class="js2-function-param">object</span>) {
        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">typeof</span></span><span class="jcXcovered"> object === </span><span class="string"><span class="jcXcovered">'function'</span></span><span class="jcXcovered"> ? </span><span class="string"><span class="jcXcovered">'function'</span></span><span class="jcXcovered"> : $.</span><span class="js2-function-call"><span class="jcXcovered">type</span></span><span class="jcXcovered">(object);</span>
    }
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: TERMINAL PLUGIN CODE
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">version_set</span> = <span class="negation-char"><span class="jcXcovered">!</span></span><span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">version</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^\{\{/</span></span><span class="jcXcovered">)</span>;
    <span class="keyword">var</span> <span class="variable-name">copyright</span> = <span class="string"><span class="jcXcovered">'Copyright (</span></span><span class="string">c) 2011-2019 Jakub T. Jankiewicz '</span> +
        <span class="string">'<a href="https://jcubic.pl/me">&lt;https://jcubic.pl/me&gt;</a>'</span>;
    <span class="keyword">var</span> <span class="variable-name">version_string</span> = <span class="jcXcovered">version_set ? </span><span class="string"><span class="jcXcovered">' v. '</span></span><span class="jcXcovered"> + $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">version</span></span><span class="jcXcovered"> : </span><span class="string"><span class="jcXcovered">' '</span></span>;
    <span class="comment">// regex is for placing version string aligned to the right
</span>    <span class="keyword">var</span> <span class="variable-name">reg</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">RegExp</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">' {'</span></span><span class="jcXcovered"> + version_string.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> + </span><span class="string"><span class="jcXcovered">'}$'</span></span><span class="jcXcovered">)</span>;
    <span class="keyword">var</span> <span class="variable-name">name_ver</span> = <span class="string"><span class="jcXcovered">'jQuery Terminal Emulato</span></span><span class="string">r'</span> +
        (version_set ? version_string : <span class="string">''</span>);
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Terminal Signatures
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">signatures</span></span><span class="jcXcovered"> = </span>[
        [<span class="string">'jQuery Terminal'</span>, <span class="string">'(c) 2011-2019 jcubic'</span>],
        [name_ver, copyright.<span class="js2-function-call">replace</span>(<span class="string">/^Copyright | *&lt;.*&gt;/g</span>, <span class="string">''</span>)],
        [name_ver, copyright.<span class="js2-function-call">replace</span>(<span class="string">/^Copyright /</span>, <span class="string">''</span>)],
        [
            <span class="string">'      _______                 ________                        __'</span>,
            <span class="string">'     / / _  /_ ____________ _/__  ___/______________  _____  / /'</span>,
            <span class="string">' __ / / // / // / _  / _/ // / / / _  / _/     / /  \\/ / _ \\/ /'</span>,
            <span class="string">'/  / / // / // / ___/ // // / / / ___/ // / / / / /\\  / // / /__'</span>,
            <span class="string">'\\___/____ \\\\__/____/_/ \\__ / /_/____/_//_/_/_/_/_/  \\/\\__\\_\\___/'</span>,
            <span class="string">'         \\/          /____/                                   '</span>
                .<span class="js2-function-call">replace</span>(reg, <span class="string">' '</span>) + version_string,
            copyright
        ],
        [
            <span class="string">'      __ _____                     ________                            '</span> +
                <span class="string">'  __'</span>,
            <span class="string">'     / // _  /__ __ _____ ___ __ _/__  ___/__ ___ ______ __ __  __ ___ '</span> +
                <span class="string">' / /'</span>,
            <span class="string">' __ / // // // // // _  // _// // / / // _  // _//     // //  \\/ // _ '</span> +
                <span class="string">'\\/ /'</span>,
            <span class="string">'/  / // // // // // ___// / / // / / // ___// / / / / // // /\\  // // '</span> +
                <span class="string">'/ /__'</span>,
            <span class="string">'\\___//____ \\\\___//____//_/ _\\_  / /_//____//_/ /_/ /_//_//_/ /_/ \\'</span> +
                <span class="string">'__\\_\\___/'</span>,
            (<span class="string">'          \\/              /____/                                     '</span> +
             <span class="string">'     '</span>).<span class="js2-function-call">replace</span>(reg, <span class="string">''</span>) + version_string,
            copyright
        ]
    ];
    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="comment">// :: Default options
</span>    <span class="comment">// -----------------------------------------------------------------------
</span>    <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">nested_formatting</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">__meta__</span></span><span class="jcXcovered"> = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
    <span class="comment">// nested formatting will always return different length so we silent the warning
</span>    <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">nested_formatting</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">__no_warn__</span></span><span class="jcXcovered"> = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
    <span class="jcXcovered">$.</span><span class="js2-object-property">terminal</span>.<span class="js2-object-property">defaults</span> = {
        <span class="js2-object-property">prompt</span>: <span class="string">'&gt; '</span>,
        <span class="js2-object-property">history</span>: <span class="constant">true</span>,
        <span class="js2-object-property">exit</span>: <span class="constant">true</span>,
        <span class="js2-object-property">clear</span>: <span class="constant">true</span>,
        <span class="js2-object-property">enabled</span>: <span class="constant">true</span>,
        <span class="js2-object-property">maskChar</span>: <span class="string">'*'</span>,
        <span class="js2-object-property">wrap</span>: <span class="constant">true</span>,
        <span class="js2-object-property">checkArity</span>: <span class="constant">true</span>,
        <span class="js2-object-property">raw</span>: <span class="constant">false</span>,
        <span class="js2-object-property">tabindex</span>: 1,
        <span class="js2-object-property">invokeMethods</span>: <span class="constant">false</span>,
        <span class="js2-object-property">exceptionHandler</span>: <span class="constant">null</span>,
        <span class="js2-object-property">pauseEvents</span>: <span class="constant">true</span>,
        <span class="js2-object-property">softPause</span>: <span class="constant">false</span>,
        <span class="js2-object-property">memory</span>: <span class="constant">false</span>,
        <span class="js2-object-property">cancelableAjax</span>: <span class="constant">true</span>,
        <span class="js2-object-property">processArguments</span>: <span class="constant">true</span>,
        <span class="js2-object-property">linksNoReferrer</span>: <span class="constant">false</span>,
        <span class="js2-object-property">anyLinks</span>: <span class="constant">false</span>,
        <span class="js2-object-property">linksNoFollow</span>: <span class="constant">false</span>,
        <span class="js2-object-property">processRPCResponse</span>: <span class="constant">null</span>,
        <span class="js2-object-property">completionEscape</span>: <span class="constant">true</span>,
        <span class="js2-object-property">onCommandChange</span>: <span class="constant">null</span>,
        <span class="js2-object-property">onPositionChange</span>: <span class="constant">null</span>,
        <span class="js2-object-property">convertLinks</span>: <span class="constant">true</span>,
        <span class="js2-object-property">extra</span>: {},
        <span class="js2-object-property">tabs</span>: 4,
        <span class="js2-object-property">historySize</span>: 60,
        <span class="js2-object-property">scrollObject</span>: <span class="constant">null</span>,
        <span class="js2-object-property">historyState</span>: <span class="constant">false</span>,
        <span class="js2-object-property">importHistory</span>: <span class="constant">false</span>,
        <span class="js2-object-property">historyFilter</span>: <span class="constant">null</span>,
        <span class="js2-object-property">echoCommand</span>: <span class="constant">true</span>,
        <span class="js2-object-property">scrollOnEcho</span>: <span class="constant">true</span>,
        <span class="js2-object-property">login</span>: <span class="constant">null</span>,
        <span class="js2-object-property">outputLimit</span>: -1,
        <span class="js2-object-property">formatters</span>: [$.<span class="js2-object-property">terminal</span>.<span class="js2-object-property">nested_formatting</span>],
        <span class="js2-object-property">onAjaxError</span>: <span class="constant">null</span>,
        <span class="js2-object-property">pasteImage</span>: <span class="constant">true</span>,
        <span class="js2-object-property">scrollBottomOffset</span>: 20,
        <span class="js2-object-property">wordAutocomplete</span>: <span class="constant">true</span>,
        <span class="js2-object-property">caseSensitiveAutocomplete</span>: <span class="constant">true</span>,
        <span class="js2-object-property">caseSensitiveSearch</span>: <span class="constant">true</span>,
        <span class="js2-object-property">clickTimeout</span>: 200,
        <span class="js2-object-property">holdTimeout</span>: 400,
        <span class="js2-object-property">holdRepeatTimeout</span>: 200,
        <span class="js2-object-property">repeatTimeoutKeys</span>: [<span class="string">'HOLD+BACKSPACE'</span>],
        <span class="js2-object-property">mobileIngoreAutoSpace</span>: [],
        <span class="js2-object-property">request</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">response</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">describe</span>: <span class="string">'procs'</span>,
        <span class="js2-object-property">onRPCError</span>: <span class="constant">null</span>,
        <span class="js2-object-property">doubleTab</span>: <span class="constant">null</span>,
        <span class="js2-object-property">doubleTabEchoCommand</span>: <span class="constant">false</span>,
        <span class="js2-object-property">completion</span>: <span class="constant">false</span>,
        <span class="js2-object-property">onInit</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onClear</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onBlur</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onFocus</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onTerminalChange</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onExit</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onPush</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onPop</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">keypress</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">keydown</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onAfterRedraw</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onEchoCommand</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onPaste</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">onFlush</span>: $.<span class="js2-object-property">noop</span>,
        <span class="js2-object-property">allowedAttributes</span>: [<span class="string">'title'</span>, <span class="string">/^aria-/</span>, <span class="string">'id'</span>, <span class="string">/^data-/</span>],
        <span class="js2-object-property">strings</span>: {
            <span class="js2-object-property">comletionParameters</span>: <span class="string">'From version 1.0.0 completion function need to'</span> +
                <span class="string">' have two arguments'</span>,
            <span class="js2-object-property">wrongPasswordTryAgain</span>: <span class="string">'Wrong password try again!'</span>,
            <span class="js2-object-property">wrongPassword</span>: <span class="string">'Wrong password!'</span>,
            <span class="js2-object-property">ajaxAbortError</span>: <span class="string">'Error while aborting ajax call!'</span>,
            <span class="js2-object-property">wrongArity</span>: <span class="string">"Wrong number of arguments. Function '%s' expects %s got"</span> +
                <span class="string">' %s!'</span>,
            <span class="js2-object-property">commandNotFound</span>: <span class="string">"Command '%s' Not Found!"</span>,
            <span class="js2-object-property">oneRPCWithIgnore</span>: <span class="string">'You can use only one rpc with describe == false '</span> +
                <span class="string">'or rpc without system.describe'</span>,
            <span class="js2-object-property">oneInterpreterFunction</span>: <span class="string">"You can't use more than one function (rpc "</span> +
                <span class="string">'without system.describe or with option describe == false count'</span> +
                 <span class="string">'s as one)'</span>,
            <span class="js2-object-property">loginFunctionMissing</span>: <span class="string">"You didn't specify a login function"</span>,
            <span class="js2-object-property">noTokenError</span>: <span class="string">'Access denied (no token)'</span>,
            <span class="js2-object-property">serverResponse</span>: <span class="string">'Server responded'</span>,
            <span class="js2-object-property">wrongGreetings</span>: <span class="string">'Wrong value of greetings parameter'</span>,
            <span class="js2-object-property">notWhileLogin</span>: <span class="string">"You can't call `%s' function while in login"</span>,
            <span class="js2-object-property">loginIsNotAFunction</span>: <span class="string">'Authenticate must be a function'</span>,
            <span class="js2-object-property">canExitError</span>: <span class="string">"You can't exit from main interpreter"</span>,
            <span class="js2-object-property">invalidCompletion</span>: <span class="string">'Invalid completion'</span>,
            <span class="js2-object-property">invalidSelector</span>: <span class="string">'Sorry, but terminal said that you use invalid '</span> +
                <span class="string">'selector!'</span>,
            <span class="js2-object-property">invalidTerminalId</span>: <span class="string">'Invalid Terminal ID'</span>,
            <span class="js2-object-property">login</span>: <span class="string">'login'</span>,
            <span class="js2-object-property">password</span>: <span class="string">'password'</span>,
            <span class="js2-object-property">recursiveCall</span>: <span class="string">'Recursive call detected, skip'</span>,
            <span class="js2-object-property">notAString</span>: <span class="string">'%s function: argument is not a string'</span>,
            <span class="js2-object-property">redrawError</span>: <span class="string">'Internal error, wrong position in cmd redraw'</span>,
            <span class="js2-object-property">invalidStrings</span>: <span class="string">'Command %s have unclosed strings'</span>,
            <span class="js2-object-property">defunctTerminal</span>: <span class="string">"You can't call method on terminal that was destroyed"</span>
        }
    };
    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="comment">// :: All terminal globals
</span>    <span class="comment">// -------------------------------------------------------------------------
</span>    <span class="keyword">var</span> <span class="variable-name">requests</span> = <span class="jcXcovered">[]</span>; <span class="comment">// for canceling on CTRL+D
</span>    <span class="keyword">var</span> <span class="variable-name">terminals</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">Cycle</span></span><span class="jcXcovered">()</span>; <span class="comment">// list of terminals global in this scope
</span>    <span class="comment">// state for all terminals, terminals can't have own array fo state because
</span>    <span class="comment">// there is only one popstate event
</span>    <span class="keyword">var</span> <span class="variable-name">save_state</span> = <span class="jcXcovered">[]</span>; <span class="comment">// hold objects returned by export_view by history API
</span>    <span class="keyword">var</span> <span class="variable-name">hash_commands</span>;
    <span class="keyword">var</span> <span class="variable-name">change_hash</span> = <span class="constant"><span class="jcXcovered">false</span></span>; <span class="comment">// don't change hash on Init
</span>    <span class="keyword">var</span> <span class="variable-name">fire_hash_change</span> = <span class="constant"><span class="jcXcovered">true</span></span>;
    <span class="keyword">var</span> <span class="variable-name">first_instance</span> = <span class="constant"><span class="jcXcovered">true</span></span>; <span class="comment">// used by history state
</span>    <span class="comment">//object_debugger($.fn, 'jquery')();
</span>    <span class="jcXcovered">$.</span><span class="js2-object-property">fn</span>.<span class="function-name">terminal</span> = <span class="keyword">function</span>(<span class="js2-function-param">init_interpreter</span>, <span class="js2-function-param">options</span>) {
        <span class="keyword">function</span> <span class="function-name">StorageHelper</span>(<span class="js2-function-param">memory</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (memory) {
                <span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">storage</span></span><span class="jcXnot-covered"> = {};</span>
            }
            <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>.<span class="function-name">set</span> = <span class="keyword">function</span>(<span class="js2-function-param">key</span>, <span class="js2-function-param">value</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (memory) {
                    <span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">storage</span></span><span class="jcXnot-covered">[key] = value;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">Storage</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(key, value);</span>
                }
            };
            <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>.<span class="function-name">get</span> = <span class="keyword">function</span>(<span class="js2-function-param">key</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (memory) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">storage</span></span><span class="jcXnot-covered">[key];</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">Storage</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">(key);</span>
                }
            };
            <span class="builtin"><span class="jcXcovered">th</span></span><span class="builtin">is</span>.<span class="function-name">remove</span> = <span class="keyword">function</span>(<span class="js2-function-param">key</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (memory) {
                    <span class="keyword"><span class="jcXnot-covered">delete</span></span><span class="jcXnot-covered"> </span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">storage</span></span><span class="jcXnot-covered">[key];</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">Storage</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(key);</span>
                }
            };
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: helper function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">get_processed_command</span>(<span class="js2-function-param">command</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">unclosed_strings</span>(command)) {
                <span class="keyword">var</span> <span class="variable-name">string</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_brackets</span></span><span class="jcXcovered">(command)</span>;
                <span class="keyword">var</span> <span class="variable-name">message</span> = <span class="js2-function-call"><span class="jcXcovered">sprintf</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">strings</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">invalidStrings</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">"`"</span></span><span class="jcXcovered"> + string + </span><span class="string"><span class="jcXcovered">"`"</span></span><span class="jcXcovered">)</span>;
                <span class="keyword"><span class="jcXcovered">throw</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">Exception</span></span><span class="jcXcovered">(message);</span>
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">processArguments</span>)) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">process_command</span></span><span class="jcXnot-covered">(command, settings.</span><span class="js2-object-property"><span class="jcXnot-covered">processArguments</span></span><span class="jcXnot-covered">);</span>
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (settings.<span class="js2-object-property">processArguments</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">parse_command</span></span><span class="jcXcovered">(command);</span>
            } <span class="keyword">else</span> {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> $.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">split_command</span></span><span class="jcXnot-covered">(command);</span>
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Display object on terminal
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">display_object</span>(<span class="js2-function-param">object</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> object === <span class="string">'string'</span>) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(object);</span>
            }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_array</span>(object)) {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">echo</span></span><span class="jcXnot-covered">($.</span><span class="js2-function-call"><span class="jcXnot-covered">ma</span></span><span class="js2-function-call">p</span>(object, <span class="keyword">function</span>(<span class="js2-function-param">object</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> JSON.</span><span class="js2-function-call"><span class="jcXnot-covered">stringify</span></span><span class="jcXnot-covered">(object);</span>
                }).<span class="js2-function-call">join</span>(<span class="string">' '</span>));
            }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> object === <span class="string">'object'</span>) {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">echo</span></span><span class="jcXnot-covered">(JSON.</span><span class="js2-function-call"><span class="jcXnot-covered">stringify</span></span><span class="jcXnot-covered">(object));</span>
            } <span class="keyword">else</span> {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">echo</span></span><span class="jcXnot-covered">(object);</span>
            }
        }
        <span class="comment">// Display line code in the file if line numbers are present
</span>        <span class="keyword">function</span> <span class="function-name">print_line</span>(<span class="js2-function-param">url_spec</span>) {
            <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="string"><span class="jcXcovered">/(.*):([0-9]+):([0-9]+)$/</span></span>;
            <span class="comment">// google chrome have line and column after filename
</span>            <span class="keyword">var</span> <span class="variable-name">m</span> = <span class="jcXcovered">url_spec.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(re)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (m) {
                <span class="comment">// TODO: do we need to call pause/resume or return promise?
</span>                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">(m[1],</span> <span class="keyword">function</span>(<span class="js2-function-param">response</span>) {
                    <span class="keyword">var</span> <span class="variable-name">file</span> = <span class="jcXcovered">m[1]</span>;
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'[[b;white;]'</span></span><span class="jcXcovered"> + file + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">);</span>
                    <span class="keyword">var</span> <span class="variable-name">code</span> = <span class="jcXcovered">response.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword">var</span> <span class="variable-name">n</span> = <span class="jcXcovered">+m[2] - 1</span>;
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(code.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(n -</span> 2, n + 3).<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">line</span>, <span class="js2-function-param">i</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (i === 2) {
                            <span class="jcXcovered">line = </span><span class="string"><span class="jcXcovered">'[[;#f00;]'</span></span><span class="jcXcovered"> +
                      </span>          $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">escape_brackets</span>(line) + <span class="string">']'</span>;
                        }
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'['</span></span><span class="jcXcovered"> + (n + i - 1) + </span><span class="string"><span class="jcXcovered">']: '</span></span><span class="jcXcovered"> + line;</span>
                    }).<span class="js2-function-call">join</span>(<span class="string">'\n'</span>)).<span class="js2-function-call">resume</span>();
                }, <span class="string">'text'</span>);
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Helper function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">display_json_rpc_error</span>(<span class="js2-function-param">error</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onRPCError</span>)) {
                <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">onRPCError</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, error);</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&amp;#91;RPC&amp;#93; '</span></span><span class="jcXcovered"> + error.</span><span class="js2-object-property"><span class="jcXcovered">message</span></span><span class="jcXcovered">);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (error.<span class="js2-object-property">error</span> &amp;&amp; error.<span class="js2-object-property">error</span>.<span class="js2-object-property">message</span>) {
                    <span class="jcXcovered">error = error.</span><span class="js2-object-property"><span class="jcXcovered">error</span></span><span class="jcXcovered">;</span>
                    <span class="comment">// more detailed error message
</span>                    <span class="keyword">var</span> <span class="variable-name">msg</span> = <span class="string"><span class="jcXcovered">'\t'</span></span><span class="jcXcovered"> + error.</span><span class="js2-object-property"><span class="jcXcovered">message</span></span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (error.<span class="js2-object-property">file</span>) {
                        <span class="jcXcovered">msg += </span><span class="string"><span class="jcXcovered">' in file "'</span></span><span class="jcXcovered"> + error.</span><span class="js2-object-property"><span class="jcXcovered">file</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/.*\//</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">) + </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (error.<span class="js2-object-property">at</span>) {
                        <span class="jcXcovered">msg += </span><span class="string"><span class="jcXcovered">' at line '</span></span><span class="jcXcovered"> + error.</span><span class="js2-object-property"><span class="jcXcovered">at</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(msg);</span>
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Create interpreter function from url string
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">make_basic_json_rpc</span>(<span class="js2-function-param">url</span>, <span class="js2-function-param">auth</span>) {
            <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="function-name"><span class="jcXcovered">interpreter</span></span><span class="jcXcovered"> = </span><span class="keyword">function</span>(<span class="js2-function-param">method</span>, <span class="js2-function-param">params</span>) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">j</span></span><span class="js2-function-call">rpc</span>({
                    <span class="js2-object-property">url</span>: url,
                    <span class="js2-object-property">method</span>: method,
                    <span class="js2-object-property">params</span>: params,
                    <span class="function-name">request</span>: <span class="keyword">function</span>(<span class="js2-function-param">jxhr</span>, <span class="js2-function-param">request</span>) {
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">request</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, jxhr, request, self);</span>
                        } <span class="keyword">catch</span> (e) {
                            <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'USER'</span></span><span class="jcXnot-covered">);</span>
                        }
                    },
                    <span class="function-name">response</span>: <span class="keyword">function</span>(<span class="js2-function-param">jxhr</span>, <span class="js2-function-param">response</span>) {
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">response</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, jxhr, response, self);</span>
                        } <span class="keyword">catch</span> (e) {
                            <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'USER'</span></span><span class="jcXnot-covered">);</span>
                        }
                    },
                    <span class="function-name">success</span>: <span class="keyword">function</span> <span class="function-name">success</span>(<span class="js2-function-param">json</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (json.<span class="js2-object-property">error</span>) {
                            <span class="js2-function-call"><span class="jcXnot-covered">display_json_rpc_error</span></span><span class="jcXnot-covered">(json.</span><span class="js2-object-property"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">);</span>
                        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">processRPCResponse</span>)) {
                            <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">processRPCResponse</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, json.</span><span class="js2-object-property"><span class="jcXnot-covered">result</span></span><span class="jcXnot-covered">, self);</span>
                        } <span class="keyword">else</span> {
                            <span class="js2-function-call"><span class="jcXcovered">display_object</span></span><span class="jcXcovered">(json.</span><span class="js2-object-property"><span class="jcXcovered">result</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                    },
                    <span class="js2-object-property">error</span>: ajax_error
                });
            };
            <span class="comment">// this is the interpreter function
</span>            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">command</span>, <span class="js2-function-param">terminal</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command === <span class="string">''</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="jcXcovered">command = </span><span class="js2-function-call"><span class="jcXcovered">get_processed_command</span></span><span class="jcXcovered">(command);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="comment">// exception can be thrown on invalid regex
</span>                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'TERMINAL (get_processed_command)'</span></span><span class="jcXnot-covered">);</span>
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                    <span class="comment">// throw e; // this will show stack in other try..catch
</span>                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>auth || command.<span class="js2-object-property">name</span> === <span class="string">'help'</span>) {
                    <span class="comment">// allows to call help without a token
</span>                    <span class="js2-function-call"><span class="jcXcovered">interpreter</span></span><span class="jcXcovered">(command.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered">, command.</span><span class="js2-object-property"><span class="jcXcovered">args</span></span><span class="jcXcovered">);</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">token</span> = <span class="jcXcovered">terminal.</span><span class="js2-function-call"><span class="jcXcovered">token</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (token) {
                        <span class="js2-function-call"><span class="jcXcovered">interpreter</span></span><span class="jcXcovered">(command.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered">, [token].</span><span class="js2-function-call"><span class="jcXcovered">concat</span></span><span class="jcXcovered">(command.</span><span class="js2-object-property"><span class="jcXcovered">args</span></span><span class="jcXcovered">));</span>
                    } <span class="keyword">else</span> {
                        <span class="comment">// should never happen
</span>                        <span class="jcXnot-covered">terminal.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'&amp;#91;AUTH&amp;#93; '</span></span><span class="jcXnot-covered"> + </span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">noTokenError</span></span><span class="jcXnot-covered">);</span>
                    }
                }
            };
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Create interpreter function from Object. If the value is object
</span>        <span class="comment">// :: it will create nested interpreters
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">make_object_interpreter</span>(<span class="js2-function-param">object</span>, <span class="js2-function-param">arity</span>, <span class="js2-function-param">login</span>, <span class="js2-function-param">fallback</span>) {
            <span class="comment">// function that maps commands to object methods
</span>            <span class="comment">// it keeps terminal context
</span>            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">user_command</span>, <span class="js2-function-param">terminal</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (user_command === <span class="string">''</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="comment">// command = split_command_line(command);
</span>                <span class="keyword">var</span> <span class="variable-name">command</span>;
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="jcXcovered">command = </span><span class="js2-function-call"><span class="jcXcovered">get_processed_command</span></span><span class="jcXcovered">(user_command);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="comment">// exception can be thrown on invalid regex
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">exception</span>)) {
                        <span class="jcXnot-covered">settings.</span><span class="js2-function-call"><span class="jcXnot-covered">exception</span></span><span class="jcXnot-covered">(e, self);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'Error: '</span></span><span class="jcXcovered"> + (e.</span><span class="js2-object-property"><span class="jcXcovered">message</span></span><span class="jcXcovered"> || e));</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                    <span class="comment">// throw e; // this will show stack in other try..catch
</span>                }
                <span class="comment">/*
                if (login) {
                    var token = self.token(true);
                    if (token) {
                        command.args = [token].concat(command.args);
                    } else {
                        terminal.error('&amp;#91;AUTH&amp;#93; ' + strings.noTokenError);
                        return;
                    }
                }*/</span>
                <span class="keyword">var</span> <span class="variable-name">val</span> = <span class="jcXcovered">object[command.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered">]</span>;
                <span class="keyword">var</span> <span class="variable-name">type</span> = <span class="js2-function-call"><span class="jcXcovered">get_type</span></span><span class="jcXcovered">(val)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (type === <span class="string">'function'</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arity &amp;&amp; val.<span class="js2-object-property">length</span> !== command.<span class="js2-object-property">args</span>.<span class="js2-object-property">length</span>) {
                        <span class="jcXcovered">se</span>lf.<span class="js2-function-call">error</span>(
                            <span class="string">'&amp;#91;Arity&amp;#93; '</span> +
                                <span class="js2-function-call">sprintf</span>(
                                    <span class="js2-function-call">strings</span>().<span class="js2-object-property">wrongArity</span>,
                                    command.<span class="js2-object-property">name</span>,
                                    val.<span class="js2-object-property">length</span>,
                                    command.<span class="js2-object-property">args</span>.<span class="js2-object-property">length</span>
                                )
                        );
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> val.</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(self, command.</span><span class="js2-object-property"><span class="jcXcovered">args</span></span><span class="jcXcovered">);</span>
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (type === <span class="string">'object'</span> || type === <span class="string">'string'</span>) {
                    <span class="keyword">var</span> <span class="variable-name">commands</span> = <span class="jcXcovered">[]</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (type === <span class="string">'object'</span>) {
                        <span class="jcXcovered">commands = Object.</span><span class="js2-function-call"><span class="jcXcovered">keys</span></span><span class="jcXcovered">(val);</span>
                        <span class="jcXcovered">va</span>l = <span class="js2-function-call">make_object_interpreter</span>(
                            val,
                            arity,
                            login
                        );
                    }
                    <span class="jcXcovered">ter</span>minal.<span class="js2-function-call">push</span>(val, {
                        <span class="js2-object-property">prompt</span>: command.<span class="js2-object-property">name</span> + <span class="string">'&gt; '</span>,
                        <span class="js2-object-property">name</span>: command.<span class="js2-object-property">name</span>,
                        <span class="js2-object-property">completion</span>: type === <span class="string">'object'</span> ? commands : <span class="constant">undefined</span>
                    });
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(fallback)) {
                    <span class="js2-function-call"><span class="jcXcovered">fallback</span></span><span class="jcXcovered">(user_command, self);</span>
                }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onCommandNotFound</span>)) {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">onCommandNotFound</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, user_command, self);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">terminal.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">sprintf</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">commandNotFound</span></span><span class="jcXnot-covered">, command.</span><span class="js2-object-property"><span class="jcXnot-covered">name</span></span><span class="jcXnot-covered">));</span>
                }
            };
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">ajax_error</span>(<span class="js2-function-param">xhr</span>, <span class="js2-function-param">status</span>, <span class="js2-function-param">error</span>) {
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span> <span class="comment">// onAjaxError can use pause/resume call it first
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onAjaxError</span>)) {
                <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">onAjaxError</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, xhr, status, error);</span>
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (status !== <span class="string">'abort'</span>) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&amp;#91;AJAX&amp;#93; '</span></span><span class="jcXcovered"> + status + </span><span class="string"><span class="jcXcovered">' - '</span></span><span class="jcXcovered"> +
         </span>                  <span class="js2-function-call">strings</span>().<span class="js2-object-property">serverResponse</span> + <span class="string">':\n'</span> +
                           $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">escape_brackets</span>(xhr.<span class="js2-object-property">responseText</span>));
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">make_json_rpc_object</span>(<span class="js2-function-param">url</span>, <span class="js2-function-param">auth</span>, <span class="js2-function-param">success</span>) {
            <span class="keyword">function</span> <span class="function-name">jrpc_success</span>(<span class="js2-function-param">json</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (json.<span class="js2-object-property">error</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">display_json_rpc_error</span></span><span class="jcXcovered">(json.</span><span class="js2-object-property"><span class="jcXcovered">error</span></span><span class="jcXcovered">);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">processRPCResponse</span>)) {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">processRPCResponse</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, json.</span><span class="js2-object-property"><span class="jcXnot-covered">result</span></span><span class="jcXnot-covered">, self);</span>
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXcovered">display_object</span></span><span class="jcXcovered">(json.</span><span class="js2-object-property"><span class="jcXcovered">result</span></span><span class="jcXcovered">);</span>
                }
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
            }
            <span class="keyword">function</span> <span class="function-name">jrpc_request</span>(<span class="js2-function-param">jxhr</span>, <span class="js2-function-param">request</span>) {
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">request</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, jxhr, request, self);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'USER'</span></span><span class="jcXnot-covered">);</span>
                }
            }
            <span class="keyword">function</span> <span class="function-name">jrpc_response</span>(<span class="js2-function-param">jxhr</span>, <span class="js2-function-param">response</span>) {
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">response</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, jxhr, response, self);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'USER'</span></span><span class="jcXnot-covered">);</span>
                }
            }
            <span class="keyword">function</span> <span class="function-name">response</span>(<span class="js2-function-param">response</span>) {
                <span class="keyword">var</span> <span class="variable-name">procs</span> = <span class="jcXcovered">response</span>;
                <span class="comment">// we check if it's false before we call this function but
</span>                <span class="comment">// it don't hurt to be explicit here
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">describe</span> !== <span class="constant">false</span> &amp;&amp; settings.<span class="js2-object-property">describe</span> !== <span class="string">''</span>) {
                    <span class="jcXcovered">set</span>tings.<span class="js2-object-property">describe</span>.<span class="js2-function-call">split</span>(<span class="string">'.'</span>).<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">field</span>) {
                        <span class="jcXcovered">procs = procs[field];</span>
                    });
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (procs &amp;&amp; procs.<span class="js2-object-property">length</span>) {
                    <span class="keyword">var</span> <span class="variable-name">interpreter_object</span> = <span class="jcXcovered">{}</span>;
                    <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">ach</span>(procs, <span class="keyword">function</span>(<span class="js2-function-param">_</span>, <span class="js2-function-param">proc</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">isPlainObject</span>(proc) &amp;&amp; <span class="keyword">typeof</span> proc.<span class="js2-object-property">name</span> === <span class="string">'string'</span>) {
                            <span class="jcXcovered">in</span>terpreter_object[proc.<span class="js2-object-property">name</span>] = <span class="keyword">function</span>() {
                                <span class="keyword">var</span> <span class="variable-name">append</span> = <span class="jcXcovered">auth &amp;&amp; proc.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered"> !== </span><span class="string"><span class="jcXcovered">'help'</span></span>;
                                <span class="keyword">var</span> <span class="variable-name">args</span> = <span class="jcXcovered">Array.</span><span class="js2-object-property"><span class="jcXcovered">prototype</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">slice</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">arguments</span></span><span class="jcXcovered">)</span>;
                                <span class="keyword">var</span> <span class="variable-name">args_len</span> = <span class="jcXcovered">args.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> + (append ? 1 : 0)</span>;
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">checkArity</span> &amp;&amp; proc.<span class="js2-object-property">params</span> &amp;&amp;
                                    proc.<span class="js2-object-property">params</span>.<span class="js2-object-property">length</span> !== args_len) {
                                    <span class="jcXnot-covered">se</span>lf.<span class="js2-function-call">error</span>(
                                        <span class="string">'&amp;#91;Arity&amp;#93; '</span> +
                                            <span class="js2-function-call">sprintf</span>(
                                                <span class="js2-function-call">strings</span>().<span class="js2-object-property">wrongArity</span>,
                                                proc.<span class="js2-object-property">name</span>,
                                                proc.<span class="js2-object-property">params</span>.<span class="js2-object-property">length</span>,
                                                args_len
                                            )
                                    );
                                } <span class="keyword">else</span> {
                                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (append) {
                                        <span class="keyword">var</span> <span class="variable-name">token</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">token</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">)</span>;
                                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (token) {
                                            <span class="jcXcovered">args = [token].</span><span class="js2-function-call"><span class="jcXcovered">concat</span></span><span class="jcXcovered">(args);</span>
                                        } <span class="keyword">else</span> {
                                            <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'&amp;#91;AUTH&amp;#93; '</span></span><span class="jcXnot-covered"> +
    </span>                                                   <span class="js2-function-call">strings</span>().<span class="js2-object-property">noTokenError</span>);
                                        }
                                    }
                                    <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">j</span></span><span class="js2-function-call">rpc</span>({
                                        <span class="js2-object-property">url</span>: url,
                                        <span class="js2-object-property">method</span>: proc.<span class="js2-object-property">name</span>,
                                        <span class="js2-object-property">params</span>: args,
                                        <span class="js2-object-property">request</span>: jrpc_request,
                                        <span class="js2-object-property">response</span>: jrpc_response,
                                        <span class="js2-object-property">success</span>: jrpc_success,
                                        <span class="js2-object-property">error</span>: ajax_error
                                    });
                                }
                            };
                        }
                    });
                    <span class="keyword">var</span> <span class="variable-name">login</span> = <span class="keyword"><span class="jcXcovered">typeof</span></span><span class="jcXcovered"> auth === </span><span class="string"><span class="jcXcovered">'string'</span></span><span class="jcXcovered"> ? auth : </span><span class="string"><span class="jcXcovered">'login'</span></span>;
                    <span class="jcXcovered">in</span>terpreter_object.<span class="js2-object-property">help</span> = interpreter_object.<span class="js2-object-property">help</span> || <span class="keyword">function</span>(<span class="js2-function-param">fn</span>) {
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> fn === <span class="string">'undefined'</span>) {
                            <span class="keyword">var</span> <span class="variable-name">names</span> = <span class="jcXnot-covered">procs.</span><span class="js2-function-call"><span class="jcXnot-covered">map</span></span><span class="jcXnot-covered">(</span><span class="keyword"><span class="jcXnot-covered">fu</span></span><span class="keyword">nction</span>(<span class="js2-function-param">proc</span>) {
                                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> proc.</span><span class="js2-object-property"><span class="jcXnot-covered">name</span></span><span class="jcXnot-covered">;</span>
                            }).<span class="js2-function-call">join</span>(<span class="string">', '</span>) + <span class="string">', help'</span>;
                            <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">echo</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'Available commands: '</span></span><span class="jcXnot-covered"> + names);</span>
                        } <span class="keyword">else</span> {
                            <span class="keyword">var</span> <span class="variable-name">found</span> = <span class="constant"><span class="jcXnot-covered">false</span></span>;
                            <span class="jcXnot-covered">$.</span><span class="js2-function-call"><span class="jcXnot-covered">e</span></span><span class="js2-function-call">ach</span>(procs, <span class="keyword">function</span>(<span class="js2-function-param">_</span>, <span class="js2-function-param">proc</span>) {
                                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (proc.<span class="js2-object-property">name</span> === fn) {
                                    <span class="jcXnot-covered">found = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                                    <span class="keyword">var</span> <span class="variable-name">msg</span> = <span class="string"><span class="jcXnot-covered">''</span></span>;
                                    <span class="jcXnot-covered">msg += </span><span class="string"><span class="jcXnot-covered">'[[bu;;]'</span></span><span class="jcXnot-covered"> + proc.</span><span class="js2-object-property"><span class="jcXnot-covered">name</span></span><span class="jcXnot-covered"> + </span><span class="string"><span class="jcXnot-covered">']'</span></span><span class="jcXnot-covered">;</span>
                                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (proc.<span class="js2-object-property">params</span>) {
                                        <span class="keyword">var</span> <span class="variable-name">params</span> = <span class="jcXnot-covered">proc.</span><span class="js2-object-property"><span class="jcXnot-covered">params</span></span>;
                                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (auth &amp;&amp; proc.<span class="js2-object-property">name</span> !== login) {
                                            <span class="jcXnot-covered">params = params.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(1);</span>
                                        }
                                        <span class="jcXnot-covered">msg += </span><span class="string"><span class="jcXnot-covered">' '</span></span><span class="jcXnot-covered"> + params.</span><span class="js2-function-call"><span class="jcXnot-covered">join</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">' '</span></span><span class="jcXnot-covered">);</span>
                                    }
                                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (proc.<span class="js2-object-property">help</span>) {
                                        <span class="jcXnot-covered">msg += </span><span class="string"><span class="jcXnot-covered">'\n'</span></span><span class="jcXnot-covered"> + proc.</span><span class="js2-object-property"><span class="jcXnot-covered">help</span></span><span class="jcXnot-covered">;</span>
                                    }
                                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">echo</span></span><span class="jcXnot-covered">(msg);</span>
                                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                                }
                            });
                            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>found) {
                                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (fn === <span class="string">'help'</span>) {
                                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">echo</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'[[bu;;]help] </span></span><span class="string">[method]\ndisplay help '</span> +
                                              <span class="string">'for the method or list of methods if not'</span> +
                                              <span class="string">' specified'</span>);
                                } <span class="keyword">else</span> {
                                    <span class="keyword">var</span> <span class="variable-name">msg</span> = <span class="string"><span class="jcXnot-covered">'Method `'</span></span><span class="jcXnot-covered"> + fn + </span><span class="string"><span class="jcXnot-covered">"' not found "</span></span>;
                                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(msg);</span>
                                }
                            }
                        }
                    };
                    <span class="js2-function-call"><span class="jcXcovered">success</span></span><span class="jcXcovered">(interpreter_object);</span>
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXcovered">success</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">);</span>
                }
            }
            <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> $.<span class="js2-function-call">jrpc</span>({
                <span class="js2-object-property">url</span>: url,
                <span class="js2-object-property">method</span>: <span class="string">'system.describe'</span>,
                <span class="js2-object-property">params</span>: [],
                <span class="js2-object-property">success</span>: response,
                <span class="js2-object-property">request</span>: jrpc_request,
                <span class="js2-object-property">response</span>: jrpc_response,
                <span class="function-name">error</span>: <span class="keyword">function</span> <span class="function-name">error</span>() {
                    <span class="js2-function-call"><span class="jcXcovered">success</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">);</span>
                }
            });
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">make_interpreter</span>(<span class="js2-function-param">user_intrp</span>, <span class="js2-function-param">login</span>, <span class="js2-function-param">finalize</span>) {
            <span class="jcXcovered">finalize = finalize || $.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span><span class="jcXcovered">;</span>
            <span class="keyword">var</span> <span class="variable-name">type</span> = <span class="js2-function-call"><span class="jcXcovered">get_type</span></span><span class="jcXcovered">(user_intrp)</span>;
            <span class="keyword">var</span> <span class="variable-name">object</span>;
            <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">{}</span>;
            <span class="keyword">var</span> <span class="variable-name">rpc_count</span> = <span class="jcXcovered">0</span>; <span class="comment">// only one rpc can be use for array
</span>            <span class="keyword">var</span> <span class="variable-name">fn_interpreter</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (type === <span class="string">'array'</span>) {
                <span class="jcXcovered">object = {};</span>
                <span class="comment">// recur will be called when previous acync call is finished
</span>                <span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">fu</span></span><span class="keyword">nction</span> <span class="function-name">recur</span>(<span class="js2-function-param">interpreters</span>, <span class="js2-function-param">success</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (interpreters.<span class="js2-object-property">length</span>) {
                        <span class="keyword">var</span> <span class="variable-name">first</span> = <span class="jcXcovered">interpreters[0]</span>;
                        <span class="keyword">var</span> <span class="variable-name">rest</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(1)</span>;
                        <span class="keyword">var</span> <span class="variable-name">type</span> = <span class="js2-function-call"><span class="jcXcovered">get_type</span></span><span class="jcXcovered">(first)</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (type === <span class="string">'string'</span>) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">describe</span> === <span class="constant">false</span>) {
                                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (++rpc_count === 1) {
                                    <span class="jcXnot-covered">fn_interpreter = </span><span class="js2-function-call"><span class="jcXnot-covered">make_basic_json_rpc</span></span><span class="jcXnot-covered">(first, login);</span>
                                } <span class="keyword">else</span> {
                                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">oneRPCWithIgnore</span></span><span class="jcXnot-covered">);</span>
                                }
                                <span class="js2-function-call"><span class="jcXnot-covered">recur</span></span><span class="jcXnot-covered">(rest, success);</span>
                            } <span class="keyword">else</span> {
                                <span class="js2-function-call"><span class="jcXcovered">mak</span></span><span class="js2-function-call">e_json_rpc_object</span>(first, login, <span class="keyword">function</span>(<span class="js2-function-param">new_obj</span>) {
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (new_obj) {
                                        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span><span class="jcXcovered">(object, new_obj);</span>
                                    }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (++rpc_count === 1) {
                                        <span class="jcXnot-covered">fn</span>_interpreter = <span class="js2-function-call">make_basic_json_rpc</span>(
                                            first,
                                            login
                                        );
                                    } <span class="keyword">else</span> {
                                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">oneRPCWithIgnore</span></span><span class="jcXnot-covered">);</span>
                                    }
                                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                                    <span class="js2-function-call"><span class="jcXcovered">recur</span></span><span class="jcXcovered">(rest, success);</span>
                                });
                            }
                        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (type === <span class="string">'function'</span>) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (fn_interpreter) {
                                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">oneInterpreterFunction</span></span><span class="jcXnot-covered">);</span>
                            } <span class="keyword">else</span> {
                                <span class="jcXcovered">fn_interpreter = first;</span>
                            }
                            <span class="js2-function-call"><span class="jcXcovered">recur</span></span><span class="jcXcovered">(rest, success);</span>
                        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (type === <span class="string">'object'</span>) {
                            <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span><span class="jcXcovered">(object, first);</span>
                            <span class="js2-function-call"><span class="jcXcovered">recur</span></span><span class="jcXcovered">(rest, success);</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="js2-function-call"><span class="jcXcovered">success</span></span><span class="jcXcovered">();</span>
                    }
                })(user_intrp, <span class="keyword">function</span>() {
                    <span class="js2-function-call"><span class="jcXcovered">fin</span></span><span class="js2-function-call">alize</span>({
                        <span class="js2-object-property">interpreter</span>: <span class="js2-function-call">make_object_interpreter</span>(
                            object,
                            <span class="constant">false</span>,
                            login,
                            fn_interpreter.<span class="js2-function-call">bind</span>(self)
                        ),
                        <span class="js2-object-property">completion</span>: Object.<span class="js2-function-call">keys</span>(object)
                    });
                });
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (type === <span class="string">'string'</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">describe</span> === <span class="constant">false</span>) {
                    <span class="jcXcovered">ob</span>ject = {
                        <span class="js2-object-property">interpreter</span>: <span class="js2-function-call">make_basic_json_rpc</span>(user_intrp, login)
                    };
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">isArray</span>(settings.<span class="js2-object-property">completion</span>)) {
                        <span class="jcXnot-covered">object.</span><span class="js2-object-property"><span class="jcXnot-covered">completion</span></span><span class="jcXnot-covered"> = settings.</span><span class="js2-object-property"><span class="jcXnot-covered">completion</span></span><span class="jcXnot-covered">;</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">finalize</span></span><span class="jcXcovered">(object);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                    <span class="js2-function-call"><span class="jcXcovered">mak</span></span><span class="js2-function-call">e_json_rpc_object</span>(user_intrp, login, <span class="keyword">function</span>(<span class="js2-function-param">object</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (object) {
                            <span class="jcXcovered">re</span>sult.<span class="js2-object-property">interpreter</span> = <span class="js2-function-call">make_object_interpreter</span>(
                                object,
                                <span class="constant">false</span>,
                                login
                            );
                            <span class="jcXcovered">result.</span><span class="js2-object-property"><span class="jcXcovered">completion</span></span><span class="jcXcovered"> = Object.</span><span class="js2-function-call"><span class="jcXcovered">keys</span></span><span class="jcXcovered">(object);</span>
                        } <span class="keyword">else</span> {
                            <span class="comment">// no procs in system.describe
</span>                            <span class="jcXcovered">result.</span><span class="js2-object-property"><span class="jcXcovered">interpreter</span></span><span class="jcXcovered"> = </span><span class="js2-function-call"><span class="jcXcovered">make_basic_json_rpc</span></span><span class="jcXcovered">(user_intrp, login);</span>
                        }
                        <span class="js2-function-call"><span class="jcXcovered">finalize</span></span><span class="jcXcovered">(result);</span>
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                    });
                }
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (type === <span class="string">'object'</span>) {
                <span class="js2-function-call"><span class="jcXcovered">fin</span></span><span class="js2-function-call">alize</span>({
                    <span class="js2-object-property">interpreter</span>: <span class="js2-function-call">make_object_interpreter</span>(
                        user_intrp,
                        settings.<span class="js2-object-property">checkArity</span>,
                        login
                    ),
                    <span class="js2-object-property">completion</span>: Object.<span class="js2-function-call">keys</span>(user_intrp)
                });
            } <span class="keyword">else</span> {
                <span class="comment">// allow $('&lt;div/&gt;').terminal();
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (type === <span class="string">'undefined'</span>) {
                    <span class="jcXcovered">user_intrp = $.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span><span class="jcXcovered">;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (type !== <span class="string">'function'</span>) {
                    <span class="keyword">var</span> <span class="variable-name">msg</span> = <span class="jcXnot-covered">type + </span><span class="string"><span class="jcXnot-covered">' is invalid interpreter value'</span></span>;
                    <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> $.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">Exception</span></span><span class="jcXnot-covered">(msg);</span>
                }
                <span class="comment">// single function don't need bind
</span>                <span class="js2-function-call"><span class="jcXcovered">fin</span></span><span class="js2-function-call">alize</span>({
                    <span class="js2-object-property">interpreter</span>: user_intrp,
                    <span class="js2-object-property">completion</span>: settings.<span class="js2-object-property">completion</span>
                });
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Create JSON-RPC authentication function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">make_json_rpc_login</span>(<span class="js2-function-param">url</span>, <span class="js2-function-param">login</span>) {
            <span class="keyword">var</span> <span class="variable-name">method</span> = <span class="js2-function-call"><span class="jcXcovered">get_type</span></span><span class="jcXcovered">(login) === </span><span class="string"><span class="jcXcovered">'boolean'</span></span><span class="jcXcovered"> ? </span><span class="string"><span class="jcXcovered">'login'</span></span><span class="jcXcovered"> : login</span>;
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">user</span>, <span class="js2-function-param">passwd</span>, <span class="js2-function-param">callback</span>) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">j</span></span><span class="js2-function-call">rpc</span>({
                    <span class="js2-object-property">url</span>: url,
                    <span class="js2-object-property">method</span>: method,
                    <span class="js2-object-property">params</span>: [user, passwd],
                    <span class="function-name">request</span>: <span class="keyword">function</span>(<span class="js2-function-param">jxhr</span>, <span class="js2-function-param">request</span>) {
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">request</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, jxhr, request, self);</span>
                        } <span class="keyword">catch</span> (e) {
                            <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'USER'</span></span><span class="jcXnot-covered">);</span>
                        }
                    },
                    <span class="function-name">response</span>: <span class="keyword">function</span>(<span class="js2-function-param">jxhr</span>, <span class="js2-function-param">response</span>) {
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">response</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, jxhr, response, self);</span>
                        } <span class="keyword">catch</span> (e) {
                            <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'USER'</span></span><span class="jcXnot-covered">);</span>
                        }
                    },
                    <span class="function-name">success</span>: <span class="keyword">function</span> <span class="function-name">success</span>(<span class="js2-function-param">response</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>response.<span class="js2-object-property">error</span> &amp;&amp; response.<span class="js2-object-property">result</span>) {
                            <span class="js2-function-call"><span class="jcXcovered">callback</span></span><span class="jcXcovered">(response.</span><span class="js2-object-property"><span class="jcXcovered">result</span></span><span class="jcXcovered">);</span>
                        } <span class="keyword">else</span> {
                            <span class="comment">// null will trigger message that login fail
</span>                            <span class="js2-function-call"><span class="jcXcovered">callback</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                    },
                    <span class="js2-object-property">error</span>: ajax_error
                });
            };
            <span class="comment">// default name is login so you can pass true
</span>        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: display Exception on terminal
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">display_exception</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">label</span>, <span class="js2-function-param">silent</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">exceptionHandler</span>)) {
                <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">exceptionHandler</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, e, label);</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">exception</span></span><span class="jcXcovered">(e, label);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent) {
                    <span class="js2-function-call"><span class="jcXnot-covered">setTim</span></span><span class="js2-function-call">eout</span>(<span class="keyword">function</span>() {
                        <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> e;</span>
                    }, 0);
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Draw line - can have line breaks and be longer than the width of
</span>        <span class="comment">// :: the terminal, there are 2 options raw and finalize
</span>        <span class="comment">// :: raw - will not encode the string and finalize if a function that
</span>        <span class="comment">// :: will have div container of the line as first argument
</span>        <span class="comment">// :: NOTE: it formats and appends lines to output_buffer. The actual
</span>        <span class="comment">// :: append to terminal output happens in the flush function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">push_line</span>(<span class="js2-function-param">string</span>) {
            <span class="jcXcovered">output_buffer.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">({</span><span class="js2-object-property"><span class="jcXcovered">line</span></span><span class="jcXcovered">: string});</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">var</span> <span class="variable-name">output_buffer</span> = <span class="jcXcovered">[]</span>;
        <span class="keyword">var</span> <span class="variable-name">NEW_LINE</span> = <span class="jcXcovered">1</span>;
        <span class="keyword">function</span> <span class="function-name">buffer_line</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">index</span>, <span class="js2-function-param">options</span>) {
            <span class="comment">// urls should always have formatting to keep url if split
</span>            <span class="keyword">var</span> <span class="variable-name">i</span>, <span class="variable-name">len</span>;
            <span class="jcXcovered">output_buffer.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(NEW_LINE);</span>
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>options.<span class="js2-object-property">raw</span>) {
                <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">format_options</span></span><span class="jcXcovered"> = </span>{
                    <span class="js2-object-property">linksNoReferrer</span>: settings.<span class="js2-object-property">linksNoReferrer</span>,
                    <span class="js2-object-property">linksNoFollow</span>: settings.<span class="js2-object-property">linksNoFollow</span>,
                    <span class="js2-object-property">anyLinks</span>: settings.<span class="js2-object-property">anyLinks</span>,
                    <span class="js2-object-property">char_width</span>: char_size.<span class="js2-object-property">width</span>,
                    <span class="js2-object-property">escape</span>: <span class="constant">false</span>,
                    <span class="js2-object-property">allowedAttributes</span>: options.<span class="js2-object-property">allowedAttributes</span> || []
                };
                <span class="jcXcovered">string = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">normalize</span></span><span class="jcXcovered">(string);</span>
                <span class="keyword">var</span> <span class="variable-name">cols</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">cols</span></span><span class="jcXcovered">()</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ((<span class="js2-function-call">strlen</span>(<span class="js2-function-call">text</span>(string)) &gt; cols ||
                     string.<span class="js2-function-call">match</span>(<span class="string">/\n/</span>)) &amp;&amp;
                    ((settings.<span class="js2-object-property">wrap</span> === <span class="constant">true</span> &amp;&amp; options.<span class="js2-object-property">wrap</span> === <span class="constant">undefined</span>) ||
                     settings.<span class="js2-object-property">wrap</span> === <span class="constant">false</span> &amp;&amp; options.<span class="js2-object-property">wrap</span> === <span class="constant">true</span>)) {
                    <span class="keyword">var</span> <span class="variable-name">words</span> = <span class="jcXcovered">options.</span><span class="js2-object-property"><span class="jcXcovered">keepWords</span></span>;
                    <span class="keyword">var</span> <span class="variable-name">array</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_equal</span></span><span class="jcXcovered">(string, cols, words)</span>;
                    <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (i = 0, len = array.<span class="js2-object-property">length</span>; i &lt; len; ++i) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (array[i] === <span class="string">''</span> || array[i] === <span class="string">'\r'</span>) {
                            <span class="jcXcovered">output_buffer.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">({</span><span class="js2-object-property"><span class="jcXcovered">line</span></span><span class="jcXcovered">: </span><span class="string"><span class="jcXcovered">'&lt;span&gt;&lt;/span&gt;'</span></span><span class="jcXcovered">});</span>
                        } <span class="keyword">else</span> {
                            <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">data</span></span><span class="jcXcovered"> = </span>{
                                <span class="js2-object-property">line</span>: $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">format</span>(
                                    array[i],
                                    format_options
                                )
                            };
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (i === len - 1) {
                                <span class="jcXcovered">data.</span><span class="js2-object-property"><span class="jcXcovered">newline</span></span><span class="jcXcovered"> = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                            }
                            <span class="jcXcovered">output_buffer.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(data);</span>
                        }
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">string = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(string, format_options);</span>
                    <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\n/</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">forEach</span></span><span class="jcXcovered">(push_line);</span>
                }
            } <span class="keyword">else</span> {
                <span class="js2-function-call"><span class="jcXcovered">push_line</span></span><span class="jcXcovered">(string);</span>
            }
            <span class="jcXcovered">out</span>put_buffer.<span class="js2-function-call">push</span>({
                <span class="js2-object-property">finalize</span>: options.<span class="js2-object-property">finalize</span>,
                <span class="js2-object-property">index</span>: index
            });
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">links</span>(<span class="js2-function-param">string</span>) {
            <span class="keyword">function</span> <span class="function-name">format</span>(<span class="js2-function-param">_</span>, <span class="js2-function-param">style</span>, <span class="js2-function-param">color</span>, <span class="js2-function-param">background</span>, <span class="js2-function-param">_class</span>, <span class="js2-function-param">data</span>, <span class="js2-function-param">text</span>) {
                <span class="keyword">function</span> <span class="function-name">formatting</span>(<span class="js2-function-param">s</span>, <span class="js2-function-param">text</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">'[['</span></span><span class="jcXnot-covered"> + [
  </span>                      style + (s || <span class="string">''</span>),
                        color,
                        background,
                        _class,
                        data || text
                    ].<span class="js2-function-call">join</span>(<span class="string">';'</span>) + <span class="string">']'</span>;
                }
                <span class="keyword">function</span> <span class="function-name">escaped</span>(<span class="js2-function-param">_</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="string"><span class="jcXnot-covered">']'</span></span><span class="jcXnot-covered"> + </span><span class="js2-function-call"><span class="jcXnot-covered">formatting</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'!'</span></span><span class="jcXnot-covered">, _) + _ + </span><span class="string"><span class="jcXnot-covered">']'</span></span><span class="jcXnot-covered"> + </span><span class="js2-function-call"><span class="jcXnot-covered">formatting</span></span><span class="jcXnot-covered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>style.<span class="js2-function-call">match</span>(<span class="string">/!/</span>)) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (text.<span class="js2-function-call">match</span>(email_full_re) || text.<span class="js2-function-call">match</span>(url_full_re)) {
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">formatting</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'!'</span></span><span class="jcXnot-covered">, text) + text + </span><span class="string"><span class="jcXnot-covered">']'</span></span><span class="jcXnot-covered">;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (text.<span class="js2-function-call">match</span>(email_re) || text.<span class="js2-function-call">match</span>(url_nf_re)) {
                        <span class="keyword">var</span> <span class="variable-name">output</span> = <span class="jcXnot-covered">text.</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(email_</span>re, escaped)
                            .<span class="js2-function-call">replace</span>(url_nf_re, escaped);
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">formatting</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">, data) + output + </span><span class="string"><span class="jcXnot-covered">']'</span></span><span class="jcXnot-covered">;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> _;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>(string.<span class="js2-function-call">match</span>(email_re) || string.<span class="js2-function-call">match</span>(url_nf_re))) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>$.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">have_formatting</span>(string)) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(email_re, </span><span class="string"><span class="jcXcovered">'[[!</span></span><span class="string">;;]$1]'</span>).
                    <span class="js2-function-call">replace</span>(url_nf_re, <span class="string">'[[!;;]$1]'</span>);
            }
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">ter</span></span><span class="js2-object-property">minal</span>.<span class="js2-function-call">format_split</span>(string).<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">str</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">is_formatting</span>(str)) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> str.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(format_parts_re, format);</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> str.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(email_re, </span><span class="string"><span class="jcXcovered">'[[!;;]</span></span><span class="string">$1]'</span>).
                        <span class="js2-function-call">replace</span>(url_nf_re, <span class="string">'[[!;;]$1]'</span>);
                }
            }).<span class="js2-function-call">join</span>(<span class="string">''</span>);
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">process_line</span>(<span class="js2-function-param">line</span>) {
            <span class="comment">// prevent exception in display exception
</span>            <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                <span class="keyword">var</span> <span class="variable-name">line_settings</span> = <span class="jcXcovered">$.</span><span class="js2-function-call">extend</span>({
                    <span class="js2-object-property">exec</span>: <span class="constant">true</span>,
                    <span class="js2-object-property">raw</span>: <span class="constant">false</span>,
                    <span class="js2-object-property">finalize</span>: $.<span class="js2-object-property">noop</span>,
                    <span class="js2-object-property">invokeMethods</span>: <span class="constant">false</span>,
                    <span class="js2-object-property">convertLinks</span>: settings.<span class="js2-object-property">convertLinks</span>
                }, line.<span class="js2-object-property">options</span> || {});
                <span class="keyword">var</span> <span class="variable-name">string</span>;
                <span class="keyword">var</span> <span class="variable-name">arg</span> = <span class="jcXcovered">line.</span><span class="js2-object-property"><span class="jcXcovered">string</span></span>;
                <span class="keyword">var</span> <span class="variable-name">is_fn</span> = <span class="js2-function-call"><span class="jcXcovered">is_function</span></span><span class="jcXcovered">(arg)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (is_fn) {
                    <span class="jcXcovered">arg = </span><span class="js2-function-call"><span class="jcXcovered">arg</span></span><span class="jcXcovered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">get_type</span>(arg) !== <span class="string">'string'</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">parseObject</span>)) {
                        <span class="keyword">var</span> <span class="variable-name">ret</span> = <span class="jcXnot-covered">settings.</span><span class="js2-function-call"><span class="jcXnot-covered">parseObject</span></span><span class="jcXnot-covered">(arg)</span>;
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">get_type</span>(ret) === <span class="string">'string'</span>) {
                            <span class="jcXnot-covered">string = ret;</span>
                        }
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_array</span>(arg)) {
                        <span class="jcXnot-covered">string = $.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">columns</span></span><span class="jcXnot-covered">(arg, self.</span><span class="js2-function-call"><span class="jcXnot-covered">cols</span></span><span class="jcXnot-covered">(), settings.</span><span class="js2-object-property"><span class="jcXnot-covered">tabs</span></span><span class="jcXnot-covered">);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">string = </span><span class="js2-function-call"><span class="jcXcovered">String</span></span><span class="jcXcovered">(arg);</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">string = arg;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string !== <span class="string">''</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>line_settings.<span class="js2-object-property">raw</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (line_settings.<span class="js2-object-property">formatters</span>) {
                            <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                                <span class="jcXcovered">st</span>ring = $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">apply_formatters</span>(
                                    string,
                                    settings
                                );
                            } <span class="keyword">catch</span> (e) {
                                <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'FORMATTING'</span></span><span class="jcXnot-covered">);</span>
                            }
                        }
                        <span class="keyword">var</span> <span class="variable-name">parts</span> = <span class="jcXcovered">string.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(format_exec_re)</span>;
                        <span class="jcXcovered">string = $.</span><span class="js2-function-call"><span class="jcXcovered">m</span></span><span class="js2-function-call">ap</span>(parts, <span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string &amp;&amp; string.<span class="js2-function-call">match</span>(format_exec_re) &amp;&amp;
                                <span class="negation-char">!</span>$.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">is_formatting</span>(string)) {
                                <span class="comment">// redraw should not execute commands and it have
</span>                                <span class="comment">// and lines variable have all extended commands
</span>                                <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^\[\[|\]\]$/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (line_settings.<span class="js2-object-property">exec</span>) {
                                    <span class="keyword">var</span> <span class="variable-name">prev_cmd</span>;
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (prev_command) {
                                        <span class="jcXnot-covered">prev_command = prev_command.</span><span class="js2-object-property"><span class="jcXnot-covered">command</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">trim</span></span><span class="jcXnot-covered">();</span>
                                    }
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (prev_cmd === string.<span class="js2-function-call">trim</span>()) {
                                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">recursiveCall</span></span><span class="jcXnot-covered">);</span>
                                    } <span class="keyword">else</span> {
                                        <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">t</span></span><span class="js2-object-property">erminal</span>.<span class="js2-function-call">extended_command</span>(self, string, {
                                            <span class="js2-object-property">invokeMethods</span>: line_settings.<span class="js2-object-property">invokeMethods</span>
                                        });
                                    }
                                }
                                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                            } <span class="keyword">else</span> {
                                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
                            }
                        }).<span class="js2-function-call">join</span>(<span class="string">''</span>);
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string === <span class="string">''</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (line_settings.<span class="js2-object-property">convertLinks</span>) {
                            <span class="jcXcovered">string = </span><span class="js2-function-call"><span class="jcXcovered">links</span></span><span class="jcXcovered">(string);</span>
                        }
                        <span class="jcXcovered">string = </span><span class="js2-function-call"><span class="jcXcovered">crlf</span></span><span class="jcXcovered">($.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">normalize</span></span><span class="jcXcovered">(string));</span>
                        <span class="jcXcovered">str</span>ing = $.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">encode</span>(string, {
                            <span class="js2-object-property">tabs</span>: settings.<span class="js2-object-property">tabs</span>
                        });
                    }
                }
                <span class="js2-function-call"><span class="jcXcovered">buffer_line</span></span><span class="jcXcovered">(string, line.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">, line_settings);</span>
            } <span class="keyword">catch</span> (e) {
                <span class="jcXnot-covered">output_buffer = [];</span>
                <span class="comment">// don't display exception if exception throw in terminal
</span>                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">exceptionHandler</span>)) {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">exceptionHandler</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, e, </span><span class="string"><span class="jcXnot-covered">'TERMINAL'</span></span><span class="jcXnot-covered">);</span>
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXnot-covered">alert_exception</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'[Internal Exception(process_line)]'</span></span><span class="jcXnot-covered">, e);</span>
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Update terminal lines
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">redraw</span>(<span class="js2-function-param">options</span>) {
            <span class="jcXcovered">options = $.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span>({}, {
                <span class="comment">// should be used when single line is updated
</span>                <span class="js2-object-property">update</span>: <span class="constant">false</span>,
                <span class="comment">// should be used if you want to scroll to bottom after redraw
</span>                <span class="js2-object-property">scroll</span>: <span class="constant">true</span>
            }, options || {});
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>options.<span class="js2-object-property">update</span>) {
                <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">resize</span></span><span class="jcXcovered">(num_chars);</span>
                <span class="comment">// we don't want reflow while processing lines
</span>                <span class="keyword">var</span> <span class="variable-name">detached_output</span> = <span class="jcXcovered">output.</span><span class="js2-function-call"><span class="jcXcovered">empty</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">detach</span></span><span class="jcXcovered">()</span>;
            }
            <span class="keyword">var</span> <span class="variable-name">lines_to_show</span> = <span class="jcXcovered">[]</span>;
            <span class="comment">// Dead code
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">outputLimit</span> &gt;= 0) {
                <span class="comment">// flush will limit lines but if there is lot of
</span>                <span class="comment">// lines we don't need to show them and then remove
</span>                <span class="comment">// them from terminal
</span>                <span class="keyword">var</span> <span class="variable-name">limit</span>;
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">outputLimit</span> === 0) {
                    <span class="jcXnot-covered">limit = self.</span><span class="js2-function-call"><span class="jcXnot-covered">rows</span></span><span class="jcXnot-covered">();</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">limit = settings.</span><span class="js2-object-property"><span class="jcXnot-covered">outputLimit</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="jcXnot-covered">lin</span>es.<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">line</span>, <span class="js2-function-param">index</span>) {
                    <span class="keyword">var</span> <span class="variable-name">string</span> = <span class="jcXnot-covered">line[0]</span>;
                    <span class="keyword">var</span> <span class="variable-name">options</span> = <span class="jcXnot-covered">line[1]</span>;
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">get_type</span>(string) === <span class="string">'function'</span>) {
                        <span class="jcXnot-covered">string = </span><span class="js2-function-call"><span class="jcXnot-covered">string</span></span><span class="jcXnot-covered">();</span>
                    }
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">get_type</span>(string) !== <span class="string">'string'</span>) {
                        <span class="jcXnot-covered">string = </span><span class="js2-function-call"><span class="jcXnot-covered">String</span></span><span class="jcXnot-covered">(string);</span>
                    }
                    <span class="jcXnot-covered">lin</span>es_to_show.<span class="js2-function-call">push</span>({
                        <span class="js2-object-property">string</span>: string,
                        <span class="js2-object-property">index</span>: index,
                        <span class="js2-object-property">options</span>: options
                    });
                });
                <span class="jcXnot-covered">lines_to_show = lines_to_show.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(lines_to_show.</span><span class="js2-object-property"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered"> - limit - 1);</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">lin</span>es_to_show = lines.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">line</span>, <span class="js2-function-param">index</span>) {
                    <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> {
                        <span class="js2-object-property">string</span>: line[0],
                        <span class="js2-object-property">index</span>: index,
                        <span class="js2-object-property">options</span>: line[1]
                    };
                });
            }
            <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                <span class="jcXcovered">output_buffer = [];</span>
                <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">ach</span>(lines_to_show, <span class="keyword">function</span>(<span class="js2-function-param">i</span>, <span class="js2-function-param">line</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">process_line</span></span><span class="jcXcovered">(line);</span>
                });
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>options.<span class="js2-object-property">update</span>) {
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">before</span></span><span class="jcXcovered">(detached_output);</span> <span class="comment">// reinsert output
</span>                }
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">flush</span></span><span class="jcXcovered">(options);</span>
                <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onAfterRedraw'</span></span><span class="jcXcovered">);</span>
            } <span class="keyword">catch</span> (e) {
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">exceptionHandler</span>)) {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">exceptionHandler</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, e, </span><span class="string"><span class="jcXnot-covered">'TERMINAL (redraw)'</span></span><span class="jcXnot-covered">);</span>
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXnot-covered">alert_exception</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'[redraw]'</span></span><span class="jcXnot-covered">, e);</span>
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Function limit output lines based on outputLimit option
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">limit_lines</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">outputLimit</span> &gt;= 0) {
                <span class="keyword">var</span> <span class="variable-name">limit</span>;
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">outputLimit</span> === 0) {
                    <span class="jcXnot-covered">limit = self.</span><span class="js2-function-call"><span class="jcXnot-covered">rows</span></span><span class="jcXnot-covered">();</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">limit = settings.</span><span class="js2-object-property"><span class="jcXnot-covered">outputLimit</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">$lines</span> = <span class="jcXnot-covered">output.</span><span class="js2-function-call"><span class="jcXnot-covered">find</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'&gt; div &gt; div'</span></span><span class="jcXnot-covered">)</span>;
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> ($lines.<span class="js2-object-property">length</span> + 1 &gt; limit) {
                    <span class="keyword">var</span> <span class="variable-name">max</span> = <span class="jcXnot-covered">$lines.</span><span class="js2-object-property"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered"> - limit + 1</span>;
                    <span class="keyword">var</span> <span class="variable-name">for_remove</span> = <span class="jcXnot-covered">$lines.</span><span class="js2-function-call"><span class="jcXnot-covered">slice</span></span><span class="jcXnot-covered">(0, max)</span>;
                    <span class="comment">// you can't get parent if you remove the
</span>                    <span class="comment">// element so we first get the parent
</span>                    <span class="keyword">var</span> <span class="variable-name">parents</span> = <span class="jcXnot-covered">for_remove.</span><span class="js2-function-call"><span class="jcXnot-covered">parent</span></span><span class="jcXnot-covered">()</span>;
                    <span class="jcXnot-covered">for_remove.</span><span class="js2-function-call"><span class="jcXnot-covered">remove</span></span><span class="jcXnot-covered">();</span>
                    <span class="jcXnot-covered">par</span>ents.<span class="js2-function-call">each</span>(<span class="keyword">function</span>() {
                        <span class="keyword">var</span> <span class="variable-name">$self</span> = <span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(</span><span class="builtin"><span class="jcXnot-covered">this</span></span><span class="jcXnot-covered">)</span>;
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> ($self.<span class="js2-function-call">is</span>(<span class="string">':empty'</span>)) {
                            <span class="comment">// there can be divs inside parent that
</span>                            <span class="comment">// was not removed
</span>                            <span class="jcXnot-covered">$self.</span><span class="js2-function-call"><span class="jcXnot-covered">remove</span></span><span class="jcXnot-covered">();</span>
                        }
                    });
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Display user greetings or terminal signature
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">show_greetings</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">greetings</span> === <span class="constant">undefined</span>) {
                <span class="comment">// signature have ascii art so it's not suite for screen readers
</span>                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(self.</span><span class="js2-object-property"><span class="jcXcovered">signature</span></span><span class="jcXcovered">, {</span><span class="js2-object-property"><span class="jcXcovered">finalize</span></span><span class="jcXcovered">: a11y_hide, </span><span class="js2-object-property"><span class="jcXcovered">formatters</span></span><span class="jcXcovered">: </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">});</span>
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (settings.<span class="js2-object-property">greetings</span>) {
                <span class="keyword">var</span> <span class="variable-name">type</span> = <span class="keyword"><span class="jcXcovered">typeof</span></span><span class="jcXcovered"> settings.</span><span class="js2-object-property"><span class="jcXcovered">greetings</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (type === <span class="string">'string'</span>) {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">greetings</span></span><span class="jcXcovered">);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (type === <span class="string">'function'</span>) {
                    <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                        <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">greetings</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, self.</span><span class="js2-object-property"><span class="jcXcovered">echo</span></span><span class="jcXcovered">);</span>
                    } <span class="keyword">catch</span> (e) {
                        <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">greetings</span></span><span class="jcXnot-covered"> = </span><span class="constant"><span class="jcXnot-covered">null</span></span><span class="jcXnot-covered">;</span>
                        <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'greetings'</span></span><span class="jcXnot-covered">);</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">wrongGreetings</span></span><span class="jcXnot-covered">);</span>
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Display prompt and last command
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">echo_command</span>(<span class="js2-function-param">command</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> command === <span class="string">'undefined'</span>) {
                <span class="jcXcovered">command = self.</span><span class="js2-function-call"><span class="jcXcovered">get_command</span></span><span class="jcXcovered">();</span>
            }
            <span class="comment">// true will return last rendered string
</span>            <span class="keyword">var</span> <span class="variable-name">prompt</span> = <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">prompt</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">)</span>;
            <span class="keyword">var</span> <span class="variable-name">mask</span> = <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">mask</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">s</span></span><span class="keyword">witch</span> (<span class="keyword">typeof</span> mask) {
                <span class="keyword">case</span> <span class="string">'string'</span>:
                    <span class="jcXcovered">command = command.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/./g</span></span><span class="jcXcovered">, mask);</span>
                    <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                <span class="keyword">case</span> <span class="string">'boolean'</span>:
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (mask) {
                        <span class="jcXnot-covered">command = command.</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/./g</span></span><span class="jcXnot-covered">, settings.</span><span class="js2-object-property"><span class="jcXnot-covered">maskChar</span></span><span class="jcXnot-covered">);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">command = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_formatting</span></span><span class="jcXcovered">(command);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
            }
            <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">options</span></span><span class="jcXcovered"> = </span>{
                <span class="js2-object-property">convertLinks</span>: <span class="constant">false</span>,
                <span class="function-name">finalize</span>: <span class="keyword">function</span> <span class="function-name">finalize</span>(<span class="js2-function-param">div</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">a11y_hide</span></span><span class="jcXcovered">(div.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'command'</span></span><span class="jcXcovered">));</span>
                    <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onEchoCommand'</span></span><span class="jcXcovered">, [div, command]);</span>
                }
            };
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(prompt + command, options);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">have_scrollbar</span>() {
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">is</span>(<span class="string">'body'</span>)) {
                <span class="comment">// source: https://stackoverflow.com/a/6639405/387194
</span>                <span class="comment">// from comment by &#352;ime Vidas
</span>                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> window.</span><span class="js2-object-property"><span class="jcXnot-covered">innerWidth</span></span><span class="jcXnot-covered"> - document.</span><span class="js2-object-property"><span class="jcXnot-covered">documentElement</span></span><span class="jcXnot-covered">.</span><span class="js2-object-property"><span class="jcXnot-covered">clientWidth</span></span><span class="jcXnot-covered"> &gt; 0;</span>
            }
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> fill.</span><span class="js2-function-call"><span class="jcXnot-covered">outerWidth</span></span><span class="jcXnot-covered">() !== self.</span><span class="js2-function-call"><span class="jcXnot-covered">outerWidth</span></span><span class="jcXnot-covered">();</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Helper function that restore state. Call import_view or exec
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">restore_state</span>(<span class="js2-function-param">spec</span>) {
            <span class="comment">// spec [terminal_id, state_index, command]
</span>            <span class="keyword">var</span> <span class="variable-name">terminal</span> = <span class="jcXnot-covered">terminals.</span><span class="js2-function-call"><span class="jcXnot-covered">get</span></span><span class="jcXnot-covered">()[spec[0]]</span>;
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>terminal) {
                <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> $.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">Exception</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">invalidTerminalId</span></span><span class="jcXnot-covered">);</span>
            }
            <span class="keyword">var</span> <span class="variable-name">command_idx</span> = <span class="jcXnot-covered">spec[1]</span>;
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (save_state[command_idx]) { <span class="comment">// state exists
</span>                <span class="jcXnot-covered">terminal.</span><span class="js2-function-call"><span class="jcXnot-covered">import_view</span></span><span class="jcXnot-covered">(save_state[command_idx]);</span>
            } <span class="keyword">else</span> {
                <span class="comment">// restore state
</span>                <span class="jcXnot-covered">change_hash = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                <span class="keyword">var</span> <span class="variable-name">command</span> = <span class="jcXnot-covered">spec[2]</span>;
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (command) {
                    <span class="jcXnot-covered">ter</span>minal.<span class="js2-function-call">exec</span>(command).<span class="js2-function-call">done</span>(<span class="keyword">function</span>() {
                        <span class="jcXnot-covered">change_hash = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                        <span class="jcXnot-covered">save_state[command_idx] = terminal.</span><span class="js2-function-call"><span class="jcXnot-covered">export_view</span></span><span class="jcXnot-covered">();</span>
                    });
                }
            }
            <span class="comment">/*if (spec[3].length) {
                restore_state(spec[3]);
            }*/</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Helper function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">maybe_update_hash</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (change_hash) {
                <span class="jcXcovered">fire_hash_change = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                <span class="jcXcovered">location.</span><span class="js2-object-property"><span class="jcXcovered">hash</span></span><span class="jcXcovered"> = </span><span class="string"><span class="jcXcovered">'#'</span></span><span class="jcXcovered"> + JSON.</span><span class="js2-function-call"><span class="jcXcovered">stringify</span></span><span class="jcXcovered">(hash_commands);</span>
                <span class="js2-function-call"><span class="jcXcovered">setTimeo</span></span><span class="js2-function-call">ut</span>(<span class="keyword">function</span>() {
                    <span class="jcXcovered">fire_hash_change = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                }, 100);
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Wrapper over interpreter, it implements exit and catches all
</span>        <span class="comment">// :: exeptions from user code and displays them on the terminal
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">var</span> <span class="variable-name">first_command</span> = <span class="constant"><span class="jcXcovered">true</span></span>;
        <span class="keyword">var</span> <span class="variable-name">resume_callbacks</span> = <span class="jcXcovered">[]</span>;
        <span class="keyword">function</span> <span class="function-name">commands</span>(<span class="js2-function-param">command</span>, <span class="js2-function-param">silent</span>, <span class="js2-function-param">exec</span>) {
            <span class="keyword">function</span> <span class="function-name">init_state</span>() {
                <span class="comment">// execHash need first empty command too
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">historyState</span> || settings.<span class="js2-object-property">execHash</span> &amp;&amp; exec) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>save_state.<span class="js2-object-property">length</span>) {
                        <span class="comment">// first command in first terminal don't have hash
</span>                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">save_state</span></span><span class="jcXnot-covered">();</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">save_state</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">);</span>
                    }
                }
            }
            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">after_exec</span>() {
                <span class="comment">// variables defined later in commands
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>exec) {
                    <span class="jcXcovered">change_hash = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">historyState</span>) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">save_state</span></span><span class="jcXcovered">(command, </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="jcXcovered">change_hash = saved_change_hash;</span>
                }
                <span class="jcXcovered">deferred.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">();</span>
                <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onAfterCommand'</span></span><span class="jcXcovered">, [command]);</span>
            }
            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">show</span>(<span class="js2-function-param">result</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> result !== <span class="string">'undefined'</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">display_object</span></span><span class="jcXcovered">(result);</span>
                }
                <span class="js2-function-call"><span class="jcXcovered">after_exec</span></span><span class="jcXcovered">();</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
            }
            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="keyword">function</span> <span class="function-name">invoke</span>() {
                <span class="comment">// Call user interpreter function
</span>                <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">interpreter.</span><span class="js2-object-property"><span class="jcXcovered">interpreter</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, command, self)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result) {
                    <span class="comment">// auto pause/resume when user return promises
</span>                    <span class="comment">// it should not pause when user return promise from read()
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>force_awake) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="jcXcovered">force_awake = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    <span class="comment">// when for native Promise object work only in jQuery 3.x
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(result.<span class="js2-object-property">done</span> || result.<span class="js2-object-property">then</span>)) {
                        <span class="jcXcovered">(result.</span><span class="js2-object-property"><span class="jcXcovered">done</span></span><span class="jcXcovered"> || result.</span><span class="js2-object-property"><span class="jcXcovered">then</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(result, show);</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> $.</span><span class="js2-function-call"><span class="jcXnot-covered">when</span></span><span class="jcXnot-covered">(result).</span><span class="js2-function-call"><span class="jcXnot-covered">done</span></span><span class="jcXnot-covered">(show);</span>
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (paused) {
                    <span class="jcXcovered">res</span>ume_callbacks.<span class="js2-function-call">push</span>(<span class="keyword">function</span>() {
                        <span class="comment">// exec with resume/pause in user code
</span>                        <span class="js2-function-call"><span class="jcXcovered">after_exec</span></span><span class="jcXcovered">();</span>
                    });
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXcovered">after_exec</span></span><span class="jcXcovered">();</span>
                }
            }
            <span class="comment">// -----------------------------------------------------------------
</span>            <span class="comment">// first command store state of the terminal before the command get
</span>            <span class="comment">// executed
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (first_command) {
                <span class="jcXcovered">first_command = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                <span class="js2-function-call"><span class="jcXcovered">init_state</span></span><span class="jcXcovered">();</span>
            }
            <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                <span class="comment">// this callback can disable commands
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">fire_event</span>(<span class="string">'onBeforeCommand'</span>, [command]) === <span class="constant">false</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>exec) {
                    <span class="jcXcovered">prev_command = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">split_command</span></span><span class="jcXcovered">(command);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span><span class="js2-function-call">ghost</span>()) {
                    <span class="comment">// exec execute this function wihout the help of cmd plugin
</span>                    <span class="comment">// that add command to history on enter
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (exec &amp;&amp; (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">historyFilter</span>) &amp;&amp;
                                 settings.<span class="js2-function-call">historyFilter</span>(command) ||
                                 command.<span class="js2-function-call">match</span>(settings.<span class="js2-object-property">historyFilter</span>))) {
                        <span class="jcXnot-covered">command_line.</span><span class="js2-function-call"><span class="jcXnot-covered">history</span></span><span class="jcXnot-covered">().</span><span class="js2-function-call"><span class="jcXnot-covered">append</span></span><span class="jcXnot-covered">(command);</span>
                    }
                }
                <span class="keyword">var</span> <span class="variable-name">interpreter</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent &amp;&amp; settings.<span class="js2-object-property">echoCommand</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">echo_command</span></span><span class="jcXcovered">(command);</span>
                }
                <span class="comment">// new promise will be returned to exec that will resolve his
</span>                <span class="comment">// returned promise
</span>                <span class="keyword">var</span> <span class="variable-name">deferred</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">Deferred</span></span><span class="jcXcovered">()</span>;
                <span class="comment">// we need to save sate before commands is deleyd because
</span>                <span class="comment">// execute_extended_command disable it and it can be executed
</span>                <span class="comment">// after delay
</span>                <span class="keyword">var</span> <span class="variable-name">saved_change_hash</span> = <span class="jcXcovered">change_hash</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command.<span class="js2-function-call">match</span>(<span class="string">/^\s*login\s*$/</span>) &amp;&amp; self.<span class="js2-function-call">token</span>(<span class="constant">true</span>)) {
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">level</span>() &gt; 1) {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">logout</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">logout</span></span><span class="jcXnot-covered">();</span>
                    }
                    <span class="js2-function-call"><span class="jcXnot-covered">after_exec</span></span><span class="jcXnot-covered">();</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (settings.<span class="js2-object-property">exit</span> &amp;&amp; command.<span class="js2-function-call">match</span>(<span class="string">/^\s*exit\s*$/</span>) &amp;&amp;
                           <span class="negation-char">!</span>in_login) {
                    <span class="keyword">var</span> <span class="variable-name">level</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">level</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (level === 1 &amp;&amp; self.<span class="js2-function-call">get_token</span>() || level &gt; 1) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">get_token</span>(<span class="constant">true</span>)) {
                            <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">set_token</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">undefined</span></span><span class="jcXnot-covered">, </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">);</span>
                        }
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">after_exec</span></span><span class="jcXcovered">();</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (settings.<span class="js2-object-property">clear</span> &amp;&amp; command.<span class="js2-function-call">match</span>(<span class="string">/^\s*clear\s*$/</span>) &amp;&amp;
                           <span class="negation-char">!</span>in_login) {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">clear</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">after_exec</span></span><span class="jcXcovered">();</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">ret</span> = <span class="js2-function-call"><span class="jcXcovered">invoke</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ret) {
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> ret;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> deferred.</span><span class="js2-function-call"><span class="jcXcovered">promise</span></span><span class="jcXcovered">();</span>
            } <span class="keyword">catch</span> (e) {
                <span class="js2-function-call"><span class="jcXcovered">display_exception</span></span><span class="jcXcovered">(e, </span><span class="string"><span class="jcXcovered">'USER'</span></span><span class="jcXcovered">, exec);</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (exec) {
                    <span class="keyword"><span class="jcXcovered">throw</span></span><span class="jcXcovered"> e;</span>
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: The logout function removes Storage, disables history and runs
</span>        <span class="comment">// :: the login function. This function is called only when options.login
</span>        <span class="comment">// :: function is defined. The check for this is in the self.pop method
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">global_logout</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onBeforeLogout</span>)) {
                <span class="keyword"><span class="jcXnot-covered">t</span></span><span class="keyword">ry</span> {
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">onBeforeLogout</span>.<span class="js2-function-call">call</span>(self, self) === <span class="constant">false</span>) {
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                    }
                } <span class="keyword">catch</span> (e) {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">onBeforeLogout</span></span><span class="jcXnot-covered"> = $.</span><span class="js2-object-property"><span class="jcXnot-covered">noop</span></span><span class="jcXnot-covered">;</span>
                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'onBeforeLogout'</span></span><span class="jcXnot-covered">);</span>
                }
            }
            <span class="js2-function-call"><span class="jcXcovered">clear_loging_storage</span></span><span class="jcXcovered">();</span>
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onAfterLogout</span>)) {
                <span class="keyword"><span class="jcXnot-covered">t</span></span><span class="keyword">ry</span> {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">onAfterLogout</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, self);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">onAfterLogout</span></span><span class="jcXnot-covered"> = $.</span><span class="js2-object-property"><span class="jcXnot-covered">noop</span></span><span class="jcXnot-covered">;</span>
                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'onAfterlogout'</span></span><span class="jcXnot-covered">);</span>
                }
            }
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">login</span></span><span class="jcXcovered">(global_login_fn, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">, initialize);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">clear_loging_storage</span>() {
            <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">prefix_name</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">) + </span><span class="string"><span class="jcXcovered">'_'</span></span>;
            <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(name + </span><span class="string"><span class="jcXcovered">'token'</span></span><span class="jcXcovered">);</span>
            <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(name + </span><span class="string"><span class="jcXcovered">'login'</span></span><span class="jcXcovered">);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Save the interpreter name for use with purge
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">maybe_append_name</span>(<span class="js2-function-param">interpreter_name</span>) {
            <span class="keyword">var</span> <span class="variable-name">storage_key</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">prefix_name</span></span><span class="jcXcovered">() + </span><span class="string"><span class="jcXcovered">'_interpreters'</span></span>;
            <span class="keyword">var</span> <span class="variable-name">names</span> = <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">(storage_key)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (names) {
                <span class="jcXcovered">names = JSON.</span><span class="js2-function-call"><span class="jcXcovered">parse</span></span><span class="jcXcovered">(names);</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">names = [];</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">inArray</span>(interpreter_name, names) === -1) {
                <span class="jcXcovered">names.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(interpreter_name);</span>
                <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(storage_key, JSON.</span><span class="js2-function-call"><span class="jcXcovered">stringify</span></span><span class="jcXcovered">(names));</span>
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Function enables history, sets prompt, runs interpreter function
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">prepare_top_interpreter</span>(<span class="js2-function-param">silent</span>) {
            <span class="keyword">var</span> <span class="variable-name">interpreter</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()</span>;
            <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">prefix_name</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">)</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span><span class="js2-function-call">ghost</span>()) {
                <span class="js2-function-call"><span class="jcXcovered">maybe_append_name</span></span><span class="jcXcovered">(name);</span>
            }
            <span class="keyword">var</span> <span class="variable-name">login</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">login_name</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">)</span>;
            <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">name</span></span><span class="jcXcovered">(name + (login ? </span><span class="string"><span class="jcXcovered">'_'</span></span><span class="jcXcovered"> + login : </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">));</span>
            <span class="keyword">var</span> <span class="variable-name">prompt</span> = <span class="jcXcovered">interpreter.</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(prompt)) {
                <span class="jcXnot-covered">prompt = </span><span class="js2-function-call"><span class="jcXnot-covered">context_callback_proxy</span></span><span class="jcXnot-covered">(prompt, </span><span class="string"><span class="jcXnot-covered">'string'</span></span><span class="jcXnot-covered">);</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (prompt !== command_line.<span class="js2-function-call">prompt</span>()) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(interpreter.<span class="js2-object-property">prompt</span>)) {
                    <span class="comment">// prevent flicker of old prompt until async prompt finishes
</span>                    <span class="jcXnot-covered">command_line.</span><span class="js2-function-call"><span class="jcXnot-covered">prompt</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">);</span>
                }
                <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">prompt</span></span><span class="jcXcovered">(interpreter.</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span><span class="jcXcovered">);</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> interpreter.<span class="js2-object-property">history</span> !== <span class="string">'undefined'</span>) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">history</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">toggle</span></span><span class="jcXcovered">(interpreter.</span><span class="js2-object-property"><span class="jcXcovered">history</span></span><span class="jcXcovered">);</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">isPlainObject</span>(interpreter.<span class="js2-object-property">keymap</span>)) {
                <span class="jcXcovered">comm</span>and_line.<span class="js2-function-call">keymap</span>($.<span class="js2-function-call">omap</span>(interpreter.<span class="js2-object-property">keymap</span>, <span class="keyword">function</span>(<span class="js2-function-param">name</span>, <span class="js2-function-param">fun</span>) {
                    <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                        <span class="keyword">var</span> <span class="variable-name">args</span> = <span class="jcXcovered">[].</span><span class="js2-object-property"><span class="jcXcovered">slice</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">arguments</span></span><span class="jcXcovered">)</span>;
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> fun.</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(self, args);</span>
                        } <span class="keyword">catch</span> (e) {
                            <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'USER KEYMAP'</span></span><span class="jcXnot-covered">);</span>
                        }
                    };
                }));
            }
            <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
            <span class="jcXcovered">init_queue.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">();</span>
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent &amp;&amp; <span class="js2-function-call">is_function</span>(interpreter.<span class="js2-object-property">onStart</span>)) {
                <span class="jcXnot-covered">interpreter.</span><span class="js2-object-property"><span class="jcXnot-covered">onStart</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, self);</span>
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">fire_event</span>(<span class="js2-function-param">name</span>, <span class="js2-function-param">args</span>) {
            <span class="jcXcovered">args = (args || []).</span><span class="js2-function-call"><span class="jcXcovered">concat</span></span><span class="jcXcovered">([self]);</span> <span class="comment">// create new array
</span>            <span class="comment">// even can be fired before interpreters is created
</span>            <span class="keyword">var</span> <span class="variable-name">top</span> = <span class="jcXcovered">interpreters &amp;&amp; interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (top &amp;&amp; <span class="js2-function-call">is_function</span>(top[name])) {
                <span class="keyword"><span class="jcXnot-covered">t</span></span><span class="keyword">ry</span> {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> top[name].</span><span class="js2-function-call"><span class="jcXnot-covered">apply</span></span><span class="jcXnot-covered">(self, args);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="keyword"><span class="jcXnot-covered">delete</span></span><span class="jcXnot-covered"> top[name];</span>
                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, name);</span>
                }
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(settings[name])) {
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> settings[name].</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(self, args);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="jcXnot-covered">settings[name] = </span><span class="constant"><span class="jcXnot-covered">null</span></span><span class="jcXnot-covered">;</span>
                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, name);</span>
                }
            }
        }
        <span class="keyword">var</span> <span class="variable-name"><span class="jcXcovered">scroll_to_view</span></span><span class="jcXcovered"> = </span>(<span class="keyword">function</span>() {
            <span class="keyword">function</span> <span class="function-name">scroll_to_view</span>(<span class="js2-function-param">visible</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>visible) {
                    <span class="comment">// try catch for Node.js unit tests
</span>                    <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scroll_to</span></span><span class="jcXcovered">(self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cursor'</span></span><span class="jcXcovered">));</span>
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    } <span class="keyword">catch</span> (e) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    }
                }
            }
            <span class="comment">// we don't want debounce in Unit Tests
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> global !== <span class="string">'undefined'</span> &amp;&amp; <span class="keyword">typeof</span> global.<span class="js2-object-property">it</span> === <span class="string">'function'</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> scroll_to_view;</span>
            }
            <span class="keyword"><span class="jcXnot-covered">ret</span></span><span class="keyword">urn</span> <span class="js2-function-call">debounce</span>(scroll_to_view, 100, {
                <span class="js2-object-property">leading</span>: <span class="constant">true</span>,
                <span class="js2-object-property">trailing</span>: <span class="constant">false</span>
            });
        })();
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">make_cursor_visible</span>() {
            <span class="keyword">var</span> <span class="variable-name">cursor</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cursor-line'</span></span><span class="jcXcovered">)</span>;
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> cursor.</span><span class="js2-function-call"><span class="jcXcovered">is_fully_in_viewport</span></span><span class="jcXcovered">(self).</span><span class="js2-function-call"><span class="jcXcovered">then</span></span><span class="jcXcovered">(scroll_to_view);</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">hashchange</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (fire_hash_change &amp;&amp; settings.<span class="js2-object-property">execHash</span>) {
                <span class="keyword"><span class="jcXnot-covered">t</span></span><span class="keyword">ry</span> {
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (location.<span class="js2-object-property">hash</span>) {
                        <span class="keyword">var</span> <span class="variable-name">hash</span> = <span class="jcXnot-covered">location.</span><span class="js2-object-property"><span class="jcXnot-covered">hash</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">replace</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">/^#/</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">''</span></span><span class="jcXnot-covered">)</span>;
                        <span class="jcXnot-covered">hash_commands = JSON.</span><span class="js2-function-call"><span class="jcXnot-covered">parse</span></span><span class="jcXnot-covered">(</span><span class="builtin"><span class="jcXnot-covered">decodeURIComponent</span></span><span class="jcXnot-covered">(hash));</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXnot-covered">hash_commands = [];</span>
                    }
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (hash_commands.<span class="js2-object-property">length</span>) {
                        <span class="js2-function-call"><span class="jcXnot-covered">restore_state</span></span><span class="jcXnot-covered">(hash_commands[hash_commands.</span><span class="js2-object-property"><span class="jcXnot-covered">length</span></span><span class="jcXnot-covered"> - 1]);</span>
                    }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (save_state[0]) {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">import_view</span></span><span class="jcXnot-covered">(save_state[0]);</span>
                    }
                } <span class="keyword">catch</span> (e) {
                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'TERMINAL'</span></span><span class="jcXnot-covered">);</span>
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">initialize</span>() {
            <span class="js2-function-call"><span class="jcXcovered">prepare_top_interpreter</span></span><span class="jcXcovered">();</span>
            <span class="js2-function-call"><span class="jcXcovered">show_greetings</span></span><span class="jcXcovered">();</span>
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (lines.<span class="js2-object-property">length</span>) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">refresh</span></span><span class="jcXcovered">();</span> <span class="comment">// for case when showing long error before init
</span>            }
            <span class="comment">// was_paused flag is workaround for case when user call exec before
</span>            <span class="comment">// login and pause in onInit, 3rd exec will have proper timing (will
</span>            <span class="comment">// execute after onInit resume)
</span>            <span class="keyword">var</span> <span class="variable-name">was_paused</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onInit</span>)) {
                <span class="function-name"><span class="jcXcovered">on</span></span><span class="function-name">Pause</span> = <span class="keyword">function</span>() { <span class="comment">// local in terminal
</span>                    <span class="jcXnot-covered">was_paused = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                };
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">onInit</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, self);</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'OnInit'</span></span><span class="jcXnot-covered">);</span>
                    <span class="comment">// throw e; // it will be catched by terminal
</span>                } <span class="keyword">finally</span> {
                    <span class="jcXcovered">onPause = $.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span><span class="jcXcovered">;</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>was_paused &amp;&amp; self.<span class="js2-function-call">enabled</span>()) {
                        <span class="comment">// resume login if user didn't call pause in onInit
</span>                        <span class="comment">// if user pause in onInit wait with exec until it
</span>                        <span class="comment">// resume
</span>                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                    }
                }
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (first_instance) {
                <span class="jcXcovered">first_instance = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(window).</span><span class="js2-function-call"><span class="jcXcovered">on</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'hashchange'</span></span><span class="jcXcovered">, hashchange);</span>
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: If Ghost don't store anything in localstorage
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">ghost</span>() {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> in_login || command_line.</span><span class="js2-function-call"><span class="jcXcovered">mask</span></span><span class="jcXcovered">() !== </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="comment">// :: Keydown event handler
</span>        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">user_key_down</span>(<span class="js2-function-param">e</span>) {
            <span class="keyword">var</span> <span class="variable-name">result</span>, <span class="variable-name">top</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(top.<span class="js2-object-property">keydown</span>)) {
                <span class="jcXcovered">result = top.</span><span class="js2-object-property"><span class="jcXcovered">keydown</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, e, self);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result !== <span class="constant">undefined</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> result;</span>
                }
            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">keydown</span>)) {
                <span class="jcXcovered">result = settings.</span><span class="js2-object-property"><span class="jcXcovered">keydown</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, e, self);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result !== <span class="constant">undefined</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> result;</span>
                }
            }
        }
        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">keymap</span></span><span class="jcXcovered"> = </span>{
            <span class="function-name">'CTRL+D'</span>: <span class="keyword">function</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">original</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>in_login) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command_line.<span class="js2-function-call">get</span>() === <span class="string">''</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (interpreters.<span class="js2-function-call">size</span>() &gt; 1 ||
                            <span class="js2-function-call">is_function</span>(global_login_fn)) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="js2-function-call"><span class="jcXnot-covered">original</span></span><span class="jcXnot-covered">();</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">'CTRL+C'</span>: <span class="keyword">function</span>() {
                <span class="js2-function-call"><span class="jcXcovered">wit</span></span><span class="js2-function-call">h_selection</span>(<span class="keyword">function</span>(<span class="js2-function-param">html</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (html === <span class="string">''</span>) {
                        <span class="keyword">var</span> <span class="variable-name">command</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">get_command</span></span><span class="jcXcovered">()</span>;
                        <span class="keyword">var</span> <span class="variable-name">position</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">get_position</span></span><span class="jcXcovered">()</span>;
                        <span class="jcXcovered">command = command.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, posit</span>ion) + <span class="string">'^C'</span> +
                            command.<span class="js2-function-call">slice</span>(position + 2);
                        <span class="js2-function-call"><span class="jcXcovered">echo_command</span></span><span class="jcXcovered">(command);</span>
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set_command</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword">var</span> <span class="variable-name">clip</span> = <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">find</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'textarea'</span></span><span class="jcXnot-covered">)</span>;
                        <span class="js2-function-call"><span class="jcXnot-covered">text_to_clipboard</span></span><span class="jcXnot-covered">(clip, </span><span class="js2-function-call"><span class="jcXnot-covered">process_selected_html</span></span><span class="jcXnot-covered">(html));</span>
                    }
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">'CTRL+L'</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">clear</span></span><span class="jcXcovered">();</span>
            },
            <span class="function-name">'TAB'</span>: <span class="keyword">function</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">orignal</span>) {
                <span class="comment">// TODO: move this to cmd plugin
</span>                <span class="comment">//       add completion = array | function
</span>                <span class="comment">//       !!! Problem complete more then one key need terminal
</span>                <span class="keyword">var</span> <span class="variable-name">top</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()</span>, <span class="variable-name">completion</span>, <span class="variable-name">caseSensitive</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> top.<span class="js2-object-property">caseSensitiveAutocomplete</span> !== <span class="string">'undefined'</span>) {
                    <span class="jcXnot-covered">caseSensitive = top.</span><span class="js2-object-property"><span class="jcXnot-covered">caseSensitiveAutocomplete</span></span><span class="jcXnot-covered">;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">caseSensitive = settings.</span><span class="js2-object-property"><span class="jcXcovered">caseSensitiveAutocomplete</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">completion</span> &amp;&amp;
                    <span class="js2-function-call">get_type</span>(settings.<span class="js2-object-property">completion</span>) !== <span class="string">'boolean'</span> &amp;&amp;
                    top.<span class="js2-object-property">completion</span> === <span class="constant">undefined</span>) {
                    <span class="jcXnot-covered">completion = settings.</span><span class="js2-object-property"><span class="jcXnot-covered">completion</span></span><span class="jcXnot-covered">;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">completion = top.</span><span class="js2-object-property"><span class="jcXcovered">completion</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (completion === <span class="string">'settings'</span>) {
                    <span class="jcXcovered">completion = settings.</span><span class="js2-object-property"><span class="jcXcovered">completion</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword">function</span> <span class="function-name">resolve</span>(<span class="js2-function-param">commands</span>) {
                    <span class="comment">// local copy
</span>                    <span class="jcXcovered">commands = commands.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">();</span>
                    <span class="comment">// default commands should not match for arguments
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>self.<span class="js2-function-call">before_cursor</span>(<span class="constant">false</span>).<span class="js2-function-call">match</span>(<span class="string">/\s/</span>)) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">clear</span> &amp;&amp; $.<span class="js2-function-call">inArray</span>(<span class="string">'clear'</span>, commands) === -1) {
                            <span class="jcXcovered">commands.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'clear'</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">exit</span> &amp;&amp; $.<span class="js2-function-call">inArray</span>(<span class="string">'exit'</span>, commands) === -1) {
                            <span class="jcXcovered">commands.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'exit'</span></span><span class="jcXcovered">);</span>
                        }
                    }
                    <span class="jcXcovered">sel</span>f.<span class="js2-function-call">complete</span>(commands, {
                        <span class="js2-object-property">echo</span>: <span class="constant">true</span>,
                        <span class="js2-object-property">word</span>: settings.<span class="js2-object-property">wordAutocomplete</span>,
                        <span class="js2-object-property">escape</span>: settings.<span class="js2-object-property">completionEscape</span>,
                        <span class="js2-object-property">caseSensitive</span>: caseSensitive,
                        <span class="js2-object-property">echoCommand</span>: settings.<span class="js2-object-property">doubleTabEchoCommand</span>,
                        <span class="js2-object-property">doubleTab</span>: settings.<span class="js2-object-property">doubleTab</span>
                    });
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (completion) {
                    <span class="keyword"><span class="jcXcovered">s</span></span><span class="keyword">witch</span> (<span class="js2-function-call">get_type</span>(completion)) {
                        <span class="keyword">case</span> <span class="string">'function'</span>:
                            <span class="keyword">var</span> <span class="variable-name">string</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">before_cursor</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">wordAutocomplete</span></span><span class="jcXcovered">)</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (completion.<span class="js2-object-property">length</span> === 3) {
                                <span class="keyword">var</span> <span class="variable-name">error</span> = <span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">comletionParameters</span></span><span class="jcXnot-covered">)</span>;
                                <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(error, </span><span class="string"><span class="jcXnot-covered">'USER'</span></span><span class="jcXnot-covered">);</span>
                                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                            }
                            <span class="keyword">var</span> <span class="variable-name">result</span> = <span class="jcXcovered">completion.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, string, resolve)</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result) {
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(result.<span class="js2-object-property">then</span>)) {
                                    <span class="jcXcovered">result.</span><span class="js2-function-call"><span class="jcXcovered">then</span></span><span class="jcXcovered">(resolve);</span>
                                }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_array</span>(result)) {
                                    <span class="js2-function-call"><span class="jcXnot-covered">resolve</span></span><span class="jcXnot-covered">(result);</span>
                                }
                            }
                            <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                        <span class="keyword">case</span> <span class="string">'array'</span>:
                            <span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">(completion);</span>
                            <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                        <span class="keyword">default</span>:
                            <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> $.</span><span class="js2-object-property"><span class="jcXnot-covered">terminal</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">Exception</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">invalidCompletion</span></span><span class="jcXnot-covered">);</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXcovered">orignal</span></span><span class="jcXcovered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
            },
            <span class="function-name">'CTRL+V'</span>: <span class="keyword">function</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">original</span>) {
                <span class="js2-function-call"><span class="jcXnot-covered">original</span></span><span class="jcXnot-covered">(e);</span>
                <span class="jcXnot-covered">sel</span>f.<span class="js2-function-call">oneTime</span>(200, <span class="keyword">function</span>() {
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">scroll_to_bottom</span></span><span class="jcXnot-covered">();</span>
                });
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
            },
            <span class="function-name">'CTRL+TAB'</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (terminals.<span class="js2-function-call">length</span>() &gt; 1) {
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">focus</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">);</span>
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                }
            },
            <span class="function-name">'PAGEDOWN'</span>: <span class="keyword">function</span>() {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">scroll</span></span><span class="jcXnot-covered">(self.</span><span class="js2-function-call"><span class="jcXnot-covered">height</span></span><span class="jcXnot-covered">());</span>
            },
            <span class="function-name">'PAGEUP'</span>: <span class="keyword">function</span>() {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">scroll</span></span><span class="jcXnot-covered">(-self.</span><span class="js2-function-call"><span class="jcXnot-covered">height</span></span><span class="jcXnot-covered">());</span>
            }
        };
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">key_down</span>(<span class="js2-function-param">e</span>) {
            <span class="comment">// Prevent to be executed by cmd: CTRL+D, TAB, CTRL+TAB (if more
</span>            <span class="comment">// then one terminal)
</span>            <span class="keyword">var</span> <span class="variable-name">result</span>, <span class="variable-name">i</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">enabled</span>()) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>self.<span class="js2-function-call">paused</span>()) {
                    <span class="jcXcovered">result = </span><span class="js2-function-call"><span class="jcXcovered">user_key_down</span></span><span class="jcXcovered">(e);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result !== <span class="constant">undefined</span>) {
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> result;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">which</span> !== 9) { <span class="comment">// not a TAB
</span>                        <span class="jcXcovered">tab_count = 0;</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>settings.<span class="js2-object-property">pauseEvents</span>) {
                        <span class="jcXcovered">result = </span><span class="js2-function-call"><span class="jcXcovered">user_key_down</span></span><span class="jcXcovered">(e);</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result !== <span class="constant">undefined</span>) {
                            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> result;</span>
                        }
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">which</span> === 68 &amp;&amp; e.<span class="js2-object-property">ctrlKey</span>) { <span class="comment">// CTRL+D (if paused)
</span>                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">pauseEvents</span>) {
                            <span class="jcXcovered">result = </span><span class="js2-function-call"><span class="jcXcovered">user_key_down</span></span><span class="jcXcovered">(e);</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (result !== <span class="constant">undefined</span>) {
                                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> result;</span>
                            }
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (requests.<span class="js2-object-property">length</span>) {
                            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (i = requests.<span class="js2-object-property">length</span>; i--;) {
                                <span class="keyword">var</span> <span class="variable-name">r</span> = <span class="jcXcovered">requests[i]</span>;
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (r.<span class="js2-object-property">readyState</span> !== 4) {
                                    <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                                        <span class="jcXcovered">r.</span><span class="js2-function-call"><span class="jcXcovered">abort</span></span><span class="jcXcovered">();</span>
                                    } <span class="keyword">catch</span> (error) {
                                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">exceptionHandler</span>)) {
                                            <span class="jcXnot-covered">se</span>ttings.<span class="js2-object-property">exceptionHandler</span>.<span class="js2-function-call">call</span>(
                                                self,
                                                e,
                                                <span class="string">'AJAX ABORT'</span>
                                            );
                                        } <span class="keyword">else</span> {
                                            <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">ajaxAbortError</span></span><span class="jcXnot-covered">);</span>
                                        }
                                    }
                                }
                            }
                            <span class="jcXcovered">requests = [];</span>
                        }
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">key_press</span>(<span class="js2-function-param">e</span>) {
            <span class="keyword">var</span> <span class="variable-name">top</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()</span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled &amp;&amp; (<span class="negation-char">!</span>paused || <span class="negation-char">!</span>settings.<span class="js2-object-property">pauseEvents</span>)) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(top.<span class="js2-object-property">keypress</span>)) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> top.</span><span class="js2-object-property"><span class="jcXcovered">keypress</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, e, self);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">keypress</span>)) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> settings.</span><span class="js2-object-property"><span class="jcXcovered">keypress</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, e, self);</span>
                }
            }
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">ready</span>(<span class="js2-function-param">queue</span>) {
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">fun</span>) {
                <span class="jcXcovered">queue.</span><span class="js2-function-call"><span class="jcXcovered">add</span></span><span class="jcXcovered">(fun);</span>
            };
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">function</span> <span class="function-name">strings</span>() {
            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> $.<span class="js2-function-call">extend</span>(
                {},
                $.<span class="js2-object-property">terminal</span>.<span class="js2-object-property">defaults</span>.<span class="js2-object-property">strings</span>,
                settings &amp;&amp; settings.<span class="js2-object-property">strings</span> || {}
            );
        }
        <span class="comment">// ---------------------------------------------------------------------
</span>        <span class="keyword">var</span> <span class="variable-name">self</span> = <span class="builtin"><span class="jcXcovered">this</span></span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">is</span>(<span class="string">'body,html'</span>)) {
            <span class="jcXnot-covered">self = </span><span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'&lt;div/&gt;'</span></span><span class="jcXnot-covered">).</span><span class="js2-function-call"><span class="jcXnot-covered">appendTo</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'body'</span></span><span class="jcXnot-covered">);</span>
            <span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'body'</span></span><span class="jcXnot-covered">).</span><span class="js2-function-call"><span class="jcXnot-covered">addClass</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'full-screen-terminal'</span></span><span class="jcXnot-covered">);</span>
        }
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="builtin">this</span>.<span class="js2-object-property">length</span> &gt; 1) {
            <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> <span class="builtin">this</span>.<span class="js2-function-call">each</span>(<span class="keyword">function</span>() {
                <span class="jcXcovered">$.</span><span class="js2-object-property">fn</span>.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">call</span>(
                    <span class="js2-function-call">$</span>(<span class="builtin">this</span>),
                    init_interpreter,
                    $.<span class="js2-function-call">extend</span>({<span class="js2-object-property">name</span>: self.<span class="js2-object-property">selector</span>}, options)
                );
            });
        }
        <span class="comment">// terminal already exists
</span>        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">data</span>(<span class="string">'terminal'</span>)) {
            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'terminal'</span></span><span class="jcXcovered">);</span>
        }
        <span class="comment">// -----------------------------------------------------------------
</span>        <span class="comment">// TERMINAL METHODS
</span>        <span class="comment">// -----------------------------------------------------------------
</span>        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">ex</span></span><span class="js2-function-call">tend</span>(self, $.<span class="js2-function-call">omap</span>({
            <span class="function-name">id</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> terminal_id;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Clear the output
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">clear</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">lines = [];</span>
                <span class="jcXcovered">output.</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onClear'</span></span><span class="jcXcovered">);</span>
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">({</span><span class="js2-object-property"><span class="jcXcovered">scrollTop</span></span><span class="jcXcovered">: 0});</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return an object that can be used with import_view to
</span>            <span class="comment">// :: restore the state
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">export_view</span>: <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">user_export</span> = <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onExport'</span></span><span class="jcXcovered">)</span>;
                <span class="jcXcovered">user_export = user_export || {};</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span><span class="jcXcovered">(</span>{}, {
                    <span class="js2-object-property">focus</span>: enabled,
                    <span class="js2-object-property">mask</span>: command_line.<span class="js2-function-call">mask</span>(),
                    <span class="js2-object-property">prompt</span>: self.<span class="js2-function-call">get_prompt</span>(),
                    <span class="js2-object-property">command</span>: self.<span class="js2-function-call">get_command</span>(),
                    <span class="js2-object-property">position</span>: command_line.<span class="js2-function-call">position</span>(),
                    <span class="js2-object-property">lines</span>: <span class="js2-function-call">clone</span>(lines),
                    <span class="js2-object-property">interpreters</span>: interpreters.<span class="js2-function-call">clone</span>(),
                    <span class="js2-object-property">history</span>: command_line.<span class="js2-function-call">history</span>().<span class="js2-object-property">data</span>
                }, user_export);
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Restore the state of the previous exported view
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">import_view</span>: <span class="keyword">function</span>(<span class="js2-function-param">view</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (in_login) {
                    <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">sprintf</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">notWhileLogin</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">'import_view'</span></span><span class="jcXnot-covered">));</span>
                }
                <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onImport'</span></span><span class="jcXcovered">, [view]);</span>
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set_prompt</span></span><span class="jcXcovered">(view.</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set_command</span></span><span class="jcXcovered">(view.</span><span class="js2-object-property"><span class="jcXcovered">command</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(view.</span><span class="js2-object-property"><span class="jcXcovered">position</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">mask</span></span><span class="jcXcovered">(view.</span><span class="js2-object-property"><span class="jcXcovered">mask</span></span><span class="jcXcovered">);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (view.<span class="js2-object-property">focus</span>) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">focus</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="jcXcovered">lin</span>es = <span class="js2-function-call">clone</span>(view.<span class="js2-object-property">lines</span>).<span class="js2-function-call">filter</span>(<span class="keyword">function</span>(<span class="js2-function-param">line</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> line[0];</span>
                    });
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (view.<span class="js2-object-property">interpreters</span> <span class="keyword">instanceof</span> Stack) {
                        <span class="jcXcovered">interpreters = view.</span><span class="js2-object-property"><span class="jcXcovered">interpreters</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">importHistory</span>) {
                        <span class="jcXnot-covered">command_line.</span><span class="js2-function-call"><span class="jcXnot-covered">history</span></span><span class="jcXnot-covered">().</span><span class="js2-function-call"><span class="jcXnot-covered">set</span></span><span class="jcXnot-covered">(view.</span><span class="js2-object-property"><span class="jcXnot-covered">history</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Store current terminal state
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">save_state</span>: <span class="keyword">function</span>(<span class="js2-function-param">command</span>, <span class="js2-function-param">ignore_hash</span>, <span class="js2-function-param">index</span>) {
                <span class="comment">// save_state.push({view:self.export_view(), join:[]});
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> index !== <span class="string">'undefined'</span>) {
                    <span class="jcXcovered">save_state[index] = self.</span><span class="js2-function-call"><span class="jcXcovered">export_view</span></span><span class="jcXcovered">();</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">save_state.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(self.</span><span class="js2-function-call"><span class="jcXcovered">export_view</span></span><span class="jcXcovered">());</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>$.<span class="js2-function-call">isArray</span>(hash_commands)) {
                    <span class="jcXcovered">hash_commands = [];</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (command !== <span class="constant">undefined</span> &amp;&amp; <span class="negation-char">!</span>ignore_hash) {
                    <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">state</span></span><span class="jcXcovered"> = </span>[
                        terminal_id,
                        save_state.<span class="js2-object-property">length</span> - 1,
                        command
                    ];
                    <span class="jcXcovered">hash_commands.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(state);</span>
                    <span class="js2-function-call"><span class="jcXcovered">maybe_update_hash</span></span><span class="jcXcovered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Execute a command, it will handle commands that do AJAX
</span>            <span class="comment">// :: calls and have delays, if the second argument is set to
</span>            <span class="comment">// :: true it will not echo executed command
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">exec</span>: <span class="keyword">function</span>(<span class="js2-function-param">command</span>, <span class="js2-function-param">silent</span>, <span class="js2-function-param">deferred</span>) {
                <span class="keyword">var</span> <span class="variable-name">d</span> = <span class="jcXcovered">deferred || </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">Deferred</span></span><span class="jcXcovered">()</span>;
                <span class="js2-function-call"><span class="jcXcovered">cmd</span></span><span class="js2-function-call">_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">isArray</span>(command)) {
                        <span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">func</span></span><span class="keyword">tion</span> <span class="function-name">recur</span>() {
                            <span class="keyword">var</span> <span class="variable-name">cmd</span> = <span class="jcXcovered">command.</span><span class="js2-function-call"><span class="jcXcovered">shift</span></span><span class="jcXcovered">()</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (cmd) {
                                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">exec</span></span><span class="jcXcovered">(cmd, silent).</span><span class="js2-function-call"><span class="jcXcovered">done</span></span><span class="jcXcovered">(recur);</span>
                            } <span class="keyword">else</span> {
                                <span class="jcXcovered">d.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">();</span>
                            }
                        })();
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (paused) {
                        <span class="comment">// both commands executed here (resume will call Term::exec)
</span>                        <span class="comment">// delay command multiple time
</span>                        <span class="jcXcovered">delayed_commands.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">([command, silent, d]);</span>
                    } <span class="keyword">else</span> {
                        <span class="comment">// commands may return promise from user code
</span>                        <span class="comment">// it will resolve exec promise when user promise
</span>                        <span class="comment">// is resolved
</span>                        <span class="keyword">var</span> <span class="variable-name">ret</span> = <span class="js2-function-call"><span class="jcXcovered">commands</span></span><span class="jcXcovered">(command, silent, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">)</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ret &amp;&amp; (ret.<span class="js2-object-property">done</span> || ret.<span class="js2-object-property">then</span>)) {
                            <span class="jcXcovered">(re</span>t.<span class="js2-object-property">done</span> || ret.<span class="js2-object-property">then</span>).<span class="js2-function-call">call</span>(ret, <span class="keyword">function</span>() {
                                <span class="jcXcovered">d.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">(self);</span>
                            });
                        }
                    }
                });
                <span class="comment">// while testing it didn't executed last exec when using this
</span>                <span class="comment">// for resolved deferred
</span>                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> d.</span><span class="js2-function-call"><span class="jcXcovered">promise</span></span><span class="jcXcovered">();</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: bypass login function that wait untill you type user/pass
</span>            <span class="comment">// :: it hide implementation detail
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">autologin</span>: <span class="keyword">function</span>(<span class="js2-function-param">user</span>, <span class="js2-function-param">token</span>, <span class="js2-function-param">silent</span>) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">trigger</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'terminal.autologin'</span></span><span class="jcXcovered">, [user, token, silent]);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Function changes the prompt of the command line to login
</span>            <span class="comment">// :: with a password and calls the user login function with
</span>            <span class="comment">// :: the callback that expects a token. The login is successful
</span>            <span class="comment">// :: if the user calls it with value that is truthy
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">login</span>: <span class="keyword">function</span>(<span class="js2-function-param">auth</span>, <span class="js2-function-param">infinite</span>, <span class="js2-function-param">success</span>, <span class="js2-function-param">error</span>) {
                <span class="jcXcovered">logins.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">([].</span><span class="js2-object-property"><span class="jcXcovered">slice</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">arguments</span></span><span class="jcXcovered">));</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (in_login) {
                    <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">sprintf</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">notWhileLogin</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">'login'</span></span><span class="jcXnot-covered">));</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span><span class="js2-function-call">is_function</span>(auth)) {
                    <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">loginIsNotAFunction</span></span><span class="jcXnot-covered">);</span>
                }
                <span class="jcXcovered">in_login = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">token</span>() &amp;&amp; self.<span class="js2-function-call">level</span>() === 1 &amp;&amp; <span class="negation-char">!</span>autologin) {
                    <span class="jcXnot-covered">in_login = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span> <span class="comment">// logout will call login
</span>                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">logout</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (self.<span class="js2-function-call">token</span>(<span class="constant">true</span>) &amp;&amp; self.<span class="js2-function-call">login_name</span>(<span class="constant">true</span>)) {
                    <span class="jcXnot-covered">in_login = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(success)) {
                        <span class="js2-function-call"><span class="jcXnot-covered">success</span></span><span class="jcXnot-covered">();</span>
                    }
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self;</span>
                }
                <span class="comment">// don't store login data in history
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">history</span>) {
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">history</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
                }
                <span class="comment">// so we know how many times call pop
</span>                <span class="keyword">var</span> <span class="variable-name">level</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">level</span></span><span class="jcXcovered">()</span>;
                <span class="keyword">function</span> <span class="function-name">login_callback</span>(<span class="js2-function-param">user</span>, <span class="js2-function-param">token</span>, <span class="js2-function-param">silent</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (token) {
                        <span class="keyword"><span class="jcXcovered">w</span></span><span class="keyword">hile</span> (self.<span class="js2-function-call">level</span>() &gt; level) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">undefined</span></span><span class="jcXcovered">, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">history</span>) {
                            <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">history</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">();</span>
                        }
                        <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">prefix_name</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">) + </span><span class="string"><span class="jcXcovered">'_'</span></span>;
                        <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(name + </span><span class="string"><span class="jcXcovered">'token'</span></span><span class="jcXcovered">, token);</span>
                        <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(name + </span><span class="string"><span class="jcXcovered">'login'</span></span><span class="jcXcovered">, user);</span>
                        <span class="jcXcovered">in_login = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(success)) {
                            <span class="comment">// will be used internaly since users know
</span>                            <span class="comment">// when login success (they decide when
</span>                            <span class="comment">// it happen by calling the callback -
</span>                            <span class="comment">// this funtion)
</span>                            <span class="js2-function-call"><span class="jcXcovered">success</span></span><span class="jcXcovered">();</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (infinite) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent) {
                                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">strings</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">wrongPasswordTryAgain</span></span><span class="jcXcovered">);</span>
                            }
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">undefined</span></span><span class="jcXcovered">, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">set_mask</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">);</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">in_login = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent) {
                                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">strings</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">wrongPassword</span></span><span class="jcXcovered">);</span>
                            }
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">undefined</span></span><span class="jcXcovered">, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">undefined</span></span><span class="jcXcovered">, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="comment">// used only to call pop in push
</span>                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(error)) {
                            <span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">();</span>
                        }
                    }
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">off</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'terminal.autologin'</span></span><span class="jcXcovered">);</span>
                }
                <span class="jcXcovered">sel</span>f.<span class="js2-function-call">on</span>(<span class="string">'terminal.autologin'</span>, <span class="keyword">function</span>(<span class="js2-function-param">event</span>, <span class="js2-function-param">user</span>, <span class="js2-function-param">token</span>, <span class="js2-function-param">silent</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">login_callback</span></span><span class="jcXcovered">(user, token, silent);</span>
                });
                <span class="jcXcovered">sel</span>f.<span class="js2-function-call">push</span>(<span class="keyword">function</span>(<span class="js2-function-param">user</span>) {
                    <span class="jcXcovered">sel</span>f.<span class="js2-function-call">set_mask</span>(settings.<span class="js2-object-property">maskChar</span>).<span class="js2-function-call">push</span>(<span class="keyword">function</span>(<span class="js2-function-param">pass</span>) {
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">ret</span></span><span class="jcXcovered"> = </span>auth.<span class="js2-function-call">call</span>(self, user, pass, <span class="keyword">function</span>(
                                <span class="js2-function-param">token</span>,
                                <span class="js2-function-param">silent</span>) {
                                <span class="js2-function-call"><span class="jcXcovered">login_callback</span></span><span class="jcXcovered">(user, token, silent);</span>
                            });
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (ret &amp;&amp; <span class="js2-function-call">is_function</span>(ret.<span class="js2-object-property">then</span>)) {
                                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">pause</span></span><span class="jcXnot-covered">();</span>
                                <span class="jcXnot-covered">ret</span>.<span class="js2-function-call">then</span>(<span class="keyword">function</span>(<span class="js2-function-param">token</span>) {
                                    <span class="js2-function-call"><span class="jcXnot-covered">login_callback</span></span><span class="jcXnot-covered">(user, token);</span>
                                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">resume</span></span><span class="jcXnot-covered">();</span>
                                });
                            }
                        } <span class="keyword">catch</span> (e) {
                            <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'AUTH'</span></span><span class="jcXnot-covered">);</span>
                        }
                    }, {
                        <span class="js2-object-property">prompt</span>: <span class="js2-function-call">strings</span>().<span class="js2-object-property">password</span> + <span class="string">': '</span>,
                        <span class="js2-object-property">name</span>: <span class="string">'password'</span>
                    });
                }, {
                    <span class="js2-object-property">prompt</span>: <span class="js2-function-call">strings</span>().<span class="js2-object-property">login</span> + <span class="string">': '</span>,
                    <span class="js2-object-property">name</span>: <span class="string">'login'</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: User defined settings and defaults as well
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">settings</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> settings;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Get string before cursor
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">before_cursor</span>: <span class="keyword">function</span>(<span class="js2-function-param">word</span>) {
                <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">()</span>;
                <span class="keyword">var</span> <span class="variable-name">command</span> = <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, pos)</span>;
                <span class="keyword">var</span> <span class="variable-name">cmd_strings</span> = <span class="jcXcovered">command.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">)</span>;
                <span class="keyword">var</span> <span class="variable-name">string</span>; <span class="comment">// string before cursor that will be completed
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (word) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (cmd_strings.<span class="js2-object-property">length</span> === 1) {
                        <span class="jcXcovered">string = cmd_strings[0];</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword">var</span> <span class="variable-name">m</span> = <span class="jcXcovered">command.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/(\\?")/g</span></span><span class="jcXcovered">)</span>;
                        <span class="keyword">var</span> <span class="variable-name">double_qu</span><span class="variable-name"><span class="jcXcovered">otes</span></span><span class="jcXcovered"> = </span>m ? m.<span class="js2-function-call">filter</span>(<span class="keyword">function</span>(<span class="js2-function-param">chr</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="negation-char"><span class="jcXcovered">!</span></span><span class="jcXcovered">chr.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^\\/</span></span><span class="jcXcovered">);</span>
                        }).<span class="js2-object-property">length</span> : 0;
                        <span class="jcXcovered">m = command.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/'/g</span></span><span class="jcXcovered">);</span>
                        <span class="keyword">var</span> <span class="variable-name">single_quote</span> = <span class="jcXcovered">m ? m.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> : 0</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (single_quote % 2 === 1) {
                            <span class="jcXcovered">string = command.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/('[^']*)$/</span></span><span class="jcXcovered">)[0];</span>
                        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (double_quotes % 2 === 1) {
                            <span class="jcXcovered">string = command.</span><span class="js2-function-call"><span class="jcXcovered">match</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/("(?:[^"]|\\")*)$/</span></span><span class="jcXcovered">)[0];</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">string = cmd_strings[cmd_strings.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1];</span>
                            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (i = cmd_strings.<span class="js2-object-property">length</span> - 1; i &gt; 0; i--) {
                                <span class="comment">// treat escape space as part of the string
</span>                                <span class="keyword">var</span> <span class="variable-name">prev_string</span> = <span class="jcXcovered">cmd_strings[i - 1]</span>;
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (prev_string[prev_string.<span class="js2-object-property">length</span> - 1] === <span class="string">'\\'</span>) {
                                    <span class="jcXcovered">string = cmd_strings[i - 1] + </span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered"> + string;</span>
                                } <span class="keyword">else</span> {
                                    <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                                }
                            }
                        }
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">string = command;</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: complete word or command based on array of words
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">complete</span>: <span class="keyword">function</span>(<span class="js2-function-param">commands</span>, <span class="js2-function-param">options</span>) {
                <span class="jcXcovered">options = $.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span>({
                    <span class="js2-object-property">word</span>: <span class="constant">true</span>,
                    <span class="js2-object-property">echo</span>: <span class="constant">false</span>,
                    <span class="js2-object-property">escape</span>: <span class="constant">true</span>,
                    <span class="js2-object-property">echoCommand</span>: <span class="constant">false</span>,
                    <span class="js2-object-property">caseSensitive</span>: <span class="constant">true</span>,
                    <span class="js2-object-property">doubleTab</span>: <span class="constant">null</span>
                }, options || {});
                <span class="keyword">var</span> <span class="variable-name">sensitive</span> = <span class="jcXcovered">options.</span><span class="js2-object-property"><span class="jcXcovered">caseSensitive</span></span>;
                <span class="comment">// cursor can be in the middle of the command
</span>                <span class="comment">// so we need to get the text before the cursor
</span>                <span class="keyword">var</span> <span class="variable-name">string</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">before_cursor</span></span><span class="jcXcovered">(options.</span><span class="js2-object-property"><span class="jcXcovered">word</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/\\"/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">)</span>;
                <span class="keyword">var</span> <span class="variable-name">quote</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">word</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">match</span>(<span class="string">/^"/</span>)) {
                        <span class="jcXcovered">quote = </span><span class="string"><span class="jcXcovered">'"'</span></span><span class="jcXcovered">;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (string.<span class="js2-function-call">match</span>(<span class="string">/^'/</span>)) {
                        <span class="jcXcovered">quote = </span><span class="string"><span class="jcXcovered">"'"</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (quote) {
                        <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^["']/</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (tab_count % 2 === 0) {
                    <span class="jcXcovered">command = self.</span><span class="js2-function-call"><span class="jcXcovered">before_cursor</span></span><span class="jcXcovered">(options.</span><span class="js2-object-property"><span class="jcXcovered">word</span></span><span class="jcXcovered">);</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">test</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">before_cursor</span></span><span class="jcXcovered">(options.</span><span class="js2-object-property"><span class="jcXcovered">word</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (test !== command) {
                        <span class="comment">// command line changed between TABS - ignore
</span>                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered">;</span>
                    }
                }
                <span class="keyword">var</span> <span class="variable-name">safe</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_regex</span></span><span class="jcXcovered">(string)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">escape</span>) {
                    <span class="jcXcovered">saf</span>e = safe.<span class="js2-function-call">replace</span>(<span class="string">/(\\+)(["'() ])/g</span>, <span class="keyword">function</span>(<span class="js2-function-param">_</span>, <span class="js2-function-param">slash</span>, <span class="js2-function-param">chr</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (chr.<span class="js2-function-call">match</span>(<span class="string">/[()]/</span>)) {
                            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> slash + </span><span class="string"><span class="jcXnot-covered">'\\?\\'</span></span><span class="jcXnot-covered"> + chr;</span>
                        } <span class="keyword">else</span> {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> slash + </span><span class="string"><span class="jcXcovered">'?'</span></span><span class="jcXcovered"> + chr;</span>
                        }
                    });
                }
                <span class="keyword">function</span> <span class="function-name">escape</span>(<span class="js2-function-param">string</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (quote === <span class="string">'"'</span>) {
                        <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/"/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'\\"'</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>quote &amp;&amp; options.<span class="js2-object-property">escape</span>) {
                        <span class="jcXcovered">string = string.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/(["'() ])/g</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'\\$1'</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> string;</span>
                }
                <span class="keyword">function</span> <span class="function-name">matched_strings</span>() {
                    <span class="keyword">var</span> <span class="variable-name">matched</span> = <span class="jcXcovered">[]</span>;
                    <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">commands.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>; i--;) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (commands[i].<span class="js2-function-call">match</span>(<span class="string">/\n/</span>) &amp;&amp; options.<span class="js2-object-property">word</span>) {
                            <span class="js2-function-call"><span class="jcXnot-covered">warn</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'If you use commands with newlines yo</span></span><span class="string">u '</span> +
                                 <span class="string">'should use word option for complete or'</span> +
                                 <span class="string">' wordAutocomplete terminal option'</span>);
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (regex.<span class="js2-function-call">test</span>(commands[i])) {
                            <span class="keyword">var</span> <span class="variable-name">match</span> = <span class="js2-function-call"><span class="jcXcovered">escape</span></span><span class="jcXcovered">(commands[i])</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>sensitive &amp;&amp; <span class="js2-function-call">same_case</span>(match)) {
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string.<span class="js2-function-call">toLowerCase</span>() === string) {
                                    <span class="jcXcovered">match = match.</span><span class="js2-function-call"><span class="jcXcovered">toLowerCase</span></span><span class="jcXcovered">();</span>
                                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (string.<span class="js2-function-call">toUpperCase</span>() === string) {
                                    <span class="jcXcovered">match = match.</span><span class="js2-function-call"><span class="jcXcovered">toUpperCase</span></span><span class="jcXcovered">();</span>
                                }
                            }
                            <span class="jcXcovered">matched.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(match);</span>
                        }
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> matched;</span>
                }
                <span class="keyword">var</span> <span class="variable-name">flags</span> = <span class="jcXcovered">sensitive ? </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered"> : </span><span class="string"><span class="jcXcovered">'i'</span></span>;
                <span class="keyword">var</span> <span class="variable-name">regex</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">RegExp</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'^'</span></span><span class="jcXcovered"> + safe, flags)</span>;
                <span class="keyword">var</span> <span class="variable-name">matched</span> = <span class="js2-function-call"><span class="jcXcovered">matched_strings</span></span><span class="jcXcovered">()</span>;
                <span class="keyword">function</span> <span class="function-name">replace</span>(<span class="js2-function-param">input</span>, <span class="js2-function-param">replacement</span>) {
                    <span class="keyword">var</span> <span class="variable-name">text</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">get_command</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword">var</span> <span class="variable-name">pos</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">get_position</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword">var</span> <span class="variable-name">re</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">RegExp</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'^'</span></span><span class="jcXcovered"> + input, </span><span class="string"><span class="jcXcovered">'i'</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword">var</span> <span class="variable-name">pre</span> = <span class="jcXcovered">text.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(0, pos)</span>;
                    <span class="keyword">var</span> <span class="variable-name">post</span> = <span class="jcXcovered">text.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">(pos)</span>;
                    <span class="keyword">var</span> <span class="variable-name">to_insert</span> = <span class="jcXcovered">replacement.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(re, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">) + (quote || </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">)</span>;
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set_command</span></span><span class="jcXcovered">(pre + to_insert + post);</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set_position</span></span><span class="jcXcovered">((pre + to_insert).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">);</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (matched.<span class="js2-object-property">length</span> === 1) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">escape</span>) {
                        <span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(safe, matched[0]);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">insert</span></span><span class="jcXcovered">(matched[0].</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(regex, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">) + (quote || </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">));</span>
                    }
                    <span class="jcXcovered">command = self.</span><span class="js2-function-call"><span class="jcXcovered">before_cursor</span></span><span class="jcXcovered">(options.</span><span class="js2-object-property"><span class="jcXcovered">word</span></span><span class="jcXcovered">);</span>
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (matched.<span class="js2-object-property">length</span> &gt; 1) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (++tab_count &gt;= 2) {
                        <span class="jcXcovered">tab_count = 0;</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">echo</span>) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(options.<span class="js2-object-property">doubleTab</span>)) {
                                <span class="comment">// new API old is keep for backward compatibility
</span>                                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">echoCommand</span>) {
                                    <span class="js2-function-call"><span class="jcXnot-covered">echo_command</span></span><span class="jcXnot-covered">();</span>
                                }
                                <span class="keyword">v</span><span class="keyword"><span class="jcXnot-covered">ar</span></span><span class="jcXnot-covered"> </span><span class="variable-name"><span class="jcXnot-covered">ret</span></span><span class="jcXnot-covered"> = </span>options.<span class="js2-object-property">doubleTab</span>.<span class="js2-function-call">call</span>(
                                    self,
                                    string,
                                    matched,
                                    echo_command
                                );
                                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> ret === <span class="string">'undefined'</span>) {
                                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                                } <span class="keyword">else</span> {
                                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> ret;</span>
                                }
                            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (options.<span class="js2-object-property">doubleTab</span> !== <span class="constant">false</span>) {
                                <span class="js2-function-call"><span class="jcXcovered">echo_command</span></span><span class="jcXcovered">();</span>
                                <span class="keyword">var</span> <span class="variable-name">text</span> = <span class="jcXcovered">matched.</span><span class="js2-function-call"><span class="jcXcovered">slice</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">reverse</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\t\t'</span></span><span class="jcXcovered">)</span>;
                                <span class="jcXcovered">sel</span>f.<span class="js2-function-call">echo</span>($.<span class="js2-object-property">terminal</span>.<span class="js2-function-call">escape_brackets</span>(text), {
                                    <span class="js2-object-property">keepWords</span>: <span class="constant">true</span>,
                                    <span class="js2-object-property">formatters</span>: <span class="constant">false</span>
                                });
                            }
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="keyword">var</span> <span class="variable-name">common</span> = <span class="js2-function-call"><span class="jcXcovered">common_string</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">escape</span></span><span class="jcXcovered">(string), matched, sensitive)</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (common) {
                            <span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(safe, common);</span>
                            <span class="jcXcovered">command = self.</span><span class="js2-function-call"><span class="jcXcovered">before_cursor</span></span><span class="jcXcovered">(options.</span><span class="js2-object-property"><span class="jcXcovered">word</span></span><span class="jcXcovered">);</span>
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                        }
                    }
                }
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return commands function from top interpreter
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">commands</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">interpreter</span></span><span class="jcXcovered">;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Low Level method that overwrites interpreter
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">set_interpreter</span>: <span class="keyword">function</span>(<span class="js2-function-param">user_intrp</span>, <span class="js2-function-param">login</span>) {
                <span class="keyword">function</span> <span class="function-name">overwrite_interpreter</span>() {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                    <span class="js2-function-call"><span class="jcXcovered">mak</span></span><span class="js2-function-call">e_interpreter</span>(user_intrp, login, <span class="keyword">function</span>(<span class="js2-function-param">result</span>) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                        <span class="keyword">var</span> <span class="variable-name">top</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()</span>;
                        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span><span class="jcXcovered">(top, result);</span>
                        <span class="js2-function-call"><span class="jcXcovered">prepare_top_interpreter</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                    });
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(login)) {
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">login</span></span><span class="jcXnot-covered">(login, </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">, overwrite_interpreter);</span>
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">get_type</span>(user_intrp) === <span class="string">'string'</span> &amp;&amp; login) {
                    <span class="jcXcovered">se</span>lf.<span class="js2-function-call">login</span>(
                        <span class="js2-function-call">make_json_rpc_login</span>(user_intrp, login),
                        <span class="constant">true</span>,
                        overwrite_interpreter
                    );
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXcovered">overwrite_interpreter</span></span><span class="jcXcovered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Show user greetings or terminal signature
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">greetings</span>: <span class="keyword">function</span>() {
                <span class="js2-function-call"><span class="jcXcovered">show_greetings</span></span><span class="jcXcovered">();</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return true if terminal is paused false otherwise
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">paused</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> paused;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Pause the terminal, it should be used for ajax calls
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">pause</span>: <span class="keyword">function</span>(<span class="js2-function-param">visible</span>) {
                <span class="js2-function-call"><span class="jcXcovered">cmd</span></span><span class="js2-function-call">_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="js2-function-call"><span class="jcXcovered">onPause</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">paused = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">(visible || is_android);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>visible) {
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.prompt'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">hidden</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onPause'</span></span><span class="jcXcovered">);</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Resume the previously paused terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">resume</span>: <span class="keyword">function</span>(<span class="js2-function-param">silent</span>) {
                <span class="js2-function-call"><span class="jcXcovered">cmd</span></span><span class="js2-function-call">_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="jcXcovered">paused = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled &amp;&amp; terminals.<span class="js2-function-call">front</span>() === self) {
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">(silent);</span>
                    }
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.prompt'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">visible</span></span><span class="jcXcovered">();</span>
                    <span class="keyword">var</span> <span class="variable-name">original</span> = <span class="jcXcovered">delayed_commands</span>;
                    <span class="jcXcovered">delayed_commands = [];</span>
                    <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>; i &lt; original.<span class="js2-object-property">length</span>; ++i) {
                        <span class="jcXcovered">self.</span><span class="js2-object-property"><span class="jcXcovered">exec</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(self, original[i]);</span>
                    }
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">trigger</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'resume'</span></span><span class="jcXcovered">);</span>
                    <span class="keyword">var</span> <span class="variable-name">fn</span> = <span class="jcXcovered">resume_callbacks.</span><span class="js2-function-call"><span class="jcXcovered">shift</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (fn) {
                        <span class="js2-function-call"><span class="jcXcovered">fn</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scroll_to_bottom</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onResume'</span></span><span class="jcXcovered">);</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return the number of characters that fit into the width of
</span>            <span class="comment">// :: the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">cols</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">numChars</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> settings.</span><span class="js2-object-property"><span class="jcXcovered">numChars</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> num_chars === <span class="string">'undefined'</span> || num_chars === 1000) {
                    <span class="jcXcovered">num_chars = </span><span class="js2-function-call"><span class="jcXcovered">get_num_chars</span></span><span class="jcXcovered">(self, char_size);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> num_chars;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return the number of lines that fit into the height of the
</span>            <span class="comment">// :: terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">rows</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">numRows</span>) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> settings.</span><span class="js2-object-property"><span class="jcXcovered">numRows</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> num_rows === <span class="string">'undefined'</span>) {
                    <span class="jcXnot-covered">num_rows = </span><span class="js2-function-call"><span class="jcXnot-covered">get_num_rows</span></span><span class="jcXnot-covered">(self, char_size);</span>
                }
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> num_rows;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return the History object
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">history</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> command_line.</span><span class="js2-function-call"><span class="jcXcovered">history</span></span><span class="jcXcovered">();</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: toggle recording of history state
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">history_state</span>: <span class="keyword">function</span>(<span class="js2-function-param">toggle</span>) {
                <span class="keyword">function</span> <span class="function-name">run</span>() {
                    <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">historyState</span></span><span class="jcXcovered"> = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>save_state.<span class="js2-object-property">length</span>) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">save_state</span></span><span class="jcXcovered">();</span>
                    }<span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">else</span></span><span class="jcXnot-covered"> </span><span class="keyword">if</span> (terminals.<span class="js2-function-call">length</span>() &gt; 1) {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">save_state</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">null</span></span><span class="jcXnot-covered">);</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (toggle) {
                    <span class="comment">// if set to true and if set from user command we need
</span>                    <span class="comment">// not to include the command
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> window.<span class="js2-object-property">setImmediate</span> === <span class="string">'undefined'</span>) {
                        <span class="js2-function-call"><span class="jcXnot-covered">setTimeout</span></span><span class="jcXnot-covered">(run, 0);</span>
                    } <span class="keyword">else</span> {
                        <span class="js2-function-call"><span class="jcXcovered">setImmediate</span></span><span class="jcXcovered">(run);</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">historyState</span></span><span class="jcXnot-covered"> = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: clear the history state
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">clear_history_state</span>: <span class="keyword">function</span>() {
                <span class="jcXcovered">hash_commands = [];</span>
                <span class="jcXcovered">save_state = [];</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Switch to the next terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">next</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (terminals.<span class="js2-function-call">length</span>() === 1) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self;</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">front</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
                    <span class="keyword">var</span> <span class="variable-name">next</span> = <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">rotate</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">()</span>;
                    <span class="comment">// 50 provides buffer in viewport
</span>                    <span class="keyword">var</span> <span class="variable-name">x</span> = <span class="jcXcovered">next.</span><span class="js2-function-call"><span class="jcXcovered">offset</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">top</span></span><span class="jcXcovered"> - 50</span>;
                    <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'html,body'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">animate</span></span><span class="jcXcovered">({</span><span class="js2-object-property"><span class="jcXcovered">scrollTop</span></span><span class="jcXcovered">: x}, 500);</span>
                    <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                        <span class="js2-function-call"><span class="jcXcovered">trigger_terminal_change</span></span><span class="jcXcovered">(next);</span>
                    } <span class="keyword">catch</span> (e) {
                        <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'onTerminalChange'</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> next;</span>
                }
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Make the terminal in focus or blur depending on the first
</span>            <span class="comment">// :: argument. If there is more then one terminal it will
</span>            <span class="comment">// :: switch to next one, if the second argument is set to true
</span>            <span class="comment">// :: the events will be not fired. Used on init
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">focus</span>: <span class="keyword">function</span>(<span class="js2-function-param">toggle</span>, <span class="js2-function-param">silent</span>) {
                <span class="js2-function-call"><span class="jcXcovered">cmd</span></span><span class="js2-function-call">_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (terminals.<span class="js2-function-call">length</span>() === 1) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (toggle === <span class="constant">false</span>) {
                            <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">disable</span></span><span class="jcXnot-covered">(silent);</span>
                        } <span class="keyword">else</span> {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">(silent);</span>
                        }
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (toggle === <span class="constant">false</span>) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">next</span></span><span class="jcXcovered">();</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword">var</span> <span class="variable-name">front</span> = <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">front</span></span><span class="jcXcovered">()</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (front !== self) {
                            <span class="comment">// there should be only from terminal enabled but tests
</span>                            <span class="comment">// sometime fail because there where more them one
</span>                            <span class="comment">// where cursor have blink class
</span>                            <span class="jcXcovered">ter</span>minals.<span class="js2-function-call">forEach</span>(<span class="keyword">function</span>(<span class="js2-function-param">terminal</span>) {
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (terminal !== self &amp;&amp; terminal.<span class="js2-function-call">enabled</span>()) {
                                    <span class="jcXcovered">terminal.</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">(silent);</span>
                                }
                            });
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent) {
                                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                                    <span class="js2-function-call"><span class="jcXcovered">trigger_terminal_change</span></span><span class="jcXcovered">(self);</span>
                                } <span class="keyword">catch</span> (e) {
                                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'onTerminalChange'</span></span><span class="jcXnot-covered">);</span>
                                }
                            }
                        }
                        <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(self);</span>
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">(silent);</span>
                    }
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Disable/Enable terminal that can be enabled by click
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">freeze</span>: <span class="keyword">function</span>(<span class="js2-function-param">freeze</span>) {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (freeze) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
                        <span class="jcXcovered">frozen = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">frozen = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">();</span>
                    }
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: check if terminal is frozen
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">frozen</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> frozen;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Enable the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">enable</span>: <span class="keyword">function</span>(<span class="js2-function-param">silent</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>enabled &amp;&amp; <span class="negation-char">!</span>frozen) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (num_chars === <span class="constant">undefined</span>) {
                        <span class="comment">// enabling first time
</span>                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resize</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">cmd</span></span><span class="js2-function-call">_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                        <span class="keyword">var</span> <span class="variable-name">ret</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent &amp;&amp; <span class="negation-char">!</span>enabled) {
                            <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onFocus'</span></span><span class="jcXcovered">);</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent &amp;&amp; ret === <span class="constant">undefined</span> || silent) {
                            <span class="jcXcovered">enabled = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>self.<span class="js2-function-call">paused</span>()) {
                                <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                            }
                        }
                    });
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Disable the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">disable</span>: <span class="keyword">function</span>(<span class="js2-function-param">silent</span>) {
                <span class="js2-function-call"><span class="jcXcovered">cmd</span></span><span class="js2-function-call">_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="keyword">var</span> <span class="variable-name">ret</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent &amp;&amp; enabled) {
                        <span class="jcXcovered">ret = </span><span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onBlur'</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent &amp;&amp; ret === <span class="constant">undefined</span> || silent) {
                        <span class="jcXcovered">enabled = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
                    }
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: return true if the terminal is enabled
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">enabled</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> enabled;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return the terminal signature depending on the size of the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">signature</span>: <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">cols</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">cols</span></span><span class="jcXcovered">()</span>;
                <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">signatures.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>; i--;) {
                    <span class="keyword">va</span><span class="keyword"><span class="jcXcovered">r</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">lenghts</span></span><span class="jcXcovered"> = </span>signatures[i].<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">line</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> line.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered">;</span>
                    });
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (Math.<span class="js2-object-property">max</span>.<span class="js2-function-call">apply</span>(<span class="constant">null</span>, lenghts) &lt;= cols) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> signatures[i].</span><span class="js2-function-call"><span class="jcXcovered">join</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">) + </span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return the version number
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">version</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-object-property"><span class="jcXcovered">version</span></span><span class="jcXcovered">;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return actual command line object (jquery object with cmd
</span>            <span class="comment">// :: methods)
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">cmd</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> command_line;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return the current command entered by terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">get_command</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> command_line.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">();</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Change the command line to the new one
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">set_command</span>: <span class="keyword">function</span>(<span class="js2-function-param">command</span>, <span class="js2-function-param">silent</span>) {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="comment">// TODO: refactor to use options - breaking change
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> command !== <span class="string">'string'</span>) {
                        <span class="jcXnot-covered">command = JSON.</span><span class="js2-function-call"><span class="jcXnot-covered">stringify</span></span><span class="jcXnot-covered">(command);</span>
                    }
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(command, </span><span class="constant"><span class="jcXcovered">undefined</span></span><span class="jcXcovered">, silent);</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Change position of the command line
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">set_position</span>: <span class="keyword">function</span>(<span class="js2-function-param">position</span>, <span class="js2-function-param">relative</span>) {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">(position, relative);</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return position of the command line
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">get_position</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> command_line.</span><span class="js2-function-call"><span class="jcXcovered">position</span></span><span class="jcXcovered">();</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Insert text into the command line after the cursor
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">insert</span>: <span class="keyword">function</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">stay</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> string === <span class="string">'string'</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                        <span class="keyword">var</span> <span class="variable-name">bottom</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">is_bottom</span></span><span class="jcXcovered">()</span>;
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">insert</span></span><span class="jcXcovered">(string, stay);</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">scrollOnEcho</span> || bottom) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scroll_to_bottom</span></span><span class="jcXcovered">();</span>
                        }
                    });
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXnot-covered">throw</span></span><span class="jcXnot-covered"> </span><span class="keyword"><span class="jcXnot-covered">new</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">Error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">sprintf</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">notAString</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">'insert'</span></span><span class="jcXnot-covered">));</span>
                }
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Set the prompt of the command line
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">set_prompt</span>: <span class="keyword">function</span>(<span class="js2-function-param">prompt</span>) {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(prompt)) {
                        <span class="jcXcovered">com</span>mand_line.<span class="js2-function-call">prompt</span>(<span class="keyword">function</span>(<span class="js2-function-param">callback</span>) {
                            <span class="jcXcovered">prompt.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, callback, self);</span>
                        });
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">prompt</span></span><span class="jcXcovered">(prompt);</span>
                    }
                    <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span><span class="jcXcovered"> = prompt;</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return the prompt used by the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">get_prompt</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span><span class="jcXcovered">;</span>
                <span class="comment">// command_line.prompt(); - can be a wrapper
</span>                <span class="comment">//return command_line.prompt();
</span>            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Enable or Disable mask depedning on the passed argument
</span>            <span class="comment">// :: the mask can also be character (in fact it will work with
</span>            <span class="comment">// :: strings longer then one)
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">set_mask</span>: <span class="keyword">function</span>(<span class="js2-function-param">mask</span>) {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">mask</span></span><span class="jcXcovered">(mask === </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered"> ? settings.</span><span class="js2-object-property"><span class="jcXcovered">maskChar</span></span><span class="jcXcovered"> : mask);</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return the ouput of the terminal as text
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">get_output</span>: <span class="keyword">function</span>(<span class="js2-function-param">raw</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (raw) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> lines;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> $.</span><span class="js2-function-call"><span class="jcXcovered">map</span></span><span class="jcXcovered">(l</span>ines, <span class="keyword">function</span>(<span class="js2-function-param">item</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">is_function</span></span><span class="jcXcovered">(item[0]) ? item[0]() : item[0];</span>
                    }).<span class="js2-function-call">join</span>(<span class="string">'\n'</span>);
                }
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Recalculate and redraw everything
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">resize</span>: <span class="keyword">function</span>(<span class="js2-function-param">width</span>, <span class="js2-function-param">height</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>self.<span class="js2-function-call">is</span>(<span class="string">':visible'</span>)) {
                    <span class="comment">// delay resize if terminal not visible
</span>                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">stopTime</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'resize'</span></span><span class="jcXnot-covered">);</span>
                    <span class="jcXnot-covered">sel</span>f.<span class="js2-function-call">oneTime</span>(500, <span class="string">'resize'</span>, <span class="keyword">function</span>() {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">resize</span></span><span class="jcXnot-covered">(width, height);</span>
                    });
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (width &amp;&amp; height) {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">width</span></span><span class="jcXnot-covered">(width);</span>
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">height</span></span><span class="jcXnot-covered">(height);</span>
                    }
                    <span class="jcXcovered">width = self.</span><span class="js2-function-call"><span class="jcXcovered">width</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">height = self.</span><span class="js2-function-call"><span class="jcXcovered">height</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> settings.<span class="js2-object-property">numChars</span> !== <span class="string">'undefined'</span> ||
                        <span class="keyword">typeof</span> settings.<span class="js2-object-property">numRows</span> !== <span class="string">'undefined'</span>) {
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">resize</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">numChars</span></span><span class="jcXcovered">);</span>
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">refresh</span></span><span class="jcXcovered">();</span>
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword">var</span> <span class="variable-name">new_num_chars</span> = <span class="js2-function-call"><span class="jcXcovered">get_num_chars</span></span><span class="jcXcovered">(self, char_size)</span>;
                    <span class="keyword">var</span> <span class="variable-name">new_num_rows</span> = <span class="js2-function-call"><span class="jcXcovered">get_num_rows</span></span><span class="jcXcovered">(self, char_size)</span>;
                    <span class="comment">// only if number of chars changed
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (new_num_chars !== num_chars ||
                        new_num_rows !== num_rows) {
                        <span class="jcXcovered">num_chars = new_num_chars;</span>
                        <span class="jcXcovered">num_rows = new_num_rows;</span>
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">resize</span></span><span class="jcXcovered">(num_chars);</span>
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">refresh</span></span><span class="jcXcovered">();</span>
                        <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onResize'</span></span><span class="jcXcovered">);</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: redraw the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">refresh</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (char_size.<span class="js2-object-property">width</span> !== 0) {
                    <span class="jcXnot-covered">self[0].</span><span class="js2-object-property"><span class="jcXnot-covered">style</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">setProperty</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'--char-width'</span></span><span class="jcXnot-covered">, char_size.</span><span class="js2-object-property"><span class="jcXnot-covered">width</span></span><span class="jcXnot-covered">);</span>
                }
                <span class="js2-function-call"><span class="jcXcovered">red</span></span><span class="js2-function-call">raw</span>({
                    <span class="js2-object-property">scroll</span>: <span class="constant">false</span>,
                    <span class="js2-object-property">update</span>: <span class="constant">true</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Flush the output to the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">flush</span>: <span class="keyword">function</span>(<span class="js2-function-param">options</span>) {
                <span class="jcXcovered">options = $.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span>({}, {
                    <span class="js2-object-property">update</span>: <span class="constant">false</span>,
                    <span class="js2-object-property">scroll</span>: <span class="constant">true</span>
                }, options || {});
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="keyword">var</span> <span class="variable-name">bottom</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">is_bottom</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword">var</span> <span class="variable-name">wrapper</span>;
                    <span class="comment">// print all lines
</span>                    <span class="comment">// var output_buffer = lines.flush();
</span>                    <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">ach</span>(output_buffer, <span class="keyword">function</span>(<span class="js2-function-param">i</span>, <span class="js2-function-param">data</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data === NEW_LINE) {
                            <span class="jcXcovered">wrapper = </span><span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;div&gt;&lt;/div&gt;'</span></span><span class="jcXcovered">);</span>
                        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> ($.<span class="js2-function-call">isPlainObject</span>(data) &amp;&amp; <span class="js2-function-call">is_function</span>(data.<span class="js2-object-property">finalize</span>)) {
                            <span class="comment">// this is finalize function from echo
</span>                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options.<span class="js2-object-property">update</span>) {
                                <span class="keyword">var</span> <span class="variable-name">selector</span> = <span class="string"><span class="jcXcovered">'&gt; div[data-index='</span></span><span class="jcXcovered"> + data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered"> + </span><span class="string"><span class="jcXcovered">']'</span></span>;
                                <span class="keyword">var</span> <span class="variable-name">node</span> = <span class="jcXcovered">output.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(selector)</span>;
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (node.<span class="js2-function-call">html</span>() !== wrapper.<span class="js2-function-call">html</span>()) {
                                    <span class="jcXcovered">node.</span><span class="js2-function-call"><span class="jcXcovered">replaceWith</span></span><span class="jcXcovered">(wrapper);</span>
                                }
                            } <span class="keyword">else</span> {
                                <span class="jcXcovered">wrapper.</span><span class="js2-function-call"><span class="jcXcovered">appendTo</span></span><span class="jcXcovered">(output);</span>
                            }
                            <span class="jcXcovered">data.</span><span class="js2-function-call"><span class="jcXcovered">finalize</span></span><span class="jcXcovered">(wrapper.</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'data-index'</span></span><span class="jcXcovered">, data.</span><span class="js2-object-property"><span class="jcXcovered">index</span></span><span class="jcXcovered">));</span>
                        } <span class="keyword">else</span> {
                            <span class="keyword">var</span> <span class="variable-name">line</span> = <span class="jcXcovered">data.</span><span class="js2-object-property"><span class="jcXcovered">line</span></span>;
                            <span class="keyword">var</span> <span class="variable-name">div</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;div/&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">html</span></span><span class="jcXcovered">(line)
   </span>                             .<span class="js2-function-call">appendTo</span>(wrapper).<span class="js2-function-call">width</span>(<span class="string">'100%'</span>);
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (data.<span class="js2-object-property">newline</span>) {
                                <span class="jcXcovered">div.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'end-line'</span></span><span class="jcXcovered">);</span>
                            }
                        }
                    });
                    <span class="js2-function-call"><span class="jcXcovered">limit_lines</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onFlush'</span></span><span class="jcXcovered">);</span>
                    <span class="comment">//num_rows = get_num_rows(self, char_size);
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ((settings.<span class="js2-object-property">scrollOnEcho</span> &amp;&amp; options.<span class="js2-object-property">scroll</span>) || bottom) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scroll_to_bottom</span></span><span class="jcXcovered">();</span>
                    }
                } <span class="keyword">catch</span> (e1) {
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">exceptionHandler</span>)) {
                        <span class="keyword"><span class="jcXnot-covered">t</span></span><span class="keyword">ry</span> {
                            <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">exceptionHandler</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, e1, </span><span class="string"><span class="jcXnot-covered">'TERMINAL (Flush)'</span></span><span class="jcXnot-covered">);</span>
                        } <span class="keyword">catch</span> (e2) {
                            <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">exceptionHandler</span></span><span class="jcXnot-covered"> = $.</span><span class="js2-object-property"><span class="jcXnot-covered">noop</span></span><span class="jcXnot-covered">;</span>
                            <span class="js2-function-call"><span class="jcXnot-covered">alert_exception</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'[exceptionHandler]'</span></span><span class="jcXnot-covered">, e2);</span>
                        }
                    } <span class="keyword">else</span> {
                        <span class="js2-function-call"><span class="jcXnot-covered">alert_exception</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'[Flush]'</span></span><span class="jcXnot-covered">, e1);</span>
                    }
                } <span class="keyword">finally</span> {
                    <span class="jcXcovered">output_buffer = [];</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Update the output line - line number can be negative
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">update</span>: <span class="keyword">function</span>(<span class="js2-function-param">line</span>, <span class="js2-function-param">string</span>, <span class="js2-function-param">options</span>) {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (line &lt; 0) {
                        <span class="jcXcovered">line = lines.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> + line;</span> <span class="comment">// yes +
</span>                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>lines[line]) {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'Invalid line number '</span></span><span class="jcXnot-covered"> + line);</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (string === <span class="constant">null</span>) {
                        <span class="jcXcovered">lines.</span><span class="js2-function-call"><span class="jcXcovered">splice</span></span><span class="jcXcovered">(line, 1);</span>
                        <span class="jcXcovered">output.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'[data-index='</span></span><span class="jcXcovered"> + line + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">lines[line][0] = string;</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (options) {
                            <span class="jcXcovered">lines[line][1] = options;</span>
                        }
                        <span class="js2-function-call"><span class="jcXcovered">pro</span></span><span class="js2-function-call">cess_line</span>({
                            <span class="js2-object-property">string</span>: string,
                            <span class="js2-object-property">index</span>: line,
                            <span class="js2-object-property">options</span>: options
                        });
                        <span class="jcXcovered">sel</span>f.<span class="js2-function-call">flush</span>({
                            <span class="js2-object-property">scroll</span>: <span class="constant">false</span>,
                            <span class="js2-object-property">update</span>: <span class="constant">true</span>
                        });
                    }
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: convenience method for removing selected line
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">remove_line</span>: <span class="keyword">function</span>(<span class="js2-function-param">line</span>) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self.</span><span class="js2-function-call"><span class="jcXnot-covered">update</span></span><span class="jcXnot-covered">(line, </span><span class="constant"><span class="jcXnot-covered">null</span></span><span class="jcXnot-covered">);</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: return index of last line in case when you need to update
</span>            <span class="comment">// :: after something is echo on the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">last_index</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> lines.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> - 1;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Print data to the terminal output. It can have options
</span>            <span class="comment">// :: * flush - indicate that arg should be send to DOM
</span>            <span class="comment">// :: * raw - indicate if it should handle input as html
</span>            <span class="comment">// :: * finalize - function call with container div
</span>            <span class="comment">// :: * keepWords - inform how to wrap text
</span>            <span class="comment">// :: * formatters - inform function if it should use formatters
</span>            <span class="comment">// ::   on input string - good to prevent XSS when you want
</span>            <span class="comment">// ::   advanced server side controling of terminal
</span>            <span class="comment">// :: you can echo: promise, function, strings array or string
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">echo</span>: <span class="keyword">function</span>(<span class="js2-function-param">arg</span>, <span class="js2-function-param">options</span>) {
                <span class="keyword">var</span> <span class="variable-name">arg_defined</span> = <span class="jcXcovered">arguments.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span><span class="jcXcovered"> &gt; 0</span>;
                <span class="keyword">function</span> <span class="function-name">echo</span>(<span class="js2-function-param">arg</span>) {
                    <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                        <span class="keyword">var</span> <span class="variable-name">locals</span> = <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">ex</span></span><span class="js2-function-call">tend</span>({
                            <span class="js2-object-property">flush</span>: <span class="constant">true</span>,
                            <span class="js2-object-property">exec</span>: <span class="constant">true</span>,
                            <span class="js2-object-property">raw</span>: settings.<span class="js2-object-property">raw</span>,
                            <span class="js2-object-property">finalize</span>: $.<span class="js2-object-property">noop</span>,
                            <span class="js2-object-property">keepWords</span>: <span class="constant">false</span>,
                            <span class="js2-object-property">invokeMethods</span>: settings.<span class="js2-object-property">invokeMethods</span>,
                            <span class="js2-object-property">formatters</span>: <span class="constant">true</span>,
                            <span class="js2-object-property">allowedAttributes</span>: settings.<span class="js2-object-property">allowedAttributes</span>
                        }, options || {});
                        <span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">function</span></span><span class="jcXcovered">(</span><span class="js2-function-param"><span class="jcXcovered">finalize</span></span><span class="jcXcovered">) </span>{
                            <span class="jcXcovered">lo</span>cals.<span class="function-name">finalize</span> = <span class="keyword">function</span>(<span class="js2-function-param">div</span>) {
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (locals.<span class="js2-object-property">raw</span>) {
                                    <span class="jcXcovered">div.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'raw'</span></span><span class="jcXcovered">);</span>
                                }
                                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(finalize)) {
                                        <span class="js2-function-call"><span class="jcXcovered">finalize</span></span><span class="jcXcovered">(div);</span>
                                    }
                                } <span class="keyword">catch</span> (e) {
                                    <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'USER:echo(finalize)'</span></span><span class="jcXnot-covered">);</span>
                                    <span class="jcXnot-covered">finalize = </span><span class="constant"><span class="jcXnot-covered">null</span></span><span class="jcXnot-covered">;</span>
                                }
                            };
                        })(locals.<span class="js2-object-property">finalize</span>);
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (locals.<span class="js2-object-property">flush</span>) {
                            <span class="comment">// flush buffer if there was no flush after previous echo
</span>                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (output_buffer.<span class="js2-object-property">length</span>) {
                                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">flush</span></span><span class="jcXcovered">();</span>
                            }
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> arg === <span class="string">'function'</span>) {
                            <span class="jcXcovered">arg = arg.</span><span class="js2-function-call"><span class="jcXcovered">bind</span></span><span class="jcXcovered">(self);</span>
                        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> arg === <span class="string">'undefined'</span>) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arg_defined) {
                                <span class="jcXcovered">arg = </span><span class="js2-function-call"><span class="jcXcovered">String</span></span><span class="jcXcovered">(arg);</span>
                            } <span class="keyword">else</span> {
                                <span class="jcXcovered">arg = </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                            }
                        }
                        <span class="js2-function-call"><span class="jcXcovered">pro</span></span><span class="js2-function-call">cess_line</span>({
                            <span class="js2-object-property">string</span>: arg,
                            <span class="js2-object-property">options</span>: locals,
                            <span class="js2-object-property">index</span>: lines.<span class="js2-object-property">length</span>
                        });
                        <span class="comment">// extended commands should be processed only
</span>                        <span class="comment">// once in echo and not on redraw
</span>                        <span class="jcXcovered">lines</span>.<span class="js2-function-call">push</span>([arg, $.<span class="js2-function-call">extend</span>(locals, {
                            <span class="js2-object-property">exec</span>: <span class="constant">false</span>
                        })]);
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (locals.<span class="js2-object-property">flush</span>) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">flush</span></span><span class="jcXcovered">();</span>
                        }
                    } <span class="keyword">catch</span> (e) {
                        <span class="comment">// if echo throw exception we can't use error to
</span>                        <span class="comment">// display that exception
</span>                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">exceptionHandler</span>)) {
                            <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">exceptionHandler</span></span><span class="jcXnot-covered">.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, e, </span><span class="string"><span class="jcXnot-covered">'TERMINAL (echo)'</span></span><span class="jcXnot-covered">);</span>
                        } <span class="keyword">else</span> {
                            <span class="js2-function-call"><span class="jcXnot-covered">alert_exception</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'[Terminal.echo]'</span></span><span class="jcXnot-covered">, e);</span>
                        }
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arg !== <span class="constant">undefined</span> &amp;&amp; <span class="js2-function-call">is_function</span>(arg.<span class="js2-object-property">then</span>)) {
                    <span class="jcXnot-covered">$.</span><span class="js2-function-call"><span class="jcXnot-covered">when</span></span><span class="jcXnot-covered">(arg).</span><span class="js2-function-call"><span class="jcXnot-covered">done</span></span><span class="jcXnot-covered">(echo);</span>
                } <span class="keyword">else</span> {
                    <span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(arg);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: echo red text
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">error</span>: <span class="keyword">function</span>(<span class="js2-function-param">message</span>, <span class="js2-function-param">options</span>) {
                <span class="jcXcovered">options = $.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span><span class="jcXcovered">({}, options, {</span><span class="js2-object-property"><span class="jcXcovered">raw</span></span><span class="jcXcovered">: </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">, </span><span class="js2-object-property"><span class="jcXcovered">formatters</span></span><span class="jcXcovered">: </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">});</span>
                <span class="keyword">function</span> <span class="function-name">format</span>(<span class="js2-function-param">string</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> string !== <span class="string">'string'</span>) {
                        <span class="jcXnot-covered">string = </span><span class="js2-function-call"><span class="jcXnot-covered">String</span></span><span class="jcXnot-covered">(string);</span>
                    }
                    <span class="comment">// quick hack to fix trailing backslash
</span>                    <span class="keyword">var</span> <span class="variable-name">str</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_brackets</span></span><span class="jcXcovered">(</span>string).
                        <span class="js2-function-call">replace</span>(<span class="string">/\\$/</span>, <span class="string">'&amp;#92;'</span>).
                        <span class="js2-function-call">replace</span>(url_re, <span class="string">']$1[[;;;error]'</span>);
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'[[;;;error]'</span></span><span class="jcXcovered"> + str + </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered">;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> message === <span class="string">'function'</span>) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self.</span><span class="js2-function-call">echo</span>(<span class="keyword">function</span>() {
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="js2-function-call"><span class="jcXnot-covered">format</span></span><span class="jcXnot-covered">(message.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self));</span>
                    }, options);
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (message &amp;&amp; message.<span class="js2-object-property">then</span>) {
                    <span class="jcXnot-covered">mes</span>sage.<span class="js2-function-call">then</span>(<span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">echo</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">format</span></span><span class="jcXnot-covered">(string));</span>
                    });
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> self;</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self.</span><span class="js2-function-call"><span class="jcXcovered">echo</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">format</span></span><span class="jcXcovered">(message), options);</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Display Exception on terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">exception</span>: <span class="keyword">function</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">label</span>) {
                <span class="keyword">var</span> <span class="variable-name">message</span> = <span class="js2-function-call"><span class="jcXcovered">exception_message</span></span><span class="jcXcovered">(e)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (label) {
                    <span class="jcXcovered">message = </span><span class="string"><span class="jcXcovered">'&amp;#91;'</span></span><span class="jcXcovered"> + label + </span><span class="string"><span class="jcXcovered">'&amp;#93;: '</span></span><span class="jcXcovered"> + message;</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (message) {
                    <span class="jcXcovered">sel</span>f.<span class="js2-function-call">error</span>(message, {
                        <span class="function-name">finalize</span>: <span class="keyword">function</span>(<span class="js2-function-param">div</span>) {
                            <span class="jcXcovered">div.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'exception message'</span></span><span class="jcXcovered">);</span>
                        },
                        <span class="js2-object-property">keepWords</span>: <span class="constant">true</span>
                    });
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> e.<span class="js2-object-property">fileName</span> === <span class="string">'string'</span>) {
                    <span class="comment">// display filename and line which throw exeption
</span>                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pause</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">softPause</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">(e.</span><span class="js2-object-property"><span class="jcXcovered">fil</span></span><span class="js2-object-property">eName</span>, <span class="keyword">function</span>(<span class="js2-function-param">file</span>) {
                        <span class="keyword">var</span> <span class="variable-name">num</span> = <span class="jcXcovered">e.</span><span class="js2-object-property"><span class="jcXcovered">lineNumber</span></span><span class="jcXcovered"> - 1</span>;
                        <span class="keyword">var</span> <span class="variable-name">line</span> = <span class="jcXcovered">file.</span><span class="js2-function-call"><span class="jcXcovered">split</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'\n'</span></span><span class="jcXcovered">)[num]</span>;
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (line) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">error</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'['</span></span><span class="jcXcovered"> + e.</span><span class="js2-object-property"><span class="jcXcovered">lineNumber</span></span><span class="jcXcovered"> + </span><span class="string"><span class="jcXcovered">']: '</span></span><span class="jcXcovered"> + line);</span>
                        }
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                    }, <span class="string">'text'</span>);
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (e.<span class="js2-object-property">stack</span>) {
                    <span class="keyword">var</span> <span class="variable-name">stack</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">escape_brackets</span></span><span class="jcXcovered">(e.</span><span class="js2-object-property"><span class="jcXcovered">stack</span></span><span class="jcXcovered">)</span>;
                    <span class="jcXcovered">sel</span>f.<span class="js2-function-call">echo</span>(stack.<span class="js2-function-call">split</span>(<span class="string">/\n/g</span>).<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">trace</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">'[</span></span><span class="string">[;;;error]'</span> + trace.<span class="js2-function-call">replace</span>(url_re, <span class="keyword">function</span>(<span class="js2-function-param">url</span>) {
                            <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> </span><span class="string"><span class="jcXcovered">']'</span></span><span class="jcXcovered"> + url + </span><span class="string"><span class="jcXcovered">'[[;;;error]'</span></span><span class="jcXcovered">;</span>
                        }) + <span class="string">']'</span>;
                    }).<span class="js2-function-call">join</span>(<span class="string">'\n'</span>), {
                        <span class="function-name">finalize</span>: <span class="keyword">function</span>(<span class="js2-function-param">div</span>) {
                            <span class="jcXcovered">div.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'exception stack-trace'</span></span><span class="jcXcovered">);</span>
                        },
                        <span class="js2-object-property">formatters</span>: <span class="constant">false</span>
                    });
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Scroll Div that holds the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">scroll</span>: <span class="keyword">function</span>(<span class="js2-function-param">amount</span>) {
                <span class="keyword">var</span> <span class="variable-name">pos</span>;
                <span class="jcXcovered">amount = Math.</span><span class="builtin"><span class="jcXcovered">round</span></span><span class="jcXcovered">(amount);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-object-property">prop</span>) { <span class="comment">// work with jQuery &gt; 1.6
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (amount &gt; self.<span class="js2-function-call">prop</span>(<span class="string">'scrollTop'</span>) &amp;&amp; amount &gt; 0) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">prop</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'scrollTop'</span></span><span class="jcXcovered">, 0);</span>
                    }
                    <span class="jcXcovered">pos = self.</span><span class="js2-function-call"><span class="jcXcovered">prop</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'scrollTop'</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scrollTop</span></span><span class="jcXcovered">(pos + amount);</span>
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (amount &gt; self.<span class="js2-function-call">attr</span>(<span class="string">'scrollTop'</span>) &amp;&amp; amount &gt; 0) {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">attr</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'scrollTop'</span></span><span class="jcXnot-covered">, 0);</span>
                    }
                    <span class="jcXnot-covered">pos = self.</span><span class="js2-function-call"><span class="jcXnot-covered">attr</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'scrollTop'</span></span><span class="jcXnot-covered">);</span>
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">scrollTop</span></span><span class="jcXnot-covered">(pos + amount);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Exit all interpreters and logout. The function will throw
</span>            <span class="comment">// :: exception if there is no login provided
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">logout</span>: <span class="keyword">function</span>(<span class="js2-function-param">local</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (in_login) {
                    <span class="keyword"><span class="jcXcovered">throw</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">Error</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">sprintf</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">strings</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">notWhileLogin</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'logout'</span></span><span class="jcXcovered">));</span>
                }
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (local) {
                        <span class="keyword">var</span> <span class="variable-name">login</span> = <span class="jcXcovered">logins.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">()</span>;
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set_token</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">undefined</span></span><span class="jcXcovered">, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                        <span class="jcXcovered">self.</span><span class="js2-object-property"><span class="jcXcovered">login</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(self, login);</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (interpreters.<span class="js2-function-call">size</span>() === 1 &amp;&amp; self.<span class="js2-function-call">token</span>()) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">logout</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXnot-covered">w</span></span><span class="keyword">hile</span> (interpreters.<span class="js2-function-call">size</span>() &gt; 1) {
                            <span class="comment">// pop will call global_logout that will call login
</span>                            <span class="comment">// and size will be &gt; 0; this is workaround the problem
</span>                            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">token</span>()) {
                                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">logout</span></span><span class="jcXnot-covered">(</span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">).</span><span class="js2-function-call"><span class="jcXnot-covered">pop</span></span><span class="jcXnot-covered">().</span><span class="js2-function-call"><span class="jcXnot-covered">pop</span></span><span class="jcXnot-covered">();</span>
                            } <span class="keyword">else</span> {
                                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">pop</span></span><span class="jcXnot-covered">();</span>
                            }
                        }
                    }
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Function returns the token returned by callback function
</span>            <span class="comment">// :: in login function. It does nothing (return undefined) if
</span>            <span class="comment">// :: there is no login
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">token</span>: <span class="keyword">function</span>(<span class="js2-function-param">local</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> storage.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">(self.</span><span class="js2-function-call"><span class="jcXcovered">prefix_name</span></span><span class="jcXcovered">(local) + </span><span class="string"><span class="jcXcovered">'_token'</span></span><span class="jcXcovered">);</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Function sets the token to the supplied value. This function
</span>            <span class="comment">// :: works regardless of wherer settings.login is supplied
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">set_token</span>: <span class="keyword">function</span>(<span class="js2-function-param">token</span>, <span class="js2-function-param">local</span>) {
                <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">prefix_name</span></span><span class="jcXcovered">(local) + </span><span class="string"><span class="jcXcovered">'_token'</span></span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> token === <span class="string">'undefined'</span>) {
                    <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(name);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="jcXcovered">(name, token);</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Function get the token either set by the login method or
</span>            <span class="comment">// :: by the set_token method.
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">get_token</span>: <span class="keyword">function</span>(<span class="js2-function-param">local</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self.</span><span class="js2-function-call"><span class="jcXcovered">token</span></span><span class="jcXcovered">(local);</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Function return Login name entered by the user
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">login_name</span>: <span class="keyword">function</span>(<span class="js2-function-param">local</span>) {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> storage.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">(self.</span><span class="js2-function-call"><span class="jcXcovered">prefix_name</span></span><span class="jcXcovered">(local) + </span><span class="string"><span class="jcXcovered">'_login'</span></span><span class="jcXcovered">);</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Function returns the name of current interpreter
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">name</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered">;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Function return prefix name for login/token
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">prefix_name</span>: <span class="keyword">function</span>(<span class="js2-function-param">local</span>) {
                <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="jcXcovered">(set</span>tings.<span class="js2-object-property">name</span> ? settings.<span class="js2-object-property">name</span> + <span class="string">'_'</span> : <span class="string">''</span>) +
                    terminal_id;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (local &amp;&amp; interpreters.<span class="js2-function-call">size</span>() &gt; 1) {
                    <span class="keyword">var</span> <span class="variable-name">local_name</span> = <span class="jcXcovered">inte</span>rpreters.<span class="js2-function-call">map</span>(<span class="keyword">function</span>(<span class="js2-function-param">intrp</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> intrp.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered"> || </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">;</span>
                    }).<span class="js2-function-call">slice</span>(1).<span class="js2-function-call">join</span>(<span class="string">'_'</span>);
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (local_name) {
                        <span class="jcXcovered">name += </span><span class="string"><span class="jcXcovered">'_'</span></span><span class="jcXcovered"> + local_name;</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> name;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: wrapper for common use case
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">read</span>: <span class="keyword">function</span>(<span class="js2-function-param">message</span>, <span class="js2-function-param">success</span>, <span class="js2-function-param">cancel</span>) {
                <span class="comment">// return from read() should not pause terminal
</span>                <span class="jcXcovered">force_awake = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                <span class="keyword">var</span> <span class="variable-name">defer</span> = <span class="jcXcovered">jQuery.</span><span class="js2-function-call"><span class="jcXcovered">Deferred</span></span><span class="jcXcovered">()</span>;
                <span class="keyword">var</span> <span class="variable-name">read</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
                <span class="jcXcovered">sel</span>f.<span class="js2-function-call">push</span>(<span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                    <span class="jcXcovered">read = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">defer.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">(string);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(success)) {
                        <span class="js2-function-call"><span class="jcXcovered">success</span></span><span class="jcXcovered">(string);</span>
                    }
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">history</span>) {
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">history</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">();</span>
                    }
                }, {
                    <span class="js2-object-property">name</span>: <span class="string">'read'</span>,
                    <span class="js2-object-property">history</span>: <span class="constant">false</span>,
                    <span class="js2-object-property">prompt</span>: message || <span class="string">''</span>,
                    <span class="function-name">onExit</span>: <span class="keyword">function</span>() {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>read) {
                            <span class="jcXcovered">defer.</span><span class="js2-function-call"><span class="jcXcovered">reject</span></span><span class="jcXcovered">();</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(cancel)) {
                                <span class="js2-function-call"><span class="jcXcovered">cancel</span></span><span class="jcXcovered">();</span>
                            }
                        }
                    }
                });
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">history</span>) {
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">history</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> defer.</span><span class="js2-function-call"><span class="jcXcovered">promise</span></span><span class="jcXcovered">();</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Push a new interenter on the Stack
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">push</span>: <span class="keyword">function</span>(<span class="js2-function-param">interpreter</span>, <span class="js2-function-param">options</span>) {
                <span class="js2-function-call"><span class="jcXcovered">cmd</span></span><span class="js2-function-call">_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="jcXcovered">options = options || {};</span>
                    <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">defaults</span></span><span class="jcXcovered"> = </span>{
                        <span class="js2-object-property">infiniteLogin</span>: <span class="constant">false</span>
                    };
                    <span class="keyword">var</span> <span class="variable-name">push_settings</span> = <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span><span class="jcXcovered">({}, defaults, options)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>push_settings.<span class="js2-object-property">name</span> &amp;&amp; prev_command) {
                        <span class="comment">// push is called in login
</span>                        <span class="jcXcovered">push_settings.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered"> = prev_command.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (push_settings.<span class="js2-object-property">prompt</span> === <span class="constant">undefined</span>) {
                        <span class="jcXcovered">push_settings.</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span><span class="jcXcovered"> = (push_settings.</span><span class="js2-object-property"><span class="jcXcovered">name</span></span><span class="jcXcovered"> || </span><span class="string"><span class="jcXcovered">'&gt;'</span></span><span class="jcXcovered">) + </span><span class="string"><span class="jcXcovered">' '</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="comment">// names.push(options.name);
</span>                    <span class="keyword">var</span> <span class="variable-name">top</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (top) {
                        <span class="jcXcovered">top.</span><span class="js2-object-property"><span class="jcXcovered">mask</span></span><span class="jcXcovered"> = command_line.</span><span class="js2-function-call"><span class="jcXcovered">mask</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="keyword">var</span> <span class="variable-name">was_paused</span> = <span class="jcXcovered">paused</span>;
                    <span class="keyword">function</span> <span class="function-name">init</span>() {
                        <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onPush'</span></span><span class="jcXcovered">, [top, interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">()]);</span>
                        <span class="js2-function-call"><span class="jcXcovered">prepare_top_interpreter</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="comment">// self.pause();
</span>                    <span class="js2-function-call"><span class="jcXcovered">mak</span></span><span class="js2-function-call">e_interpreter</span>(interpreter, options.<span class="js2-object-property">login</span>, <span class="keyword">function</span>(<span class="js2-function-param">ret</span>) {
                        <span class="comment">// result is object with interpreter and completion properties
</span>                        <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">($.</span><span class="js2-function-call"><span class="jcXcovered">extend</span></span><span class="jcXcovered">({}, ret, push_settings));</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (push_settings.<span class="js2-object-property">completion</span> === <span class="constant">true</span>) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($.<span class="js2-function-call">isArray</span>(ret.<span class="js2-object-property">completion</span>)) {
                                <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">completion</span></span><span class="jcXcovered"> = ret.</span><span class="js2-object-property"><span class="jcXcovered">completion</span></span><span class="jcXcovered">;</span>
                            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="negation-char">!</span>ret.<span class="js2-object-property">completion</span>) {
                                <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">completion</span></span><span class="jcXcovered"> = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                            }
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (push_settings.<span class="js2-object-property">login</span>) {
                            <span class="keyword">var</span> <span class="variable-name">error</span>;
                            <span class="keyword">var</span> <span class="variable-name">type</span> = <span class="js2-function-call"><span class="jcXcovered">get_type</span></span><span class="jcXcovered">(push_settings.</span><span class="js2-object-property"><span class="jcXcovered">login</span></span><span class="jcXcovered">)</span>;
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (type === <span class="string">'function'</span>) {
                                <span class="jcXcovered">error = push_settings.</span><span class="js2-object-property"><span class="jcXcovered">infiniteLogin</span></span><span class="jcXcovered"> ? $.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span><span class="jcXcovered"> : self.</span><span class="js2-object-property"><span class="jcXcovered">pop</span></span><span class="jcXcovered">;</span>
                                <span class="jcXcovered">se</span>lf.<span class="js2-function-call">login</span>(
                                    push_settings.<span class="js2-object-property">login</span>,
                                    push_settings.<span class="js2-object-property">infiniteLogin</span>,
                                    init,
                                    error
                                );
                            }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">get_type</span>(interpreter) === <span class="string">'string'</span> &amp;&amp;
                                       type === <span class="string">'string'</span> || type === <span class="string">'boolean'</span>) {
                                <span class="jcXcovered">error = push_settings.</span><span class="js2-object-property"><span class="jcXcovered">infiniteLogin</span></span><span class="jcXcovered"> ? $.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span><span class="jcXcovered"> : self.</span><span class="js2-object-property"><span class="jcXcovered">pop</span></span><span class="jcXcovered">;</span>
                                <span class="jcXcovered">se</span>lf.<span class="js2-function-call">login</span>(
                                    <span class="js2-function-call">make_json_rpc_login</span>(
                                        interpreter,
                                        push_settings.<span class="js2-object-property">login</span>
                                    ),
                                    push_settings.<span class="js2-object-property">infiniteLogin</span>,
                                    init,
                                    error
                                );
                            }
                        } <span class="keyword">else</span> {
                            <span class="js2-function-call"><span class="jcXcovered">init</span></span><span class="jcXcovered">();</span>
                        }
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>was_paused &amp;&amp; self.<span class="js2-function-call">enabled</span>()) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resume</span></span><span class="jcXcovered">();</span>
                        }
                    });
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Remove the last interpreter from the Stack
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">pop</span>: <span class="keyword">function</span>(<span class="js2-function-param">string</span>, <span class="js2-function-param">silent</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (string !== <span class="constant">undefined</span>) {
                    <span class="js2-function-call"><span class="jcXcovered">echo_command</span></span><span class="jcXcovered">(string);</span>
                }
                <span class="keyword">var</span> <span class="variable-name">token</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">token</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">)</span>;
                <span class="keyword">var</span> <span class="variable-name">top</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (interpreters.<span class="js2-function-call">size</span>() === 1) {
                    <span class="jcXcovered">top = interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">login</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent) {
                            <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onPop'</span></span><span class="jcXcovered">, [top, </span><span class="constant"><span class="jcXcovered">null</span></span><span class="jcXcovered">]);</span>
                        }
                        <span class="js2-function-call"><span class="jcXcovered">global_logout</span></span><span class="jcXcovered">();</span>
                        <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onExit'</span></span><span class="jcXcovered">);</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">error</span></span><span class="jcXnot-covered">(</span><span class="js2-function-call"><span class="jcXnot-covered">strings</span></span><span class="jcXnot-covered">().</span><span class="js2-object-property"><span class="jcXnot-covered">canExitError</span></span><span class="jcXnot-covered">);</span>
                    }
                } <span class="keyword">else</span> {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (token) {
                        <span class="js2-function-call"><span class="jcXnot-covered">clear_loging_storage</span></span><span class="jcXnot-covered">();</span>
                    }
                    <span class="keyword">var</span> <span class="variable-name">current</span> = <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">()</span>;
                    <span class="jcXcovered">top = interpreters.</span><span class="js2-function-call"><span class="jcXcovered">top</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">prepare_top_interpreter</span></span><span class="jcXcovered">();</span>
                    <span class="comment">// restore mask
</span>                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">set_mask</span></span><span class="jcXcovered">(top.</span><span class="js2-object-property"><span class="jcXcovered">mask</span></span><span class="jcXcovered">);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>silent) {
                        <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onPop'</span></span><span class="jcXcovered">, [current, top]);</span>
                    }
                    <span class="comment">// we check in case if you don't pop from password interpreter
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (in_login &amp;&amp; self.<span class="js2-function-call">get_prompt</span>() !== <span class="js2-function-call">strings</span>().<span class="js2-object-property">login</span> + <span class="string">': '</span>) {
                        <span class="jcXcovered">in_login = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(current.<span class="js2-object-property">onExit</span>)) {
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="jcXcovered">current.</span><span class="js2-object-property"><span class="jcXcovered">onExit</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(self, self);</span>
                        } <span class="keyword">catch</span> (e) {
                            <span class="jcXnot-covered">current.</span><span class="js2-object-property"><span class="jcXnot-covered">onExit</span></span><span class="jcXnot-covered"> = $.</span><span class="js2-object-property"><span class="jcXnot-covered">noop</span></span><span class="jcXnot-covered">;</span>
                            <span class="js2-function-call"><span class="jcXnot-covered">display_exception</span></span><span class="jcXnot-covered">(e, </span><span class="string"><span class="jcXnot-covered">'onExit'</span></span><span class="jcXnot-covered">);</span>
                        }
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Change terminal option(s) at runtime
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">option</span>: <span class="keyword">function</span>(<span class="js2-function-param">object_or_name</span>, <span class="js2-function-param">value</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> value === <span class="string">'undefined'</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> object_or_name === <span class="string">'string'</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> settings[object_or_name];</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> object_or_name === <span class="string">'object'</span>) {
                        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">ach</span>(object_or_name, <span class="keyword">function</span>(<span class="js2-function-param">key</span>, <span class="js2-function-param">value</span>) {
                            <span class="jcXcovered">settings[key] = value;</span>
                        });
                    }
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">settings[object_or_name] = value;</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (object_or_name.<span class="js2-function-call">match</span>(<span class="string">/^num(Chars|Rows)$/</span>)) {
                        <span class="js2-function-call"><span class="jcXcovered">redraw</span></span><span class="jcXcovered">();</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: invoke keydown shorcut
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">invoke_key</span>: <span class="keyword">function</span>(<span class="js2-function-param">shortcut</span>) {
                <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">invoke_key</span></span><span class="jcXcovered">(shortcut);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: change terminal keymap at runtime
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">keymap</span>: <span class="keyword">function</span>(<span class="js2-function-param">keymap</span>, <span class="js2-function-param">fn</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (arguments.<span class="js2-object-property">length</span> === 0) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> command_line.</span><span class="js2-function-call"><span class="jcXcovered">keymap</span></span><span class="jcXcovered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> fn === <span class="string">'undefined'</span>) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> keymap === <span class="string">'string'</span>) {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> command_line.</span><span class="js2-function-call"><span class="jcXcovered">keymap</span></span><span class="jcXcovered">(keymap);</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> ($.<span class="js2-function-call">isPlainObject</span>(keymap)) {
                        <span class="comment">// argument is an object
</span>                        <span class="jcXcovered">key</span>map = $.<span class="js2-function-call">omap</span>(keymap || {}, <span class="keyword">function</span>(<span class="js2-function-param">key</span>, <span class="js2-function-param">fn</span>) {
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>new_keymap[key]) {
                                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> fn.</span><span class="js2-function-call"><span class="jcXcovered">bind</span></span><span class="jcXcovered">(self);</span>
                            }
                            <span class="keyword"><span class="jcXnot-covered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">original</span>) {
                                <span class="comment">// new keymap function will get default as 2nd argument
</span>                                <span class="keyword"><span class="jcXnot-covered">ret</span></span><span class="keyword">urn</span> fn.<span class="js2-function-call">call</span>(self, e, <span class="keyword">function</span>() {
                                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> new_keymap[key](e, original);</span>
                                });
                            };
                        });
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">keymap</span></span><span class="jcXcovered">(keymap);</span>
                    }
                }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="keyword">typeof</span> fn === <span class="string">'function'</span>) {
                    <span class="keyword">var</span> <span class="variable-name">key</span> = <span class="jcXcovered">keymap</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>new_keymap[key]) {
                        <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">keymap</span></span><span class="jcXcovered">(key, fn.</span><span class="js2-function-call"><span class="jcXcovered">bind</span></span><span class="jcXcovered">(self));</span>
                    } <span class="keyword">else</span> {
                        <span class="jcXcovered">com</span>mand_line.<span class="js2-function-call">keymap</span>(key, <span class="keyword">function</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">original</span>) {
                            <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> fn.<span class="js2-function-call">call</span>(self, e, <span class="keyword">function</span>() {
                                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> new_keymap[key](e, original);</span>
                            });
                        });
                    }
                }
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Return how deep you are in nested interpreters
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">level</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> interpreters.</span><span class="js2-function-call"><span class="jcXcovered">size</span></span><span class="jcXcovered">();</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Reinitialize the terminal
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">reset</span>: <span class="keyword">function</span>() {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">clear</span></span><span class="jcXcovered">();</span>
                    <span class="keyword"><span class="jcXcovered">w</span></span><span class="keyword">hile</span> (interpreters.<span class="js2-function-call">size</span>() &gt; 1) {
                        <span class="jcXcovered">interpreters.</span><span class="js2-function-call"><span class="jcXcovered">pop</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">initialize</span></span><span class="jcXcovered">();</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Remove all local storage left by terminal, it will not
</span>            <span class="comment">// :: logout you until you refresh the browser
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">purge</span>: <span class="keyword">function</span>() {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="keyword">var</span> <span class="variable-name">prefix</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">prefix_name</span></span><span class="jcXcovered">() + </span><span class="string"><span class="jcXcovered">'_'</span></span>;
                    <span class="keyword">var</span> <span class="variable-name">names</span> = <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">(prefix + </span><span class="string"><span class="jcXcovered">'interpreters'</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (names) {
                        <span class="jcXcovered">$.</span><span class="js2-function-call"><span class="jcXcovered">e</span></span><span class="js2-function-call">ach</span>(JSON.<span class="js2-function-call">parse</span>(names), <span class="keyword">function</span>(<span class="js2-function-param">_</span>, <span class="js2-function-param">name</span>) {
                            <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(name + </span><span class="string"><span class="jcXcovered">'_commands'</span></span><span class="jcXcovered">);</span>
                            <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(name + </span><span class="string"><span class="jcXcovered">'_token'</span></span><span class="jcXcovered">);</span>
                            <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(name + </span><span class="string"><span class="jcXcovered">'_login'</span></span><span class="jcXcovered">);</span>
                        });
                    }
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">purge</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">storage.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(prefix + </span><span class="string"><span class="jcXcovered">'interpreters'</span></span><span class="jcXcovered">);</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: Remove all events and DOM nodes left by terminal, it will
</span>            <span class="comment">// :: not purge the terminal so you will have the same state
</span>            <span class="comment">// :: when you refresh the browser
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">destroy</span>: <span class="keyword">function</span>() {
                <span class="js2-function-call"><span class="jcXcovered">whe</span></span><span class="js2-function-call">n_ready</span>(<span class="keyword">function</span> <span class="function-name">ready</span>() {
                    <span class="jcXcovered">command_line.</span><span class="js2-function-call"><span class="jcXcovered">destroy</span></span><span class="jcXcovered">().</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resizer</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'unbind'</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">font_resizer.</span><span class="js2-function-call"><span class="jcXcovered">resizer</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'unbind'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(document).</span><span class="js2-function-call"><span class="jcXcovered">unbind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.terminal_'</span></span><span class="jcXcovered"> + self.</span><span class="js2-function-call"><span class="jcXcovered">id</span></span><span class="jcXcovered">());</span>
                    <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(window).</span><span class="js2-function-call"><span class="jcXcovered">unbind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.terminal_'</span></span><span class="jcXcovered"> + self.</span><span class="js2-function-call"><span class="jcXcovered">id</span></span><span class="jcXcovered">());</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">unbind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'click wheel mousewheel mousedown mouseup'</span></span><span class="jcXcovered">);</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">removeData</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'termina</span></span><span class="string">l'</span>).<span class="js2-function-call">removeClass</span>(<span class="string">'terminal'</span>).
                        <span class="js2-function-call">unbind</span>(<span class="string">'.terminal'</span>);
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">width</span>) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'width'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">height</span>) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'height'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(window).</span><span class="js2-function-call"><span class="jcXcovered">off</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'blur'</span></span><span class="jcXcovered">, blur_termin</span>al).
                        <span class="js2-function-call">off</span>(<span class="string">'focus'</span>, focus_terminal);
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.terminal-fill'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">stopTime</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">(terminal_id);</span>
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (visibility_observer) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (visibility_observer.<span class="js2-object-property">unobserve</span>) {
                            <span class="jcXcovered">visibility_observer.</span><span class="js2-function-call"><span class="jcXcovered">unobserve</span></span><span class="jcXcovered">(self[0]);</span>
                        } <span class="keyword">else</span> {
                            <span class="js2-function-call"><span class="jcXcovered">clearInterval</span></span><span class="jcXcovered">(visibility_observer);</span>
                        }
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (mutation_observer) {
                        <span class="jcXcovered">mutation_observer.</span><span class="js2-function-call"><span class="jcXcovered">disconnect</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>terminals.<span class="js2-function-call">length</span>()) {
                        <span class="js2-function-call"><span class="jcXnot-covered">$</span></span><span class="jcXnot-covered">(window).</span><span class="js2-function-call"><span class="jcXnot-covered">off</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'hashchange'</span></span><span class="jcXnot-covered">);</span>
                    }
                    <span class="jcXcovered">output.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">wrapper.</span><span class="js2-function-call"><span class="jcXcovered">remove</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">defunct = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                });
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: ref: https://stackoverflow.com/a/18927969/387194
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">scroll_to</span>: <span class="keyword">function</span>(<span class="js2-function-param">elem</span>) {
                <span class="keyword">var</span> <span class="variable-name">scroll</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scrollTop</span></span><span class="jcXcovered">() - self.</span><span class="js2-function-call"><span class="jcXcovered">offset</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">top</span></span><span class="jcXcovered"> + </span><span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(elem).</span><span class="js2-function-call"><span class="jcXcovered">offset</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">top</span></span>;
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scrollTop</span></span><span class="jcXcovered">(scroll);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">scroll_to_bottom</span>: <span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">scrollHeight</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-object-property">prop</span>) {
                    <span class="jcXcovered">scrollHeight = self.</span><span class="js2-function-call"><span class="jcXcovered">prop</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'scrollHeight'</span></span><span class="jcXcovered">);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">scrollHeight = self.</span><span class="js2-function-call"><span class="jcXnot-covered">attr</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'scrollHeight'</span></span><span class="jcXnot-covered">);</span>
                }
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scrollTop</span></span><span class="jcXcovered">(scrollHeight);</span>
                <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
            },
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: return true if terminal div or body is at the bottom
</span>            <span class="comment">// :: is use scrollBottomOffset option as margin for the check
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="function-name">is_bottom</span>: <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">scrollBottomOffset</span> === -1) {
                    <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
                } <span class="keyword">else</span> {
                    <span class="keyword">var</span> <span class="variable-name">scroll_height</span>, <span class="variable-name">scroll_top</span>, <span class="variable-name">height</span>;
                    <span class="jcXcovered">scroll_height = self[0].</span><span class="js2-object-property"><span class="jcXcovered">scrollHeight</span></span><span class="jcXcovered">;</span>
                    <span class="jcXcovered">scroll_top = self.</span><span class="js2-function-call"><span class="jcXcovered">scrollTop</span></span><span class="jcXcovered">();</span>
                    <span class="jcXcovered">height = self.</span><span class="js2-function-call"><span class="jcXcovered">outerHeight</span></span><span class="jcXcovered">();</span>
                    <span class="keyword">var</span> <span class="variable-name">limit</span> = <span class="jcXcovered">scroll_height - settings.</span><span class="js2-object-property"><span class="jcXcovered">scrollBottomOffset</span></span>;
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> scroll_top + height &gt; limit;</span>
                }
            }
        }, <span class="keyword">function</span>(<span class="js2-function-param">name</span>, <span class="js2-function-param">fun</span>) {
            <span class="comment">// wrap all functions and display execptions
</span>            <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (defunct) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>settings.<span class="js2-object-property">exceptionHandler</span>) {
                        <span class="keyword"><span class="jcXcovered">throw</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">Exception</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">strings</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">defunctTerminal</span></span><span class="jcXcovered">);</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> fun.</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(self, [].</span><span class="js2-object-property"><span class="jcXcovered">slice</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">apply</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">arguments</span></span><span class="jcXcovered">));</span>
                } <span class="keyword">catch</span> (e) {
                    <span class="comment">// exec catch by command (resume call exec)
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (name !== <span class="string">'exec'</span> &amp;&amp; name !== <span class="string">'resume'</span>) {
                        <span class="js2-function-call"><span class="jcXcovered">display_exception</span></span><span class="jcXcovered">(e, e.</span><span class="js2-object-property"><span class="jcXcovered">type</span></span><span class="jcXcovered"> || </span><span class="string"><span class="jcXcovered">'TERMINAL'</span></span><span class="jcXcovered">, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
                    }
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>settings.<span class="js2-object-property">exceptionHandler</span>) {
                        <span class="keyword"><span class="jcXcovered">throw</span></span><span class="jcXcovered"> e;</span>
                    }
                }
            };
        }));
        <span class="comment">// -----------------------------------------------------------------
</span>        <span class="comment">// INIT CODE
</span>        <span class="comment">// -----------------------------------------------------------------
</span>        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-object-property">length</span> === 0) {
            <span class="keyword">var</span> <span class="variable-name">msg</span> = <span class="js2-function-call"><span class="jcXcovered">sprintf</span></span><span class="jcXcovered">(</span><span class="js2-function-call"><span class="jcXcovered">strings</span></span><span class="jcXcovered">().</span><span class="js2-object-property"><span class="jcXcovered">invalidSelector</span></span><span class="jcXcovered">)</span>;
            <span class="keyword"><span class="jcXcovered">throw</span></span><span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">Exception</span></span><span class="jcXcovered">(msg);</span>
        }
        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">data</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'terminal'</span></span><span class="jcXcovered">, self);</span>
        <span class="comment">// var names = []; // stack if interpreter names
</span>        <span class="keyword">var</span> <span class="variable-name">prev_command</span>; <span class="comment">// used for name on the terminal if not defined
</span>        <span class="keyword">var</span> <span class="variable-name">tab_count</span> = <span class="jcXcovered">0</span>; <span class="comment">// for tab completion
</span>        <span class="keyword">var</span> <span class="variable-name">output</span>; <span class="comment">// .terminal-output jquery object
</span>        <span class="keyword">var</span> <span class="variable-name">terminal_id</span> = <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">length</span></span><span class="jcXcovered">()</span>;
        <span class="keyword">var</span> <span class="variable-name">force_awake</span> = <span class="constant"><span class="jcXcovered">false</span></span>; <span class="comment">// flag used to don't pause when user return read() call
</span>        <span class="keyword">var</span> <span class="variable-name">num_chars</span>; <span class="comment">// numer of chars in line
</span>        <span class="keyword">var</span> <span class="variable-name">num_rows</span>; <span class="comment">// number of lines that fit without scrollbar
</span>        <span class="keyword">var</span> <span class="variable-name">command</span>; <span class="comment">// for tab completion
</span>        <span class="keyword">var</span> <span class="variable-name">logins</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">Stack</span></span><span class="jcXcovered">()</span>; <span class="comment">// stack of logins
</span>        <span class="keyword">var</span> <span class="variable-name">command_queue</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">DelayQueue</span></span><span class="jcXcovered">()</span>;
        <span class="keyword">var</span> <span class="variable-name">init_queue</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">DelayQueue</span></span><span class="jcXcovered">()</span>;
        <span class="keyword">var</span> <span class="variable-name">when_ready</span> = <span class="js2-function-call"><span class="jcXcovered">ready</span></span><span class="jcXcovered">(init_queue)</span>;
        <span class="keyword">var</span> <span class="variable-name">cmd_ready</span> = <span class="js2-function-call"><span class="jcXcovered">ready</span></span><span class="jcXcovered">(command_queue)</span>;
        <span class="keyword">var</span> <span class="variable-name">in_login</span> = <span class="constant"><span class="jcXcovered">false</span></span>;<span class="comment">// some Methods should not be called when login
</span>        <span class="comment">// TODO: Try to use mutex like counter for pause/resume
</span>        <span class="keyword">var</span> <span class="variable-name">onPause</span> = <span class="jcXcovered">$.</span><span class="js2-object-property"><span class="jcXcovered">noop</span></span>;<span class="comment">// used to indicate that user call pause onInit
</span>        <span class="keyword">var</span> <span class="variable-name">old_width</span>, <span class="variable-name">old_height</span>;
        <span class="keyword">var</span> <span class="variable-name">delayed_commands</span> = <span class="jcXcovered">[]</span>; <span class="comment">// used when exec commands while paused
</span>        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">settings</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>(
            {},
            $.<span class="js2-object-property">terminal</span>.<span class="js2-object-property">defaults</span>,
            {
                <span class="js2-object-property">name</span>: self.<span class="js2-object-property">selector</span>,
                <span class="js2-object-property">exit</span>: <span class="negation-char">!!</span>(options &amp;&amp; options.<span class="js2-object-property">login</span> || <span class="negation-char">!</span>options)
            },
            options || {}
        );
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> settings.<span class="js2-object-property">width</span> === <span class="string">'number'</span>) {
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">width</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">width</span></span><span class="jcXcovered">);</span>
        }
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> settings.<span class="js2-object-property">height</span> === <span class="string">'number'</span>) {
            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">height</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">height</span></span><span class="jcXcovered">);</span>
        }
        <span class="keyword">var</span> <span class="variable-name">char_size</span> = <span class="js2-function-call"><span class="jcXcovered">get_char_size</span></span><span class="jcXcovered">(self)</span>;
        <span class="comment">// so it's the same as in TypeScript definition for options
</span>        <span class="keyword"><span class="jcXcovered">delete</span></span><span class="jcXcovered"> settings.</span><span class="js2-object-property"><span class="jcXcovered">formatters</span></span><span class="jcXcovered">;</span>
        <span class="comment">// used to throw error when calling methods on destroyed terminal
</span>        <span class="keyword">var</span> <span class="variable-name">defunct</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">lines</span> = <span class="jcXcovered">[]</span>;
        <span class="keyword">var</span> <span class="variable-name">storage</span> = <span class="keyword"><span class="jcXcovered">new</span></span><span class="jcXcovered"> </span><span class="js2-function-call"><span class="jcXcovered">StorageHelper</span></span><span class="jcXcovered">(settings.</span><span class="js2-object-property"><span class="jcXcovered">memory</span></span><span class="jcXcovered">)</span>;
        <span class="keyword">var</span> <span class="variable-name">enabled</span> = <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">enabled</span></span>;
        <span class="keyword">var</span> <span class="variable-name">frozen</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">paused</span> = <span class="constant"><span class="jcXcovered">false</span></span>;
        <span class="keyword">var</span> <span class="variable-name">autologin</span> = <span class="constant"><span class="jcXcovered">true</span></span>; <span class="comment">// set to false if onBeforeLogin return false
</span>        <span class="keyword">var</span> <span class="variable-name">interpreters</span>;
        <span class="keyword">var</span> <span class="variable-name">command_line</span>;
        <span class="keyword">var</span> <span class="variable-name">old_enabled</span>;
        <span class="keyword">var</span> <span class="variable-name">visibility_observer</span>;
        <span class="keyword">var</span> <span class="variable-name">mutation_observer</span>;
        <span class="comment">// backward compatibility
</span>        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">ignoreSystemDescribe</span> === <span class="constant">true</span>) {
            <span class="jcXnot-covered">settings.</span><span class="js2-object-property"><span class="jcXnot-covered">describe</span></span><span class="jcXnot-covered"> = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="comment">// register ajaxSend for cancel requests on CTRL+D
</span>        <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(d</span>ocument).<span class="js2-function-call">bind</span>(<span class="string">'ajaxSend.terminal_'</span> + self.<span class="js2-function-call">id</span>(), <span class="keyword">function</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">xhr</span>) {
            <span class="jcXcovered">requests.</span><span class="js2-function-call"><span class="jcXcovered">push</span></span><span class="jcXcovered">(xhr);</span>
        });
        <span class="keyword">var</span> <span class="variable-name">wrapper</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;div class="terminal-wrapper"/&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">appendTo</span></span><span class="jcXcovered">(self)</span>;
        <span class="keyword">var</span> <span class="variable-name">font_resizer</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;div class="font"&gt;&amp;nbsp;&lt;/div&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">appendTo</span></span><span class="jcXcovered">(self)</span>;
        <span class="keyword">var</span> <span class="variable-name">fill</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;div class="terminal-fill"/&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">appendTo</span></span><span class="jcXcovered">(self)</span>;
        <span class="jcXcovered">output = </span><span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'&lt;div&gt;'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">add</span></span><span class="js2-function-call">Class</span>(<span class="string">'terminal-output'</span>).<span class="js2-function-call">attr</span>(<span class="string">'role'</span>, <span class="string">'log'</span>)
            .<span class="js2-function-call">appendTo</span>(wrapper);
        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">addClass</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'terminal'</span></span><span class="jcXcovered">);</span>
        <span class="comment">// before login event
</span>        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">login</span> &amp;&amp; <span class="js2-function-call">fire_event</span>(<span class="string">'onBeforeLogin'</span>) === <span class="constant">false</span>) {
            <span class="jcXnot-covered">autologin = </span><span class="constant"><span class="jcXnot-covered">false</span></span><span class="jcXnot-covered">;</span>
        }
        <span class="comment">// create json-rpc authentication function
</span>        <span class="keyword">var</span> <span class="variable-name">base_interpreter</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> init_interpreter === <span class="string">'string'</span>) {
            <span class="jcXcovered">base_interpreter = init_interpreter;</span>
        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (<span class="js2-function-call">is_array</span>(init_interpreter)) {
            <span class="comment">// first JSON-RPC
</span>            <span class="keyword"><span class="jcXcovered">f</span></span><span class="keyword">or</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>, <span class="variable-name">len</span> = <span class="jcXcovered">init_interpreter.</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>; i &lt; len; ++i) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> init_interpreter[i] === <span class="string">'string'</span>) {
                    <span class="jcXcovered">base_interpreter = init_interpreter[i];</span>
                    <span class="keyword"><span class="jcXcovered">break</span></span><span class="jcXcovered">;</span>
                }
            }
        }
        <span class="keyword">var</span> <span class="variable-name">global_login_fn</span>;
        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">login</span>)) {
            <span class="jcXcovered">global_login_fn = settings.</span><span class="js2-object-property"><span class="jcXcovered">login</span></span><span class="jcXcovered">;</span>
        }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (base_interpreter &amp;&amp;
            (<span class="keyword">typeof</span> settings.<span class="js2-object-property">login</span> === <span class="string">'string'</span> || settings.<span class="js2-object-property">login</span> === <span class="constant">true</span>)) {
            <span class="jcXcovered">global_login_fn = </span><span class="js2-function-call"><span class="jcXcovered">make_json_rpc_login</span></span><span class="jcXcovered">(base_interpreter, settings.</span><span class="js2-object-property"><span class="jcXcovered">login</span></span><span class="jcXcovered">);</span>
        }
        <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">append</span></span><span class="jcXcovered">(self);</span>
        <span class="keyword">function</span> <span class="function-name">focus_terminal</span>() {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (old_enabled) {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">focus</span></span><span class="jcXnot-covered">();</span>
            }
        }
        <span class="keyword">function</span> <span class="function-name">blur_terminal</span>() {
            <span class="jcXnot-covered">old_enabled = enabled;</span>
            <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">disable</span></span><span class="jcXnot-covered">().</span><span class="js2-function-call"><span class="jcXnot-covered">find</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'.cmd textarea'</span></span><span class="jcXnot-covered">).</span><span class="js2-function-call"><span class="jcXnot-covered">trigger</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'blur'</span></span><span class="jcXnot-covered">, [</span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">]);</span>
        }
        <span class="keyword">function</span> <span class="function-name">context_callback_proxy</span>(<span class="js2-function-param">fn</span>, <span class="js2-function-param">type</span>) {
            <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (fn.<span class="js2-object-property">proxy</span>) {
                <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> fn;</span>
            }
            <span class="keyword">v</span><span class="keyword"><span class="jcXnot-covered">ar</span></span><span class="jcXnot-covered"> </span><span class="function-name"><span class="jcXnot-covered">wrapper</span></span><span class="jcXnot-covered"> = </span><span class="keyword">function</span>(<span class="js2-function-param">callback</span>) {
                <span class="keyword">var</span> <span class="variable-name">ret</span> = <span class="jcXnot-covered">fn.</span><span class="js2-function-call"><span class="jcXnot-covered">call</span></span><span class="jcXnot-covered">(self, callback, self)</span>;
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (ret &amp;&amp; <span class="js2-function-call">is_function</span>(ret.<span class="js2-object-property">then</span>)) {
                    <span class="jcXnot-covered">ret</span>.<span class="js2-function-call">then</span>(<span class="keyword">function</span>(<span class="js2-function-param">string</span>) {
                        <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="keyword">typeof</span> string === type) {
                            <span class="js2-function-call"><span class="jcXnot-covered">callback</span></span><span class="jcXnot-covered">(string);</span>
                        }
                    });
                }
            };
            <span class="jcXnot-covered">wrapper.</span><span class="js2-object-property"><span class="jcXnot-covered">proxy</span></span><span class="jcXnot-covered"> = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
            <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> wrapper;</span>
        }
        <span class="comment">// paste event is not testable in node
</span>        <span class="comment">// istanbul ignore next
</span>        <span class="keyword">function</span> <span class="function-name">paste_event</span>(<span class="js2-function-param">e</span>) {
            e = e.<span class="js2-object-property">originalEvent</span>;
            <span class="comment">// we don't care about browser that don't support clipboard data
</span>            <span class="comment">// those browser simple will not have this feature normal paste
</span>            <span class="comment">// is cross-browser and it's handled by cmd plugin
</span>            <span class="keyword">function</span> <span class="function-name">is_type</span>(<span class="js2-function-param">item</span>, <span class="js2-function-param">type</span>) {
                <span class="keyword">return</span> item.<span class="js2-object-property">type</span>.<span class="js2-function-call">indexOf</span>(type) !== -1;
            }
            <span class="keyword">function</span> <span class="function-name">echo_image</span>(<span class="js2-function-param">image</span>) {
                self.<span class="js2-function-call">echo</span>(<span class="string">'&lt;img src="'</span> + image + <span class="string">'"/&gt;'</span>, {<span class="js2-object-property">raw</span>: <span class="constant">true</span>});
            }
            <span class="keyword">function</span> <span class="function-name">data_uri</span>(<span class="js2-function-param">blob</span>) {
                <span class="keyword">var</span> <span class="variable-name">URL</span> = window.<span class="js2-object-property">URL</span> || window.<span class="js2-object-property">webkitURL</span>;
                <span class="keyword">return</span> URL.<span class="js2-function-call">createObjectURL</span>(blob);
            }
            <span class="keyword">function</span> <span class="function-name">echo</span>(<span class="js2-function-param">object</span>, <span class="js2-function-param">ignoreEvents</span>) {
                <span class="keyword">if</span> (<span class="negation-char">!</span>ignoreEvents &amp;&amp; <span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">onPaste</span>)) {
                    <span class="keyword">var</span> <span class="variable-name">event</span> = {
                        <span class="js2-object-property">target</span>: self
                    };
                    <span class="keyword">if</span> (<span class="keyword">typeof</span> object === <span class="string">'string'</span>) {
                        event[<span class="string">'text'</span>] = object;
                    } <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Blob) {
                        event[<span class="string">'image'</span>] = <span class="js2-function-call">data_uri</span>(object);
                    }
                    <span class="keyword">var</span> <span class="variable-name">ret</span> = <span class="js2-function-call">fire_event</span>(<span class="string">'onPaste'</span>, [event]);
                    <span class="keyword">if</span> (ret) {
                        <span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(ret.<span class="js2-object-property">then</span>)) {
                            <span class="keyword">return</span> ret.<span class="js2-function-call">then</span>(<span class="keyword">function</span>(<span class="js2-function-param">ret</span>) {
                                <span class="js2-function-call">echo</span>(ret, <span class="constant">true</span>);
                            });
                        } <span class="keyword">else</span> {
                            <span class="js2-function-call">echo</span>(ret, <span class="constant">true</span>);
                        }
                    } <span class="keyword">else</span> {
                        <span class="js2-function-call">echo</span>(event.<span class="js2-object-property">image</span> || event.<span class="js2-object-property">text</span>, <span class="constant">true</span>);
                    }
                } <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Blob) {
                    <span class="js2-function-call">echo_image</span>(<span class="js2-function-call">data_uri</span>(object));
                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> object === <span class="string">'string'</span>) {
                    <span class="keyword">if</span> (object.<span class="js2-function-call">match</span>(<span class="string">/^data:/</span>)) {
                        <span class="js2-function-call">echo_image</span>(object);
                    } <span class="keyword">else</span> {
                        self.<span class="js2-function-call">insert</span>(object);
                    }
                }
            }
            <span class="keyword">if</span> (e.<span class="js2-object-property">clipboardData</span>) {
                <span class="keyword">if</span> (self.<span class="js2-function-call">enabled</span>()) {
                    <span class="keyword">var</span> <span class="variable-name">items</span> = e.<span class="js2-object-property">clipboardData</span>.<span class="js2-object-property">items</span>;
                    <span class="keyword">if</span> (items) {
                        <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable-name">i</span> = 0; i &lt; items.<span class="js2-object-property">length</span>; i++) {
                            <span class="keyword">if</span> (<span class="js2-function-call">is_type</span>(items[i], <span class="string">'image'</span>) &amp;&amp; settings.<span class="js2-object-property">pasteImage</span>) {
                                <span class="keyword">var</span> <span class="variable-name">blob</span> = items[i].<span class="js2-function-call">getAsFile</span>();
                                <span class="js2-function-call">echo</span>(blob);
                            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="js2-function-call">is_type</span>(items[i], <span class="string">'text/plain'</span>)) {
                                items[i].<span class="js2-function-call">getAsString</span>(echo);
                            }
                        }
                    } <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="js2-object-property">clipboardData</span>.<span class="js2-object-property">getData</span>) {
                        <span class="keyword">var</span> <span class="variable-name">text</span> = e.<span class="js2-object-property">clipboardData</span>.<span class="js2-function-call">getData</span>(<span class="string">'text/plain'</span>);
                        <span class="js2-function-call">echo</span>(text);
                    }
                    <span class="keyword">return</span> <span class="constant">false</span>;
                }
            }
        }
        <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(document).</span><span class="js2-function-call"><span class="jcXcovered">on</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'paste.terminal_'</span></span><span class="jcXcovered"> + self.</span><span class="js2-function-call"><span class="jcXcovered">id</span></span><span class="jcXcovered">(), paste_event);</span>
        <span class="keyword">v</span><span class="keyword"><span class="jcXcovered">ar</span></span><span class="jcXcovered"> </span><span class="variable-name"><span class="jcXcovered">new_keymap</span></span><span class="jcXcovered"> = </span>$.<span class="js2-function-call">extend</span>(
            {},
            keymap,
            $.<span class="js2-function-call">omap</span>(settings.<span class="js2-object-property">keymap</span> || {}, <span class="keyword">function</span>(<span class="js2-function-param">key</span>, <span class="js2-function-param">fn</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>keymap[key]) {
                    <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> fn.</span><span class="js2-function-call"><span class="jcXcovered">bind</span></span><span class="jcXcovered">(self);</span>
                }
                <span class="keyword"><span class="jcXcovered">re</span></span><span class="keyword">turn</span> <span class="keyword">function</span>(<span class="js2-function-param">e</span>, <span class="js2-function-param">original</span>) {
                    <span class="comment">// new keymap function will get default as 2nd argument
</span>                    <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> fn.<span class="js2-function-call">call</span>(self, e, <span class="keyword">function</span>() {
                        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> keymap[key](e, original);</span>
                    });
                };
            })
        );
        <span class="js2-function-call"><span class="jcXcovered">mak</span></span><span class="js2-function-call">e_interpreter</span>(init_interpreter, settings.<span class="js2-object-property">login</span>, <span class="keyword">function</span>(<span class="js2-function-param">interpreter</span>) {
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">completion</span> &amp;&amp; <span class="keyword">typeof</span> settings.<span class="js2-object-property">completion</span> !== <span class="string">'boolean'</span> ||
                <span class="negation-char">!</span>settings.<span class="js2-object-property">completion</span>) {
                <span class="comment">// overwrite interpreter completion by global setting #224
</span>                <span class="comment">// we use string to indicate that it need to be taken from settings
</span>                <span class="comment">// so we are able to change it using option API method
</span>                <span class="jcXcovered">interpreter.</span><span class="js2-object-property"><span class="jcXcovered">completion</span></span><span class="jcXcovered"> = </span><span class="string"><span class="jcXcovered">'settings'</span></span><span class="jcXcovered">;</span>
            }
            <span class="keyword">var</span> <span class="variable-name">prompt</span> = <span class="jcXcovered">settings.</span><span class="js2-object-property"><span class="jcXcovered">prompt</span></span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(prompt)) {
                <span class="jcXnot-covered">prompt = </span><span class="js2-function-call"><span class="jcXnot-covered">context_callback_proxy</span></span><span class="jcXnot-covered">(prompt, </span><span class="string"><span class="jcXnot-covered">'string'</span></span><span class="jcXnot-covered">);</span>
            }
            <span class="jcXcovered">interpreters = </span><span class="keyword"><span class="jcXcovered">ne</span></span><span class="keyword">w</span> <span class="js2-function-call">Stack</span>($.<span class="js2-function-call">extend</span>({}, settings.<span class="js2-object-property">extra</span>, {
                <span class="js2-object-property">name</span>: settings.<span class="js2-object-property">name</span>,
                <span class="js2-object-property">prompt</span>: prompt,
                <span class="js2-object-property">keypress</span>: settings.<span class="js2-object-property">keypress</span>,
                <span class="js2-object-property">keydown</span>: settings.<span class="js2-object-property">keydown</span>,
                <span class="js2-object-property">resize</span>: settings.<span class="js2-object-property">onResize</span>,
                <span class="js2-object-property">greetings</span>: settings.<span class="js2-object-property">greetings</span>,
                <span class="js2-object-property">mousewheel</span>: settings.<span class="js2-object-property">mousewheel</span>,
                <span class="js2-object-property">history</span>: settings.<span class="js2-object-property">history</span>,
                <span class="js2-object-property">keymap</span>: new_keymap
            }, interpreter));
            <span class="comment">// CREATE COMMAND LINE
</span>            <span class="jcXcovered">com</span>mand_line = <span class="js2-function-call">$</span>(<span class="string">'&lt;div/&gt;'</span>).<span class="js2-function-call">appendTo</span>(wrapper).<span class="js2-function-call">cmd</span>({
                <span class="js2-object-property">tabindex</span>: settings.<span class="js2-object-property">tabindex</span>,
                <span class="js2-object-property">mobileIngoreAutoSpace</span>: settings.<span class="js2-object-property">mobileIngoreAutoSpace</span>,
                <span class="js2-object-property">prompt</span>: global_login_fn ? <span class="constant">false</span> : prompt,
                <span class="js2-object-property">history</span>: settings.<span class="js2-object-property">memory</span> ? <span class="string">'memory'</span> : settings.<span class="js2-object-property">history</span>,
                <span class="js2-object-property">historyFilter</span>: settings.<span class="js2-object-property">historyFilter</span>,
                <span class="js2-object-property">historySize</span>: settings.<span class="js2-object-property">historySize</span>,
                <span class="js2-object-property">caseSensitiveSearch</span>: settings.<span class="js2-object-property">caseSensitiveSearch</span>,
                <span class="js2-object-property">onPaste</span>: settings.<span class="js2-object-property">onPaste</span>,
                <span class="js2-object-property">width</span>: <span class="string">'100%'</span>,
                <span class="js2-object-property">enabled</span>: <span class="constant">false</span>,
                <span class="js2-object-property">char_width</span>: char_size.<span class="js2-object-property">width</span>,
                <span class="js2-object-property">keydown</span>: key_down,
                <span class="js2-object-property">keymap</span>: new_keymap,
                <span class="js2-object-property">clickTimeout</span>: settings.<span class="js2-object-property">clickTimeout</span>,
                <span class="js2-object-property">holdTimeout</span>: settings.<span class="js2-object-property">holdTimeout</span>,
                <span class="js2-object-property">holdRepeatTimeout</span>: settings.<span class="js2-object-property">holdRepeatTimeout</span>,
                <span class="js2-object-property">repeatTimeoutKeys</span>: settings.<span class="js2-object-property">repeatTimeoutKeys</span>,
                <span class="js2-object-property">keypress</span>: key_press,
                <span class="js2-object-property">tabs</span>: settings.<span class="js2-object-property">tabs</span>,
                <span class="function-name">onPositionChange</span>: <span class="keyword">function</span>() {
                    <span class="keyword">var</span> <span class="variable-name">args</span> = <span class="jcXcovered">[].</span><span class="js2-object-property"><span class="jcXcovered">slice</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">call</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">arguments</span></span><span class="jcXcovered">)</span>;
                    <span class="js2-function-call"><span class="jcXcovered">make_cursor_visible</span></span><span class="jcXcovered">();</span>
                    <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onPositionChange'</span></span><span class="jcXcovered">, args);</span>
                },
                <span class="function-name">onCommandChange</span>: <span class="keyword">function</span>(<span class="js2-function-param">command</span>) {
                    <span class="comment">// resize is not triggered when insert called just after init
</span>                    <span class="comment">//  and scrollbar appear
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (old_width !== fill.<span class="js2-function-call">width</span>()) {
                        <span class="comment">// resizer handler will update old_width
</span>                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resizer</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="js2-function-call"><span class="jcXcovered">fire_event</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'onCommandChange'</span></span><span class="jcXcovered">, [command]);</span>
                    <span class="js2-function-call"><span class="jcXcovered">make_cursor_visible</span></span><span class="jcXcovered">();</span>
                },
                <span class="js2-object-property">commands</span>: commands
            });
            <span class="keyword">function</span> <span class="function-name">disable</span>(<span class="js2-function-param">e</span>) {
                <span class="jcXnot-covered">e = e.</span><span class="js2-object-property"><span class="jcXnot-covered">originalEvent</span></span><span class="jcXnot-covered">;</span>
                <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (e) {
                    <span class="comment">// e.terget is body when click outside of context menu to close it
</span>                    <span class="comment">// even if you click on terminal
</span>                    <span class="keyword">var</span> <span class="variable-name">node</span> = <span class="jcXnot-covered">document.</span><span class="js2-function-call"><span class="jcXnot-covered">elementFromPoint</span></span><span class="jcXnot-covered">(e.</span><span class="js2-object-property"><span class="jcXnot-covered">clientX</span></span><span class="jcXnot-covered">, e.</span><span class="js2-object-property"><span class="jcXnot-covered">clientY</span></span><span class="jcXnot-covered">)</span>;
                    <span class="keyword"><span class="jcXnot-covered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span><span class="js2-function-call">$</span>(node).<span class="js2-function-call">closest</span>(<span class="string">'.terminal'</span>).<span class="js2-object-property">length</span> &amp;&amp; self.<span class="js2-function-call">enabled</span>()) {
                        <span class="comment">// we only need to disable when click outside of terminal
</span>                        <span class="comment">// click on other terminal is handled by focus event
</span>                        <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">disable</span></span><span class="jcXnot-covered">();</span>
                    }
                }
            }
            <span class="jcXcovered">sel</span>f.<span class="js2-function-call">oneTime</span>(100, <span class="keyword">function</span>() {
                <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(document).</span><span class="js2-function-call"><span class="jcXcovered">bind</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'click.terminal_'</span></span><span class="jcXcovered"> + self.</span><span class="js2-function-call"><span class="jcXcovered">id</span></span><span class="jcXcovered">(), disable</span>).
                    <span class="js2-function-call">bind</span>(<span class="string">'contextmenu.terminal_'</span> + self.<span class="js2-function-call">id</span>(), disable);
            });
            <span class="keyword">var</span> <span class="variable-name">$win</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(window)</span>;
            <span class="comment">// cordova application, if keyboard was open and we resume, it will be
</span>            <span class="comment">// closed so we need to disable terminal so you can enable it with tap
</span>            <span class="jcXcovered">doc</span>ument.<span class="js2-function-call">addEventListener</span>(<span class="string">"resume"</span>, <span class="keyword">function</span>() {
                <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">disable</span></span><span class="jcXnot-covered">();</span>
            });
            <span class="comment">// istanbul ignore next
</span>            <span class="keyword">if</span> (is_mobile) {
                self.<span class="js2-function-call">click</span>(<span class="keyword">function</span>() {
                    <span class="keyword">if</span> (<span class="negation-char">!</span>frozen) {
                        <span class="keyword">if</span> (<span class="negation-char">!</span>self.<span class="js2-function-call">enabled</span>()) {
                            self.<span class="js2-function-call">focus</span>();
                            command_line.<span class="js2-function-call">enable</span>();
                        } <span class="keyword">else</span> {
                            self.<span class="js2-function-call">disable</span>();
                        }
                    }
                });
            } <span class="keyword">else</span> {
                <span class="comment">// work weird on mobile
</span>                $win.<span class="js2-function-call">on</span>(<span class="string">'focus.terminal_'</span> + self.<span class="js2-function-call">id</span>(), focus_terminal).
                    <span class="js2-function-call">on</span>(<span class="string">'blur.terminal_'</span> + self.<span class="js2-function-call">id</span>(), blur_terminal);
                <span class="comment">// detect mouse drag
</span>                (<span class="keyword">function</span>() {
                    <span class="keyword">var</span> <span class="variable-name">count</span> = 0;
                    <span class="keyword">var</span> <span class="variable-name">$target</span>;
                    <span class="keyword">var</span> <span class="variable-name">name</span> = <span class="string">'click_'</span> + self.<span class="js2-function-call">id</span>();
                    <span class="keyword">var</span> <span class="variable-name">textarea</span> = self.<span class="js2-function-call">find</span>(<span class="string">'.cmd textarea'</span>);
                    <span class="keyword">function</span> <span class="function-name">click</span>() {
                        <span class="keyword">if</span> ($target.<span class="js2-function-call">is</span>(<span class="string">'.terminal'</span>) ||
                            $target.<span class="js2-function-call">is</span>(<span class="string">'.terminal-wrapper'</span>)) {
                            <span class="keyword">var</span> <span class="variable-name">len</span> = self.<span class="js2-function-call">get_command</span>().<span class="js2-object-property">length</span>;
                            self.<span class="js2-function-call">set_position</span>(len);
                        } <span class="keyword">else</span> <span class="keyword">if</span> ($target.<span class="js2-function-call">closest</span>(<span class="string">'.prompt'</span>).<span class="js2-object-property">length</span>) {
                            self.<span class="js2-function-call">set_position</span>(0);
                        }
                        <span class="keyword">if</span> (<span class="negation-char">!</span>textarea.<span class="js2-function-call">is</span>(<span class="string">':focus'</span>)) {
                            textarea.<span class="js2-function-call">focus</span>();
                        }
                        <span class="js2-function-call">reset</span>();
                    }
                    <span class="keyword">function</span> <span class="function-name">reset</span>() {
                        count = 0;
                        $target = <span class="constant">null</span>;
                    }
                    <span class="keyword">var</span> <span class="variable-name">ignore_elements</span> = <span class="string">'.terminal-output textarea,'</span> +
                        <span class="string">'.terminal-output input'</span>;
                    self.<span class="js2-function-call">mousedown</span>(<span class="keyword">function</span>(<span class="js2-function-param">e</span>) {
                        <span class="keyword">if</span> (<span class="negation-char">!</span><span class="js2-function-call">scrollbar_event</span>(e, fill)) {
                            $target = <span class="js2-function-call">$</span>(e.<span class="js2-object-property">target</span>);
                        }
                    }).<span class="js2-function-call">mouseup</span>(<span class="keyword">function</span>() {
                        <span class="keyword">if</span> ($target &amp;&amp; $target.<span class="js2-function-call">closest</span>(ignore_elements).<span class="js2-object-property">length</span>) {
                            <span class="keyword">if</span> (enabled) {
                                self.<span class="js2-function-call">disable</span>();
                            }
                        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="js2-function-call">get_selected_html</span>() === <span class="string">''</span> &amp;&amp; $target) {
                            <span class="keyword">if</span> (++count === 1) {
                                <span class="keyword">if</span> (<span class="negation-char">!</span>frozen) {
                                    <span class="keyword">if</span> (<span class="negation-char">!</span>enabled) {
                                        self.<span class="js2-function-call">focus</span>();
                                    } <span class="keyword">else</span> {
                                        <span class="keyword">var</span> <span class="variable-name">timeout</span> = settings.<span class="js2-object-property">clickTimeout</span>;
                                        self.<span class="js2-function-call">oneTime</span>(timeout, name, click);
                                        <span class="keyword">return</span>;
                                    }
                                }
                            } <span class="keyword">else</span> {
                                self.<span class="js2-function-call">stopTime</span>(name);
                            }
                        }
                        <span class="js2-function-call">reset</span>();
                    }).<span class="js2-function-call">dblclick</span>(<span class="keyword">function</span>() {
                        <span class="js2-function-call">reset</span>();
                        self.<span class="js2-function-call">stopTime</span>(name);
                    });
                })();
                (<span class="keyword">function</span>() {
                    <span class="keyword">var</span> <span class="variable-name">clip</span> = self.<span class="js2-function-call">find</span>(<span class="string">'.cmd textarea'</span>);
                    <span class="keyword">function</span> <span class="function-name">is_context_event</span>(<span class="js2-function-param">e</span>) {
                        <span class="keyword">return</span> e.<span class="js2-object-property">type</span> === <span class="string">'mousedown'</span> &amp;&amp; e.<span class="js2-object-property">buttons</span> === 2 ||
                            e.<span class="js2-object-property">type</span> === <span class="string">'contextmenu'</span>;
                    }
                    self.<span class="js2-function-call">on</span>(<span class="string">'contextmenu.terminal mousedown.terminal'</span>, <span class="keyword">function</span>(<span class="js2-function-param">e</span>) {
                        <span class="keyword">if</span> (<span class="js2-function-call">get_selected_html</span>() === <span class="string">''</span> &amp;&amp; <span class="js2-function-call">is_context_event</span>(e)) {
                            <span class="keyword">if</span> (<span class="negation-char">!</span><span class="js2-function-call">$</span>(e.<span class="js2-object-property">target</span>).<span class="js2-function-call">is</span>(<span class="string">'img,value,audio,object,canvas,a'</span>)) {
                                <span class="keyword">if</span> (<span class="negation-char">!</span>self.<span class="js2-function-call">enabled</span>()) {
                                    self.<span class="js2-function-call">enable</span>();
                                }
                                <span class="keyword">var</span> <span class="variable-name">offset</span> = command_line.<span class="js2-function-call">offset</span>();
                                wrapper.<span class="js2-function-call">css</span>(<span class="string">'overflow'</span>, <span class="string">'hidden'</span>);
                                clip.<span class="js2-function-call">css</span>({
                                    <span class="js2-object-property">left</span>: e.<span class="js2-object-property">pageX</span> - offset.<span class="js2-object-property">left</span> - 20,
                                    <span class="js2-object-property">top</span>: e.<span class="js2-object-property">pageY</span> - offset.<span class="js2-object-property">top</span> - 20,
                                    <span class="js2-object-property">width</span>: <span class="string">'5em'</span>,
                                    <span class="js2-object-property">height</span>: <span class="string">'4em'</span>
                                });
                                <span class="keyword">if</span> (<span class="negation-char">!</span>clip.<span class="js2-function-call">is</span>(<span class="string">':focus'</span>)) {
                                    clip.<span class="js2-function-call">focus</span>();
                                }
                                self.<span class="js2-function-call">stopTime</span>(<span class="string">'textarea'</span>);
                                self.<span class="js2-function-call">oneTime</span>(100, <span class="string">'textarea'</span>, <span class="keyword">function</span>() {
                                    <span class="keyword">var</span> <span class="variable-name">props</span> = {
                                        <span class="js2-object-property">left</span>: <span class="string">''</span>,
                                        <span class="js2-object-property">top</span>: <span class="string">''</span>,
                                        <span class="js2-object-property">width</span>: <span class="string">''</span>,
                                        <span class="js2-object-property">height</span>: <span class="string">''</span>
                                    };
                                    <span class="keyword">if</span> (<span class="negation-char">!</span>is_css_variables_supported) {
                                        <span class="keyword">var</span> <span class="variable-name">in_line</span> = self.<span class="js2-function-call">find</span>(<span class="string">'.cmd .cursor-line'</span>)
                                            .<span class="js2-function-call">prevUntil</span>(<span class="string">'.prompt'</span>).<span class="js2-object-property">length</span>;
                                        props.<span class="js2-object-property">top</span> = in_line * 14 + <span class="string">'px'</span>;
                                    }
                                    clip.<span class="js2-function-call">css</span>(props);
                                    wrapper.<span class="js2-function-call">css</span>(<span class="string">'overflow'</span>, <span class="string">''</span>);
                                });
                                self.<span class="js2-function-call">stopTime</span>(<span class="string">'selection'</span>);
                                self.<span class="js2-function-call">everyTime</span>(20, <span class="string">'selection'</span>, <span class="keyword">function</span>() {
                                    <span class="keyword">if</span> (clip[0].<span class="js2-object-property">selection</span> !== clip[0].<span class="js2-object-property">value</span>) {
                                        <span class="keyword">if</span> (<span class="js2-function-call">get_textarea_selection</span>(clip[0])) {
                                            <span class="js2-function-call">clear_textarea_selection</span>(clip[0]);
                                            <span class="js2-function-call">select</span>(
                                                self.<span class="js2-function-call">find</span>(<span class="string">'.terminal-output'</span>)[0],
                                                self.<span class="js2-function-call">find</span>(<span class="string">'.cmd div:last-of-type'</span>)[0]
                                            );
                                            self.<span class="js2-function-call">stopTime</span>(<span class="string">'selection'</span>);
                                        }
                                    }
                                });
                            }
                        }
                    });
                })();
            }
            <span class="jcXcovered">sel</span>f.<span class="js2-function-call">on</span>(<span class="string">'click'</span>, <span class="string">'a'</span>, <span class="keyword">function</span>(<span class="js2-function-param">e</span>) {
                <span class="keyword">var</span> <span class="variable-name">$this</span> = <span class="js2-function-call"><span class="jcXcovered">$</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">this</span></span><span class="jcXcovered">)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> ($this.<span class="js2-function-call">closest</span>(<span class="string">'.exception'</span>).<span class="js2-object-property">length</span>) {
                    <span class="keyword">var</span> <span class="variable-name">href</span> = <span class="jcXcovered">$this.</span><span class="js2-function-call"><span class="jcXcovered">attr</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'href'</span></span><span class="jcXcovered">)</span>;
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (href.<span class="js2-function-call">match</span>(<span class="string">/:[0-9]+$/</span>)) { <span class="comment">// display line if specified
</span>                        <span class="jcXcovered">e.</span><span class="js2-function-call"><span class="jcXcovered">preventDefault</span></span><span class="jcXcovered">();</span>
                        <span class="js2-function-call"><span class="jcXcovered">print_line</span></span><span class="jcXcovered">(href);</span>
                    }
                }
                <span class="comment">// refocus because links have tabindex in case where user want
</span>                <span class="comment">// tab change urls, we can ignore this function on click
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled) {
                    <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">find</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'.cmd textarea'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">focus</span></span><span class="jcXcovered">();</span>
                }
            });
            <span class="keyword">function</span> <span class="function-name">calculate_char_size</span>() {
                <span class="keyword">var</span> <span class="variable-name">width</span> = <span class="jcXcovered">char_size.</span><span class="js2-object-property"><span class="jcXcovered">width</span></span>;
                <span class="jcXcovered">char_size = </span><span class="js2-function-call"><span class="jcXcovered">get_char_size</span></span><span class="jcXcovered">(self);</span>
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (width !== char_size.<span class="js2-object-property">width</span>) {
                    <span class="jcXnot-covered">command_line.</span><span class="js2-function-call"><span class="jcXnot-covered">option</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'char_width'</span></span><span class="jcXnot-covered">, char_size.</span><span class="js2-object-property"><span class="jcXnot-covered">width</span></span><span class="jcXnot-covered">).</span><span class="js2-function-call"><span class="jcXnot-covered">refresh</span></span><span class="jcXnot-covered">();</span>
                }
            }
            <span class="js2-function-call"><span class="jcXcovered">resize</span></span><span class="jcXcovered">();</span>
            <span class="keyword">function</span> <span class="function-name">resize</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">is</span>(<span class="string">':visible'</span>)) {
                    <span class="keyword">var</span> <span class="variable-name">width</span> = <span class="jcXcovered">fill.</span><span class="js2-function-call"><span class="jcXcovered">width</span></span><span class="jcXcovered">()</span>;
                    <span class="keyword">var</span> <span class="variable-name">height</span> = <span class="jcXcovered">fill.</span><span class="js2-function-call"><span class="jcXcovered">height</span></span><span class="jcXcovered">()</span>;
                    <span class="comment">// prevent too many calculations in IE
</span>                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (old_height !== height || old_width !== width) {
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resize</span></span><span class="jcXcovered">();</span>
                    }
                    <span class="jcXcovered">old_height = height;</span>
                    <span class="jcXcovered">old_width = width;</span>
                }
            }
            <span class="keyword">function</span> <span class="function-name">create_resizers</span>() {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">resizer</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'unbind'</span></span><span class="jcXcovered">).</span><span class="js2-function-call"><span class="jcXcovered">resizer</span></span><span class="jcXcovered">(resize);</span>
                <span class="jcXcovered">fon</span>t_resizer.<span class="js2-function-call">resizer</span>(<span class="string">'unbind'</span>).<span class="js2-function-call">resizer</span>(<span class="keyword">function</span>() {
                    <span class="js2-function-call"><span class="jcXnot-covered">calculate_char_size</span></span><span class="jcXnot-covered">();</span>
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">resize</span></span><span class="jcXnot-covered">();</span>
                });
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">is</span>(<span class="string">':visible'</span>)) {
                <span class="js2-function-call"><span class="jcXcovered">create_resizers</span></span><span class="jcXcovered">();</span>
            }
            <span class="keyword">function</span> <span class="function-name">observe_visibility</span>() {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (visibility_observer) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (visibility_observer.<span class="js2-object-property">unobserve</span>) {
                        <span class="jcXcovered">visibility_observer.</span><span class="js2-function-call"><span class="jcXcovered">unobserve</span></span><span class="jcXcovered">(self[0]);</span>
                    } <span class="keyword">else</span> {
                        <span class="js2-function-call"><span class="jcXnot-covered">clearInterval</span></span><span class="jcXnot-covered">(visibility_observer);</span>
                    }
                }
                <span class="keyword">var</span> <span class="variable-name">was_enabled</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">enabled</span></span><span class="jcXcovered">()</span>;
                <span class="keyword">var</span> <span class="variable-name">visible</span> = <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">is</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">':visible'</span></span><span class="jcXcovered">)</span>;
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (was_enabled &amp;&amp; <span class="negation-char">!</span>visible) {
                    <span class="jcXnot-covered">self.</span><span class="js2-function-call"><span class="jcXnot-covered">disable</span></span><span class="jcXnot-covered">();</span>
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (visible) {
                    <span class="js2-function-call"><span class="jcXcovered">create_resizers</span></span><span class="jcXcovered">();</span>
                } <span class="keyword">else</span> {
                    <span class="comment">// hide terminal content until it's resized (and num chars calculated)
</span>                    <span class="jcXnot-covered">wrapper.</span><span class="js2-function-call"><span class="jcXnot-covered">css</span></span><span class="jcXnot-covered">(</span><span class="string"><span class="jcXnot-covered">'visibility'</span></span><span class="jcXnot-covered">, </span><span class="string"><span class="jcXnot-covered">'hidden'</span></span><span class="jcXnot-covered">);</span>
                }
                <span class="keyword">function</span> <span class="function-name">visibility_checker</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">is</span>(<span class="string">':visible'</span>) &amp;&amp; <span class="negation-char">!</span>visible) {
                        <span class="jcXcovered">visible = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                        <span class="js2-function-call"><span class="jcXcovered">create_resizers</span></span><span class="jcXcovered">();</span>
                        <span class="js2-function-call"><span class="jcXcovered">calculate_char_size</span></span><span class="jcXcovered">();</span>
                        <span class="js2-function-call"><span class="jcXcovered">resize</span></span><span class="jcXcovered">();</span>
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (was_enabled) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">enable</span></span><span class="jcXcovered">();</span>
                        }
                        <span class="jcXcovered">wrapper.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'visibility'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">);</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (visible &amp;&amp; <span class="negation-char">!</span>self.<span class="js2-function-call">is</span>(<span class="string">':visible'</span>)) {
                        <span class="jcXcovered">visible = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                        <span class="jcXcovered">was_enabled = $.</span><span class="js2-object-property"><span class="jcXcovered">terminal</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">active</span></span><span class="jcXcovered">() === self &amp;&amp; self.</span><span class="js2-function-call"><span class="jcXcovered">enabled</span></span><span class="jcXcovered">();</span>
                        <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
                        <span class="jcXcovered">wrapper.</span><span class="js2-function-call"><span class="jcXcovered">css</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'visibility'</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">'hidden'</span></span><span class="jcXcovered">);</span>
                    }
                }
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (window.<span class="js2-object-property">IntersectionObserver</span> &amp;&amp; self.<span class="js2-function-call">css</span>(<span class="string">'position'</span>) !== <span class="string">'fixed'</span>) {
                    <span class="jcXcovered">vis</span>ibility_observer = <span class="keyword">new</span> <span class="js2-function-call">IntersectionObserver</span>(visibility_checker, {
                        <span class="js2-object-property">root</span>: <span class="constant">null</span>
                    });
                    <span class="jcXcovered">visibility_observer.</span><span class="js2-function-call"><span class="jcXcovered">observe</span></span><span class="jcXcovered">(self[0]);</span>
                } <span class="keyword">else</span> {
                    <span class="jcXcovered">visibility_observer = </span><span class="js2-function-call"><span class="jcXcovered">setInterval</span></span><span class="jcXcovered">(visibility_checker, 100);</span>
                }
            }
            <span class="keyword">var</span> <span class="variable-name">in_dom</span> = <span class="negation-char"><span class="jcXcovered">!!</span></span><span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">closest</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">'body'</span></span><span class="jcXcovered">).</span><span class="js2-object-property"><span class="jcXcovered">length</span></span>;
            <span class="keyword">var</span> <span class="variable-name">MutationObsrv</span> = <span class="jcXcovered">window.</span><span class="js2-object-property"><span class="jcXcovered">MutationObserver</span></span><span class="jcXcovered"> || window.</span><span class="js2-object-property"><span class="jcXcovered">WebKitMutationObserver</span></span>;
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (MutationObsrv) {
                <span class="jcXcovered">mut</span>ation_observer = <span class="keyword">new</span> <span class="js2-function-call">MutationObsrv</span>(<span class="keyword">function</span>() {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (self.<span class="js2-function-call">closest</span>(<span class="string">'body'</span>).<span class="js2-object-property">length</span>) {
                        <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>in_dom) {
                            <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">scroll_to_bottom</span></span><span class="jcXcovered">();</span>
                            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (window.<span class="js2-object-property">IntersectionObserver</span>) {
                                <span class="js2-function-call"><span class="jcXcovered">observe_visibility</span></span><span class="jcXcovered">();</span>
                            }
                            <span class="js2-function-call"><span class="jcXcovered">resize</span></span><span class="jcXcovered">();</span>
                        }
                        <span class="jcXcovered">in_dom = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (in_dom) {
                        <span class="jcXcovered">in_dom = </span><span class="constant"><span class="jcXcovered">false</span></span><span class="jcXcovered">;</span>
                    }
                });
                <span class="jcXcovered">mutation_observer.</span><span class="js2-function-call"><span class="jcXcovered">observe</span></span><span class="jcXcovered">(document.</span><span class="js2-object-property"><span class="jcXcovered">body</span></span><span class="jcXcovered">, {</span><span class="js2-object-property"><span class="jcXcovered">childList</span></span><span class="jcXcovered">: </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">});</span>
            }
            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (in_dom) {
                <span class="comment">// check if element is in the DOM if not running IntersectionObserver
</span>                <span class="comment">// don't make sense
</span>                <span class="js2-function-call"><span class="jcXcovered">observe_visibility</span></span><span class="jcXcovered">();</span>
            }
            <span class="jcXcovered">command_queue.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">();</span>
            <span class="comment">// touch devices need touch event to get virtual keyboard
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (enabled &amp;&amp; self.<span class="js2-function-call">is</span>(<span class="string">':visible'</span>) &amp;&amp; <span class="negation-char">!</span>is_mobile) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">focus</span></span><span class="jcXcovered">(</span><span class="constant"><span class="jcXcovered">undefined</span></span><span class="jcXcovered">, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">);</span>
            } <span class="keyword">else</span> {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">disable</span></span><span class="jcXcovered">();</span>
            }
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// Run Login
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="js2-function-call">is_function</span>(global_login_fn)) {
                <span class="jcXcovered">self.</span><span class="js2-function-call"><span class="jcXcovered">login</span></span><span class="jcXcovered">(global_login_fn, </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">, initialize);</span>
            } <span class="keyword">else</span> {
                <span class="js2-function-call"><span class="jcXcovered">initialize</span></span><span class="jcXcovered">();</span>
            }
            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">// :: helper
</span>            <span class="keyword">function</span> <span class="function-name">exec_spec</span>(<span class="js2-function-param">spec</span>) {
                <span class="keyword">var</span> <span class="variable-name">terminal</span> = <span class="jcXcovered">terminals.</span><span class="js2-function-call"><span class="jcXcovered">get</span></span><span class="jcXcovered">()[spec[0]]</span>;
                <span class="comment">// execute if belong to this terminal
</span>                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (terminal &amp;&amp; terminal_id === terminal.<span class="js2-function-call">id</span>()) {
                    <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (<span class="negation-char">!</span>spec[2]) {
                        <span class="jcXcovered">defer.</span><span class="js2-function-call"><span class="jcXcovered">resolve</span></span><span class="jcXcovered">();</span>
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> defer.</span><span class="js2-function-call"><span class="jcXnot-covered">promise</span></span><span class="jcXnot-covered">();</span>
                    }<span class="jcXcovered"> </span><span class="keyword"><span class="jcXcovered">else</span></span><span class="jcXcovered"> </span><span class="keyword">if</span> (paused) {
                        <span class="keyword">var</span> <span class="variable-name">defer</span> = <span class="jcXnot-covered">$.</span><span class="js2-function-call"><span class="jcXnot-covered">Deferred</span></span><span class="jcXnot-covered">()</span>;
                        <span class="jcXnot-covered">res</span>ume_callbacks.<span class="js2-function-call">push</span>(<span class="keyword">function</span>() {
                            <span class="keyword"><span class="jcXnot-covered">ret</span></span><span class="keyword">urn</span> terminal.<span class="js2-function-call">exec</span>(spec[2]).<span class="js2-function-call">done</span>(<span class="keyword">function</span>() {
                                <span class="jcXnot-covered">terminal.</span><span class="js2-function-call"><span class="jcXnot-covered">save_state</span></span><span class="jcXnot-covered">(spec[2], </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">, spec[1]);</span>
                                <span class="jcXnot-covered">defer.</span><span class="js2-function-call"><span class="jcXnot-covered">resolve</span></span><span class="jcXnot-covered">();</span>
                            });
                        });
                        <span class="keyword"><span class="jcXnot-covered">return</span></span><span class="jcXnot-covered"> defer.</span><span class="js2-function-call"><span class="jcXnot-covered">promise</span></span><span class="jcXnot-covered">();</span>
                    } <span class="keyword">else</span> {
                        <span class="keyword"><span class="jcXcovered">ret</span></span><span class="keyword">urn</span> terminal.<span class="js2-function-call">exec</span>(spec[2]).<span class="js2-function-call">done</span>(<span class="keyword">function</span>() {
                            <span class="jcXcovered">terminal.</span><span class="js2-function-call"><span class="jcXcovered">save_state</span></span><span class="jcXcovered">(spec[2], </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">, spec[1]);</span>
                        });
                    }
                }
            }
            <span class="comment">// exec from hash called in each terminal instance
</span>            <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (settings.<span class="js2-object-property">execHash</span>) {
                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (location.<span class="js2-object-property">hash</span>) {
                    <span class="comment">// wait until login is initialized
</span>                    <span class="js2-function-call"><span class="jcXcovered">set</span></span><span class="js2-function-call">Timeout</span>(<span class="keyword">function</span>() {
                        <span class="keyword"><span class="jcXcovered">t</span></span><span class="keyword">ry</span> {
                            <span class="keyword">var</span> <span class="variable-name">hash</span> = <span class="jcXcovered">location.</span><span class="js2-object-property"><span class="jcXcovered">hash</span></span><span class="jcXcovered">.</span><span class="js2-function-call"><span class="jcXcovered">replace</span></span><span class="jcXcovered">(</span><span class="string"><span class="jcXcovered">/^#/</span></span><span class="jcXcovered">, </span><span class="string"><span class="jcXcovered">''</span></span><span class="jcXcovered">)</span>;
                            <span class="comment">// yes no var - local inside terminal
</span>                            <span class="jcXcovered">hash_commands = JSON.</span><span class="js2-function-call"><span class="jcXcovered">parse</span></span><span class="jcXcovered">(</span><span class="builtin"><span class="jcXcovered">decodeURIComponent</span></span><span class="jcXcovered">(hash));</span>
                            <span class="keyword">var</span> <span class="variable-name">i</span> = <span class="jcXcovered">0</span>;
                            <span class="jcXcovered">(</span><span class="keyword"><span class="jcXcovered">func</span></span><span class="keyword">tion</span> <span class="function-name">recur</span>() {
                                <span class="keyword">var</span> <span class="variable-name">spec</span> = <span class="jcXcovered">hash_commands[i++]</span>;
                                <span class="keyword"><span class="jcXcovered">i</span></span><span class="keyword">f</span> (spec) {
                                    <span class="js2-function-call"><span class="jcXcovered">exec_spec</span></span><span class="jcXcovered">(spec).</span><span class="js2-function-call"><span class="jcXcovered">done</span></span><span class="jcXcovered">(recur);</span>
                                } <span class="keyword">else</span> {
                                    <span class="jcXnot-covered">change_hash = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                                }
                            })();<span class="comment">// */
</span>                        } <span class="keyword">catch</span> (e) {
                            <span class="comment">// invalid json - ignore
</span>                        }
                    });
                } <span class="keyword">else</span> {
                    <span class="jcXnot-covered">change_hash = </span><span class="constant"><span class="jcXnot-covered">true</span></span><span class="jcXnot-covered">;</span>
                }
            } <span class="keyword">else</span> {
                <span class="jcXcovered">change_hash = </span><span class="constant"><span class="jcXcovered">true</span></span><span class="jcXcovered">;</span> <span class="comment">// if enabled later
</span>            }
            <span class="comment">// change_hash = true; // exec can now change hash
</span>            <span class="comment">// -------------------------------------------------------------
</span>            <span class="comment">/* istanbul ignore next */</span>
            (<span class="keyword">function</span>() {
                <span class="keyword">var</span> <span class="variable-name">shift</span> = <span class="constant">false</span>;
                <span class="js2-function-call">$</span>(document).<span class="js2-function-call">bind</span>(<span class="string">'keydown.terminal_'</span> + self.<span class="js2-function-call">id</span>(), <span class="keyword">function</span>(<span class="js2-function-param">e</span>) {
                    <span class="keyword">if</span> (e.<span class="js2-object-property">shiftKey</span>) {
                        shift = <span class="constant">true</span>;
                    }
                }).<span class="js2-function-call">bind</span>(<span class="string">'keyup.terminal_'</span> + self.<span class="js2-function-call">id</span>(), <span class="keyword">function</span>(<span class="js2-function-param">e</span>) {
                    <span class="comment">// in Google Chromium/Linux shiftKey is false
</span>                    <span class="keyword">if</span> (e.<span class="js2-object-property">shiftKey</span> || e.<span class="js2-object-property">which</span> === 16) {
                        shift = <span class="constant">false</span>;
                    }
                });
                <span class="comment">// this could work without calling scroll on wheel event but we
</span>                <span class="comment">// need it for cases where you have mouse wheel work differently
</span>                <span class="comment">// like with less command that scroll text
</span>                <span class="keyword">function</span> <span class="function-name">mousewheel</span>(<span class="js2-function-param">event</span>, <span class="js2-function-param">delta</span>) {
                    <span class="keyword">if</span> (<span class="negation-char">!</span>shift) {
                        <span class="keyword">var</span> <span class="variable-name">interpreter</span> = interpreters.<span class="js2-function-call">top</span>();
                        <span class="keyword">var</span> <span class="variable-name">ret</span>;
                        <span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(interpreter.<span class="js2-object-property">mousewheel</span>)) {
                            ret = interpreter.<span class="js2-function-call">mousewheel</span>(event, delta, self);
                        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="js2-function-call">is_function</span>(settings.<span class="js2-object-property">mousewheel</span>)) {
                            ret = settings.<span class="js2-function-call">mousewheel</span>(event, delta, self);
                        }
                        <span class="keyword">if</span> (ret === <span class="constant">true</span>) {
                            <span class="keyword">return</span>;
                        }
                        <span class="keyword">if</span> ((<span class="js2-function-call">have_scrollbar</span>() || ret === <span class="constant">false</span>) &amp;&amp; <span class="negation-char">!</span>event.<span class="js2-object-property">ctrlKey</span>) {
                            event.<span class="js2-function-call">stopPropagation</span>();
                            event.<span class="js2-function-call">preventDefault</span>();
                        }
                        <span class="keyword">if</span> (ret === <span class="constant">false</span>) {
                            <span class="keyword">return</span> <span class="constant">false</span>;
                        }
                        <span class="keyword">if</span> (delta &gt; 0) {
                            self.<span class="js2-function-call">scroll</span>(-40);
                        } <span class="keyword">else</span> {
                            self.<span class="js2-function-call">scroll</span>(40);
                        }
                    }
                }
                <span class="keyword">if</span> ($.<span class="js2-object-property">event</span>.<span class="js2-object-property">special</span>.<span class="js2-object-property">mousewheel</span>) {
                    <span class="comment">// we keep mousewheel plugin just in case
</span>                    self.<span class="js2-function-call">on</span>(<span class="string">'mousewheel'</span>, mousewheel);
                } <span class="keyword">else</span> {
                    <span class="comment">// detection take from:
</span>                    <span class="comment">// https://developer.mozilla.org/en-US/docs/Web/Events/wheel
</span>                    <span class="keyword">var</span> <span class="variable-name">event</span>;
                    <span class="keyword">var</span> <span class="variable-name">div</span> = document.<span class="js2-function-call">createElement</span>(<span class="string">"div"</span>);
                    <span class="keyword">if</span> (<span class="string">"onwheel"</span> <span class="keyword">in</span> div) {
                        event = <span class="string">"wheel"</span>; <span class="comment">// Modern browsers support "wheel"
</span>                    } <span class="keyword">else</span> <span class="keyword">if</span> (document.<span class="js2-object-property">onmousewheel</span> !== <span class="constant">undefined</span>) {
                        <span class="comment">// Webkit and IE support at least "mousewheel"
</span>                        event = <span class="string">"mousewheel"</span>;
                    } <span class="keyword">else</span> {
                        <span class="comment">// let's assume that remaining browsers are older Firefox
</span>                        event = <span class="string">"DOMMouseScroll"</span>;
                    }
                    div = <span class="constant">null</span>;
                    self.<span class="js2-function-call">on</span>(event, <span class="keyword">function</span>(<span class="js2-function-param">e</span>) {
                        <span class="keyword">var</span> <span class="variable-name">delta</span>;
                        <span class="keyword">if</span> (event === <span class="string">'mousewheel'</span>) {
                            delta = - 1 / 40 * e.<span class="js2-object-property">originalEvent</span>.<span class="js2-object-property">wheelDelta</span>;
                        } <span class="keyword">else</span> {
                            delta = e.<span class="js2-object-property">originalEvent</span>.<span class="js2-object-property">deltaY</span> || e.<span class="js2-object-property">originalEvent</span>.<span class="js2-object-property">detail</span>;
                        }
                        <span class="js2-function-call">mousewheel</span>(e, -delta);
                    });
                }
            })();
        }); <span class="comment">// make_interpreter
</span>        <span class="keyword"><span class="jcXcovered">return</span></span><span class="jcXcovered"> self;</span>
    }; <span class="comment">// terminal plugin
</span>});
</pre>
    <!-- Piwik -->
    <script type="text/javascript">
     if (location.host == 'terminal.jcubic.pl') {
         var _paq = _paq || [];
         _paq.push(['trackPageView']);
         _paq.push(['enableLinkTracking']);
         (function() {
             var u=(("https:" == document.location.protocol) ? "https" : "http") + "://piwik.jcubic.pl/";
             _paq.push(['setTrackerUrl', u+'piwik.php']);
             _paq.push(['setSiteId', 1]);
             var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
             g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
         })();
     }
    </script>
    <noscript><p><img src="https://piwik.jcubic.pl/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
    <!-- End Piwik Code -->
  </body>
</html>
